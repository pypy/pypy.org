<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A Faster Python">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PyPy (old posts, page 42) | PyPy</title>
<link href="../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.pypy.org/blog/index-42.html">
<link rel="icon" href="../favicon2.ico" sizes="16x16">
<link rel="icon" href="../favicon32x32.ico" sizes="32x32">
<link rel="prev" href="index-43.html" type="text/html">
<link rel="next" href="index-41.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../assets/css/tipuesearch.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../index.html">
                    <image id="toplogo" src="../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../compat.html">Compatibility</a> </li>  
                    <li> <a href="../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href=".">Index</a> </li>  
                    <li> <a href="../categories/">Tags</a> </li>  
                    <li> <a href="../archive.html">Archive by year</a> </li>  
                    <li> <a href="../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><div class="post">
<div class="postindex">
    <article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/07/m1-support-for-pypy.html" class="u-url">M1 support for PyPy</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/07/m1-support-for-pypy.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-21T18:27:14Z" itemprop="datePublished" title="2022-07-21 18:27">2022-07-21 18:27</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>The PyPy team is happy to announce that we can now target the macOS ARM64
platform. Much of the work was executed by Maciej Fijałkowski (fijal) and
funded via a generous contribution to our <a class="reference external" href="https://opencollective.com/pypy">OpenCollective</a>. The work is based
on our existing <a class="reference external" href="../posts/2019/07/pypy-jit-for-aarch64-7161523403247118006.html">support for aarch64</a> (arm64 on linux) with some twists
to support the differences between the CPUs and the operating system. There
are nightly builds for <a class="reference external" href="https://buildbot.pypy.org/nightly/py3.8/">pypy3.8</a> and <a class="reference external" href="https://buildbot.pypy.org/nightly/py3.9/">pypy3.9</a> (look for <code class="docutils literal">macos_arm64</code>), and
the architecture will be part of our next release.</p>
<p>Please try it out and let us know how it is useful for you or how we could
improve.</p>
<p>We still need help improving our macOS support. We have an <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3697">open issue</a> to
help our packaging story. Help is welcome.</p>
<p>The PyPy team.</p>
    </div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/07/toy-optimizer.html" class="u-url">Implementing a Toy Optimizer</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/07/toy-optimizer.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-07-19T12:00:00Z" itemprop="datePublished" title="2022-07-19 12:00">2022-07-19 12:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>In this blog post I want to show the complete code (in Python3) of how a very
simple optimizer for sequences of operations can work. These algorithms could
be part of a (really simple) compiler, or a JIT. The architecture of the code in
this blog post is very similar to that of the trace optimizer of the PyPy JIT:
After a trace is produced, is is optimized before being sent to the machine code
backend that produces binary instructions for the CPU architecture that PyPy is
running on.</p>
<p>To get started, the first thing we need to do is define how our operations are
stored. The
format that a compiler uses to store the program while it is being optimized
is usually called its <a class="reference external" href="https://en.wikipedia.org/wiki/Intermediate_representation">intermediate representation</a> (IR). Many production
compilers use IRs that are in the <a class="reference external" href="https://en.wikipedia.org/wiki/Static_single-assignment_form">Static Single-Assignment Form</a> (SSA), and
we will also use that. SSA form has the property that every variable is
assigned to exactly once, and every variable is defined before it is used. This
simplifies many things.</p>
<p>Let's make this concrete. If our input program is a complex expressions, such
as <code class="docutils literal">a * (b + 17) + (b + 17)</code> the intermediate representation of that (or at
least its text representation) would maybe be something like:</p>
<pre class="literal-block">var1 = add(b, 17)
var2 = mul(a, var1)
var3 = add(b, 17)
var4 = add(var2, var3)</pre>
<p>This sequence of instructions is inefficient. The operation <code class="docutils literal">add(b, 17)</code> is
computed twice and we can save time by removing the second one and only
computing it once. In this post I want to show an optimizer that can do this
(and some related) optimizations.</p>
<p>Looking at the IR we notice that the input expression has been linearized
into a sequence of operations, and all the intermedia results have been given
unique variable names. The value that every variable is assigned is computed
by the right hand side, which is some operation consisting of an operand and an
arbitrary number of arguments. The arguments of an operation are either
themselves variables or constants.</p>
<p>I will not at all talk about the process of translating the input program
into the IR. Instead, I will assume we have some component that does this
translation already. The tests in this blog post will construct small
snippets of IR by hand. I also won't talk about what happens after the
optimization (usually the optimized IR is translated into machine code).</p>
<section id="implementing-the-intermediate-representation"><h2>Implementing the Intermediate Representation</h2>
<p>Let's start modelling the intermediate representation with Python classes.
First we define a base class of all values that can be used as arguments in
operations, and let's also add a class that represents constants:</p>
<div class="code"><pre class="code python"><a id="rest_code_3b71809eda364606b1523f509c7531e1-1" name="rest_code_3b71809eda364606b1523f509c7531e1-1" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-2" name="rest_code_3b71809eda364606b1523f509c7531e1-2" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-3" name="rest_code_3b71809eda364606b1523f509c7531e1-3" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-3"></a>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-4" name="rest_code_3b71809eda364606b1523f509c7531e1-4" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="p">:</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-5" name="rest_code_3b71809eda364606b1523f509c7531e1-5" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-5"></a>    <span class="k">pass</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-6" name="rest_code_3b71809eda364606b1523f509c7531e1-6" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-6"></a>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-7" name="rest_code_3b71809eda364606b1523f509c7531e1-7" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Constant</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-8" name="rest_code_3b71809eda364606b1523f509c7531e1-8" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-9" name="rest_code_3b71809eda364606b1523f509c7531e1-9" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-10" name="rest_code_3b71809eda364606b1523f509c7531e1-10" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-10"></a>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-11" name="rest_code_3b71809eda364606b1523f509c7531e1-11" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_3b71809eda364606b1523f509c7531e1-12" name="rest_code_3b71809eda364606b1523f509c7531e1-12" href="../posts/2022/07/toy-optimizer.html#rest_code_3b71809eda364606b1523f509c7531e1-12"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Constant(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)"</span>
</pre></div>
<p>One consequence of the fact that every variable is assigned to only once is
that variables are in a one-to-one correspondence with the right-hand-side of
their unique assignments. That means that we don't need a class that represents
variables at all. Instead, it's sufficient to have a class that represents an
operation (the right-hand side), and that by definition is the same as the variable (left-hand side) that it defines:</p>
<div class="code"><pre class="code python"><a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-1" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-1" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Operation</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-2" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-2" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Value</span><span class="p">]):</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-3" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-3" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-4" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-4" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-5" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-5" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-5"></a>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-6" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-6" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-7" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-7" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-7"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Operation(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-8" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-8" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-8"></a>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-9" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-9" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-10" name="rest_code_fe600ae83ce7416a8eb9fb650e9503ad-10" href="../posts/2022/07/toy-optimizer.html#rest_code_fe600ae83ce7416a8eb9fb650e9503ad-10"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
<p>Now we can instantiate these two classes to represent the example sequence of
operations above:</p>
<div class="code"><pre class="code python"><a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-1" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-1" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_construct_example</span><span class="p">():</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-2" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-2" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-2"></a>    <span class="c1"># first we need something to represent</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-3" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-3" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-3"></a>    <span class="c1"># "a" and "b". In our limited view, we don't</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-4" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-4" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-4"></a>    <span class="c1"># know where they come from, so we will define</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-5" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-5" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-5"></a>    <span class="c1"># them with a pseudo-operation called "getarg"</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-6" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-6" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-6"></a>    <span class="c1"># which takes a number n as an argument and</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-7" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-7" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-7"></a>    <span class="c1"># returns the n-th input argument. The proper</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-8" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-8" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-8"></a>    <span class="c1"># SSA way to do this would be phi-nodes.</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-9" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-9" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-9"></a>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-10" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-10" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-10"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-11" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-11" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-11"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-12" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-12" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-12"></a>    <span class="c1"># var1 = add(b, 17)</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-13" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-13" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-13"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-14" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-14" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-14"></a>    <span class="c1"># var2 = mul(a, var1)</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-15" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-15" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-15"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">])</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-16" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-16" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-16"></a>    <span class="c1"># var3 = add(b, 17)</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-17" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-17" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-17"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-18" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-18" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-18"></a>    <span class="c1"># var4 = add(var2, var3)</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-19" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-19" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-19"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="s2">"add"</span><span class="p">,</span> <span class="p">[</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">])</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-20" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-20" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-20"></a>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-21" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-21" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-21"></a>    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">,</span> <span class="n">var4</span><span class="p">]</span>
<a id="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-22" name="rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-22" href="../posts/2022/07/toy-optimizer.html#rest_code_9e90f3ec3cc44d9498cbe1c9b3dfcb9d-22"></a>    <span class="c1"># nothing to test really, it shouldn't crash</span>
</pre></div>
<p>Usually, complicated programs are represented as a <a class="reference external" href="https://en.wikipedia.org/wiki/Control-flow_graph">control flow graph</a> in a
compiler, which represents all the possible paths that control can take while
executing the program. Every node in the control flow graph is a <a class="reference external" href="https://en.wikipedia.org/wiki/Basic_block">basic
block</a>. A basic block is a linear sequence of operations with no control flow
inside of it.</p>
<p>When optimizing a program, a compiler usually looks at the whole control flow
graph of a function. However, that is still too complicated! So let's
simplify further and look at only at optimizations we can do when looking at
a single basic block and its sequence of instructions (they are called local
optimizations).</p>
<p>Let's define a class representing basic blocks and let's also add some
convenience functions for constructing sequences of operations, because the
code in <code class="docutils literal">test_construct_example</code> is a bit annoying.</p>
<div class="code"><pre class="code python"><a id="rest_code_d79af4fe211347ef83f35508aed998ee-1" name="rest_code_d79af4fe211347ef83f35508aed998ee-1" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Block</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-2" name="rest_code_d79af4fe211347ef83f35508aed998ee-2" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">opbuilder</span><span class="p">(</span><span class="n">opname</span><span class="p">):</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-3" name="rest_code_d79af4fe211347ef83f35508aed998ee-3" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-3"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-4" name="rest_code_d79af4fe211347ef83f35508aed998ee-4" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-4"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-5" name="rest_code_d79af4fe211347ef83f35508aed998ee-5" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-5"></a>                <span class="n">arg</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-6" name="rest_code_d79af4fe211347ef83f35508aed998ee-6" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-6"></a>            <span class="k">return</span> <span class="n">arg</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-7" name="rest_code_d79af4fe211347ef83f35508aed998ee-7" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-7"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-8" name="rest_code_d79af4fe211347ef83f35508aed998ee-8" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-8"></a>            <span class="c1"># construct an Operation, wrap the</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-9" name="rest_code_d79af4fe211347ef83f35508aed998ee-9" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-9"></a>            <span class="c1"># arguments in Constants if necessary</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-10" name="rest_code_d79af4fe211347ef83f35508aed998ee-10" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-10"></a>            <span class="n">op</span> <span class="o">=</span> <span class="n">Operation</span><span class="p">(</span><span class="n">opname</span><span class="p">,</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-11" name="rest_code_d79af4fe211347ef83f35508aed998ee-11" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-11"></a>                <span class="p">[</span><span class="n">wraparg</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-12" name="rest_code_d79af4fe211347ef83f35508aed998ee-12" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-12"></a>            <span class="c1"># add it to self, the basic block</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-13" name="rest_code_d79af4fe211347ef83f35508aed998ee-13" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-14" name="rest_code_d79af4fe211347ef83f35508aed998ee-14" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-14"></a>            <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-15" name="rest_code_d79af4fe211347ef83f35508aed998ee-15" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-15"></a>        <span class="k">return</span> <span class="n">build</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-16" name="rest_code_d79af4fe211347ef83f35508aed998ee-16" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-16"></a>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-17" name="rest_code_d79af4fe211347ef83f35508aed998ee-17" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-17"></a>    <span class="c1"># a bunch of operations we support</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-18" name="rest_code_d79af4fe211347ef83f35508aed998ee-18" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-18"></a>    <span class="n">add</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"add"</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-19" name="rest_code_d79af4fe211347ef83f35508aed998ee-19" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-19"></a>    <span class="n">mul</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"mul"</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-20" name="rest_code_d79af4fe211347ef83f35508aed998ee-20" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-20"></a>    <span class="n">getarg</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"getarg"</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-21" name="rest_code_d79af4fe211347ef83f35508aed998ee-21" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-21"></a>    <span class="n">dummy</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"dummy"</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-22" name="rest_code_d79af4fe211347ef83f35508aed998ee-22" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-22"></a>    <span class="n">lshift</span> <span class="o">=</span> <span class="n">opbuilder</span><span class="p">(</span><span class="s2">"lshift"</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-23" name="rest_code_d79af4fe211347ef83f35508aed998ee-23" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-23"></a>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-24" name="rest_code_d79af4fe211347ef83f35508aed998ee-24" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_convencience_block_construction</span><span class="p">():</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-25" name="rest_code_d79af4fe211347ef83f35508aed998ee-25" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-25"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-26" name="rest_code_d79af4fe211347ef83f35508aed998ee-26" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-26"></a>    <span class="c1"># a again with getarg, the following line</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-27" name="rest_code_d79af4fe211347ef83f35508aed998ee-27" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-27"></a>    <span class="c1"># defines the Operation instance and</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-28" name="rest_code_d79af4fe211347ef83f35508aed998ee-28" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-28"></a>    <span class="c1"># immediately adds it to the basic block bb</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-29" name="rest_code_d79af4fe211347ef83f35508aed998ee-29" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-29"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-30" name="rest_code_d79af4fe211347ef83f35508aed998ee-30" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-30"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-31" name="rest_code_d79af4fe211347ef83f35508aed998ee-31" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-31"></a>    <span class="k">assert</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"getarg"</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-32" name="rest_code_d79af4fe211347ef83f35508aed998ee-32" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-32"></a>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-33" name="rest_code_d79af4fe211347ef83f35508aed998ee-33" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-33"></a>    <span class="c1"># it's a Constant</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-34" name="rest_code_d79af4fe211347ef83f35508aed998ee-34" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-34"></a>    <span class="k">assert</span> <span class="n">bb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-35" name="rest_code_d79af4fe211347ef83f35508aed998ee-35" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-35"></a>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-36" name="rest_code_d79af4fe211347ef83f35508aed998ee-36" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-36"></a>    <span class="c1"># b with getarg</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-37" name="rest_code_d79af4fe211347ef83f35508aed998ee-37" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-37"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-38" name="rest_code_d79af4fe211347ef83f35508aed998ee-38" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-38"></a>    <span class="c1"># var1 = add(b, 17)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-39" name="rest_code_d79af4fe211347ef83f35508aed998ee-39" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-39"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-40" name="rest_code_d79af4fe211347ef83f35508aed998ee-40" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-40"></a>    <span class="c1"># var2 = mul(a, var1)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-41" name="rest_code_d79af4fe211347ef83f35508aed998ee-41" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-41"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-42" name="rest_code_d79af4fe211347ef83f35508aed998ee-42" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-42"></a>    <span class="c1"># var3 = add(b, 17)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-43" name="rest_code_d79af4fe211347ef83f35508aed998ee-43" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-43"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-44" name="rest_code_d79af4fe211347ef83f35508aed998ee-44" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-44"></a>    <span class="c1"># var4 = add(var2, var3)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-45" name="rest_code_d79af4fe211347ef83f35508aed998ee-45" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-45"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_d79af4fe211347ef83f35508aed998ee-46" name="rest_code_d79af4fe211347ef83f35508aed998ee-46" href="../posts/2022/07/toy-optimizer.html#rest_code_d79af4fe211347ef83f35508aed998ee-46"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
</pre></div>
<p>That's a good bit of infrastructure to make the tests easy to write. One
thing we are lacking though is a way to print the basic blocks into a nicely
readable textual representation. Because in the current form, the <code class="docutils literal">repr</code> of a
Block is very annoying, the output of pretty-printing <code class="docutils literal">bb</code> in the test above
looks like this:</p>
<div class="code"><pre class="code python"><a id="rest_code_276446a07913410d8f4a02aa32b97b99-1" name="rest_code_276446a07913410d8f4a02aa32b97b99-1" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-1"></a><span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-2" name="rest_code_276446a07913410d8f4a02aa32b97b99-2" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-2"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span> <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-3" name="rest_code_276446a07913410d8f4a02aa32b97b99-3" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-3"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-4" name="rest_code_276446a07913410d8f4a02aa32b97b99-4" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-4"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-5" name="rest_code_276446a07913410d8f4a02aa32b97b99-5" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-5"></a>                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-6" name="rest_code_276446a07913410d8f4a02aa32b97b99-6" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-6"></a>                 <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-7" name="rest_code_276446a07913410d8f4a02aa32b97b99-7" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-7"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'mul'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-8" name="rest_code_276446a07913410d8f4a02aa32b97b99-8" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-8"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-9" name="rest_code_276446a07913410d8f4a02aa32b97b99-9" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-9"></a>                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-10" name="rest_code_276446a07913410d8f4a02aa32b97b99-10" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-10"></a>                 <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-11" name="rest_code_276446a07913410d8f4a02aa32b97b99-11" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-11"></a>                           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-12" name="rest_code_276446a07913410d8f4a02aa32b97b99-12" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-12"></a>                                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-13" name="rest_code_276446a07913410d8f4a02aa32b97b99-13" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-13"></a>                            <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-14" name="rest_code_276446a07913410d8f4a02aa32b97b99-14" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-14"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-15" name="rest_code_276446a07913410d8f4a02aa32b97b99-15" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-15"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-16" name="rest_code_276446a07913410d8f4a02aa32b97b99-16" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-16"></a>                      <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-17" name="rest_code_276446a07913410d8f4a02aa32b97b99-17" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-17"></a>            <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-18" name="rest_code_276446a07913410d8f4a02aa32b97b99-18" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-18"></a> <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-19" name="rest_code_276446a07913410d8f4a02aa32b97b99-19" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-19"></a>           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'mul'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-20" name="rest_code_276446a07913410d8f4a02aa32b97b99-20" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-20"></a>                       <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-21" name="rest_code_276446a07913410d8f4a02aa32b97b99-21" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-21"></a>                                  <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-22" name="rest_code_276446a07913410d8f4a02aa32b97b99-22" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-22"></a>                             <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-23" name="rest_code_276446a07913410d8f4a02aa32b97b99-23" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-23"></a>                                       <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-24" name="rest_code_276446a07913410d8f4a02aa32b97b99-24" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-24"></a>                                                  <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-25" name="rest_code_276446a07913410d8f4a02aa32b97b99-25" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-25"></a>                                        <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-26" name="rest_code_276446a07913410d8f4a02aa32b97b99-26" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-26"></a>                 <span class="n">Operation</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-27" name="rest_code_276446a07913410d8f4a02aa32b97b99-27" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-27"></a>                           <span class="p">[</span><span class="n">Operation</span><span class="p">(</span><span class="s1">'getarg'</span><span class="p">,</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-28" name="rest_code_276446a07913410d8f4a02aa32b97b99-28" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-28"></a>                                           <span class="p">[</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)]),</span>
<a id="rest_code_276446a07913410d8f4a02aa32b97b99-29" name="rest_code_276446a07913410d8f4a02aa32b97b99-29" href="../posts/2022/07/toy-optimizer.html#rest_code_276446a07913410d8f4a02aa32b97b99-29"></a>                                 <span class="n">Constant</span><span class="p">(</span><span class="mi">17</span><span class="p">)])])]</span>
</pre></div>
<p>It's impossible to see what is going on here, because the <code class="docutils literal">Operations</code> in the
basic block appear several times, once as elements of the list but then also as
arguments to operations further down in the list. So we need some code that
turns things back into a readable textual representation, so we have a chance
to debug.</p>
<div class="code"><pre class="code python"><a id="rest_code_e317e66b655743e7bf025201e502749d-1" name="rest_code_e317e66b655743e7bf025201e502749d-1" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">,</span> <span class="n">varprefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"var"</span><span class="p">):</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-2" name="rest_code_e317e66b655743e7bf025201e502749d-2" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-2"></a>    <span class="c1"># the implementation is not too important,</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-3" name="rest_code_e317e66b655743e7bf025201e502749d-3" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-3"></a>    <span class="c1"># look at the test below to see what the</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-4" name="rest_code_e317e66b655743e7bf025201e502749d-4" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-4"></a>    <span class="c1"># result looks like</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-5" name="rest_code_e317e66b655743e7bf025201e502749d-5" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-5"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-6" name="rest_code_e317e66b655743e7bf025201e502749d-6" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-6"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arg_to_str</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-7" name="rest_code_e317e66b655743e7bf025201e502749d-7" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-7"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-8" name="rest_code_e317e66b655743e7bf025201e502749d-8" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-8"></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-9" name="rest_code_e317e66b655743e7bf025201e502749d-9" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-9"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-10" name="rest_code_e317e66b655743e7bf025201e502749d-10" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-10"></a>            <span class="c1"># the key must exist, otherwise it's</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-11" name="rest_code_e317e66b655743e7bf025201e502749d-11" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-11"></a>            <span class="c1"># not a valid SSA basic block:</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-12" name="rest_code_e317e66b655743e7bf025201e502749d-12" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-12"></a>            <span class="c1"># the variable must be defined before</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-13" name="rest_code_e317e66b655743e7bf025201e502749d-13" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-13"></a>            <span class="c1"># its first use</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-14" name="rest_code_e317e66b655743e7bf025201e502749d-14" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-14"></a>            <span class="k">return</span> <span class="n">varnames</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-15" name="rest_code_e317e66b655743e7bf025201e502749d-15" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-15"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-16" name="rest_code_e317e66b655743e7bf025201e502749d-16" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-16"></a>    <span class="n">varnames</span> <span class="o">=</span> <span class="p">{}</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-17" name="rest_code_e317e66b655743e7bf025201e502749d-17" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-17"></a>    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-18" name="rest_code_e317e66b655743e7bf025201e502749d-18" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-18"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bb</span><span class="p">):</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-19" name="rest_code_e317e66b655743e7bf025201e502749d-19" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-19"></a>        <span class="c1"># give the operation a name used while</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-20" name="rest_code_e317e66b655743e7bf025201e502749d-20" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-20"></a>        <span class="c1"># printing:</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-21" name="rest_code_e317e66b655743e7bf025201e502749d-21" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-21"></a>        <span class="n">var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">varprefix</span><span class="si">}{</span><span class="n">index</span><span class="si">}</span><span class="s2">"</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-22" name="rest_code_e317e66b655743e7bf025201e502749d-22" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-22"></a>        <span class="n">varnames</span><span class="p">[</span><span class="n">op</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-23" name="rest_code_e317e66b655743e7bf025201e502749d-23" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-23"></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-24" name="rest_code_e317e66b655743e7bf025201e502749d-24" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-24"></a>            <span class="n">arg_to_str</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-25" name="rest_code_e317e66b655743e7bf025201e502749d-25" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-25"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-26" name="rest_code_e317e66b655743e7bf025201e502749d-26" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-26"></a>        <span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-27" name="rest_code_e317e66b655743e7bf025201e502749d-27" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-27"></a>        <span class="n">strop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">arguments</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-28" name="rest_code_e317e66b655743e7bf025201e502749d-28" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-28"></a>        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strop</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-29" name="rest_code_e317e66b655743e7bf025201e502749d-29" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-29"></a>    <span class="k">return</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-30" name="rest_code_e317e66b655743e7bf025201e502749d-30" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-30"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-31" name="rest_code_e317e66b655743e7bf025201e502749d-31" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_basicblock_to_str</span><span class="p">():</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-32" name="rest_code_e317e66b655743e7bf025201e502749d-32" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-32"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-33" name="rest_code_e317e66b655743e7bf025201e502749d-33" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-33"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-34" name="rest_code_e317e66b655743e7bf025201e502749d-34" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-34"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-35" name="rest_code_e317e66b655743e7bf025201e502749d-35" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-35"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-36" name="rest_code_e317e66b655743e7bf025201e502749d-36" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-36"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-37" name="rest_code_e317e66b655743e7bf025201e502749d-37" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-37"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-38" name="rest_code_e317e66b655743e7bf025201e502749d-38" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-38"></a><span class="s2">var0 = getarg(0)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-39" name="rest_code_e317e66b655743e7bf025201e502749d-39" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-39"></a><span class="s2">var1 = add(5, 4)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-40" name="rest_code_e317e66b655743e7bf025201e502749d-40" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-40"></a><span class="s2">var2 = add(var1, var0)"""</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-41" name="rest_code_e317e66b655743e7bf025201e502749d-41" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-41"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-42" name="rest_code_e317e66b655743e7bf025201e502749d-42" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-42"></a>    <span class="c1"># with a different prefix for the invented</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-43" name="rest_code_e317e66b655743e7bf025201e502749d-43" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-43"></a>    <span class="c1"># variable names:</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-44" name="rest_code_e317e66b655743e7bf025201e502749d-44" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-44"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="s2">"x"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-45" name="rest_code_e317e66b655743e7bf025201e502749d-45" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-45"></a><span class="s2">x0 = getarg(0)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-46" name="rest_code_e317e66b655743e7bf025201e502749d-46" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-46"></a><span class="s2">x1 = add(5, 4)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-47" name="rest_code_e317e66b655743e7bf025201e502749d-47" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-47"></a><span class="s2">x2 = add(x1, x0)"""</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-48" name="rest_code_e317e66b655743e7bf025201e502749d-48" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-48"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-49" name="rest_code_e317e66b655743e7bf025201e502749d-49" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-49"></a>    <span class="c1"># and our running example:</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-50" name="rest_code_e317e66b655743e7bf025201e502749d-50" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-50"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-51" name="rest_code_e317e66b655743e7bf025201e502749d-51" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-51"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-52" name="rest_code_e317e66b655743e7bf025201e502749d-52" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-52"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-53" name="rest_code_e317e66b655743e7bf025201e502749d-53" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-53"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-54" name="rest_code_e317e66b655743e7bf025201e502749d-54" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-54"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-55" name="rest_code_e317e66b655743e7bf025201e502749d-55" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-55"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-56" name="rest_code_e317e66b655743e7bf025201e502749d-56" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-56"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-57" name="rest_code_e317e66b655743e7bf025201e502749d-57" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-57"></a>
<a id="rest_code_e317e66b655743e7bf025201e502749d-58" name="rest_code_e317e66b655743e7bf025201e502749d-58" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-58"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="s2">"v"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-59" name="rest_code_e317e66b655743e7bf025201e502749d-59" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-59"></a><span class="s2">v0 = getarg(0)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-60" name="rest_code_e317e66b655743e7bf025201e502749d-60" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-60"></a><span class="s2">v1 = getarg(1)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-61" name="rest_code_e317e66b655743e7bf025201e502749d-61" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-61"></a><span class="s2">v2 = add(v1, 17)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-62" name="rest_code_e317e66b655743e7bf025201e502749d-62" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-62"></a><span class="s2">v3 = mul(v0, v2)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-63" name="rest_code_e317e66b655743e7bf025201e502749d-63" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-63"></a><span class="s2">v4 = add(v1, 17)</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-64" name="rest_code_e317e66b655743e7bf025201e502749d-64" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-64"></a><span class="s2">v5 = add(v3, v4)"""</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-65" name="rest_code_e317e66b655743e7bf025201e502749d-65" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-65"></a>    <span class="c1"># Note the re-numbering of the variables! We</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-66" name="rest_code_e317e66b655743e7bf025201e502749d-66" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-66"></a>    <span class="c1"># don't attach names to Operations at all, so</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-67" name="rest_code_e317e66b655743e7bf025201e502749d-67" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-67"></a>    <span class="c1"># the printing will just number them in</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-68" name="rest_code_e317e66b655743e7bf025201e502749d-68" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-68"></a>    <span class="c1"># sequence, can sometimes be a source of</span>
<a id="rest_code_e317e66b655743e7bf025201e502749d-69" name="rest_code_e317e66b655743e7bf025201e502749d-69" href="../posts/2022/07/toy-optimizer.html#rest_code_e317e66b655743e7bf025201e502749d-69"></a>    <span class="c1"># confusion.</span>
</pre></div>
<p>This is much better. Now we're done with the basic infrastructure, we can
define sequences of operations and print them in a readable way. Next we need a
central data structure that is used when actually optimizing basic blocks.</p>
</section><section id="storing-equivalences-between-operations-using-a-union-find-data-structure"><h2>Storing Equivalences between Operations Using a Union-Find Data Structure</h2>
<p>When optimizing a sequence of operations, we want to make it less costly to
execute. For that we typically want to remove operations (and sometimes
replace operations with less expensive ones). We can remove operations if
they do redundant computation, like case of the duplicate <code class="docutils literal">add(v1, 17)</code> in
the example. So what we want to do is to turn the running input sequence:</p>
<pre class="literal-block">v0 = getarg(0)
v1 = getarg(1)
v2 = add(v1, 17)
v3 = mul(v0, v2)
v4 = add(v1, 17)
v5 = add(v3, v4)</pre>
<p>Into the following optimized output sequence:</p>
<pre class="literal-block">optvar0 = getarg(0)
optvar1 = getarg(1)
optvar2 = add(optvar1, 17)
optvar3 = mul(optvar0, optvar2)
optvar4 = add(optvar3, optvar2)</pre>
<p>We left out the second <code class="docutils literal">add</code> (which defines <code class="docutils literal">v4</code>), and then replaced the
usage of <code class="docutils literal">v4</code> with <code class="docutils literal">v2</code> in the final operation that defines <code class="docutils literal">v5</code>.</p>
<p>What we effectively did was discover that <code class="docutils literal">v2</code> and <code class="docutils literal">v4</code> are equivalent and then
replaced <code class="docutils literal">v4</code> with <code class="docutils literal">v2</code>. In general, we might discover more such equivalences,
and we need a data structure to store them. A good data structure to store
these equivalences is <a class="reference external" href="https://en.wikipedia.org/wiki/Disjoint-set_data_structure">Union Find</a> (also called Disjoint-set data structure),
which stores a collection of disjoint sets. Disjoint means, that no operation
can appear in more than one set. The sets in our concrete case are the sets of
operations that compute the same result.</p>
<p>When we start out, every operation is in its own singleton set, with no other
member. As we discover more equivalences, we will unify sets into larger sets
of operations that all compute the same result. So one operation the data
structure supports is <code class="docutils literal">union</code>, to unify two sets, we'll call that
<code class="docutils literal">make_equal_to</code> in the code below.</p>
<p>The other operation the data structure supports is <code class="docutils literal">find</code>, which takes an
operation and returns a "representative" of the set of all equivalent
operations. Two operations are in the same set, if the representative that
find returns for them is the same.</p>
<p>The exact details of how the data structure works are only sort of important
(even though it's very cool, I promise!). It's OK to skip over the
implementation. We will add the data structure right into our <code class="docutils literal">Value</code>,
<code class="docutils literal">Constant</code> and <code class="docutils literal">Operation</code> classes:</p>
<div class="code"><pre class="code python"><a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-1" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-1" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="p">:</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-2" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-2" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-3" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-3" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-3"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-4" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-4" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-5" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-5" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-5"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"abstract"</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-6" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-6" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-6"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-7" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-7" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-7"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-8" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-8" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Operation</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-9" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-9" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Value</span><span class="p">]):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-10" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-10" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-11" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-11" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-12" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-12" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-13" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-13" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-13"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-14" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-14" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-15" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-15" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-15"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-16" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-16" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-16"></a>            <span class="sa">f</span><span class="s2">"Operation(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,"</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-17" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-17" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-17"></a>            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-18" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-18" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-18"></a>        <span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-19" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-19" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-19"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-20" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-20" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Value</span><span class="p">:</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-21" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-21" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-21"></a>        <span class="c1"># returns the "representative" value of</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-22" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-22" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-22"></a>        <span class="c1"># self, in the union-find sense</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-23" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-23" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-23"></a>        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-24" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-24" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-24"></a>        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-25" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-25" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-25"></a>            <span class="c1"># could do path compression here too</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-26" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-26" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-26"></a>            <span class="c1"># but not essential</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-27" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-27" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-27"></a>            <span class="nb">next</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">forwarded</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-28" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-28" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-28"></a>            <span class="k">if</span> <span class="nb">next</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-29" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-29" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-29"></a>                <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-30" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-30" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-30"></a>            <span class="n">op</span> <span class="o">=</span> <span class="nb">next</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-31" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-31" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-31"></a>        <span class="k">return</span> <span class="n">op</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-32" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-32" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-32"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-33" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-33" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-34" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-34" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-34"></a>        <span class="c1"># change to above: return the</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-35" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-35" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-35"></a>        <span class="c1"># representative of argument 'index'</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-36" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-36" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-36"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-37" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-37" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-37"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-38" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-38" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_equal_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-39" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-39" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-39"></a>        <span class="c1"># this is "union" in the union-find sense,</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-40" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-40" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-40"></a>        <span class="c1"># but the direction is important! The</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-41" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-41" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-41"></a>        <span class="c1"># representative of the union of Operations</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-42" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-42" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-42"></a>        <span class="c1"># must be either a Constant or an operation</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-43" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-43" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-43"></a>        <span class="c1"># that we know for sure is not optimized</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-44" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-44" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-44"></a>        <span class="c1"># away.</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-45" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-45" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-45"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-46" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-46" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">_set_forwarded</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-47" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-47" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-47"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-48" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-48" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-49" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-49" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">forwarded</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-50" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-50" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-50"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-51" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-51" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-51"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-52" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-52" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-52"></a><span class="k">class</span><span class="w"> </span><span class="nc">Constant</span><span class="p">(</span><span class="n">Value</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-53" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-53" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-53"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-54" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-54" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-55" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-55" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-55"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-56" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-56" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-56"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-57" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-57" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-57"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Constant(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)"</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-58" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-58" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-58"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-59" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-59" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-60" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-60" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-60"></a>        <span class="k">return</span> <span class="bp">self</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-61" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-61" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-61"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-62" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-62" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_set_forwarded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Value</span><span class="p">):</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-63" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-63" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-63"></a>        <span class="c1"># if we found out that an Operation is</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-64" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-64" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-64"></a>        <span class="c1"># equal to a constant, it's a compiler bug</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-65" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-65" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-65"></a>        <span class="c1"># to find out that it's equal to another</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-66" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-66" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-66"></a>        <span class="c1"># constant</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-67" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-67" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-67"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-68" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-68" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-68"></a>            <span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-69" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-69" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-69"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-70" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-70" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-70"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_union_find</span><span class="p">():</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-71" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-71" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-71"></a>    <span class="c1"># construct three operation, and unify them</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-72" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-72" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-72"></a>    <span class="c1"># step by step</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-73" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-73" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-73"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-74" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-74" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-74"></a>    <span class="n">a1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-75" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-75" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-75"></a>    <span class="n">a2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-76" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-76" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-76"></a>    <span class="n">a3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">dummy</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-77" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-77" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-77"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-78" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-78" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-78"></a>    <span class="c1"># at the beginning, every op is its own</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-79" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-79" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-79"></a>    <span class="c1"># representative, that means every</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-80" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-80" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-80"></a>    <span class="c1"># operation is in a singleton set</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-81" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-81" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-81"></a>    <span class="c1"># {a1} {a2} {a3}</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-82" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-82" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-82"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-83" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-83" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-83"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a2</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-84" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-84" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-84"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a3</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-85" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-85" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-85"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-86" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-86" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-86"></a>    <span class="c1"># now we unify a2 and a1, then the sets are</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-87" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-87" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-87"></a>    <span class="c1"># {a1, a2} {a3}</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-88" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-88" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-88"></a>    <span class="n">a2</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-89" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-89" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-89"></a>    <span class="c1"># they both return a1 as the representative</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-90" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-90" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-90"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-91" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-91" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-91"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-92" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-92" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-92"></a>    <span class="c1"># a3 is still different</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-93" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-93" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-93"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a3</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-94" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-94" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-94"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-95" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-95" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-95"></a>    <span class="c1"># now they are all in the same set {a1, a2, a3}</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-96" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-96" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-96"></a>    <span class="n">a3</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-97" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-97" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-97"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-98" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-98" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-98"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-99" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-99" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-99"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">a1</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-100" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-100" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-100"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-101" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-101" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-101"></a>    <span class="c1"># now they are still all the same, and we</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-102" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-102" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-102"></a>    <span class="c1"># also learned that they are the same as the</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-103" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-103" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-103"></a>    <span class="c1"># constant 6</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-104" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-104" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-104"></a>    <span class="c1"># the single remaining set then is</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-105" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-105" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-105"></a>    <span class="c1"># {6, a1, a2, a3}</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-106" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-106" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-106"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-107" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-107" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-107"></a>    <span class="n">a2</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-108" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-108" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-108"></a>    <span class="k">assert</span> <span class="n">a1</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">c</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-109" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-109" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-109"></a>    <span class="k">assert</span> <span class="n">a2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">c</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-110" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-110" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-110"></a>    <span class="k">assert</span> <span class="n">a3</span><span class="o">.</span><span class="n">find</span><span class="p">()</span> <span class="ow">is</span> <span class="n">c</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-111" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-111" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-111"></a>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-112" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-112" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-112"></a>    <span class="c1"># union with the same constant again is fine</span>
<a id="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-113" name="rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-113" href="../posts/2022/07/toy-optimizer.html#rest_code_f1c3e0c3068e4841a9b8aab9a9d31469-113"></a>    <span class="n">a2</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</section><section id="constant-folding"><h2>Constant Folding</h2>
<p>Now comes the first actual optimization, a simple <a class="reference external" href="https://en.wikipedia.org/wiki/Constant_folding">constant folding</a> pass. It
will remove operations where all the arguments are constants and replace them
with the constant result.</p>
<p>Every pass has the same structure: we go over all operations in the basic
block in order and decide for each operation whether it can be removed. For the
constant folding pass, we can remove all the operations with constant
arguments (but we'll implement only the <code class="docutils literal">add</code> case here).</p>
<p>I will show a buggy version of the <a class="reference external" href="https://en.wikipedia.org/wiki/Constant_folding">constant folding</a> pass first. It has a
problem that is related to why we need the union-find data structure. We will
fix it a bit further down.</p>
<div class="code"><pre class="code python"><a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-1" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-1" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">constfold_buggy</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-2" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-2" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-3" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-3" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-3"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-4" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-4" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-4"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-5" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-5" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-5"></a>        <span class="c1"># basic idea: go over the list and do</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-6" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-6" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-6"></a>        <span class="c1"># constant folding of add where possible</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-7" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-7" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-8" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-8" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-8"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-9" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-9" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-9"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-10" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-10" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-10"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-11" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-11" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-11"></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-12" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-12" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-12"></a>                <span class="c1"># can constant-fold! that means we</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-13" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-13" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-13"></a>                <span class="c1"># learned a new equality, namely</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-14" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-14" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-14"></a>                <span class="c1"># that op is equal to a specific</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-15" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-15" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-15"></a>                <span class="c1"># constant</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-16" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-16" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-16"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-17" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-17" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-17"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-18" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-18" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-18"></a>                <span class="c1"># don't need to have the operation</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-19" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-19" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-19"></a>                <span class="c1"># in the optimized basic block</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-20" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-20" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-20"></a>                <span class="k">continue</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-21" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-21" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-21"></a>        <span class="c1"># otherwise the operation is not</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-22" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-22" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-22"></a>        <span class="c1"># constant-foldable and we put into the</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-23" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-23" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-23"></a>        <span class="c1"># output list</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-24" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-24" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-24"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-25" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-25" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-25"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-26" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-26" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-26"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-27" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-27" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-27"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-28" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-28" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_constfold_simple</span><span class="p">():</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-29" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-29" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-29"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-30" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-30" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-30"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-31" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-31" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-31"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-32" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-32" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-32"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-33" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-33" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-33"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-34" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-34" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-34"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">constfold_buggy</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-35" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-35" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-35"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-36" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-36" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-36"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-37" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-37" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-37"></a><span class="s2">optvar1 = add(9, optvar0)"""</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-38" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-38" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-38"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-39" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-39" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-39"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">xfail</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-40" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-40" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-40"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_constfold_buggy_limitation</span><span class="p">():</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-41" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-41" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-41"></a>    <span class="c1"># this test fails! it shows the problem with</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-42" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-42" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-42"></a>    <span class="c1"># the above simple constfold_buggy pass</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-43" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-43" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-43"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-44" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-44" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-44"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-45" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-45" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-45"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-46" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-46" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-46"></a>    <span class="c1"># this is folded</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-47" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-47" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-47"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-48" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-48" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-48"></a>    <span class="c1"># we want this folded too, but it doesn't work</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-49" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-49" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-49"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-50" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-50" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-50"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-51" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-51" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-51"></a>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-52" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-52" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-52"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">constfold_buggy</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-53" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-53" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-53"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-54" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-54" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-54"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_2546f0a514d443ba9137d9e6edb123f5-55" name="rest_code_2546f0a514d443ba9137d9e6edb123f5-55" href="../posts/2022/07/toy-optimizer.html#rest_code_2546f0a514d443ba9137d9e6edb123f5-55"></a><span class="s2">optvar1 = add(19, optvar0)"""</span>
</pre></div>
<p>Why does the test fail? The <code class="docutils literal">opt_bb</code> printed output looks like this:</p>
<pre class="literal-block">optvar0 = getarg(0)
optvar1 = add(9, 10)
optvar2 = add(optvar1, optvar0)</pre>
<p>The problem is that when we optimize the second addition in <cite>constfold_buggy</cite>,
the argument of that operation is an <em>Operation</em> not a <code class="docutils literal">Constant</code>, so
constant-folding is not applied to the second add. However, we have already
learned that the argument <code class="docutils literal">var1</code> to the operation <code class="docutils literal">var2</code> is equal to
<code class="docutils literal">Constant(9)</code>. This information is stored in the union-find data structure.
So what we are missing are suitable find calls in the constant folding pass, to
make use of the previously learned equalities.</p>
<p>Here's the fixed version:</p>
<div class="code"><pre class="code python"><a id="rest_code_032276e26def47b7b82a091a41d0db10-1" name="rest_code_032276e26def47b7b82a091a41d0db10-1" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">constfold</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-2" name="rest_code_032276e26def47b7b82a091a41d0db10-2" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-3" name="rest_code_032276e26def47b7b82a091a41d0db10-3" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-3"></a>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-4" name="rest_code_032276e26def47b7b82a091a41d0db10-4" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-4"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-5" name="rest_code_032276e26def47b7b82a091a41d0db10-5" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-5"></a>        <span class="c1"># basic idea: go over the list and do</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-6" name="rest_code_032276e26def47b7b82a091a41d0db10-6" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-6"></a>        <span class="c1"># constant folding of add where possible</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-7" name="rest_code_032276e26def47b7b82a091a41d0db10-7" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-7"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-8" name="rest_code_032276e26def47b7b82a091a41d0db10-8" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-8"></a>            <span class="c1"># &gt;&gt;&gt; changed</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-9" name="rest_code_032276e26def47b7b82a091a41d0db10-9" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-9"></a><span class="hll">            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># uses .find()</span>
</span><a id="rest_code_032276e26def47b7b82a091a41d0db10-10" name="rest_code_032276e26def47b7b82a091a41d0db10-10" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-10"></a><span class="hll">            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># uses .find()</span>
</span><a id="rest_code_032276e26def47b7b82a091a41d0db10-11" name="rest_code_032276e26def47b7b82a091a41d0db10-11" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-11"></a>            <span class="c1"># &lt;&lt;&lt; end changes</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-12" name="rest_code_032276e26def47b7b82a091a41d0db10-12" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-12"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_032276e26def47b7b82a091a41d0db10-13" name="rest_code_032276e26def47b7b82a091a41d0db10-13" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-13"></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-14" name="rest_code_032276e26def47b7b82a091a41d0db10-14" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-14"></a>                <span class="c1"># can constant-fold! that means we</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-15" name="rest_code_032276e26def47b7b82a091a41d0db10-15" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-15"></a>                <span class="c1"># learned a new equality, namely</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-16" name="rest_code_032276e26def47b7b82a091a41d0db10-16" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-16"></a>                <span class="c1"># that op is equal to a specific</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-17" name="rest_code_032276e26def47b7b82a091a41d0db10-17" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-17"></a>                <span class="c1"># constant</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-18" name="rest_code_032276e26def47b7b82a091a41d0db10-18" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-18"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-19" name="rest_code_032276e26def47b7b82a091a41d0db10-19" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-19"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-20" name="rest_code_032276e26def47b7b82a091a41d0db10-20" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-20"></a>                <span class="c1"># don't need to have the operation</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-21" name="rest_code_032276e26def47b7b82a091a41d0db10-21" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-21"></a>                <span class="c1"># in the optimized basic block</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-22" name="rest_code_032276e26def47b7b82a091a41d0db10-22" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-22"></a>                <span class="k">continue</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-23" name="rest_code_032276e26def47b7b82a091a41d0db10-23" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-23"></a>        <span class="c1"># otherwise the operation is not</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-24" name="rest_code_032276e26def47b7b82a091a41d0db10-24" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-24"></a>        <span class="c1"># constant-foldable and we put into the</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-25" name="rest_code_032276e26def47b7b82a091a41d0db10-25" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-25"></a>        <span class="c1"># output list</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-26" name="rest_code_032276e26def47b7b82a091a41d0db10-26" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-26"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-27" name="rest_code_032276e26def47b7b82a091a41d0db10-27" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-27"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-28" name="rest_code_032276e26def47b7b82a091a41d0db10-28" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-28"></a>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-29" name="rest_code_032276e26def47b7b82a091a41d0db10-29" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-29"></a>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-30" name="rest_code_032276e26def47b7b82a091a41d0db10-30" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_constfold_two_ops</span><span class="p">():</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-31" name="rest_code_032276e26def47b7b82a091a41d0db10-31" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-31"></a>    <span class="c1"># now it works!</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-32" name="rest_code_032276e26def47b7b82a091a41d0db10-32" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-32"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-33" name="rest_code_032276e26def47b7b82a091a41d0db10-33" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-33"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-34" name="rest_code_032276e26def47b7b82a091a41d0db10-34" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-34"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-35" name="rest_code_032276e26def47b7b82a091a41d0db10-35" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-35"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-36" name="rest_code_032276e26def47b7b82a091a41d0db10-36" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-36"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-37" name="rest_code_032276e26def47b7b82a091a41d0db10-37" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-37"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">constfold</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-38" name="rest_code_032276e26def47b7b82a091a41d0db10-38" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-38"></a>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-39" name="rest_code_032276e26def47b7b82a091a41d0db10-39" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-39"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-40" name="rest_code_032276e26def47b7b82a091a41d0db10-40" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-40"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_032276e26def47b7b82a091a41d0db10-41" name="rest_code_032276e26def47b7b82a091a41d0db10-41" href="../posts/2022/07/toy-optimizer.html#rest_code_032276e26def47b7b82a091a41d0db10-41"></a><span class="s2">optvar1 = add(19, optvar0)"""</span>
</pre></div>
</section><section id="common-subexpression-elimination"><h2>Common Subexpression Elimination</h2>
<p>The <code class="docutils literal">constfold</code> pass only discovers equalities between <code class="docutils literal">Operations</code> and
<code class="docutils literal">Constants</code>. Let's do a second pass that also discovers equalities between
<code class="docutils literal">Operations</code> and other <code class="docutils literal">Operations</code>.</p>
<p>A simple optimization that does that has this property <a class="reference external" href="https://en.wikipedia.org/wiki/Common_subexpression_elimination">common subexpression
elimination</a> (CSE), which will finally optimize away the problem in the
introductory example code that we had above.</p>
<div class="code"><pre class="code python"><a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-1" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-1" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">cse</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-2" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-2" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-2"></a>    <span class="c1"># structure is the same, loop over the input,</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-3" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-3" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-3"></a>    <span class="c1"># add some but not all operations to the</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-4" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-4" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-4"></a>    <span class="c1"># output</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-5" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-5" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-5"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-6" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-6" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-6"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-7" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-7" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-7"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-8" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-8" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-8"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-9" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-9" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-9"></a>        <span class="c1"># only do CSE for add here, but it</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-10" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-10" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-10"></a>        <span class="c1"># generalizes</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-11" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-11" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-11"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-12" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-12" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-12"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-13" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-13" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-13"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-14" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-14" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-14"></a>            <span class="c1"># Check whether we have emitted the</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-15" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-15" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-15"></a>            <span class="c1"># same operation already</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-16" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-16" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-16"></a>            <span class="n">prev_op</span> <span class="o">=</span> <span class="n">find_prev_add_op</span><span class="p">(</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-17" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-17" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-17"></a>                <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">opt_bb</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-18" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-18" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-18"></a>            <span class="k">if</span> <span class="n">prev_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-19" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-19" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-19"></a>                <span class="c1"># if yes, we can optimize op away</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-20" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-20" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-20"></a>                <span class="c1"># and replace it with the earlier</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-21" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-21" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-21"></a>                <span class="c1"># result, which is an Operation</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-22" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-22" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-22"></a>                <span class="c1"># that was already emitted to</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-23" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-23" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-23"></a>                <span class="c1"># opt_bb</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-24" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-24" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-24"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">prev_op</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-25" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-25" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-25"></a>                <span class="k">continue</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-26" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-26" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-26"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-27" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-27" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-27"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-28" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-28" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-28"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-29" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-29" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-29"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-30" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-30" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">eq_value</span><span class="p">(</span><span class="n">val0</span><span class="p">,</span> <span class="n">val1</span><span class="p">):</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-31" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-31" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-31"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-32" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-32" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-32"></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-33" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-33" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-33"></a>        <span class="c1"># constants compare by their value</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-34" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-34" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-34"></a>        <span class="k">return</span> <span class="n">val0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">val1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-35" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-35" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-35"></a>    <span class="c1"># everything else by identity</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-36" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-36" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-36"></a>    <span class="k">return</span> <span class="n">val0</span> <span class="ow">is</span> <span class="n">val1</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-37" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-37" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-37"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-38" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-38" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-38"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-39" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-39" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-39"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_prev_add_op</span><span class="p">(</span><span class="n">arg0</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span> <span class="n">arg1</span><span class="p">:</span> <span class="n">Value</span><span class="p">,</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-40" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-40" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-40"></a>        <span class="n">opt_bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Operation</span><span class="p">]:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-41" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-41" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-41"></a>    <span class="c1"># Really naive and quadratic implementation.</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-42" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-42" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-42"></a>    <span class="c1"># What we do is walk over the already emitted</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-43" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-43" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-43"></a>    <span class="c1"># operations and see whether we emitted an add</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-44" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-44" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-44"></a>    <span class="c1"># with the current arguments already. A real</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-45" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-45" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-45"></a>    <span class="c1"># implementation might use a hashmap of some</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-46" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-46" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-46"></a>    <span class="c1"># kind, or at least only look at a limited</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-47" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-47" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-47"></a>    <span class="c1"># window of instructions.</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-48" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-48" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-48"></a>    <span class="k">for</span> <span class="n">opt_op</span> <span class="ow">in</span> <span class="n">opt_bb</span><span class="p">:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-49" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-49" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-49"></a>        <span class="k">if</span> <span class="n">opt_op</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-50" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-50" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-50"></a>            <span class="k">continue</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-51" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-51" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-51"></a>        <span class="c1"># It's important to call arg here,</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-52" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-52" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-52"></a>        <span class="c1"># for the same reason why we</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-53" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-53" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-53"></a>        <span class="c1"># needed it in constfold: we need to</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-54" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-54" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-54"></a>        <span class="c1"># make sure .find() is called</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-55" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-55" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-55"></a>        <span class="k">if</span> <span class="n">eq_value</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">opt_op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> \
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-56" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-56" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-56"></a>                <span class="n">eq_value</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">opt_op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-57" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-57" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-57"></a>            <span class="k">return</span> <span class="n">opt_op</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-58" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-58" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-58"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-59" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-59" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-59"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-60" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-60" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-60"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-61" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-61" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-61"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_cse</span><span class="p">():</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-62" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-62" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-62"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-63" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-63" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-63"></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-64" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-64" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-64"></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-65" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-65" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-65"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-66" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-66" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-66"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-67" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-67" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-67"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-68" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-68" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-68"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-69" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-69" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-69"></a>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-70" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-70" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-70"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">cse</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-71" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-71" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-71"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-72" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-72" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-72"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-73" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-73" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-73"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-74" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-74" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-74"></a><span class="s2">optvar2 = add(optvar1, 17)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-75" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-75" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-75"></a><span class="s2">optvar3 = mul(optvar0, optvar2)</span>
<a id="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-76" name="rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-76" href="../posts/2022/07/toy-optimizer.html#rest_code_b3aaf6b0073c4fabaf9c05753c3f91f6-76"></a><span class="s2">optvar4 = add(optvar3, optvar2)"""</span>
</pre></div>
</section><section id="strength-reduction"><h2>Strength Reduction</h2>
<p>Now we have one pass that replaces <code class="docutils literal">Operations</code> with <code class="docutils literal">Constants</code> and one that
replaces <code class="docutils literal">Operations</code> with previously existing <code class="docutils literal">Operations</code>. Let's now do one
final pass that replaces <code class="docutils literal">Operations</code> by newly invented <code class="docutils literal">Operations</code>, a simple
<a class="reference external" href="https://en.wikipedia.org/wiki/Strength_reduction">strength reduction</a>. This one will be simple.</p>
<div class="code"><pre class="code python"><a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-1" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-1" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">strength_reduce</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-2" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-2" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-3" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-3" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-3"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-4" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-4" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-4"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-5" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-5" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-5"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-6" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-6" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-6"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-7" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-7" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-7"></a>            <span class="k">if</span> <span class="n">arg0</span> <span class="ow">is</span> <span class="n">arg1</span><span class="p">:</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-8" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-8" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-8"></a>                <span class="c1"># x + x turns into x &lt;&lt; 1</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-9" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-9" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-9"></a>                <span class="n">newop</span> <span class="o">=</span> <span class="n">opt_bb</span><span class="o">.</span><span class="n">lshift</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-10" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-10" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-10"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">newop</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-11" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-11" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-11"></a>                <span class="k">continue</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-12" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-12" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-12"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-13" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-13" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-13"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-14" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-14" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-14"></a>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-15" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-15" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_strength_reduce</span><span class="p">():</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-16" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-16" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-16"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-17" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-17" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-17"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-18" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-18" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-18"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-19" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-19" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-19"></a>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-20" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-20" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-20"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">strength_reduce</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-21" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-21" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-21"></a>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-22" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-22" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-22"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-23" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-23" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-23"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_91c6f32d99ef4276b8b4be03ca411e16-24" name="rest_code_91c6f32d99ef4276b8b4be03ca411e16-24" href="../posts/2022/07/toy-optimizer.html#rest_code_91c6f32d99ef4276b8b4be03ca411e16-24"></a><span class="s2">optvar1 = lshift(optvar0, 1)"""</span>
</pre></div>
</section><section id="putting-things-together"><h2>Putting Things Together</h2>
<p>Let's combine the passes into one single pass, so that we are going over all
the operations only exactly once, instead of having to look at every operation
once for all the different passes.</p>
<div class="code"><pre class="code python"><a id="rest_code_8e4bef69a11045179e40ca98b4d47562-1" name="rest_code_8e4bef69a11045179e40ca98b4d47562-1" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">:</span> <span class="n">Block</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Block</span><span class="p">:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-2" name="rest_code_8e4bef69a11045179e40ca98b4d47562-2" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-2"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-3" name="rest_code_8e4bef69a11045179e40ca98b4d47562-3" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-3"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-4" name="rest_code_8e4bef69a11045179e40ca98b4d47562-4" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-4"></a>    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">bb</span><span class="p">:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-5" name="rest_code_8e4bef69a11045179e40ca98b4d47562-5" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-5"></a>        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"add"</span><span class="p">:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-6" name="rest_code_8e4bef69a11045179e40ca98b4d47562-6" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-6"></a>            <span class="n">arg0</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-7" name="rest_code_8e4bef69a11045179e40ca98b4d47562-7" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-7"></a>            <span class="n">arg1</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-8" name="rest_code_8e4bef69a11045179e40ca98b4d47562-8" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-8"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-9" name="rest_code_8e4bef69a11045179e40ca98b4d47562-9" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-9"></a>            <span class="c1"># constant folding</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-10" name="rest_code_8e4bef69a11045179e40ca98b4d47562-10" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-10"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> \
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-11" name="rest_code_8e4bef69a11045179e40ca98b4d47562-11" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-11"></a>                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-12" name="rest_code_8e4bef69a11045179e40ca98b4d47562-12" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-12"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">arg1</span><span class="o">.</span><span class="n">value</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-13" name="rest_code_8e4bef69a11045179e40ca98b4d47562-13" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-13"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-14" name="rest_code_8e4bef69a11045179e40ca98b4d47562-14" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-14"></a>                <span class="k">continue</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-15" name="rest_code_8e4bef69a11045179e40ca98b4d47562-15" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-15"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-16" name="rest_code_8e4bef69a11045179e40ca98b4d47562-16" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-16"></a>            <span class="c1"># cse</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-17" name="rest_code_8e4bef69a11045179e40ca98b4d47562-17" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-17"></a>            <span class="n">prev_op</span> <span class="o">=</span> <span class="n">find_prev_add_op</span><span class="p">(</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-18" name="rest_code_8e4bef69a11045179e40ca98b4d47562-18" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-18"></a>                <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">opt_bb</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-19" name="rest_code_8e4bef69a11045179e40ca98b4d47562-19" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-19"></a>            <span class="k">if</span> <span class="n">prev_op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-20" name="rest_code_8e4bef69a11045179e40ca98b4d47562-20" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-20"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">prev_op</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-21" name="rest_code_8e4bef69a11045179e40ca98b4d47562-21" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-21"></a>                <span class="k">continue</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-22" name="rest_code_8e4bef69a11045179e40ca98b4d47562-22" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-22"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-23" name="rest_code_8e4bef69a11045179e40ca98b4d47562-23" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-23"></a>            <span class="c1"># strength reduce:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-24" name="rest_code_8e4bef69a11045179e40ca98b4d47562-24" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-24"></a>            <span class="c1"># x + x turns into x &lt;&lt; 1</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-25" name="rest_code_8e4bef69a11045179e40ca98b4d47562-25" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-25"></a>            <span class="k">if</span> <span class="n">arg0</span> <span class="ow">is</span> <span class="n">arg1</span><span class="p">:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-26" name="rest_code_8e4bef69a11045179e40ca98b4d47562-26" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-26"></a>                <span class="n">newop</span> <span class="o">=</span> <span class="n">opt_bb</span><span class="o">.</span><span class="n">lshift</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-27" name="rest_code_8e4bef69a11045179e40ca98b4d47562-27" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-27"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">newop</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-28" name="rest_code_8e4bef69a11045179e40ca98b4d47562-28" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-28"></a>                <span class="k">continue</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-29" name="rest_code_8e4bef69a11045179e40ca98b4d47562-29" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-29"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-30" name="rest_code_8e4bef69a11045179e40ca98b4d47562-30" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-30"></a>            <span class="c1"># and while we are at it, let's do some</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-31" name="rest_code_8e4bef69a11045179e40ca98b4d47562-31" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-31"></a>            <span class="c1"># arithmetic simplification:</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-32" name="rest_code_8e4bef69a11045179e40ca98b4d47562-32" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-32"></a>            <span class="c1"># a + 0 =&gt; a</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-33" name="rest_code_8e4bef69a11045179e40ca98b4d47562-33" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-33"></a>            <span class="k">if</span> <span class="n">eq_value</span><span class="p">(</span><span class="n">arg0</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-34" name="rest_code_8e4bef69a11045179e40ca98b4d47562-34" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-34"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-35" name="rest_code_8e4bef69a11045179e40ca98b4d47562-35" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-35"></a>                <span class="k">continue</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-36" name="rest_code_8e4bef69a11045179e40ca98b4d47562-36" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-36"></a>            <span class="k">if</span> <span class="n">eq_value</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-37" name="rest_code_8e4bef69a11045179e40ca98b4d47562-37" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-37"></a>                <span class="n">op</span><span class="o">.</span><span class="n">make_equal_to</span><span class="p">(</span><span class="n">arg0</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-38" name="rest_code_8e4bef69a11045179e40ca98b4d47562-38" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-38"></a>                <span class="k">continue</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-39" name="rest_code_8e4bef69a11045179e40ca98b4d47562-39" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-39"></a>        <span class="n">opt_bb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-40" name="rest_code_8e4bef69a11045179e40ca98b4d47562-40" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-40"></a>    <span class="k">return</span> <span class="n">opt_bb</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-41" name="rest_code_8e4bef69a11045179e40ca98b4d47562-41" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-41"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-42" name="rest_code_8e4bef69a11045179e40ca98b4d47562-42" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-42"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-43" name="rest_code_8e4bef69a11045179e40ca98b4d47562-43" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_single_pass</span><span class="p">():</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-44" name="rest_code_8e4bef69a11045179e40ca98b4d47562-44" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-44"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-45" name="rest_code_8e4bef69a11045179e40ca98b4d47562-45" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-45"></a>    <span class="c1"># constant folding</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-46" name="rest_code_8e4bef69a11045179e40ca98b4d47562-46" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-46"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-47" name="rest_code_8e4bef69a11045179e40ca98b4d47562-47" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-47"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-48" name="rest_code_8e4bef69a11045179e40ca98b4d47562-48" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-48"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-49" name="rest_code_8e4bef69a11045179e40ca98b4d47562-49" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-49"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-50" name="rest_code_8e4bef69a11045179e40ca98b4d47562-50" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-50"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-51" name="rest_code_8e4bef69a11045179e40ca98b4d47562-51" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-51"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-52" name="rest_code_8e4bef69a11045179e40ca98b4d47562-52" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-52"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-53" name="rest_code_8e4bef69a11045179e40ca98b4d47562-53" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-53"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-54" name="rest_code_8e4bef69a11045179e40ca98b4d47562-54" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-54"></a><span class="s2">optvar1 = add(19, optvar0)"""</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-55" name="rest_code_8e4bef69a11045179e40ca98b4d47562-55" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-55"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-56" name="rest_code_8e4bef69a11045179e40ca98b4d47562-56" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-56"></a>    <span class="c1"># cse + strength reduction</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-57" name="rest_code_8e4bef69a11045179e40ca98b4d47562-57" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-57"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-58" name="rest_code_8e4bef69a11045179e40ca98b4d47562-58" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-58"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-59" name="rest_code_8e4bef69a11045179e40ca98b4d47562-59" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-59"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-60" name="rest_code_8e4bef69a11045179e40ca98b4d47562-60" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-60"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-61" name="rest_code_8e4bef69a11045179e40ca98b4d47562-61" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-61"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span> <span class="c1"># the same as var3</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-62" name="rest_code_8e4bef69a11045179e40ca98b4d47562-62" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-62"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-63" name="rest_code_8e4bef69a11045179e40ca98b4d47562-63" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-63"></a>    <span class="n">var5</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># the same as var4</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-64" name="rest_code_8e4bef69a11045179e40ca98b4d47562-64" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-64"></a>    <span class="n">var6</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var4</span><span class="p">,</span> <span class="n">var5</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-65" name="rest_code_8e4bef69a11045179e40ca98b4d47562-65" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-65"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-66" name="rest_code_8e4bef69a11045179e40ca98b4d47562-66" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-66"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-67" name="rest_code_8e4bef69a11045179e40ca98b4d47562-67" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-67"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-68" name="rest_code_8e4bef69a11045179e40ca98b4d47562-68" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-68"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-69" name="rest_code_8e4bef69a11045179e40ca98b4d47562-69" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-69"></a><span class="s2">optvar1 = getarg(1)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-70" name="rest_code_8e4bef69a11045179e40ca98b4d47562-70" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-70"></a><span class="s2">optvar2 = add(optvar0, optvar1)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-71" name="rest_code_8e4bef69a11045179e40ca98b4d47562-71" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-71"></a><span class="s2">optvar3 = add(optvar2, 2)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-72" name="rest_code_8e4bef69a11045179e40ca98b4d47562-72" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-72"></a><span class="s2">optvar4 = lshift(optvar3, 1)"""</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-73" name="rest_code_8e4bef69a11045179e40ca98b4d47562-73" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-73"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-74" name="rest_code_8e4bef69a11045179e40ca98b4d47562-74" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-74"></a>    <span class="c1"># removing + 0</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-75" name="rest_code_8e4bef69a11045179e40ca98b4d47562-75" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-75"></a>    <span class="n">bb</span> <span class="o">=</span> <span class="n">Block</span><span class="p">()</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-76" name="rest_code_8e4bef69a11045179e40ca98b4d47562-76" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-76"></a>    <span class="n">var0</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">getarg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-77" name="rest_code_8e4bef69a11045179e40ca98b4d47562-77" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-77"></a>    <span class="n">var1</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-78" name="rest_code_8e4bef69a11045179e40ca98b4d47562-78" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-78"></a>    <span class="n">var2</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var0</span><span class="p">,</span> <span class="n">var1</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-79" name="rest_code_8e4bef69a11045179e40ca98b4d47562-79" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-79"></a>    <span class="n">var3</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-80" name="rest_code_8e4bef69a11045179e40ca98b4d47562-80" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-80"></a>    <span class="n">var4</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="n">var3</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-81" name="rest_code_8e4bef69a11045179e40ca98b4d47562-81" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-81"></a>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-82" name="rest_code_8e4bef69a11045179e40ca98b4d47562-82" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-82"></a>    <span class="n">opt_bb</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bb</span><span class="p">)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-83" name="rest_code_8e4bef69a11045179e40ca98b4d47562-83" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-83"></a>    <span class="k">assert</span> <span class="n">bb_to_str</span><span class="p">(</span><span class="n">opt_bb</span><span class="p">,</span> <span class="s2">"optvar"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"""</span><span class="se">\</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-84" name="rest_code_8e4bef69a11045179e40ca98b4d47562-84" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-84"></a><span class="s2">optvar0 = getarg(0)</span>
<a id="rest_code_8e4bef69a11045179e40ca98b4d47562-85" name="rest_code_8e4bef69a11045179e40ca98b4d47562-85" href="../posts/2022/07/toy-optimizer.html#rest_code_8e4bef69a11045179e40ca98b4d47562-85"></a><span class="s2">optvar1 = lshift(optvar0, 1)"""</span>
</pre></div>
</section><section id="conclusion"><h2>Conclusion</h2>
<p>That's it for now. Why is this architecture cool? From a software engineering
point of view, sticking everything into a single function like in <code class="docutils literal">optimize</code>
above is obviously not great, and if you wanted to do this for real you would
try to split the cases into different functions that are individually
digestible, or even use a DSL that makes the pattern matching much more
readable. But the advantage of the architecture is that it's quite efficient,
it makes it possible to pack a lot of good optimizations into a single pass
over a basic block.</p>
<p>Of course this works even better if you are in a tracing context, where
everything is put into a trace, which is basically one incredibly long basic
block. In a JIT context it's also quite important that the
optimizer itself runs quickly.</p>
<p>Various other optimizations are possible in this model. There is a
<a class="reference external" href="../posts/2022/10/toy-optimizer-allocation-removal.html">follow-up post</a> that show how to implement what is arguably PyPy's <a class="reference external" href="https://www.pypy.org/posts/2010/09/escape-analysis-in-pypys-jit-1780048403046080197.html">most
important optimization</a>.</p>
</section><section id="some-further-pointers"><h2>Some Further Pointers</h2>
<p>This post is only a short introduction and is taking some shortcuts, I wanted to
also give some (non-exhaustive) pointers to more general literature about the
touched topics.</p>
<p>The approach to CSE described here is usually can be seen as <a class="reference external" href="https://en.wikipedia.org/wiki/Value_numbering">value
numbering</a>, it's normally really implemented with a hashmap though. Here's a
<a class="reference external" href="https://www.cs.tufts.edu/~nr/cs257/archive/keith-cooper/value-numbering.pdf">paper</a> that describes various styles of implementing that, even beyond a
single basic block. The paper also partly takes the perspective of discovering
equivalence classes of operations that compute the same result.</p>
<p>A technique that leans even more fully into finding equivalences between
operations is using e-graphs and then applying <a class="reference external" href="https://en.wikipedia.org/wiki/E-graph#Equality_saturation">equality saturation</a> (this is
significantly more advanced that what I described here though). A cool modern
project that applies this technique is <a class="reference external" href="https://egraphs-good.github.io/">egg</a>.</p>
<p>If you squint a bit, you can generally view a constant folding pass as a very
simple form of <a class="reference external" href="https://en.wikipedia.org/wiki/Partial_evaluation">Partial Evaluation</a>: every operation that has constant
arguments is constant-folded away, and the remaining ones are "residualized",
i.e. put into the output program. This point of view is not super important for
the current post, but will become important in the next one.</p>
<p><strong>Acknowledgements:</strong> Thanks to <a class="reference external" href="https://thorstenball.com/">Thorsten Ball</a> for <a class="reference external" href="https://twitter.com/cfbolz/status/1547231548017106944">getting me</a> to write
this and for his enthusiastic feedback. I also got great feedback from <a class="reference external" href="https://bernsteinbear.com/">Max
Bernstein</a>, Matti Picus and Per Vognsen. A conversation with <a class="reference external" href="https://pengwu.substack.com/">Peng Wu</a> that
we had many many years ago and that stuck with me made me keep thinking about
various ways to view compiler optimizations.</p>
</section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/04/how-is-pypy-tested.html" class="u-url">How is PyPy Tested?</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/04/how-is-pypy-tested.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-04-02T15:00:00Z" itemprop="datePublished" title="2022-04-02 15:00">2022-04-02 15:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="how-is-pypy-tested"><h2>How is PyPy Tested?</h2>
<p>In this post I want to give an overview of how the PyPy project does and thinks
about testing. PyPy takes testing quite seriously and has done some from the
start of the project. Here I want to present the different styles of
tests that PyPy has, when we use them and how I think about them.</p>
<section id="background"><h3>Background</h3>
<p>To make the blog post self-contained, I am going to start with a small overview
about PyPy's architecture. If you already know what PyPy is and how it works,
you can skip this section.</p>
<p>PyPy means "Python in Python". It is an alternative implementation of the Python
language. Usually, when we speak of "Python", we can mean two different things.
On the one hand it means "Python as an abstract programming language". On the
other hand, the main implementation of that language is also often called
"Python". To more clearly distinguish the two, the implementation is often also
called "CPython", because it is an interpreter implemented in C code.</p>
<p>Now we can make the statement "PyPy is Python in Python" more precise: PyPy is
an interpreter for Python 3.9, implemented in RPython. RPython ("Restricted
Python") is a subset of Python 2, which is statically typed (using type
inference, not type annotations) and can be compiled
to C code. That means we can take our Python 3.9 interpreter, and compile it
into a C binary that can run Python 3.9 code. The final binary behaves pretty
similarly to CPython.</p>
<p>The main thing that makes PyPy interesting is that during the translation of our
interpreter to C, a number of components are automatically inserted into the
final binary. One component is a reasonably good garbage collector.</p>
<p>The more exciting component that is inserted into the binary is a just-in-time
compiler. The insertion of this component is not fully automatic, instead it is
guided by a small number of annotations in the source code of the interpreter.
The effect of inserting this JIT compiler into the binary is that the resulting
binary can run Python code significantly faster than CPython, in many cases.
How this works is not important for the rest of the post, if you want to see an
example of concretely doing that to a small interpreter you can look at this
<a class="reference external" href="https://www.youtube.com/watch?v=fZj3uljJl_k">video</a>.</p>
</section><section id="pypy-testing-history"><h3>PyPy Testing History</h3>
<p>A few historical notes on the PyPy project and its relationship to testing: The
PyPy project <a class="reference external" href="https://www.pypy.org/posts/2018/09/the-first-15-years-of-pypy-3412615975376972020.html">was started in 2004</a>. At the time when the project was started,
Extreme Programming and Agile Software Development were up and coming. On the
methodology side, PyPy was heavily influenced by these, and started using
Test-Driven Development and pair programming right from the start.</p>
<p>Also technologically, PyPy has been influential on testing in the Python world.
Originally, PyPy had used the <code class="docutils literal">unittest</code> testing framework, but pretty soon
the developers got frustrated with it. <a class="reference external" href="https://holgerkrekel.net/">Holger Krekel</a>, one of the original
developers who started PyPy, started the <a class="reference external" href="https://pytest.org/">pytest</a> testing framework soon
afterwards.</p>
</section><section id="interpreter-level-tests"><h3>Interpreter-Level Tests</h3>
<p>So, how are tests for PyPy written, concretely? The tests for the interpreter
are split into two different kinds, which we call "interpreter level tests" and
"application level tests". The former are tests that can be used to test the
objects and functions that are used in the implementation of the Python
interpreter. Since the interpreter is written in Python 2, those tests are also
written in Python 2, using pytest. They tend to be more on the unit test side of
things. They are in files with the pattern <code class="docutils literal"><span class="pre">test_*.py</span></code>.</p>
<p>Here is an example that tests the implementation of integers (very slightly
simplified):</p>
<div class="code"><pre class="code python"><a id="rest_code_a51fc73807284bac9d5456c12ab71cca-1" name="rest_code_a51fc73807284bac9d5456c12ab71cca-1" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestW_IntObject</span><span class="p">:</span>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-2" name="rest_code_a51fc73807284bac9d5456c12ab71cca-2" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-2"></a>    <span class="o">...</span>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-3" name="rest_code_a51fc73807284bac9d5456c12ab71cca-3" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-3"></a>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-4" name="rest_code_a51fc73807284bac9d5456c12ab71cca-4" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-5" name="rest_code_a51fc73807284bac9d5456c12ab71cca-5" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-5"></a>        <span class="n">w_x</span> <span class="o">=</span> <span class="n">W_IntObject</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-6" name="rest_code_a51fc73807284bac9d5456c12ab71cca-6" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-6"></a>        <span class="n">w_result</span> <span class="o">=</span> <span class="n">w_x</span><span class="o">.</span><span class="n">descr_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-7" name="rest_code_a51fc73807284bac9d5456c12ab71cca-7" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-7"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w_result</span><span class="p">,</span> <span class="n">W_IntObject</span><span class="p">)</span>
<a id="rest_code_a51fc73807284bac9d5456c12ab71cca-8" name="rest_code_a51fc73807284bac9d5456c12ab71cca-8" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_a51fc73807284bac9d5456c12ab71cca-8"></a>        <span class="k">assert</span> <span class="n">w_result</span><span class="o">.</span><span class="n">intval</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
<p>This test checks that if you take an object that represents integers in the
Python language (using the class <code class="docutils literal">W_IntObject</code>, a "wrapped integer object")
with the value 42, computing the hash of that object returns another instance of
the same class, also with the value 42.</p>
<p>These tests can be run on top of any Python 2 implementation, either CPython or
PyPy. We can then test and debug the internals of the PyPy interpreter using
familiar tools like indeed pytest and the Python debuggers. They can be run,
because all the involved code like the tests and the class <code class="docutils literal">W_IntObject</code> are
just completely regular Python 2 classes that behave in the regular way when
run on top of a Python interpreter.</p>
<p>In CPython, these tests don't really have an equivalent. They would correspond
to tests that are written in C and that can test the logic of all the C
functions of CPython that execute certain functionality, accessing the internals
of C structs in the process. <a class="reference internal" href="../posts/2022/04/how-is-pypy-tested.html#target-1">¹</a></p>
</section><section id="application-level-tests"><h3>Application-Level Tests</h3>
<p>There is also a second class of tests for the interpreter. Those are tests that
don't run on the level of the implementation. Instead, they are executed <em>by</em>
the PyPy Python interpreter, thus running on the level of the applications run
by PyPy. Since the interpreter is running Python 3, the tests are also written
in Python 3. They are stored in files with the pattern <code class="docutils literal"><span class="pre">apptest_*.py</span></code> and
look like "regular" Python 3 tests. <a class="reference internal" href="../posts/2022/04/how-is-pypy-tested.html#target-2">²</a></p>
<p>Here's an example of how you could write a test equivalent to the one above:</p>
<div class="code"><pre class="code python"><a id="rest_code_c5eb0031754945d38418e50140a51a13-1" name="rest_code_c5eb0031754945d38418e50140a51a13-1" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_c5eb0031754945d38418e50140a51a13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_hash</span><span class="p">():</span>
<a id="rest_code_c5eb0031754945d38418e50140a51a13-2" name="rest_code_c5eb0031754945d38418e50140a51a13-2" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_c5eb0031754945d38418e50140a51a13-2"></a>    <span class="k">assert</span> <span class="nb">hash</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
<p>This style of test looks more "natural" and is the preferred one in cases where
the test does not need to access the internals of the logic or the objects of
the interpreter.</p>
<p>Application level tests can be run in two different ways. On the one hand, we
can simply run them on CPython 3. This is very useful! Since we want PyPy to
behave like CPython, running the tests that we write on CPython is useful to
make sure that the tests themselves aren't wrong.</p>
<p>On the other hand, the main way to run these tests is on top of PyPy, itself
running on top of a Python 2 implementation. This makes it possible to run the
test without first bootstrapping PyPy to C. Since bootstrapping to C is a
relatively slow operation (can take up to an hour) it is crucially important to
be able to run tests without bootstrapping first. It also again makes it
possible to debug crashes in the interpreter using the regular Python 2
debugger. Of course running tests in this way is unfortunately itself not super
fast, given that they run on a stack of two different interpreters.</p>
<p>Application-level tests correspond quite closely to CPython's tests suite (which
is using the unittest framework). Of course in CPython it is not possible to run
the test suite without building the CPython binary using a C compiler. <a class="reference internal" href="../posts/2022/04/how-is-pypy-tested.html#target-3">³</a></p>
<p>So when do we write application-level tests, and when interpreter-level tests?
Interpreter-level tests are necessary to test internal data structures that
touch data and logic that is not directly exposed to the Python language. If
that is not necessary, we try to write application-level tests. App-level tests
are however by their nature always more on the integration test side of things.
To be able to run the <code class="docutils literal">test_hash</code> function above, many parts of PyPy need to
work correctly, the parser, the bytecode compiler, the bytecode interpreter, the
<code class="docutils literal">hash</code> builtin, calling the <code class="docutils literal">__hash__</code> special method, etc, etc.</p>
<p>This observation is also true for CPython! One could argue that CPython has no
unit tests at all, because in order to be able to even run the tests, most of
Python needs to be in working order already, so all the tests are really
implicitly integration tests.</p>
</section><section id="the-cpython-test-suite"><h3>The CPython Test Suite</h3>
<p>We also use the CPython Test suite as a final check to see whether our
interpreter correctly implements all the features of the Python language. In
that sense it acts as some kind of compliance test suite that checks whether we
implement the language correctly. The test suite is not perfect for this.
Since it is written for CPython's purposes during its development, a
lot of the tests check really specific CPython implementation details. Examples
for these are tests that check that <code class="docutils literal">__del__</code> is called immediately after
objects go out of scope (which only happens if you use reference counting as a
garbage collection strategy, PyPy uses a <a class="reference external" href="https://www.pypy.org/posts/2013/10/incremental-garbage-collector-in-pypy-8956893523842234676.html">different approach to garbage
collection</a>). Other examples are checking
for exception error messages very explicitly. However, the CPython test suite
has gotten a lot better in these regards over time, by adding
<code class="docutils literal">support.gc_collect()</code> calls to fix the former problem, and by marking some
very specific tests with the <code class="docutils literal">@impl_detail</code> decorator. Thanks to all the
CPython developers who have worked on this!</p>
<p>In the process of re-implementing CPython's functionality and running CPython's
tests suite, PyPy can often also be a good way to find bugs in CPython. While we
think about the corner cases of some Python feature we occasionally find
situations where CPython didn't get everything completely correct either, which
we then report back.</p>
</section><section id="testing-for-performance-regressions"><h3>Testing for Performance Regressions</h3>
<p>All the tests we described so far are checking <em>behaviour</em>. But one of PyPy's
important goals is to be a <em>fast</em> implementation not "just" a correct one. Some
aspects of performance can be tested by regular unit tests, either application-
or interpreter-level. In order to check whether some performance shortcut is
taken in the interpreter, we sometimes can write tests that monkeypatch the slow
default implementation to always error. Then, if the fast path is taken
properly, that slow default implementation is never reached.</p>
<p>But we also have additional tests that test the correct interaction with the JIT
explicitly. For that, we have a special style of test that checks that the JIT
will produce the correct machine code for a small snippet of Python code. To
make this kind of test somewhat more robust, we don't check the machine code
directly, but instead the architecture independent <a class="reference external" href="https://www.pypy.org/posts/2018/09/the-first-15-years-of-pypy-3412615975376972020.html">intermediate
representation</a> that the JIT uses to produce machine code from.</p>
<p>As an example, here is a small test that loading the attribute of a constant
global instance can be completely constant folded away:</p>
<div class="code"><pre class="code python"><a id="rest_code_abba7b413b5346b0a48d5c438a81da78-1" name="rest_code_abba7b413b5346b0a48d5c438a81da78-1" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_load_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-2" name="rest_code_abba7b413b5346b0a48d5c438a81da78-2" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-2"></a>    <span class="n">src</span> <span class="o">=</span> <span class="s1">'''</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-3" name="rest_code_abba7b413b5346b0a48d5c438a81da78-3" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-3"></a><span class="s1">        class A(object):</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-4" name="rest_code_abba7b413b5346b0a48d5c438a81da78-4" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-4"></a><span class="s1">            pass</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-5" name="rest_code_abba7b413b5346b0a48d5c438a81da78-5" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-5"></a><span class="s1">        a = A()</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-6" name="rest_code_abba7b413b5346b0a48d5c438a81da78-6" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-6"></a><span class="s1">        a.x = 1</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-7" name="rest_code_abba7b413b5346b0a48d5c438a81da78-7" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-7"></a><span class="s1">        def main(n):</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-8" name="rest_code_abba7b413b5346b0a48d5c438a81da78-8" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-8"></a><span class="s1">            i = 0</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-9" name="rest_code_abba7b413b5346b0a48d5c438a81da78-9" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-9"></a><span class="s1">            while i &lt; n:</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-10" name="rest_code_abba7b413b5346b0a48d5c438a81da78-10" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-10"></a><span class="s1">                i = i + a.x</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-11" name="rest_code_abba7b413b5346b0a48d5c438a81da78-11" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-11"></a><span class="s1">            return i</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-12" name="rest_code_abba7b413b5346b0a48d5c438a81da78-12" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-12"></a><span class="s1">    '''</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-13" name="rest_code_abba7b413b5346b0a48d5c438a81da78-13" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-13"></a>    <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="mi">1000</span><span class="p">])</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-14" name="rest_code_abba7b413b5346b0a48d5c438a81da78-14" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-14"></a>    <span class="k">assert</span> <span class="n">log</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1000</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-15" name="rest_code_abba7b413b5346b0a48d5c438a81da78-15" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-15"></a>    <span class="n">loop</span><span class="p">,</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loops_by_filename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-16" name="rest_code_abba7b413b5346b0a48d5c438a81da78-16" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-16"></a>    <span class="k">assert</span> <span class="n">loop</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">"""</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-17" name="rest_code_abba7b413b5346b0a48d5c438a81da78-17" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-17"></a><span class="s2">        i9 = int_lt(i5, i6)</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-18" name="rest_code_abba7b413b5346b0a48d5c438a81da78-18" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-18"></a><span class="s2">        guard_true(i9, descr=...)</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-19" name="rest_code_abba7b413b5346b0a48d5c438a81da78-19" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-19"></a><span class="s2">        guard_not_invalidated(descr=...)</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-20" name="rest_code_abba7b413b5346b0a48d5c438a81da78-20" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-20"></a><span class="s2">        i10 = int_add(i5, 1)</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-21" name="rest_code_abba7b413b5346b0a48d5c438a81da78-21" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-21"></a><span class="s2">        --TICK--</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-22" name="rest_code_abba7b413b5346b0a48d5c438a81da78-22" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-22"></a><span class="s2">        jump(..., descr=...)</span>
<a id="rest_code_abba7b413b5346b0a48d5c438a81da78-23" name="rest_code_abba7b413b5346b0a48d5c438a81da78-23" href="../posts/2022/04/how-is-pypy-tested.html#rest_code_abba7b413b5346b0a48d5c438a81da78-23"></a><span class="s2">    """</span><span class="p">)</span>
</pre></div>
<p>The string passed to the <code class="docutils literal">loop.match</code> function is a string representation of
the intermediate representation code that is generated for the <code class="docutils literal">while</code> loop in
the <code class="docutils literal">main</code> function given in the source. The important part of that
intermediate representation is that the <code class="docutils literal">i = i + a.x</code> addition is optimized
into an <code class="docutils literal">int_add(x, 1)</code> operation. The second argument for the addition is the
constant <code class="docutils literal">1</code>, because the JIT noted that the global <code class="docutils literal">a</code> is a constant, and
the attribute <code class="docutils literal">x</code> of that instance is always <code class="docutils literal">1</code>. The test thus checks that
this optimization still works.</p>
<p>Those tests are again more on the unit test side of things (and can thus
unfortunately be a bit brittle sometimes and break). The integration test
equivalent for performance is the <a class="reference external" href="https://speed.pypy.org/">PyPy Speed Center</a> which tracks the
performance of micro- and macro-benchmarks over time and lets us see when big
performance regressions are happening. The speed center is not really an
automatic test and does not produce pass/fail outcomes. Instead, it requires
human judgement and intervention in order to interpret the performance changes.
Having a real pass/fail mechanism is something that would be <a class="reference external" href="https://twitter.com/glyph/status/1495122754286198790">great to have</a>
but is probably <a class="reference external" href="https://arxiv.org/abs/1602.00602">quite tricky in practice</a>.</p>
</section><section id="conclusion"><h3>Conclusion</h3>
<p>This concludes my overview of some of the different styles of tests that we use
to develop the PyPy Python interpreter.</p>
<p>There is a whole other set of tests for the development of the RPython language,
the garbage collectors it provides as well as the code that does the automatic
JIT insertion, maybe I'll cover these in a future post.</p>
<section id="footnotes"><h4>Footnotes</h4>
<p id="target-1">¹ CPython has the <cite>_testcapimodule.c</cite> and related modules, that are used to
unit-test the C-API. However, these are still driven from Python tests using
the <code class="docutils literal">unittest</code> framework and wouldn't run without the Python interpreter
already working.</p>
<p id="target-2">² There is also a deprecated different way to write these tests, by putting
them in the <code class="docutils literal"><span class="pre">test_*.py</span></code> files that interpreter level tests are using and
then having a test class with the pattern <code class="docutils literal">class AppTest*</code>. We haven't
converted all of them to the new style yet, even though the old style is
quite weird: since the <code class="docutils literal"><span class="pre">test_*.py</span></code> files are themselves parsed by
Python 2, the tests methods in <code class="docutils literal">AppTest*</code> classes need to be written in the
subset of Python 3 syntax that is also valid Python 2 syntax, leading to a lot
of confusion.</p>
<p id="target-3">³ Nit-picky side-note: <a class="reference external" href="https://root.cern.ch/root/html534/guides/users-guide/CINT.html">C interpreters</a> <a class="reference external" href="https://www.youtube.com/watch?v=yyDD_KRdQQU">are a thing</a>! But not that
widely used in practice, or only in very specific situations.</p>
</section></section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/03/pypy-v738-release.html" class="u-url">PyPy v7.3.9 security release</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/03/pypy-v738-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-03-30T05:53:45Z" itemprop="datePublished" title="2022-03-30 05:53">2022-03-30 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-9-security-release"><h2>PyPy v7.3.9 security release</h2>
<p>The PyPy team is proud to release version 7.3.9 of PyPy. This is a security
release to match the recent <a class="reference external" href="https://discuss.python.org/t/py-day-is-coming-a-joint-security-release-spree-for-python-3-7-3-8-3-9-and-3-10-on-march-14th">CPython release</a> and updates the portable pypy
tarballs with <code class="docutils literal">bzip2 1.0.8</code>, <code class="docutils literal">openssl1.1.1n</code>, and <code class="docutils literal">libexpat 2.4.7</code>. Along
the way this release fixes some issues discovered after the 7.3.8 release and
updates <code class="docutils literal">sqlite3</code> to 3.38.2. It includes:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.7,  which is an interpreter supporting the syntax and the features of
Python 3.7, including the stdlib for CPython 3.7.13. This will be the last
release of PyPy3.7.</p></li>
<li><p>PyPy3.8, which is an interpreter supporting the syntax and the features of
Python 3.8, including the stdlib for CPython 3.8.13.</p></li>
<li><p>PyPy3.9, which is an interpreter supporting the syntax and the features of
Python 3.9, including the stdlib for CPython 3.9.12. We relate to this as
"beta" quality. We welcome testing of this version, if you discover
incompatibilities, please report them so we can gain confidence in the version.</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. Highlights of the release, since the release of 7.3.8 in February 2022,
include:</p>
<blockquote>
<ul class="simple">
<li><p>Fixed some failing stdlib tests on PyPy3.9</p></li>
<li><p>Update the bundled libexpat to 2.4.6 and sqlite3 to 3.38.2</p></li>
</ul>
</blockquote>
<p>We recommend updating. You can find links to download the v7.3.9 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://doc.pypy.org/">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython's JIT even better. Since the
7.3.7 release, we have accepted contributions from 6 new contributors,
thanks for pitching in, and welcome to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://hpyproject.org/">HPy</a> / <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant
on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, 3.8 and
3.9. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux. A shoutout to Huawei for sponsoring
the VM running the tests.</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
<li><p>big- and little-endian variants of <strong>PPC64</strong> running Linux,</p></li>
</ul>
</blockquote>
<p>PyPy support Windows 32-bit, PPC64 big- and little-endian, and ARM 32 bit, but
does not release binaries. Please reach out to us if you wish to sponsor
releases for those platforms.</p>
</section><section id="known-issues-with-pypy3-9"><h3>Known Issues with PyPy3.9</h3>
<ul class="simple">
<li><p>We slightly modified the concurrent future's <code class="docutils literal">ProcessExcecutorPool</code> to
start all the worker processes when the first task is received (like on
Python3.8) to avoid an apparent race condition when using <code class="docutils literal">fork</code> and
threads (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3650">3650</a>).</p></li>
</ul></section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.9 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.9.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make PyPy better.</p>
<p>Cheers,
The PyPy team</p>
</section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/02/pypy-v738-release.html" class="u-url">PyPy v7.3.8: release of python 2.7, 3.7, 3.8, and 3.9</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/02/pypy-v738-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-02-20T05:53:45Z" itemprop="datePublished" title="2022-02-20 05:53">2022-02-20 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-8-release-of-python-2-7-3-7-3-8-and-3-9-beta"><h2>PyPy v7.3.8: release of python 2.7, 3.7, 3.8, and 3.9-beta</h2>
<p>The PyPy team is proud to release version 7.3.8 of PyPy. It has been only a few
months since our last release, but we have some nice speedups and bugfixes we
wish to share. The release includes four different interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.7,  which is an interpreter supporting the syntax and the features of
Python 3.7, including the stdlib for CPython 3.7.12. This will be the last
release of PyPy3.7.</p></li>
<li><p>PyPy3.8, which is an interpreter supporting the syntax and the features of
Python 3.8, including the stdlib for CPython 3.8.12. This is our third
release of this interpreter, and we are removing the "beta" tag.</p></li>
<li><p>PyPy3.9, which is an interpreter supporting the syntax and the features of
Python 3.9, including the stdlib for CPython 3.9.10. As this is our first
release of this interpreter, we relate to this as "beta" quality. We
welcome testing of this version, if you discover incompatibilities, please
report them so we can gain confidence in the version.</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. Highlights of the release, since the release of 7.3.7 in late October 2021,
include:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy3.9 uses an RPython version of the PEG parser which brought with it a
cleanup of the lexer and parser in general</p></li>
<li><p>Fixed a regression in PyPy3.8 when JITting empty list comprehensions</p></li>
<li><p>Tweaked some issues around changing the file layout after packaging to make
the on-disk layout of PyPy3.8 more compatible with CPython. This requires
<code class="docutils literal"><span class="pre">setuptools&gt;=58.1.0</span></code></p></li>
<li><p>RPython now allows the target executable to have a <code class="docutils literal">.</code> in its name, so
PyPy3.9 will produce a <code class="docutils literal"><span class="pre">pypy3.9-c</span></code> and <code class="docutils literal"><span class="pre">libpypy3.9-c.so</span></code>. Changing the
name of the shared object to be version-specific (it used to be
<code class="docutils literal"><span class="pre">libpypy3-c.so</span></code>) will allow it to live alongside other versions.</p></li>
<li><p>Building PyPy3.9+ accepts a <code class="docutils literal"><span class="pre">--platlibdir</span></code> argument like CPython.</p></li>
<li><p>Improvement in ssl's use of CFFI buffers to speed up <code class="docutils literal">recv</code> and <code class="docutils literal">recvinto</code></p></li>
<li><p>Update the packaged OpenSSL to 1.1.1m</p></li>
</ul>
</blockquote>
<p>We recommend updating. You can find links to download the v7.3.8 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://doc.pypy.org/">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython's JIT even better. Since the
previous release, we have accepted contributions from 6 new contributors,
thanks for pitching in, and welcome to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://hpyproject.org/">HPy</a> / <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant
on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, 3.8 and
3.9. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux. A shoutout to Huawei for sponsoring
the VM running the tests.</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
<li><p>big- and little-endian variants of <strong>PPC64</strong> running Linux,</p></li>
</ul>
</blockquote>
<p>PyPy support Windows 32-bit, PPC64 big- and little-endian, and ARM 32 bit, but
does not release binaries. Please reach out to us if you wish to sponsor
releases for those platforms.</p>
</section><section id="known-issues-with-pypy3-9"><h3>Known Issues with PyPy3.9</h3>
<ul class="simple">
<li><p>There is still a known <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3649">speed regression</a> around <code class="docutils literal">**kwargs</code> handling</p></li>
<li><p>We slightly modified the concurrent future's <code class="docutils literal">ProcessExcecutorPool</code> to
start all the worker processes when the first task is received (like on
Python3.8) to avoid an apparent race condition when using <code class="docutils literal">fork</code> and
threads (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3650">3650</a>).</p></li>
</ul></section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.8 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.8.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make PyPy better.</p>
<p>Cheers,
The PyPy team</p>
</section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2022/02/nlp-icelandic-case-study.html" class="u-url">Natural Language Processing for Icelandic with PyPy: A Case Study</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/vilhjalmur-thorsteinsson.html">Vilhjálmur Þorsteinsson</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2022/02/nlp-icelandic-case-study.html" rel="bookmark">
            <time class="published dt-published" datetime="2022-02-06T15:00:00Z" itemprop="datePublished" title="2022-02-06 15:00">2022-02-06 15:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="natural-language-processing-for-icelandic-with-pypy-a-case-study"><h2>Natural Language Processing for Icelandic with PyPy: A Case Study</h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Icelandic_language">Icelandic</a> is one
of the smallest languages of the world, with about 370.000 speakers. It
is a language in the Germanic family, most similar to Norwegian, Danish
and Swedish, but closer to the original <a class="reference external" href="https://en.wikipedia.org/wiki/Old_Norse">Old
Norse</a> spoken throughout
Scandinavia until about the 14th century CE.</p>
<p>As with other small languages, there are <a class="reference external" href="https://www.theguardian.com/world/2018/feb/26/icelandic-language-battles-threat-of-digital-extinction">worries that the language may
not
survive</a>
in a digital world, where all kinds of fancy applications are developed
first - and perhaps only - for the major languages. Voice assistants,
chatbots, spelling and grammar checking utilities, machine translation,
etc., are increasingly becoming staples of our personal and professional
lives, but if they don’t exist for Icelandic, Icelanders will gravitate
towards English or other languages where such tools are readily
available.</p>
<p>Iceland is a technology-savvy country, with <a class="reference external" href="https://ourworldindata.org/grapher/share-of-individuals-using-the-internet?tab=table">world-leading adoption
rates of the
Internet</a>,
PCs and smart devices, and a thriving software industry. So the
government figured that it would be worthwhile to fund a <a class="reference external" href="https://aclanthology.org/2020.lrec-1.418.pdf">5-year
plan</a> to build natural
language processing (NLP) resources and other infrastructure for the
Icelandic language. The project focuses on collecting data and
developing open source software for a range of core applications, such
as tokenization, vocabulary lookup, n-gram statistics, part-of-speech
tagging, named entity recognition, spelling and grammar checking, neural
language models and speech processing.</p>
<hr class="docutils">
<p>My name is Vilhjálmur Þorsteinsson, and I’m the founder and CEO of a
software startup <a class="reference external" href="https://mideind.is/english.html">Miðeind</a> in Reykjavík,
Iceland, that employs 10 software engineers and linguists and focuses on
NLP and AI for the Icelandic language. The company participates in the
government’s language technology program, and has contributed
significantly to the program’s core tools (e.g., a tokenizer and a
parser), spelling and grammar checking modules, and a neural machine
translation stack.</p>
<p>When it came to a choice of programming languages and development tools
for the government program, the requirements were for a major, well
supported, vendor-and-OS-agnostic FOSS platform with a large and diverse
community, including in the NLP space. The decision to select Python as
a foundational language for the project was a relatively easy one. That
said, there was a bit of trepidation around the well known fact that
CPython can be slow for inner-core tasks, such as tokenization and
parsing, that can see heavy workloads in production.</p>
<p>I first became aware of PyPy in early 2016 when I was developing a
crossword game <a class="reference external" href="https://github.com/mideind/Netskrafl">Netskrafl</a> in Python 2.7
for Google App Engine. I had a utility program that compressed a
dictionary into a Directed Acyclic Word Graph and was taking 160
seconds  to run on CPython 2.7, so I tried PyPy and to my amazement saw
a 4x speedup (down to 38 seconds), with literally no effort besides
downloading the PyPy runtime.</p>
<p>This led me to select PyPy as the default Python interpreter for my
company’s Python development efforts as well as for our production
websites and API servers, a role in which it remains to this day. We
have followed PyPy’s upgrades along the way, being just about to migrate
our minimally required language version from 3.6 to 3.7.</p>
<p>In NLP, speed and memory requirements can be quite important for
software usability. On the other hand, NLP logic and algorithms are
often complex and challenging to program, so programmer productivity and
code clarity are also critical success factors. A pragmatic approach
balances these factors, avoids premature optimization and seeks a
careful compromise between maximal run-time efficiency and minimal
programming and maintenance effort.</p>
<p>Turning to our use cases, our Icelandic text
tokenizer <a class="reference external" href="https://github.com/mideind/Tokenizer">"Tokenizer"</a> is fairly light,
runs tight loops and performs a large number of small, repetitive
operations. It runs very well on PyPy’s JIT and has not required further
optimization.</p>
<p>Our Icelandic parser <a class="reference external" href="https://github.com/mideind/GreynirPackage">Greynir</a>
(known on PyPI as <a class="reference external" href="https://pypi.org/project/reynir/">reynir</a>) is,
if I may say so myself, a piece of work. It <a class="reference external" href="https://aclanthology.org/R19-1160.pdf">parses natural language
text</a> according to a
<a class="reference external" href="https://github.com/mideind/GreynirPackage/blob/master/src/reynir/Greynir.grammar">hand-written context-free
grammar</a>,
using an <a class="reference external" href="https://en.wikipedia.org/wiki/Earley_parser">Earley-type
algorithm</a> as <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0167642309000951">enhanced
by Scott and
Johnstone</a>.
The CFG contains almost 7,000 nonterminals and 6,000 terminals, and the
parser handles ambiguity as well as left, right and middle recursion. It
returns a packed parse forest for each input sentence, which is then
pruned by a scoring heuristic down to a single best result tree.</p>
<p>This parser was originally coded in pure Python and turned out to be
unusably slow when run on CPython - but usable on PyPy, where it was
3-4x faster. However, when we started applying it to heavier production
workloads, it  became apparent that it needed to be faster still. We
then proceeded to convert the innermost Earley parsing loop from Python
to <a class="reference external" href="https://github.com/mideind/GreynirPackage/blob/master/src/reynir/eparser.cpp">tight
C++</a>
and to call it from PyPy via
<a class="reference external" href="https://cffi.readthedocs.io/en/latest/">CFFI</a>, with callbacks for
token-terminal matching functions (“business logic”) that remained on
the Python side. This made the parser much faster (on the order of 100x
faster than the original on CPython) and quick enough for our production
use cases. Even after moving much of the heavy processing to C++ and using CFFI, PyPy still gives a significant speed boost over CPython.</p>
<p>Connecting C++ code with PyPy proved to be quite painless using CFFI,
although we had to figure out a few <a class="reference external" href="https://github.com/mideind/GreynirPackage/blob/master/src/reynir/eparser_build.py">magic incantations in our build
module</a>
to make it compile smoothly during setup from source on Windows and
MacOS in addition to Linux. Of course, we build binary PyPy and CPython
wheels for the most common targets so most users don’t have to worry
about setup requirements.</p>
<p>With the positive experience from the parser project, we proceeded to
take a similar approach for two other core NLP packages: our compressed
vocabulary package <a class="reference external" href="https://github.com/mideind/BinPackage">BinPackage</a>
(known on PyPI as <a class="reference external" href="https://pypi.org/project/islenska/">islenska</a>) and our
trigrams database package <a class="reference external" href="https://github.com/mideind/Icegrams">Icegrams</a>.
These packages both take large text input (3.1 million word forms with
inflection data in the vocabulary case; 100 million tokens in the
trigrams case) and compress it into packed binary structures. These
structures are then memory-mapped at run-time using
<a class="reference external" href="https://docs.python.org/3/library/mmap.html">mmap</a> and queried via
Python functions with a lookup time in the microseconds range. The
low-level data structure navigation is <a class="reference external" href="https://github.com/mideind/Icegrams/blob/master/src/icegrams/trie.cpp">done in
C++</a>,
called from Python via CFFI. The ex-ante preparation, packing,
bit-fiddling and data structure generation is fast enough with PyPy, so
we haven’t seen a need to optimize that part further.</p>
<p>To showcase our tools, we host public (and open source) websites such as
<a class="reference external" href="https://greynir.is/">greynir.is</a> for our parsing, named entity
recognition and query stack and
<a class="reference external" href="https://yfirlestur.is/">yfirlestur.is</a> for our spell and grammar
checking stack. The server code on these sites is all Python running on
PyPy using <a class="reference external" href="https://flask.palletsprojects.com/en/2.0.x/">Flask</a>,
wrapped in <a class="reference external" href="https://gunicorn.org/">gunicorn</a> and hosted on
<a class="reference external" href="https://www.nginx.com/">nginx</a>. The underlying database is
<a class="reference external" href="https://www.postgresql.org/">PostgreSQL</a> accessed via
<a class="reference external" href="https://www.sqlalchemy.org/">SQLAlchemy</a> and
<a class="reference external" href="https://pypi.org/project/psycopg2cffi/">psycopg2cffi</a>. This setup
has served us well for 6 years and counting, being fast, reliable and
having helpful and supporting communities.</p>
<p>As can be inferred from the above, we are avid fans of PyPy and
commensurately thankful for the great work by the PyPy team over the
years. PyPy has enabled us to use Python for a larger part of our
toolset than CPython alone would have supported, and its smooth
integration with C/C++ through CFFI has helped us attain a better
tradeoff between performance and programmer productivity in our
projects. We wish for PyPy a great and bright future and also look
forward to exciting related developments on the horizon, such as
<a class="reference external" href="https://hpyproject.org/">HPy</a>.</p>
</section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/12/error-message-style-guides.html" class="u-url">Error Message Style Guides of Various Languages</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/12/error-message-style-guides.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-12-05T14:00:00Z" itemprop="datePublished" title="2021-12-05 14:00">2021-12-05 14:00</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="error-message-style-guides-of-various-languages"><h2>Error Message Style Guides of Various Languages</h2>
<p>PyPy has been trying to produce good <a class="reference external" href="https://www.pypy.org/posts/2018/04/improving-syntaxerror-in-pypy-5733639208090522433.html">SyntaxErrors</a> and <a class="reference external" href="https://twitter.com/cfbolz/status/783313503230844929/photo/1">other</a> <a class="reference external" href="https://twitter.com/pypyproject/status/999930324481081344">errors</a> for
a long time. CPython has also made an enormous push to <a class="reference external" href="https://docs.python.org/3/whatsnew/3.10.html#better-error-messages">improve its
SyntaxErrors in the last few releases</a>. These improvements are great, but the process
feels somewhat arbitrary sometimes. To see what other languages are doing, I
<a class="reference external" href="https://twitter.com/cfbolz/status/1466033151315173384">asked people on Twitter</a> whether they know of error message style guides for
other programming languages.</p>
<p>Wonderfully, people answered me with lots of helpful links (<a class="reference internal" href="../posts/2021/12/error-message-style-guides.html#full-list">full list</a> at the
end of the post), thank you everybody! All those sources are very interesting
and contain many great points, I recommend reading them directly! In this
post, I'll try to summarize some common themes or topics that I thought were
particularly interesting.</p>
<section id="language-use"><h3>Language Use</h3>
<p>Almost all guides stress the need for plain and simple English, as well as
conciseness and clarity [Flix, Racket, Rust, Flow]. Flow suggests to put coding
effort into making the grammar correct, for example in the case of plurals or
to distinguish between "a" and "an".</p>
<p>The suggested tone should be friendly and neutral, the messages should not
blame the Programmer [Flow]. Rust and Flix suggest to not use the term
'illegal' and use something like 'invalid' instead.</p>
<p>Flow suggests to avoid "compiler speak". For example terms like 'token' and
'identifier' should be avoided and terms that are more familiar to programmers
be used (eg "name" is better). The Racket guide goes further and has a list of
allowed technical terms and some prohibited terms.</p>
</section><section id="structure"><h3>Structure</h3>
<p>Several guides (such as Flix and Flow) point out a 80/20 rule: 80% of the times an error message is
read, the developer knows that message well and knows exactly what to do. For
this use case it's important that the message is short. On the other hand, 20%
of the times this same message will have to be understood by a developer who
has never seen it before and is confused, and so the message needs to contain
enough information
to allow them to find out what is going on. So the error message needs to strike
a balance between brevity and clarity.</p>
<p>The Racket guide proposes to use the following general structure for errors:
'State the constraint that was violated ("expected a"), followed by what was
found instead.'</p>
<p>The Rust guides says to avoid "Did you mean?" and questions in general, and
wants the compiler to instead be explicit about why something was suggested. The
example the Rust guide gives is: 'Compare "did you mean: Foo" vs. "there is a
struct with a similar name: Foo".' Racket goes further and forbids
suggestions altogether because "Students will follow well‐meaning‐but‐wrong
advice uncritically, if only because they have no reason to doubt the
authoritative voice of the tool."</p>
</section><section id="formatting-and-source-positions"><h3>Formatting and Source Positions</h3>
<p>The Rust guide suggests to put all identifiers into backticks (like in
Markdown), Flow formats the error messages using full Markdown.</p>
<p>The Clang, Flow and Rust guides point out the importance of using precise
source code spans to point to errors, which is especially important if the
compiler information is used in the context of an IDE to show a red squiggly
underline or some other highlighting. The spans should be as small as possible to point out the source of
the error [Flow].</p>
</section><section id="conclusion"><h3>Conclusion</h3>
<p>I am quite impressed how advanced and well-thought out the approaches are. I wonder whether it would makes sense for
Python to adopt a (probably minimal, to get started) subset of these ideas as guidelines for its own errors.</p>
</section><section id="sources"><span id="full-list"></span><h3>Sources</h3>
<ul class="simple">
<li><p>Rust: <a class="reference external" href="https://rustc-dev-guide.rust-lang.org/diagnostics.html">https://rustc-dev-guide.rust-lang.org/diagnostics.html</a></p></li>
<li><p>Clang: <a class="reference external" href="https://clang.llvm.org/diagnostics.html">https://clang.llvm.org/diagnostics.html</a></p></li>
<li><p>Flix: <a class="reference external" href="https://flix.dev/principles/">https://flix.dev/principles/</a></p></li>
<li><p>Racket: <a class="reference external" href="https://cs.brown.edu/~kfisler/Misc/error-msg-guidelines-racket-studlangs.pdf">https://cs.brown.edu/~kfisler/Misc/error-msg-guidelines-racket-studlangs.pdf</a></p></li>
<li><p>More about the research that lead to the Racket guidelines (including the referenced papers): <a class="reference external" href="https://twitter.com/ShriramKMurthi/status/1451688982761381892">https://twitter.com/ShriramKMurthi/status/1451688982761381892</a></p></li>
<li><p>Flow: <a class="reference external" href="https://calebmer.com/2019/07/01/writing-good-compiler-error-messages.html">https://calebmer.com/2019/07/01/writing-good-compiler-error-messages.html</a></p></li>
<li><p>Elm: <a class="reference external" href="https://elm-lang.org/news/compiler-errors-for-humans">https://elm-lang.org/news/compiler-errors-for-humans</a></p></li>
<li><p>Elm's error message catalog: <a class="reference external" href="https://github.com/elm/error-message-catalog">https://github.com/elm/error-message-catalog</a></p></li>
<li><p>Reason: <a class="reference external" href="https://reasonml.github.io/blog/2017/08/25/way-nicer-error-messages.html">https://reasonml.github.io/blog/2017/08/25/way-nicer-error-messages.html</a></p></li>
</ul></section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/10/pypy-v737-release.html" class="u-url">PyPy v7.3.7: bugfix release of python 3.7 and 3.8</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/10/pypy-v737-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-10-25T05:53:45Z" itemprop="datePublished" title="2021-10-25 05:53">2021-10-25 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-7-bug-fix-release-of-3-7-3-8"><h2>PyPy v7.3.7: bug-fix release of 3.7, 3.8</h2>
<p>We are releasing a PyPy 7.3.7 to fix the recent 7.3.6 release's binary
incompatibility with the previous 7.3.x releases. We mistakenly added fields
to <code class="docutils literal">PyFrameObject</code> and <code class="docutils literal">PyDateTime_CAPI</code> that broke the promise of binary
compatibility, which means that c-extension wheels compiled for 7.3.5 will not
work with 7.3.6 and via-versa. Please do not use 7.3.6.</p>
<p>We have added a cursory test for binary API breakage to the
<a class="reference external" href="https://github.com/pypy/binary-testing">https://github.com/pypy/binary-testing</a> repo which hopefully will prevent such
mistakes in the future.</p>
<p>Additionally, a few smaller bugs were fixed:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal">uint</code> for the <code class="docutils literal">request</code> argument of <code class="docutils literal">fcntl.ioctl</code> (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3568">3568</a>)</p></li>
<li><p>Fix incorrect tracing of <cite>while True`</cite> body in 3.8 (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3577">3577</a>)</p></li>
<li><p>Properly close resources when using a <code class="docutils literal">concurrent.futures.ProcessPool</code>
(issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3317">3317</a>)</p></li>
<li><p>Fix the value of <code class="docutils literal">LIBDIR</code> in <code class="docutils literal">_sysconfigdata</code> in 3.8 (issue <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/issues/3582">3582</a>)</p></li>
</ul>
<p>You can find links to download the v7.3.7 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog site</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://doc.pypy.org/">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython's JIT even better.</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, and
3.8. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux.</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
</ul>
</blockquote>
<p>PyPy does support ARM 32 bit and PPC64 processors, but does not release binaries.</p>
</section></section>
</div>
    </article><article class="h-entry post-rest" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/10/pypy-v736-release.html" class="u-url">PyPy v7.3.6: release of python 2.7, 3.7, and 3.8</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/the-pypy-team.html">The PyPy Team</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/10/pypy-v736-release.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-10-17T05:53:45Z" itemprop="datePublished" title="2021-10-17 05:53">2021-10-17 05:53</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <section id="pypy-v7-3-6-release-of-python-2-7-3-7-and-3-8-beta"><h2>PyPy v7.3.6: release of python 2.7, 3.7, and 3.8-beta</h2>
<p>The PyPy team is proud to release version 7.3.6 of PyPy, which includes
three different interpreters:</p>
<blockquote>
<ul class="simple">
<li><p>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.18+ (the <code class="docutils literal">+</code> is for
backported security updates)</p></li>
<li><p>PyPy3.7,  which is an interpreter supporting the syntax and the features of
Python 3.7, including the stdlib for CPython 3.7.12.</p></li>
<li><p>PyPy3.8, which is an interpreter supporting the syntax and the features of
Python 3.8, including the stdlib for CPython 3.8.12. Since this is our
first release of the interpreter, we relate to this as "beta" quality. We
welcome testing of this version, if you discover incompatibilites, please
report them so we can gain confidence in the version.</p></li>
</ul>
</blockquote>
<p>The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, all APIs are compatible with the other 7.3
releases. Highlights of the release, since the release of 7.3.5 in May 2021,
include:</p>
<blockquote>
<ul class="simple">
<li><p>We have merged a backend for <a class="reference external" href="https://hpyproject.org/">HPy</a>, the better C-API interface. The backend
implements HPy version 0.0.3.</p></li>
<li><p>Translation of PyPy into a binary, known to be slow, is now about 40%
faster. On a modern machine, PyPy3.8 can translate in about 20 minutes.</p></li>
<li><p>PyPy Windows 64 is now available on <a class="reference external" href="https://conda-forge.org/blog//2020/03/10/pypy">conda-forge</a>, along with nearly 700
commonly used binary packages. This new offering joins the more than 1000
conda packages for PyPy on Linux and macOS. Many thanks to the conda-forge
maintainers for pushing this forward over the past 18 months.</p></li>
<li><p>Speed improvements were made to <code class="docutils literal">io</code>, <code class="docutils literal">sum</code>, <code class="docutils literal">_ssl</code> and more. These
were done in response to user feedback.</p></li>
<li><p>The 3.8 version of the release contains a beta-quality improvement to the
JIT to better support <a class="reference external" href="https://www.pypy.org/posts/2021/09/jit-auto-generated-code.html">compiling huge Python functions</a> by breaking them
up into smaller pieces.</p></li>
<li><p>The release of Python3.8 required a concerted effort. We were greatly
helped by @isidentical (Batuhan Taskaya) and other new contributors.</p></li>
<li><p>The 3.8 package now uses the same layout as CPython, and many of the
PyPy-specific changes to <code class="docutils literal">sysconfig</code>, <code class="docutils literal">distutils.sysconfig</code>, and
<code class="docutils literal">distutils.commands.install.py</code> have been removed. The <code class="docutils literal">stdlib</code> now
is located in <code class="docutils literal"><span class="pre">&lt;base&gt;/lib/pypy3.8</span></code> on <code class="docutils literal">posix</code> systems, and in
<code class="docutils literal"><span class="pre">&lt;base&gt;/Lib</span></code> on Windows. The include files on windows remain the same.
On <code class="docutils literal">posix</code> they are in <code class="docutils literal"><span class="pre">&lt;base&gt;/include/pypy3.8</span></code>. Note we still use the
<code class="docutils literal">pypy</code> prefix to prevent mixing the files with CPython (which uses
<code class="docutils literal">python</code>.</p></li>
</ul>
</blockquote>
<p>We recommend updating. You can find links to download the v7.3.6 releases here:</p>
<blockquote>
<p><a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a></p>
</blockquote>
<p>We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work. If PyPy is helping you out, we would love to hear about
it and encourage submissions to our <a class="reference external" href="https://pypy.org/blog">blog</a> via a pull request
to <a class="reference external" href="https://github.com/pypy/pypy.org">https://github.com/pypy/pypy.org</a></p>
<p>We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://pypy.org">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython's JIT even better. Since the
previous release, we have accepted contributions from 7 new contributors,
thanks for pitching in, and welcome to the project!</p>
<p>If you are a python library maintainer and use C-extensions, please consider
making a <a class="reference external" href="https://cffi.readthedocs.io">CFFI</a> / <a class="reference external" href="https://cppyy.readthedocs.io">cppyy</a> version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy.</p>
<section id="what-is-pypy"><h3>What is PyPy?</h3>
<p>PyPy is a Python interpreter, a drop-in replacement for CPython 2.7, 3.7, and
soon 3.8. It's fast (<a class="reference external" href="https://speed.pypy.org">PyPy and CPython 3.7.4</a> performance
comparison) due to its integrated tracing JIT compiler.</p>
<p>We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.</p>
<p>This PyPy release supports:</p>
<blockquote>
<ul class="simple">
<li><p><strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 64 bits, OpenBSD, FreeBSD)</p></li>
<li><p>big- and little-endian variants of <strong>PPC64</strong> running Linux,</p></li>
<li><p><strong>s390x</strong> running Linux</p></li>
<li><p>64-bit <strong>ARM</strong> machines running Linux.</p></li>
</ul>
</blockquote>
<p>PyPy does support Windows 32-bit and ARM 32 bit processors, but does not
release binaries. Please reach out to us if you wish to sponsor releases for
those platforms.</p>
</section><section id="what-else-is-new"><h3>What else is new?</h3>
<p>For more information about the 7.3.6 release, see the <a class="reference external" href="https://doc.pypy.org/en/latest/release-v7.3.6.html#changelog">full changelog</a>.</p>
<p>Please update, and continue to help us make PyPy better.</p>
<p>Cheers,
The PyPy team</p>
</section></section>
</div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2021/09/jit-auto-generated-code.html" class="u-url">Better JIT Support for Auto-Generated Python Code</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2021/09/jit-auto-generated-code.html" rel="bookmark">
            <time class="published dt-published" datetime="2021-09-17T19:55:09Z" itemprop="datePublished" title="2021-09-17 19:55">2021-09-17 19:55</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <h2 id="performance-cliffs">Performance Cliffs</h2>
<p>A common bad property of many different JIT compilers is that of a "performance
cliff": A seemingly reasonable code change, leading to massively reduced
performance due to hitting some weird property of the JIT compiler that's not
easy to understand for the programmer (e.g. here's a blog post about the fix of
a performance cliff when running <a href="https://v8.dev/blog/react-cliff">React on
V8</a>). Hitting a performance cliff as a
programmer can be intensely frustrating and turn people off from using PyPy
altogether. Recently we've been working on trying to remove some of PyPy's
performance cliffs, and this post describes one such effort.</p>
<p>The problem showed up in an <a href="https://foss.heptapod.net/pypy/pypy/-/issues/3402">issue</a>
where somebody found the performance
of their website using <a href="https://www.tornadoweb.org/en/stable/">Tornado</a> a lot
worse than what various benchmarks suggested. It took some careful digging to
figure out what caused the problem: The slow performance was caused by the huge
functions that the Tornado templating engine creates. These functions lead the
JIT to behave in unproductive ways. In this blog post I'll describe why the
problem occurs and how we fixed it.</p>
<h2 id="problem">Problem</h2>
<p>After quite a bit of debugging we narrowed down the problem to the following
reproducer: If you render a big HTML template
(<a href="https://gist.github.com/cfbolz/4a346d104fee41affc860a7b928b7291#file-index-html">example</a>)
using the Tornado templating engine, the template rendering is really not any
faster than CPython. A small template doesn't show this behavior, and other
parts of Tornado seem to perform well. So we looked into how the templating
engine works, and it turns out that the templates are compiled into Python
functions. This means that a big template can turn into a really enormous Python
function (<a href="https://gist.github.com/cfbolz/4a346d104fee41affc860a7b928b7291#file-zz_autogenerated-py">Python version of the
example</a>).
For some reason really enormous Python functions aren't handled particularly
well by the JIT, and in the next section I'll explain some the background that's
necessary to understand why this happens.</p>
<h2 id="trace-limits-and-inlining">Trace Limits and Inlining</h2>
<p>To understand why the problem occurs, it's necessary to understand how PyPy's
trace limit and inlining works. The tracing JIT has a maximum trace length built
in, the reason for that is some limitation in the compact encoding of traces in
the JIT. Another reason is that we don't want to generate arbitrary large chunks
of machine code. Usually, when we hit the trace limit, it is due to <em>inlining</em>.
While tracing, the JIT will inline many of the functions called from the
outermost one. This is usually good and improves performance greatly, however,
inlining can also lead to the trace being too long. If that happens, we
will mark a called function as uninlinable. The next time we trace the outer
function we won't inline it, leading to a shorter trace, which hopefully fits
the trace limit.</p>
<p><img alt="Diagram illustrating the interaction of the trace limit and inlining" src="../images/2021-open-ended-traces-01-inlining.svg"></p>
<p>In the diagram above we trace a function <code>f</code>, which calls a function <code>g</code>, which
is inlined into the trace. The trace ends up being too long, so the JIT
disables inlining of <code>g</code>. The next time we try to trace <code>f</code> the trace will
contain a <em>call</em> to <code>g</code> instead of inlining it. The trace ends up being not too
long, so we can turn it into machine code when tracing finishes.</p>
<p>Now we know enough to understand what the problem with automatically generated
code is: sometimes, the outermost function itself
doesn't fit the trace limit, without any inlining going on at all. This is
usually not the case for normal, hand-written Python functions. However, it can
happen for automatically generated Python code, such as the code that the
Tornado templating engine produces.</p>
<p>So, what happens when the JIT hits such a huge function? The function is traced
until the trace is too long. Then the trace limits stops further tracing. Since
nothing was inlined, we cannot make the trace shorter the next time by disabling
inlining. Therefore, this happens again and again, the next time we trace the
function we run into exactly the same problem. The net effect is that the
function is even slowed down: we spend time tracing it, then stop tracing and
throw the trace away. Therefore, that effort is never useful, so the resulting
execution can be slower than not using the JIT at all!</p>
<h2 id="solution">Solution</h2>
<p>To get out of the endless cycle of useless retracing we first had the idea of
simply disabling all code generation for such huge functions, that produce too long
traces even if there is no inlining at all. However, that lead to disappointing
performance in the example Tornado program, because important parts of the code
remain always interpreted.</p>
<p>Instead, our solution is now as follows: After we have hit the trace limit and
no inlining has happened so far, we mark the outermost function as a source of huge
traces. The next time we trace such a function, we do so in a special mode. In
that mode, hitting the trace limit behaves differently: Instead of stopping the
tracer and throwing away the trace produced so far, we will use the unfinished
trace to produce machine code. This trace corresponds to the first part of the
function, but stops at a basically arbitrary point in the middle of the
function.</p>
<p>The question is what should happen when execution
reaches the end of this unfinished trace. We want to be able to cover more of
the function with machine code and therefore need to extend the trace
from that point on. But we don't want to do that too
eagerly to prevent lots and lots of machine code being generated. To achieve
this behaviour we add a guard to the end of the unfinished trace, which will
always fail. This has the right behaviour: a failing guard will transfer control
to the interpreter, but if it fails often enough, we can patch it to jump to
more machine code, that starts from this position. In that way, we can slowly
explore the full gigantic function and add all those parts of the control flow
graph that are actually commonly executed at runtime.</p>
<p><img alt="Diagram showing what happens in the new jit when tracing a huge function" src="../images/2021-open-ended-traces-02-no-inlining.svg"></p>
<p>In the diagram we are trying to trace a huge function <code>f</code>, which leads to
hitting the trace limit. However, nothing was inlined into the trace, so
disabling inlining won't ensure a successful trace attempt the next time.
Instead, we mark <code>f</code> as "huge". This has the effect that when we trace it again
and are about to hit the trace limit, we end the trace at an arbitrary point by
inserting a guard that always fails.</p>
<p><img alt="Diagram showing what happens in the new jit when tracing a huge function until completion" src="../images/2021-open-ended-traces-03-complete.svg"></p>
<p>If this guard failure is executed often enough, we might patch the guard and
add a jump to a further part of the function <code>f</code>. This can continue potentially
several times, until the trace really hits and end points (for example by
closing the loop and jumping back to trace 1, or by returning from <code>f</code>).</p>
<h2 id="evaluation">Evaluation</h2>
<p>Since this is a performance cliff that we didn't observe in any of our
<a href="http://speed.pypy.org/">benchmarks</a> ourselves, it's pointless to look at the
effect that this improvement has on existing benchmarks – there shouldn't and
indeed there isn't any.</p>
<p>Instead, we are going to look at a micro-benchmark that came out of the
original bug report, one that simply renders a big artificial Tornado template
200 times. The code of the micro-benchmark can be found
<a href="https://gist.github.com/cfbolz/4a346d104fee41affc860a7b928b7291">here</a>.</p>
<p>All benchmarks were run 10 times in new processes. The means and standard
deviations of the benchmark runs are:</p>
<table>
<thead><tr>
<th>Implementation</th>
<th style="text-align: right;">Time taken (lower is better)</th>
</tr></thead>
<tbody>
<tr>
<td>CPython 3.9.5</td>
<td style="text-align: right;">14.19 ± 0.35s</td>
</tr>
<tr>
<td>PyPy3 without JIT</td>
<td style="text-align: right;">59.48 ± 5.41s</td>
</tr>
<tr>
<td>PyPy3 JIT old</td>
<td style="text-align: right;">14.47 ± 0.35s</td>
</tr>
<tr>
<td>PyPy3 JIT new</td>
<td style="text-align: right;">4.89 ± 0.10s</td>
</tr>
</tbody>
</table>
<p>What we can see is that while the old JIT is very helpful for this
micro-benchmark, it only brings the performance up to CPython levels, not
providing any extra benefit. The new JIT gives an almost 3x speedup.</p>
<p>Another interesting number we can look at is how often the JIT started a trace,
and for how many traces we produced actual machine code:</p>
<table>
<thead><tr>
<th>Implementation</th>
<th style="text-align: right;">Traces Started</th>
<th style="text-align: right;">Traces sent to backend</th>
<th style="text-align: right;">Time spent in JIT</th>
</tr></thead>
<tbody>
<tr>
<td>PyPy3 JIT old</td>
<td style="text-align: right;">216</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0.65s</td>
</tr>
<tr>
<td>PyPy3 JIT new</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">0.06s</td>
</tr>
</tbody>
</table>
<p>Here we can clearly see the problem: The old JIT would try tracing the
auto-generated templating code again and again, but would never actually produce
any machine code, wasting lots of time in the process. The new JIT still traces a
few times uselessly, but then eventually converges and stops emitting machine
code for all the paths through the auto-generated Python code.</p>
<!--
1: /home/cfbolz/projects/small-commits-pypy/pypy/goal/pypy-c-38-jit-chunked-traces -jit off render.py
            Mean        Std.Dev.    Min         Median      Max
real        59.479      5.411       51.864      59.966      67.721      
user        59.395      5.383       51.821      59.859      67.585      
sys         0.058       0.034       0.020       0.056       0.108

1: pypy3 render.py
            Mean        Std.Dev.    Min         Median      Max
real        14.469      0.352       13.744      14.472      15.174      
user        14.399      0.359       13.671      14.402      15.126      
sys         0.050       0.034       0.024       0.042       0.148

Tracing:        216 0.653033
Backend:        24  0.003664
TOTAL:              14.854610
ops:                2217432
heapcached ops:     701575
recorded ops:       643513
  calls:            60038
guards:             330245
opt ops:            1876
opt guards:         465
opt guards shared:  237
forcings:           0
abort: trace too long:  191
abort: compiling:   0
abort: vable escape:    0
abort: bad loop:    0
abort: force quasi-immut:   1
nvirtuals:          391
nvholes:            122
nvreused:           141
vecopt tried:       0
vecopt success:     0
Total # of loops:   17
Total # of bridges: 8
Freed # of loops:   5
Freed # of bridges: 5


1: /home/cfbolz/projects/small-commits-pypy/pypy/goal/pypy-c-38-jit-chunked-traces render.py
            Mean        Std.Dev.    Min         Median      Max
real        4.892       0.098       4.718       4.882       5.118       
user        4.807       0.097       4.644       4.797       5.022       
sys         0.067       0.019       0.040       0.070       0.096


Tracing:        30  0.060128
Backend:        25  0.033536
TOTAL:              4.551791
ops:                124584
heapcached ops:     53962
recorded ops:       33486
  calls:            4389
guards:             14061
opt ops:            18922
opt guards:         4281
opt guards shared:  2248
forcings:           0
abort: trace too long:  4
abort: compiling:   0
abort: vable escape:    0
abort: bad loop:    0
abort: force quasi-immut:   1
abort: segmenting trace:    5
nvirtuals:          314
nvholes:            90
nvreused:           114
vecopt tried:       0
vecopt success:     0
Total # of loops:   14
Total # of bridges: 12
Freed # of loops:   0
Freed # of bridges: 0

-->

<h2 id="related-work">Related Work</h2>
<p><a href="https://www.timfelgentreff.de/">Tim Felgentreff</a> pointed me to the fact that
Truffle also has a
<a href="https://www.graalvm.org/truffle/javadoc/com/oracle/truffle/api/nodes/BlockNode.html">mechanism</a>
to slice huge methods into smaller compilation units (and I am sure other JITs
have such mechanisms as well).</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post we've described a performance cliff in PyPy's JIT, that of really
big auto-generated functions which hit the trace limit without inlining, that we
still want to generate machine code for. We achieve this by chunking up the
trace into several smaller traces, which we compile piece by piece. This is not
a super common thing to be happening – otherwise we would have run into and
fixed it earlier – but it's still good to have a fix now.</p>
<p>The work
described in this post tiny bit experimental still, but we will release it as
part of the upcoming 3.8 beta release, to get some more experience with it.
Please grab a <a href="https://mail.python.org/pipermail/pypy-dev/2021-September/016214.html">3.8 release
candidate</a>,
try it out and let us know your observations, good and bad!</p>
    </div>
    </article>
</div>
</div>
<div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/12/toy-load-store.html" class="listtitle">Load and store forwarding in the Toy Optimizer</a>
      </li>
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (6)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div></div>
</main>
</div>
<div style="clear: both; width: 75%; margin: 1em auto;">
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-43.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-41.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
         
                 <footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2026 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2026-01-17T00:22
  </div>
  <div style="margin-left: auto">
  <a href="../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../assets/js/styles.js"></script></footer>
</body>
</html>