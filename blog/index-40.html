<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A Faster Python">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PyPy (old posts, page 40) | PyPy</title>
<link href="../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.pypy.org/blog/index-40.html">
<link rel="icon" href="../favicon2.ico" sizes="16x16">
<link rel="icon" href="../favicon32x32.ico" sizes="32x32">
<link rel="prev" href="index-41.html" type="text/html">
<link rel="next" href="index-39.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../assets/css/tipuesearch.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../index.html">
                    <image id="toplogo" src="../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../compat.html">Compatibility</a> </li>  
                    <li> <a href="../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href=".">Index</a> </li>  
                    <li> <a href="../categories/">Tags</a> </li>  
                    <li> <a href="../archive.html">Archive by year</a> </li>  
                    <li> <a href="../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><div class="post">
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2020/08/a-new-chapter-for-pypy-8388322709667328389.html" class="u-url">A new chapter for PyPy</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/hodgestar.html">hodgestar</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2020/08/a-new-chapter-for-pypy-8388322709667328389.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-08-12T19:00:00Z" itemprop="datePublished" title="2020-08-12 19:00">2020-08-12 19:00</time></a>
            </p>
                <p class="commentline">5 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p><i>PyPy winds down its membership in the Software Freedom Conservancy</i></p>

<h1>Conservancy and PyPy's great work together</h1>

<p><a href="https://pypy.org/">PyPy</a> joined <a href="https://sfconservancy.org/">Conservancy</a> in
the <a href="https://sfconservancy.org/blog/2011/jan/02/oct-dec-2010/">second half of 2010</a>, shortly after the release of
PyPy 1.2, the first version to contain a fully functional JIT. <a href="https://lwn.net/Articles/550427/">In 2013</a>, PyPy
started supporting ARM, bringing its just-in-time speediness to many more devices and began working toward supporting NumPy to help
scientists crunch their numbers faster. Together, PyPy and Conservancy ran successful fundraising drives and facilitated payment
and oversight for <a href="https://sfconservancy.org/blog/2016/dec/01/pypy-2016/">contractors and code sprints</a>.</p>

<p>Conservancy supported PyPy's impressive growth as it expanded support for
different hardware platforms, greatly improved the performance of C extensions,
and added support for Python 3 as the language itself evolved.</p>

<h1>The road ahead</h1>
  
<p>Conservancy provides a fiscal and organizational home for projects that find the
freedoms and guardrails that come along with a charitable home advantageous for
their community goals. While this framework was a great fit for the early PyPy
community, times change and all good things must come to an end.</p>

<p>PyPy will remain a free and open source project, but the community's structure
and organizational underpinnings will be changing and the PyPy community will be
exploring options outside of the charitable realm for its next phase of growth
("charitable" in the legal sense -- PyPy will remain a community project).</p>

<p>During the last year PyPy and Conservancy have worked together to properly
utilise the generous donations made by stalwart PyPy enthusiats over the years
and to wrap up PyPy's remaining charitable obligations. PyPy is grateful for
the Conservancy's help in shepherding the project toward its next chapter.</p>

<h1>Thank yous</h1>
<p>From Conservancy: <br></p>
<p style="text-align: left;"></p>
<blockquote>"We are happy that Conservancy was able to help PyPy bring important software
for the public good during a critical time in its history. We wish the
community well and look forward to seeing it develop and succeed in new ways." <br>
</blockquote>
<blockquote>— Karen Sandler, Conservancy's Executive Director</blockquote>
<p></p>
<p>From PyPy:</p>
<p></p>
<div style="text-align: left;"><div style="text-align: left;">
<blockquote><p>"PyPy would like to thank Conservancy for their decade long support in
building the community and wishes Conservancy continued success in their
journey promoting, improving, developing and defending free and open source
sofware." <br></p></blockquote>
<blockquote><p style="text-align: left;">— Simon Cross &amp; Carl Friedrich Bolz-Tereick, on behalf of PyPy.</p></blockquote>
</div></div>
<p></p>
<blockquote>
</blockquote>

<h1>About</h1>

<p><a class="reference external" href="https://pypy.org/">PyPy</a> is a multi-layer python interpreter with a built-in JIT compiler that runs
Python quickly across different computing environments.
<a class="reference external" href="https://sfconservancy.org/">Software Freedom Conservancy</a> (Conservancy) is a charity that provides a home
to over forty free and open source software projects.</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-1990052443244807947">
        <div class="comment-header">
          <a name="comment-1990052443244807947"></a>
            <span class="author">intgr</span> wrote on <span class="date">2020-08-12 23:36</span>:
        </div>
        <div class="comment-content">
          <p>This post has lots of words but unfortunately contains almost no information. What impact does this change have on PyPy? What is the new chapter?<br></p>
        </div>
      </div>
      <div class="comment comment-3964298030103788729">
        <div class="comment-header">
          <a name="comment-3964298030103788729"></a>
            <span class="author">Rick Sanchez</span> wrote on <span class="date">2020-08-13 06:33</span>:
        </div>
        <div class="comment-content">
          <p>What does PyPy do? Why should I use it over other Python compilers?</p>
        </div>
      </div>
      <div class="comment comment-6709930945749531766">
        <div class="comment-header">
          <a name="comment-6709930945749531766"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2020-08-13 08:38</span>:
        </div>
        <div class="comment-content">
          <p>@intgr the wind-down with the SFC hasn't been smooth and this is the politically-neutral, agreed-by-both-parties post.  PyPy remains the same free and open-source project.  Essentially we just switched to a different money-handler.  We're announcing it in the next blog post.</p>
        </div>
      </div>
      <div class="comment comment-1948152757547113242">
        <div class="comment-header">
          <a name="comment-1948152757547113242"></a>
            <span class="author">Florian</span> wrote on <span class="date">2020-08-19 11:10</span>:
        </div>
        <div class="comment-content">
          <p>As https://bitbucket.org/pypy/pypy/downloads/pypy2.7-v7.3.1-linux32.tar.bz2 is down (due to heptapod move ?)<br><br>Where can we download pypy binaries ?</p>

        </div>
      </div>
      <div class="comment comment-6833997738017974869">
        <div class="comment-header">
          <a name="comment-6833997738017974869"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2020-08-19 22:44</span>:
        </div>
        <div class="comment-content">
          <p>The page https://pypy.org/download.html contains the updated links.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2020/04/pypy-731-released-6266451647387657480.html" class="u-url">PyPy 7.3.1 released</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2020/04/pypy-731-released-6266451647387657480.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-04-10T14:29:00Z" itemprop="datePublished" title="2020-04-10 14:29">2020-04-10 14:29</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div dir="ltr" style="text-align: left;">
The PyPy team is proud to release the version 7.3.1 of PyPy, which includes
two different interpreters:<br><blockquote>
<div>
<ul class="simple">
<li>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.13</li>
<li>PyPy3.6: which is an interpreter supporting the syntax and the features of
Python 3.6, including the stdlib for CPython 3.6.9.</li>
</ul>
</div>
</blockquote>
The interpreters are based on much the same codebase, thus the multiple
release. This is a micro release, no APIs have changed since the 7.3.0 release
in December, but read on to find out what is new.<br><br>
Conda Forge now <a class="reference external" href="https://conda-forge.org/blog//2020/03/10/pypy">supports PyPy</a> as a Python interpreter. The support right now
is being built out. After this release, many more c-extension-based
packages can be successfully built and uploaded. This is the result of a lot of
hard work and good will on the part of the Conda Forge team.  A big shout out
to them for taking this on.<br><br>
We have worked with the Python packaging group to support tooling around
building third party packages for Python, so this release updates the pip and
setuptools installed when executing <code class="docutils literal notranslate"><span class="pre">pypy</span> <span class="pre">-mensurepip</span></code> to <code class="docutils literal notranslate"><span class="pre">pip&gt;=20</span></code>. This
completes the work done to update the PEP 425 <a class="reference external" href="https://www.python.org/dev/peps/pep-0425/#python-tag">python tag</a> from <code class="docutils literal notranslate"><span class="pre">pp373</span></code> to
mean “PyPy 7.3 running python3” to <code class="docutils literal notranslate"><span class="pre">pp36</span></code> meaning “PyPy running Python
3.6” (the format is recommended in the PEP). The tag itself was
changed in 7.3.0, but older pip versions build their own tag without querying
PyPy. This means that wheels built for the previous tag format will not be
discovered by pip from this version, so library authors should update their
PyPy-specific wheels on PyPI.<br><br>
Development of PyPy is transitioning to <a class="reference external" href="https://foss.heptapod.net/pypy/pypy">https://foss.heptapod.net/pypy/pypy</a>.
This move was covered more extensively in the <a class="reference external" href="../posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html">blog post</a> from last month.<br><br>
The <a class="reference external" href="https://cffi.readthedocs.io/">CFFI</a> backend has been updated to version 14.0. We recommend using CFFI
rather than c-extensions to interact with C, and using <a class="reference external" href="https://cppyy.readthedocs.io/">cppyy</a> for performant
wrapping of C++ code for Python. The <code class="docutils literal notranslate"><span class="pre">cppyy</span></code> backend has been enabled
experimentally for win32, try it out and let use know how it works.<br><br>
Enabling <code class="docutils literal notranslate"><span class="pre">cppyy</span></code> requires a more modern C compiler, so win32 is now built
with MSVC160 (Visual Studio 2019). This is true for PyPy 3.6 as well as for 2.7.<br><br>
We have improved warmup time by up to 20%, performance of <code class="docutils literal notranslate"><span class="pre">io.StringIO</span></code> to
match if not be faster than CPython, and improved JIT code generation for
generators (and generator expressions in particular) when passing them to
functions like <code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">map</span></code>, and <code class="docutils literal notranslate"><span class="pre">map</span></code> that consume them. Performance of closures has also be improved in certain situations.<br><br>
As always, this release fixed several issues and bugs raised by the growing
community of PyPy users.  We strongly recommend updating. Many of the fixes are
the direct result of end-user bug reports, so please continue reporting issues
as they crop up.<br>

You can find links to download the v7.3.1 releases here:<br><blockquote>
<div>
<a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a>
</div>
</blockquote>
We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work.<br><br>
We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://doc.pypy.org/en/latest/index.html">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org/">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython’s JIT even better. Since the
previous release, we have accepted contributions from 13 new contributors,
thanks for pitching in.<br><br>
If you are a Python library maintainer and use c-extensions, please consider
making a cffi / cppyy version of your library that would be performant on PyPy.
In any case both <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheel</a> and the <a class="reference external" href="https://github.com/matthew-brett/multibuild">multibuild system</a> support
building wheels for PyPy wheels.<br><div class="section" id="what-is-pypy">
<h2 style="text-align: center;">
 </h2>
<h2 style="text-align: center;">
<span style="font-size: x-large;">What is PyPy?</span>
</h2>
PyPy is a very compliant Python interpreter, almost a drop-in replacement for
CPython 2.7, 3.6, and soon 3.7. It’s fast (<a class="reference external" href="https://speed.pypy.org/">PyPy and CPython 2.7.x</a> performance
comparison) due to its integrated tracing JIT compiler.<br><br>
We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.<br><br>
This PyPy release supports:<br><blockquote>
<div>
<ul class="simple">
<li>
<strong>x86</strong> machines on most common operating systems
(Linux 32/64 bits, Mac OS X 64 bits, Windows 32 bits, OpenBSD, FreeBSD)</li>
<li>big- and little-endian variants of <strong>PPC64</strong> running Linux,</li>
<li>
<strong>s390x</strong> running Linux</li>
<li>64-bit <strong>ARM</strong> machines running Linux.</li>
</ul>
</div>
</blockquote>
<br><div class="section" id="changelog">
<h2 style="text-align: center;">
<span style="font-size: x-large;">What else is new?</span>
</h2>
For more information about the 7.3.1 release, see the full <a href="https://pypy.readthedocs.io/en/latest/release-v7.3.1.html">changelog</a>.<br><br>
Please update, and continue to help us make PyPy better.<br><br>
Cheers,<br>
The PyPy team
</div>
<br><br><br>
The PyPy Team  <br>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2020/03/leysin-2020-sprint-report-764567777353955897.html" class="u-url">Leysin 2020 Sprint Report</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/hodgestar.html">hodgestar</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2020/03/leysin-2020-sprint-report-764567777353955897.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-03-17T21:57:00Z" itemprop="datePublished" title="2020-03-17 21:57">2020-03-17 21:57</time></a>
            </p>
                <p class="commentline">2 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>At the end of February ten of us gathered in Leysin, Switzerland to work on<br>
a variety of topics including <a class="reference external" href="https://github.com/pyhandle/hpy/">HPy</a>, <a class="reference external" href="https://buildbot.pypy.org/summary?branch=py3.7">PyPy Python 3.7</a> support and the PyPy<br>
migration to <a class="reference external" href="https://foss.heptapod.net/pypy/">Heptapod</a>.<br><br></p>
<div class="separator" style="clear: both; text-align: center;">
<a href="https://1.bp.blogspot.com/-PIs_hVhn3RY/XnFDceuihNI/AAAAAAAAbRg/LKMOMWxeFw4jhcwqy8jx7iKzKE01fbfxQCEwYBhgL/s1600/2020_leysin_sprint_attendees.jpg" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="180" src="https://1.bp.blogspot.com/-PIs_hVhn3RY/XnFDceuihNI/AAAAAAAAbRg/LKMOMWxeFw4jhcwqy8jx7iKzKE01fbfxQCEwYBhgL/s320/2020_leysin_sprint_attendees.jpg" width="320"></a>
</div>
<br>
We had a fun and productive week. The snow was beautiful. There was skiing<br>
and lunch at the top of <a class="reference external" href="https://en.wikipedia.org/wiki/Berneuse">Berneuse</a>, cooking together, some late nights at<br>
the pub next door, some even later nights coding, and of course the<br>
obligatory cheese fondue outing.<br><br>
There were a few of us participating in a PyPy sprint for the first time<br>
and a few familiar faces who had attended many sprints. Many different<br>
projects were represented including PyPy, <a class="reference external" href="https://github.com/pyhandle/hpy/">HPy</a>, <a class="reference external" href="https://github.com/graalvm/graalpython">GraalPython</a>,<br><a class="reference external" href="https://foss.heptapod.net/pypy/">Heptapod</a>, and <a class="reference external" href="https://github.com/dgrunwald/rust-cpython">rust-cpython</a>. The atmosphere was relaxed and welcoming, so if<br>
you're thinking of attending the next one -- please do!<br><br>
Topics worked on:<br><br><h2>
HPy</h2>
HPy is a new project to design and implement a better API for extending<br>
Python in C. If you're unfamiliar with it you can read more about it at<br><a class="reference external" href="https://github.com/pyhandle/hpy/">HPy</a>.<br><br>
A lot of attention was devoted to the Big HPy Design Discussion which<br>
took up two full mornings. So much was decided that this will likely<br>
get its own detailed write-up, but bigger topics included:<br><ul class="simple">
<li>the HPy GetAttr, SetAttr, GetItem and SetItem methods,</li>
<li>HPy_FromVoidP and HPy_AsVoidP for passing HPy handles to C functions<br>
that pass void* pointers to callbacks,</li>
<li>avoiding having va_args as part of the ABI,</li>
<li>exception handling,</li>
<li>support for creating custom types.</li>
</ul>
Quite a few things got worked on too:<br><ul class="simple">
<li>implemented support for writing methods that take keyword arguments with<br>
HPy_METH_KEYWORDS,</li>
<li>implemented HPy_GetAttr, HPy_SetAttr, HPy_GetItem, and HPy_SetItem,</li>
<li>started implementing support for adding custom types,</li>
<li>started implementing dumping JSON objects in ultrajson-hpy,</li>
<li>refactored the PyPy GIL to improve the interaction between HPy and<br>
PyPy's cpyext,</li>
<li>experimented with adding HPy support to rust-cpython.</li>
</ul>
And there was some discussion of the next steps of the HPy initiative<br>
including writing documentation, setting up websites and funding, and<br>
possibly organising another HPy gathering later in the year.<br><br><h2>
PyPy</h2>
<ul class="simple">
<li>Georges gave a presentation on the Heptapod topic and branch workflows<br>
and showed everyone how to use hg-evolve.</li>
<li>Work was done on improving the PyPy CI buildbot post the move to<br>
heptapod, including a light-weight pre-merge CI and restricting<br>
when the full CI is run to only branch commits.</li>
<li>A lot of work was done improving the -D tests. </li>
</ul>
<br><h2>
Miscellaneous</h2>
<ul class="simple">
<li>Armin demoed VRSketch and NaN Industries in VR, including an implementation<br>
of the Game of Life within NaN Industries!</li>
<li>Skiing!</li>
</ul>
<br><h2>
Aftermath</h2>
Immediately after the sprint large parts of Europe and the world were<br>
hit by the COVID-19 epidemic. It was good to spend time together before<br>
travelling ceased to be a sensible idea and many gatherings were cancelled.<br><br>
Keep safe out there everyone.<br><br>
The HPy &amp; PyPy Team &amp; Friends<br><br><i>In joke for those who attended the sprint: Please don't replace this blog post<br>
with its Swedish translation (or indeed a translation to any other language :).</i>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-5886740003122828365">
        <div class="comment-header">
          <a name="comment-5886740003122828365"></a>
            <span class="author">Pim</span> wrote on <span class="date">2020-03-30 13:04</span>:
        </div>
        <div class="comment-content">
          <p>How does HPY relate to CFFI?<br><br></p>
        </div>
      </div>
      <div class="comment comment-8894121621448970780">
        <div class="comment-header">
          <a name="comment-8894121621448970780"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2020-03-30 16:44</span>:
        </div>
        <div class="comment-content">
          <p>@Pim: CFFI allows to wrap C code in pure Python.<br>HPy allows to write Python extensions in C.<br><br>For example, you can't write a new class in CFFI, and CFFI functions can't receive Python objects as arguments</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html" class="u-url">PyPy and CFFI have moved to Heptapod</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-02-16T14:36:00Z" itemprop="datePublished" title="2020-02-16 14:36">2020-02-16 14:36</time></a>
            </p>
                <p class="commentline">5 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <div dir="ltr" style="text-align: left;">
<div class="document">
<div class="body">
<div class="section" id="pypy-and-cffi-have-moved-to-heptapod">
It has been a very busy month, not so much because of deep changes in the JIT of PyPy but more around the development, deployment, and packaging of the project.<br><div class="section" id="hosting">
<h2>
<span style="font-size: x-large;"> </span>
</h2>
<h2>
<span style="font-size: x-large;">Hosting</span>
</h2>
The biggest news is that we have moved the center of our development off Bitbucket and to the new <a class="reference external" href="https://foss.heptapod.net/pypy">https://foss.heptapod.net/pypy</a>. This is a friendly fork of Gitlab called <a class="reference external" href="https://heptapod.net/">heptapod</a> that understands Mercurial and is hosted by <a class="reference external" href="https://www.clever-cloud.com/en/heptapod">Clever Cloud</a>. When Atlassian decided to close down Mercurial hosting on bitbucket.org, PyPy debated what to do. Our development model is based on long-lived branches, and we want to keep the ability to immediately see which branch each commit came from. Mercurial has this, git does not (see <a class="reference external" href="https://doc.pypy.org/en/latest/faq.html#why-doesn-t-pypy-use-git-and-move-to-github">our FAQ</a>). <a class="reference external" href="https://octobus.net/">Octobus</a>, whose business is Mercurial, developed a way to use Mercurial with Gitlab called heptapod. The product is still <a class="reference external" href="https://heptapod.net/pages/getting-involved.html">under development</a>, but quite usable (i.e., it doesn't get in the way). Octobus partnered with Clever Cloud hosting to offer community FOSS projects hosted on Bitbucket who wish to remain with Mercurial a new home. PyPy took them up on the offer, and migrated its repos to <a class="reference external" href="https://foss.heptapod.net/pypy">https://foss.heptapod.net/pypy</a>. We were very happy with how smooth it was to import the repos to heptapod/GitLab, and are learning the small differences between Bitbucket and GitLab. All the pull requests, issues, and commits kept the same ids, but work is still being done to attribute the issues, pull requests, and comments to the correct users. So from now on, when you want to contribute to PyPy, you do so at the new home.<br><br>
CFFI, which previously was also hosted on Bitbucket, has joined the PyPy group at <a class="reference external" href="https://foss.heptapod.net/pypy/cffi">https://foss.heptapod.net/pypy/cffi</a>.</div>
<div class="section" id="website">
<h2>
<span style="font-size: x-large;"> </span>
</h2>
<h2>
<span style="font-size: x-large;">Website</span>
</h2>
Secondly, thanks to work by <a class="reference external" href="https://baroquesoftware.com/">https://baroquesoftware.com/</a> in leading a redesign and updating the logo, the <a class="reference external" href="https://www.pypy.org/">https://www.pypy.org</a> website has undergone a facelift. It should now be easier to use on small-screen devices. Thanks also to the PSF for hosting the site.</div>
<div class="section" id="packaging">
<h2>
<span style="font-size: x-large;"> </span>
</h2>
<h2>
<span style="font-size: x-large;">Packaging</span>
</h2>
Also, building PyPy from source takes a fair amount of time. While we provide downloads in the form of tarballs or zipfiles, and some platforms such as debian and Homebrew provide packages, traditionally the downloads have only worked on a specific flavor of operating system. A few years ago squeaky-pl started providing <a class="reference external" href="https://github.com/squeaky-pl/portable-pypy">portable builds</a>. We have adopted that build system for our linux offerings, so the <a class="reference external" href="https://buildbot.pypy.org/nightly">nightly downloads</a> and <a class="reference external" href="https://downloads.pypy.org/downloads">release downloads</a> should now work on any glibc platform that has not gone EndOfLife. So there goes another excuse not to use PyPy. And the "but does it run scipy" excuse also no longer holds, although "does it speed up scipy" still has the wrong answer. For that we are working on <a class="reference external" href="../posts/2019/12/hpy-kick-off-sprint-report-1840829336092490938.html">HPy</a>, and will be <a class="reference external" href="../posts/2020/01/leysin-winter-sprint-2020-feb-28-march-6349761524797409012.html">sprinting soon</a>.<br>
The latest versions of pip, wheel, and setuptools, together with the manylinux2010 standard for linux wheels and tools such as <a class="reference external" href="https://github.com/matthew-brett/multibuild/">multibuild</a> or <a class="reference external" href="https://github.com/joerick/cibuildwheel">cibuildwheels</a> (well, from the next version) make it easier for library developers to build binary wheels for PyPy. If you are having problems getting going with this, please reach out.</div>
</div>
<div class="section" id="give-it-a-try">
<h2 style="text-align: left;">
<span style="font-size: x-large;"> </span>
</h2>
<h2 style="text-align: left;">
<span style="font-size: x-large;">Give it a try</span>
</h2>
Thanks to all the folks who provide the infrastructure PyPy depends on. We hope the new look will encourage more involvement and engagement. Help prove us right!<br><br>
The PyPy Team</div>
</div>
</div>
</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-8593475061965265364">
        <div class="comment-header">
          <a name="comment-8593475061965265364"></a>
            <span class="author">Matěj Cepl</span> wrote on <span class="date">2020-02-16 21:20</span>:
        </div>
        <div class="comment-content">
          <p>Could you elaborate on “this is not always possible with Git”, please? This is too brief statement for my taste, and it doesn't make much sense (merging a branch certainly doesn't make it go away, and it is certainly possible to find to which branch a commit used to belong before merging).</p>
        </div>
      </div>
      <div class="comment comment-3334434925703288005">
        <div class="comment-header">
          <a name="comment-3334434925703288005"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2020-02-16 22:35</span>:
        </div>
        <div class="comment-content">
          <p>https://doc.pypy.org/en/latest/faq.html#why-doesn-t-pypy-use-git-and-move-to-github</p>
        </div>
      </div>
      <div class="comment comment-8075281165032634114">
        <div class="comment-header">
          <a name="comment-8075281165032634114"></a>
            <span class="author">Miro Hrončok</span> wrote on <span class="date">2020-02-18 07:25</span>:
        </div>
        <div class="comment-content">
          <p>Were issue attachments migrated properly?</p>
        </div>
      </div>
      <div class="comment comment-7212091686312392981">
        <div class="comment-header">
          <a name="comment-7212091686312392981"></a>
            <span class="author">mattip</span> wrote on <span class="date">2020-02-19 07:34</span>:
        </div>
        <div class="comment-content">
          <p>&gt; Were issue attachments migrated properly? <br><br>No. They should be migrated in a follow-up. Here is the heptapod issue about attachments https://foss.heptapod.net/heptapod/foss.heptapod.net/issues/37</p>
        </div>
      </div>
      <div class="comment comment-7524732571223644941">
        <div class="comment-header">
          <a name="comment-7524732571223644941"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2020-02-19 08:19</span>:
        </div>
        <div class="comment-content">
          <p>I deleted one anonymous comment that was insulting the project decision. Please make your points constructively or don't make them.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2020/01/leysin-winter-sprint-2020-feb-28-march-6349761524797409012.html" class="u-url">Leysin Winter sprint 2020: Feb 29 - March 8th</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/armin-rigo.html">Armin Rigo</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2020/01/leysin-winter-sprint-2020-feb-28-march-6349761524797409012.html" rel="bookmark">
            <time class="published dt-published" datetime="2020-01-17T10:36:00Z" itemprop="datePublished" title="2020-01-17 10:36">2020-01-17 10:36</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <a href="https://q-cf.bstatic.com/images/hotel/max1280x900/321/32136520.jpg" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="240" src="https://q-cf.bstatic.com/images/hotel/max1280x900/321/32136520.jpg" width="320"></a>The next PyPy sprint will be in Leysin, Switzerland, for the fourteenth
time.  This is a fully public sprint: newcomers and topics other than
those proposed below are welcome.<br><br><br><br><h3>
Goals and topics of the sprint</h3>
The list of topics is open.  For reference, we would like to work at least partially on the following topics:<br><ul>
<li>
<a href="https://github.com/pyhandle/hpy">HPy</a> </li>
<li>Python 3.7 support (<a href="https://buildbot.pypy.org/summary?branch=py3.7">buildbot status</a>)</li>
</ul>
As usual, the main side goal is to have fun in winter sports :-)
We can take a day off (for ski or anything else).<br><br><h3>
Times and accomodation</h3>
The sprint will occur for one week starting on Saturday, the 29th of February, to Sunday, the 8th of March 2020 <b>(dates were pushed back one day!)</b>  It will occur in <a href="https://www.booking.com/hotel/ch/les-airelles.html">Les Airelles</a>, a different bed-and-breakfast place from the traditional one in <span class="il">Leysin</span>.  It is a nice old house at the top of the village.<br><br><strike>We have a 4- or 5-people room as well as up to three double-rooms.  Please register early!  These rooms are not booked for the sprint in advance, and might be already taken if you end up announcing yourself late.</strike>  We have a big room for up to 7 people with nice view, which might be split in two or three sub-rooms; plus possibly separately-booked double rooms if needed. (But it is of course always possible to book at a different place in Leysin.)<br><br>
For more information, see our <a href="https://foss.heptapod.net/pypy/extradoc/-/blob/branch/default/extradoc/sprintinfo/leysin-winter-2020/">repository</a> or write to me directly at armin.rigo@gmail.com.
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2019/12/pypy-730-released-3614026620096963655.html" class="u-url">PyPy 7.3.0 released</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2019/12/pypy-730-released-3614026620096963655.html" rel="bookmark">
            <time class="published dt-published" datetime="2019-12-24T13:55:00Z" itemprop="datePublished" title="2019-12-24 13:55">2019-12-24 13:55</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div dir="ltr" style="text-align: left;">
The PyPy team is proud to release the version 7.3.0 of PyPy, which includes
two different interpreters:<br><ul class="simple">
<li>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.13</li>
<li>PyPy3.6: which is an interpreter supporting the syntax and the features of
Python 3.6, including the stdlib for CPython 3.6.9.</li>
</ul>
<blockquote>
<div>
</div>
</blockquote>
The interpreters are based on much the same codebase, thus the double
release.<br><br>
We have worked with the python packaging group to support tooling around
building third party packages for python, so this release changes the ABI tag
for PyPy.<br><br>
Based on the great work done in <a class="reference external" href="https://github.com/squeaky-pl/portable-pypy">portable-pypy</a>, the linux downloads we
provide are now built on top of the <a href="https://github.com/pypa/manylinux"><span class="problematic" id="id11">manylinux2010</span></a> CentOS6 docker image.
The tarballs include the needed shared objects to run on any platform that
supports manylinux2010 wheels, which should include all supported versions of
debian- and RedHat-based distributions (including Ubuntu, CentOS, and Fedora).<br><br>
The <a class="reference external" href="https://cffi.readthedocs.io/">CFFI</a> backend has been updated to version 1.13.1. We recommend using CFFI
rather than c-extensions to interact with C.<br>

The built-in <a href="https://cppyy.readthedocs.io/en/latest/"><code class="docutils literal notranslate"><span class="pre">cppyy</span></code></a> module was upgraded to 1.10.6, which
provides, among others, better template resolution, stricter <code class="docutils literal notranslate"><span class="pre">enum</span></code> handling,
anonymous struct/unions, cmake fragments for distribution, optimizations for
PODs, and faster wrapper calls. We reccomend using <a class="reference external" href="https://cppyy.readthedocs.io/">cppyy</a> for performant
wrapping of C++ code for Python.<br><br>
The vendored pyrepl package for interaction inside the REPL was updated.<br><br>
Support for codepage encoding and decoding was added for Windows.<br><br>
As always, this release fixed several issues and bugs raised by the growing
community of PyPy users.  We strongly recommend updating. Many of the fixes are
the direct result of end-user bug reports, so please continue reporting issues
as they crop up.<br>

You can download the v7.3 releases here:<br><blockquote>
<div>
<a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a>
</div>
</blockquote>
We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work.<br><br>
We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://doc.pypy.org/en/latest/index.html">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org/">RPython</a> documentation improvements, tweaking popular packages to run
on pypy, or general <a class="reference external" href="https://doc.pypy.org/en/latest/project-ideas.html">help</a> with making RPython’s JIT even better. Since the
previous release, we have accepted contributions from 3 new contributors,
thanks for pitching in.<br><br>
If you are a python library maintainer and use c-extensions, please consider making a cffi / cppyy version of your library that would be performant on PyPy. If you are stuck with using the C-API, you can use <a href="https://github.com/pypy/manylinux">docker images with PyPy built in</a> or the <a href="https://github.com/matthew-brett/multibuild/">multibuild system</a> to build wheels.<br><br><div class="section" id="what-is-pypy">
<h2 style="text-align: center;">
<span style="font-size: x-large;">What is PyPy?</span>
</h2>
PyPy is a very compliant Python interpreter, almost a drop-in replacement for
CPython 2.7, 3.6. It’s fast (<a class="reference external" href="https://speed.pypy.org/">PyPy and CPython 2.7.x</a> performance
comparison) due to its integrated tracing JIT compiler.<br><br>
We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.<br><br>
This PyPy release supports:<br><ul style="text-align: left;">
<li>
<b>x86</b> machines on most common operating systems
(Linux 32/64 bit, Mac OS X 64-bit, Windows 32-bit, OpenBSD, FreeBSD)</li>
</ul>
</div>
<div class="section" id="what-is-pypy">
<ul style="text-align: left;">
<li>big- and little-endian variants of <b>PPC64</b> running Linux<b> </b>
</li>
</ul>
</div>
<div class="section" id="what-is-pypy">
<ul style="text-align: left;">
<li>
<b>s390x</b> running Linux</li>
</ul>
</div>
<div class="section" id="what-is-pypy">
<ul style="text-align: left;">
<li>64-bit <b>ARM</b> machines running Linux</li>
</ul>
Unfortunately at the moment of writing our ARM buildbots are out of service,
so for now we are <b>not</b> releasing any binary for the ARM architecture (32-bit), although PyPy does support ARM 32-bit processors.<br><br><div class="section" id="changelog">
<h2 style="text-align: center;">
<span style="font-size: x-large;">What else is new?</span>
</h2>
PyPy 7.2 was released in October, 2019.
There are many incremental improvements to RPython and PyPy, For more information about the 7.3.0 release, see the full <a href="https://pypy.readthedocs.io/en/latest/release-v7.3.0.html">changelog</a>.<br><br>
Please update, and continue to help us make PyPy better.<br><br>
Cheers,<br>
The PyPy team
</div>
<br><br>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2019/12/hpy-kick-off-sprint-report-1840829336092490938.html" class="u-url">HPy kick-off sprint report</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2019/12/hpy-kick-off-sprint-report-1840829336092490938.html" rel="bookmark">
            <time class="published dt-published" datetime="2019-12-18T13:38:00Z" itemprop="datePublished" title="2019-12-18 13:38">2019-12-18 13:38</time></a>
            </p>
                <p class="commentline">7 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Recently Antonio, Armin and Ronan had a small internal sprint in the beautiful
city of Gdańsk to kick-off the development of HPy. Here is a brief report of
what was accomplished during the sprint.</p>
<div class="section" id="what-is-hpy">
<h2>What is HPy?</h2>
<p>The TL;DR answer is "a better way to write C extensions for Python".</p>
<p>The idea of HPy was born during EuroPython 2019 in Basel, where there was an
informal meeting which included core developers of PyPy, CPython (Victor
Stinner and Mark Shannon) and Cython (Stefan Behnel). The ideas were later also
discussed with Tim Felgentreff of <a class="reference external" href="https://github.com/graalvm/graalpython">GraalPython</a>, to make sure they would also be
applicable to this very different implementation, Windel Bouwman of <a class="reference external" href="https://github.com/RustPython/RustPython">RustPython</a>
is following the project as well.</p>
<p>All of us agreed that the current design of the CPython C API is problematic
for various reasons and, in particular, because it is too tied to the current
internal design of CPython.  The end result is that:</p>

<ul class="simple">
<li>alternative implementations of Python (such as PyPy, but not only) have a
<a class="reference external" href="../posts/2018/09/inside-cpyext-why-emulating-cpython-c-8083064623681286567.html">hard time</a> loading and executing existing C extensions;</li>
<li>CPython itself is unable to change some of its internal implementation
details without breaking the world. For example, as of today it would be
impossible to switch from using reference counting to using a real GC,
which in turns make it hard for example to remove the GIL, as <a class="reference external" href="https://pythoncapi.readthedocs.io/gilectomy.html">gilectomy</a>
attempted.</li>
</ul>
<p>HPy tries to address these issues by following two major design guidelines:</p>
<ol class="arabic simple">
<li>objects are referenced and passed around using opaque handles, which are
similar to e.g., file descriptors in spirit. Multiple, different handles
can point to the same underlying object, handles can be duplicated and
each handle must be released independently of any other duplicate.</li>
<li>The internal data structures and C-level layout of objects are not
visible nor accessible using the API, so each implementation if free to
use what fits best.</li>
</ol>
<p>The other major design goal of HPy is to allow incremental transition and
porting, so existing modules can migrate their codebase one method at a time.
Moreover, Cython is considering to optionally generate HPy code, so extension
module written in Cython would be able to benefit from HPy automatically.</p>
<p>More details can be found in the README of the official <a class="reference external" href="https://github.com/pyhandle/hpy">HPy repository</a>.</p>
</div>
<div class="section" id="target-abi">
<h2>Target ABI</h2>
<p>When compiling an HPy extension you can choose one of two different target ABIs:</p>

<ul class="simple">
<li>
<strong>HPy/CPython ABI</strong>: in this case, <tt class="docutils literal">hpy.h</tt> contains a set of macros and
static inline functions. At compilation time this translates the HPy API
into the standard C-API. The compiled module will have no performance
penalty, and it will have a "standard" filename like
<tt class="docutils literal"><span class="pre">foo.cpython-37m-x86_64-linux-gnu.so</span></tt>.</li>
<li>
<strong>Universal HPy ABI</strong>: as the name implies, extension modules compiled
this way are "universal" and can be loaded unmodified by multiple Python
interpreters and versions.  Moreover, it will be possible to dynamically
enable a special debug mode which will make it easy to find e.g., open
handles or memory leaks, <strong>without having to recompile the extension</strong>.</li>
</ul>
<p>Universal modules can <strong>also</strong> be loaded on CPython, thanks to the
<tt class="docutils literal">hpy_universal</tt> module which is under development. An extra layer of
indirection enables loading extensions compiled with the universal ABI. Users
of <tt class="docutils literal">hpy_universal</tt> will face a small performance penalty compared to the ones
using the HPy/CPython ABI.</p>
<p>This setup gives several benefits:</p>

<ul class="simple">
<li>Extension developers can use the extra debug features given by the
Universal ABI with no need to use a special debug version of Python.</li>
<li>Projects which need the maximum level of performance can compile their
extension for each relevant version of CPython, as they are doing now.</li>
<li>Projects for which runtime speed is less important will have the choice of
distributing a single binary which will work on any version and
implementation of Python.</li>
</ul>
</div>
<div class="section" id="a-simple-example">
<h2>A simple example</h2>
<p>The HPy repo contains a <a class="reference external" href="https://github.com/pyhandle/hpy/blob/master/proof-of-concept/pof.c">proof of concept</a> module. Here is a simplified
version which illustrates what a HPy module looks like:</p>
<pre class="code C literal-block">
<span class="comment preproc">#include</span> <span class="comment preprocfile">"hpy.h"</span><span class="comment preproc">
</span>
<span class="name">HPy_DEF_METH_VARARGS</span><span class="punctuation">(</span><span class="name">add_ints</span><span class="punctuation">)</span>
<span class="keyword">static</span> <span class="name">HPy</span> <span class="name">add_ints_impl</span><span class="punctuation">(</span><span class="name">HPyContext</span> <span class="name">ctx</span><span class="punctuation">,</span> <span class="name">HPy</span> <span class="name">self</span><span class="punctuation">,</span> <span class="name">HPy</span> <span class="operator">*</span><span class="name">args</span><span class="punctuation">,</span> <span class="name">HPy_ssize_t</span> <span class="name">nargs</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="keyword type">long</span> <span class="name">a</span><span class="punctuation">,</span> <span class="name">b</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span><span class="name">HPyArg_Parse</span><span class="punctuation">(</span><span class="name">ctx</span><span class="punctuation">,</span> <span class="name">args</span><span class="punctuation">,</span> <span class="name">nargs</span><span class="punctuation">,</span> <span class="literal string">"ll"</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">a</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">b</span><span class="punctuation">))</span>
        <span class="keyword">return</span> <span class="name">HPy_NULL</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="name function">HPyLong_FromLong</span><span class="punctuation">(</span><span class="name">ctx</span><span class="punctuation">,</span> <span class="name">a</span><span class="operator">+</span><span class="name">b</span><span class="punctuation">);</span>
<span class="punctuation">}</span>


<span class="keyword">static</span> <span class="name">HPyMethodDef</span> <span class="name">PofMethods</span><span class="punctuation">[]</span> <span class="operator">=</span> <span class="punctuation">{</span>
    <span class="punctuation">{</span><span class="literal string">"add_ints"</span><span class="punctuation">,</span> <span class="name">add_ints</span><span class="punctuation">,</span> <span class="name">HPy_METH_VARARGS</span><span class="punctuation">,</span> <span class="literal string">""</span><span class="punctuation">},</span>
    <span class="punctuation">{</span><span class="name builtin">NULL</span><span class="punctuation">,</span> <span class="name builtin">NULL</span><span class="punctuation">,</span> <span class="literal number integer">0</span><span class="punctuation">,</span> <span class="name builtin">NULL</span><span class="punctuation">}</span>
<span class="punctuation">};</span>

<span class="keyword">static</span> <span class="name">HPyModuleDef</span> <span class="name">moduledef</span> <span class="operator">=</span> <span class="punctuation">{</span>
    <span class="name">HPyModuleDef_HEAD_INIT</span><span class="punctuation">,</span>
    <span class="punctuation">.</span><span class="name">m_name</span> <span class="operator">=</span> <span class="literal string">"pof"</span><span class="punctuation">,</span>
    <span class="punctuation">.</span><span class="name">m_doc</span> <span class="operator">=</span> <span class="literal string">"HPy Proof of Concept"</span><span class="punctuation">,</span>
    <span class="punctuation">.</span><span class="name">m_size</span> <span class="operator">=</span> <span class="operator">-</span><span class="literal number integer">1</span><span class="punctuation">,</span>
    <span class="punctuation">.</span><span class="name">m_methods</span> <span class="operator">=</span> <span class="name">PofMethods</span>
<span class="punctuation">};</span>


<span class="name">HPy_MODINIT</span><span class="punctuation">(</span><span class="name">pof</span><span class="punctuation">)</span>
<span class="keyword">static</span> <span class="name">HPy</span> <span class="name">init_pof_impl</span><span class="punctuation">(</span><span class="name">HPyContext</span> <span class="name">ctx</span><span class="punctuation">)</span>
<span class="punctuation">{</span>
    <span class="name">HPy</span> <span class="name">m</span><span class="punctuation">;</span>
    <span class="name">m</span> <span class="operator">=</span> <span class="name">HPyModule_Create</span><span class="punctuation">(</span><span class="name">ctx</span><span class="punctuation">,</span> <span class="operator">&amp;</span><span class="name">moduledef</span><span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name">HPy_IsNull</span><span class="punctuation">(</span><span class="name">m</span><span class="punctuation">))</span>
        <span class="keyword">return</span> <span class="name">HPy_NULL</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="name">m</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
</pre>
<p>People who are familiar with the current C-API will surely notice many
similarities. The biggest differences are:</p>

<ul class="simple">
<li>Instead of <tt class="docutils literal">PyObject *</tt>, objects have the type <tt class="docutils literal">HPy</tt>, which as
explained above represents a handle.</li>
<li>You need to explicitly pass an <tt class="docutils literal">HPyContext</tt> around: the intent is
primary to be future-proof and make it easier to implement things like
sub- interpreters.</li>
<li>
<tt class="docutils literal">HPy_METH_VARARGS</tt> is implemented differently than CPython's
<tt class="docutils literal">METH_VARARGS</tt>: in particular, these methods receive an array of <tt class="docutils literal">HPy</tt>
and its length, instead of a fully constructed tuple: passing a tuple
makes sense on CPython where you have it anyway, but it might be an
unnecessary burden for alternate implementations.  Note that this is
similar to the new <a class="reference external" href="https://www.python.org/dev/peps/pep-0580/">METH_FASTCALL</a> which was introduced in CPython.</li>
<li>HPy relies a lot on C macros, which most of the time are needed to support
the HPy/CPython ABI compilation mode. For example, <tt class="docutils literal">HPy_DEF_METH_VARARGS</tt>
expands into a trampoline which has the correct C signature that CPython
expects (i.e., <tt class="docutils literal">PyObject <span class="pre">(*)(PyObject</span> *self, *PyObject *args)</tt>) and
which calls <tt class="docutils literal">add_ints_impl</tt>.</li>
</ul>
</div>
<div class="section" id="sprint-report-and-current-status">
<h2>Sprint report and current status</h2>
<p>After this long preamble, here is a rough list of what we accomplished during
the week-long sprint and the days immediatly after.</p>
<p>On the HPy side, we kicked-off the code in the repo: at the moment of writing
the layout of the directories is a bit messy because we moved things around
several times, but we identified several main sections:</p>

<ol class="arabic">
<li>
<p class="first">A specification of the API which serves both as documentation and as an
input for parts of the projects which are automatically
generated. Currently, this lives in <a class="reference external" href="https://github.com/pyhandle/hpy/blob/9aa8a2738af3fd2eda69d4773b319d10a9a5373f/tools/public_api.h">public_api.h</a>.</p>
</li>
<li>
<p class="first">A set of header files which can be used to compile extension modules:
depending on whether the flag <tt class="docutils literal"><span class="pre">-DHPY_UNIVERSAL_ABI</span></tt> is passed to the
compiler, the extension can target the <a class="reference external" href="https://github.com/pyhandle/hpy/blob/9aa8a2738af3fd2eda69d4773b319d10a9a5373f/hpy-api/hpy_devel/include/cpython/hpy.h">HPy/CPython ABI</a> or the <a class="reference external" href="https://github.com/pyhandle/hpy/blob/9aa8a2738af3fd2eda69d4773b319d10a9a5373f/hpy-api/hpy_devel/include/universal/hpy.h">HPy
Universal ABI</a></p>
</li>
<li>
<p class="first">A <a class="reference external" href="https://github.com/pyhandle/hpy/tree/9aa8a2738af3fd2eda69d4773b319d10a9a5373f/cpython-universal/src">CPython extension module</a> called <tt class="docutils literal">hpy_universal</tt> which makes it
possible to import universal modules on CPython</p>
</li>
<li>
<p class="first">A set of <a class="reference external" href="https://github.com/pyhandle/hpy/tree/9aa8a2738af3fd2eda69d4773b319d10a9a5373f/test">tests</a> which are independent of the implementation and are meant
to be an "executable specification" of the semantics.  Currently, these
tests are run against three different implementations of the HPy API:</p>

<ul class="simple">
<li>the headers which implements the "HPy/CPython ABI"</li>
<li>the <tt class="docutils literal">hpy_universal</tt> module for CPython</li>
<li>the <tt class="docutils literal">hpy_universal</tt> module for PyPy (these tests are run in the PyPy repo)</li>
</ul>
</li>
</ol>
<p>Moreover, we started a <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/hpy/pypy/module/hpy_universal/">PyPy branch</a> in which to implement the
<tt class="docutils literal">hpy_univeral</tt> module: at the moment of writing PyPy can pass all the HPy
tests apart the ones which allow conversion to and from <tt class="docutils literal">PyObject *</tt>.
Among the other things, this means that it is already possible to load the
very same binary module in both CPython and PyPy, which is impressive on its
own :).</p>
<p>Finally, we wanted a real-life use case to show how to port a module to HPy
and to do benchmarks.  After some searching, we choose <a class="reference external" href="https://github.com/esnme/ultrajson">ultrajson</a>, for the
following reasons:</p>

<ul class="simple">
<li>it is a real-world extension module which was written with performance in
mind</li>
<li>when parsing a JSON file it does a lot of calls to the Python API to
construct the various parts of the result message</li>
<li>it uses only a small subset of the Python API</li>
</ul>
<p>This repo contains the <a class="reference external" href="https://github.com/pyhandle/ultrajson-hpy">HPy port of ultrajson</a>. This <a class="reference external" href="https://github.com/pyhandle/ultrajson-hpy/commit/efb35807afa8cf57db5df6a3dfd4b64c289fe907">commit</a> shows an example
of what the porting looks like.</p>
<p><tt class="docutils literal">ujson_hpy</tt> is also a very good example of incremental migration: so far
only <tt class="docutils literal">ujson.loads</tt> is implemented using the HPy API, while <tt class="docutils literal">ujson.dumps</tt>
is still implemented using the old C-API, and both can coexist nicely in the
same compiled module.</p>
</div>
<div class="section" id="benchmarks">
<h2>Benchmarks</h2>
<p>Once we have a fully working <tt class="docutils literal">ujson_hpy</tt> module, we can finally run
benchmarks!  We tested several different versions of the module:</p>

<ul class="simple">
<li>
<tt class="docutils literal">ujson</tt>: this is the vanilla implementation of ultrajson using the
C-API. On PyPy this is executed by the infamous <tt class="docutils literal">cpyext</tt> compatibility
layer, so we expect it to be much slower than on CPython</li>
<li>
<tt class="docutils literal">ujson_hpy</tt>: our HPy port compiled to target the HPy/CPython ABI. We
expect it to be as fast as <tt class="docutils literal">ujson</tt>
</li>
<li>
<tt class="docutils literal">ujson_hpy_universal</tt>: same as above but compiled to target the
Universal HPy ABI. We expect it to be slightly slower than <tt class="docutils literal">ujson</tt> on
CPython, and much faster on PyPy.</li>
</ul>
<p>Finally, we also ran the benchmark using the builtin <tt class="docutils literal">json</tt> module. This is
not really relevant to HPy, but it might still be an interesting as a
reference data point.</p>
<p>The <a class="reference external" href="https://github.com/pyhandle/ultrajson-hpy/blob/hpy/benchmark/main.py">benchmark</a> is very simple and consists of parsing a <a class="reference external" href="https://github.com/pyhandle/ultrajson-hpy/blob/hpy/benchmark/download_data.sh">big JSON file</a> 100
times. Here is the average time per iteration (in milliseconds) using the
various versions of the module, CPython 3.7 and the latest version of the hpy
PyPy branch:</p>
<table border="1" class="docutils">
<colgroup>
<col width="55%">
<col width="24%">
<col width="21%">
</colgroup>
<tbody valign="top">
<tr>
<td> </td>
<td>CPython</td>
<td>PyPy</td>
</tr>
<tr>
<td>ujson</td>
<td>154.32</td>
<td>633.97</td>
</tr>
<tr>
<td>ujson_hpy</td>
<td>152.19</td>
<td> </td>
</tr>
<tr>
<td>ujson_hpy_universal</td>
<td>168.78</td>
<td>207.68</td>
</tr>
<tr>
<td>json</td>
<td>224.59</td>
<td>135.43</td>
</tr>
</tbody>
</table>
<p>As expected, the benchmark proves that when targeting the HPy/CPython ABI, HPy
doesn't impose any performance penalty on CPython. The universal version is
~10% slower on CPython, but gives an impressive 3x speedup on PyPy! It it
worth noting that the PyPy hpy module is not fully optimized yet, and we
expect to be able to reach the same performance as CPython for this particular
example (or even more, thanks to our better GC).</p>
<p>All in all, not a bad result for two weeks of intense hacking :)</p>
<p>It is also worth noting than PyPy's builtin <tt class="docutils literal">json</tt> module does <strong>really</strong>
well in this benchmark, thanks to the recent optimizations that were described
in an <a class="reference external" href="../posts/2019/10/pypys-new-json-parser-492911724084305501.html">earlier blog post</a>.</p>
</div>
<div class="section" id="conclusion-and-future-directions">
<h2>Conclusion and future directions</h2>
<p>We think we can be very satisfied about what we have got so far. The
development of HPy is quite new, but these early results seem to indicate that
we are on the right track to bring Python extensions into the future.</p>
<p>At the moment, we can anticipate some of the next steps in the development of
HPy:</p>

<ul class="simple">
<li>Think about a proper API design: what we have done so far has
been a "dumb" translation of the API we needed to run <tt class="docutils literal">ujson</tt>. However,
one of the declared goal of HPy is to improve the design of the API. There
will be a trade-off between the desire of having a clean, fresh new API
and the need to be not too different than the old one, to make porting
easier.  Finding the sweet spot will not be easy!</li>
<li>Implement the "debug" mode, which will help developers to find
bugs such as leaking handles or using invalid handles.</li>
<li>Instruct Cython to emit HPy code on request.</li>
<li>Eventually, we will also want to try to port parts of <tt class="docutils literal">numpy</tt> to HPy to
finally solve the long-standing problem of sub-optimal <tt class="docutils literal">numpy</tt>
performance in PyPy.</li>
</ul>
<p>Stay tuned!</p>

</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-9060317356935549506">
        <div class="comment-header">
          <a name="comment-9060317356935549506"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2019-12-18 16:22</span>:
        </div>
        <div class="comment-content">
          <p>Is HPy going to be C(++)-specific? Will you consider the feasibility of implementing that API in other languages, such as Rust? Extensive usage of macros is something that's more difficult to generate bindings for.</p>
        </div>
      </div>
      <div class="comment comment-14470588976993205">
        <div class="comment-header">
          <a name="comment-14470588976993205"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2019-12-18 19:00</span>:
        </div>
        <div class="comment-content">
          <p>At the moment HPy is two thing:<br><br>- A C API: here the goal is to have something which is easy to write and to migrate from existing C extensions. The macros are mostly needed to overcome limitations of C as a language<br><br>- an ABI: this is independent from C: any language can decide what is the best API to generate extensions compatible with such an ABI</p>
        </div>
      </div>
      <div class="comment comment-1284748987903741642">
        <div class="comment-header">
          <a name="comment-1284748987903741642"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2019-12-18 23:53</span>:
        </div>
        <div class="comment-content">
          <p>This sounds really interesting.<br><br>What does this mean for the future of CFFI?<br></p>
        </div>
      </div>
      <div class="comment comment-2993491145162329141">
        <div class="comment-header">
          <a name="comment-2993491145162329141"></a>
            <span class="author">René Dudfield</span> wrote on <span class="date">2019-12-19 07:41</span>:
        </div>
        <div class="comment-content">
          <p>Great work!<br><br>Especially happy with the consideration of incremental adoption.</p>
        </div>
      </div>
      <div class="comment comment-6341244147736237531">
        <div class="comment-header">
          <a name="comment-6341244147736237531"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2019-12-19 09:35</span>:
        </div>
        <div class="comment-content">
          <p>@Unknown: CFFI solves a different problem, which is how to wrap an existing C library which does not need to manipulate Python objects. As such, it will continue its development independently than HPy, as far as I can see</p>
        </div>
      </div>
      <div class="comment comment-8359903724208048687">
        <div class="comment-header">
          <a name="comment-8359903724208048687"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2019-12-20 08:39</span>:
        </div>
        <div class="comment-content">
          <br>Hi PyPy team, thanks for your great work but I found this:<br><br>import sqlite3<br>print sqlite3.version<br><br>2.6.0<br><br><br>sqlite3 is SQLite 2?<br><br>Any chance of a dot release to bring sqlite3 up to date?
        </div>
      </div>
      <div class="comment comment-7870652435983317508">
        <div class="comment-header">
          <a name="comment-7870652435983317508"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2019-12-20 09:09</span>:
        </div>
        <div class="comment-content">
          <p>import sqlite3<br>print sqlite3.sqlite_version<br><br>D'oh!<br>Sorry about that :-)</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2019/10/pypy-v72-released-1090406556726313495.html" class="u-url">PyPy v7.2 released</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/mattip.html">mattip</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2019/10/pypy-v72-released-1090406556726313495.html" rel="bookmark">
            <time class="published dt-published" datetime="2019-10-14T18:46:00Z" itemprop="datePublished" title="2019-10-14 18:46">2019-10-14 18:46</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <div dir="ltr" style="text-align: left;">
The PyPy team is proud to release the version 7.2.0 of PyPy, which includes
two different interpreters:<br><ul style="text-align: left;">
<li>PyPy2.7, which is an interpreter supporting the syntax and the features of
Python 2.7 including the stdlib for CPython 2.7.13</li>
</ul>
<ul style="text-align: left;">
<li>PyPy3.6: which is an interpreter supporting the syntax and the features of
Python 3.6, including the stdlib for CPython 3.6.9.</li>
</ul>
<blockquote>
<div>
</div>
</blockquote>
The interpreters are based on much the same codebase, thus the double
release.<br><br>
As always, this release is 100% compatible with the previous one and fixed
several issues and bugs raised by the growing community of PyPy users.
We strongly recommend updating. Many of the fixes are the direct result of
end-user bug reports, so please continue reporting issues as they crop up.<br><br>
You can download the v7.2 releases here:<br><blockquote>
<div>
<a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a>
</div>
</blockquote>
With the support of Arm Holdings Ltd. and <a class="reference external" href="https://crossbario.com/">Crossbar.io</a>, this release supports
the 64-bit <code class="docutils literal notranslate"><span class="pre">aarch64</span></code> ARM architecture. More about the work and the
performance data around this welcome development can be found in the <a class="reference external" href="../posts/2019/07/pypy-jit-for-aarch64-7161523403247118006.html">blog
post</a>.<br><br>

This release removes the “beta” tag from PyPy3.6. While there may still be some
small corner-case incompatibilities (around the exact error messages in
exceptions and the handling of faulty codec errorhandlers) we are happy with
the quality of the 3.6 series and are looking forward to working on a Python
3.7 interpreter.<br><br>
We updated our benchmark runner at <a class="reference external" href="https://speed.pypy.org/">https://speed.pypy.org</a> to a more modern
machine and updated the baseline python to CPython 2.7.11. Thanks to <a class="reference external" href="https://baroquesoftware.com/">Baroque
Software</a> for maintaining the benchmark runner.<br><br>
The CFFI-based <code class="docutils literal notranslate"><span class="pre">_ssl</span></code> module was backported to PyPy2.7 and updated to use
<a class="reference external" href="https://cryptography.io/en/latest">cryptography</a> version 2.7. Additionally, the <code class="docutils literal notranslate"><span class="pre">_hashlib</span></code>, and <code class="docutils literal notranslate"><span class="pre">crypt</span></code> (or
<code class="docutils literal notranslate"><span class="pre">_crypt</span></code> on Python3) modules were converted to CFFI. This has two
consequences: end users and packagers can more easily update these libraries
for their platform by executing <code class="docutils literal notranslate"><span class="pre">(cd</span> <span class="pre">lib_pypy;</span> <span class="pre">../bin/pypy</span> <span class="pre">_*_build.py)</span></code>.
More significantly, since PyPy itself links to fewer system shared objects
(DLLs), on platforms with a single runtime namespace like linux, different CFFI
and c-extension modules can load different versions of the same shared object
into PyPy without collision (<a class="reference external" href="https://bitbucket.com/pypy/pypy/issues/2617">issue 2617</a>).<br><br>
Until downstream providers begin to distribute c-extension builds with PyPy, we
have made packages for some common packages <a class="reference external" href="https://github.com/antocuni/pypy-wheels">available as wheels</a>.<br><br>
The <a class="reference external" href="https://cffi.readthedocs.io/">CFFI</a> backend has been updated to version 1.13.0. We recommend using CFFI
rather than c-extensions to interact with C, and <a class="reference external" href="https://cppyy.readthedocs.io/">cppyy</a> for interacting with
C++ code.<br><br>
Thanks to <a class="reference external" href="https://anvil.works/">Anvil</a>, we revived the <a class="reference external" href="../posts/2019/10/posts/2019/08/a-second-life-for-sandbox-6848726729476245390.html">PyPy Sandbox</a>, (soon to be released) which allows total control
over a Python interpreter’s interactions with the external world.<br><br>
We implemented a new JSON decoder that is much faster, uses less memory, and
uses a JIT-friendly specialized dictionary. More about that in the recent <a href="../posts/2019/10/pypys-new-json-parser-492911724084305501.html">blog post</a><br><br>
We would like to thank our donors for the continued support of the PyPy
project. If PyPy is not quite good enough for your needs, we are available for
direct consulting work.
<br>
We would also like to thank our contributors and encourage new people to join
the project. PyPy has many layers and we need help with all of them: <a class="reference external" href="https://pypy.readthedocs.io/en/latest/index.html">PyPy</a>
and <a class="reference external" href="https://rpython.readthedocs.org/">RPython</a> documentation improvements, tweaking popular modules to run
on PyPy, or general <a class="reference external" href="https://pypy.readthedocs.io/en/latest/project-ideas.html">help</a> with making RPython’s JIT even better. Since the
previous release, we have accepted contributions from 27 new contributors,
so thanks for pitching in.<br><br><div class="section" id="what-is-pypy">
<h2 style="text-align: center;">
<span style="font-size: x-large;">What is PyPy?</span>
</h2>
PyPy is a very compliant Python interpreter, almost a drop-in replacement for
CPython 2.7, 3.6. It’s fast (<a class="reference external" href="https://speed.pypy.org/">PyPy and CPython 2.7.x</a> performance
comparison) due to its integrated tracing JIT compiler.<br><br>
We also welcome developers of other <a class="reference external" href="https://rpython.readthedocs.io/en/latest/examples.html">dynamic languages</a> to see what RPython
can do for them.<br><br>
This PyPy release supports:<br><ul style="text-align: left;">
<li>
<strong>x86</strong> machines on most common operating systems
(Linux 32/64 bit, Mac OS X 64-bit, Windows 32-bit, OpenBSD, FreeBSD)</li>
</ul>
</div>
<div class="section" id="what-is-pypy">
<ul style="text-align: left;">
<li>big- and little-endian variants of <strong>PPC64</strong> running Linux<strong> </strong>
</li>
</ul>
</div>
<div class="section" id="what-is-pypy">
<ul style="text-align: left;">
<li>
<strong>s390x</strong> running Linux</li>
</ul>
</div>
<div class="section" id="what-is-pypy">
<ul style="text-align: left;">
<li>64-bit <strong>ARM</strong> machines running Linux</li>
</ul>
<blockquote>
<div>
</div>
</blockquote>
Unfortunately at the moment of writing our ARM buildbots are out of service,
so for now we are <strong>not</strong> releasing any binary for the ARM architecture (32-bit), although PyPy does support ARM 32-bit processors.<br><br><div class="section" id="changelog">
<h2 style="text-align: center;">
<span style="font-size: x-large;">What else is new?</span>
</h2>
PyPy 7.1 was released in March, 2019.
There are many incremental improvements to RPython and PyPy, For more information about the 7.2.0 release, see the full <a href="https://pypy.readthedocs.io/en/latest/release-v7.2.0.html">changelog</a>.<br><br>
Please update, and continue to help us make PyPy better.<br><br>
Cheers,<br>
The PyPy team
</div>
<br><br>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2019/10/pypys-new-json-parser-492911724084305501.html" class="u-url">PyPy's new JSON parser</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2019/10/pypys-new-json-parser-492911724084305501.html" rel="bookmark">
            <time class="published dt-published" datetime="2019-10-08T12:37:00Z" itemprop="datePublished" title="2019-10-08 12:37">2019-10-08 12:37</time></a>
            </p>
                <p class="commentline">4 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <h2>
Introduction</h2>
In the last year or two I have worked on and off on making PyPy's
<a class="reference external" href="https://www.json.org/">JSON</a> faster, particularly when parsing large
JSON files. In this post I am going to document those techniques and
measure their performance impact. Note that I am quite a lot more
constrained in what optimizations I can apply here, compared to some of
the much more advanced approaches like
<a class="reference external" href="https://www.microsoft.com/en-us/research/publication/mison-fast-json-parser-data-analytics/">Mison</a>,
<a class="reference external" href="https://dawn.cs.stanford.edu/2018/08/07/sparser/">Sparser</a> or
<a class="reference external" href="https://arxiv.org/abs/1902.08318">SimdJSON</a> because I don't want to
change the <tt class="docutils literal">json.loads</tt> API that Python programs expect, and because I
don't want to only support CPUs with wide SIMD extensions. With a more
expressive API, more optimizations would be possible.<br>
There are a number of problems of working with huge JSON files:
deserialization takes a long time on the one hand, and the resulting
data structures often take a lot of memory (usually they can be many
times bigger than the size of the file they originated from). Of course
these problems are related, because allocating and initializing a big
data structure takes longer than a smaller data structure. Therefore I
always tried to attack both of these problems at the same time.<br>
One common theme of the techniques I am describing is that of optimizing
the parser for how JSON files are typically used, not how they could
theoretically be used. This is a similar approach to the way dynamic
languages are optimized more generally: most JITs will optimize for
typical patterns of usage, at the cost of less common usage patterns,
which might even become slower as a result of the optimizations.<br><h2>
Maps</h2>
The first technique I investigated is to use maps in the JSON parser.
Maps, also called hidden classes or shapes, are a fairly common way to
(generally, not just in the context of JSON parsing) <a class="reference external" href="../posts/2010/11/efficiently-implementing-python-objects-3838329944323946932.html">optimize instances
of
classes</a>
in dynamic language VMs. Maps exploit the fact that while it is in
theory possible to add arbitrary fields to an instance, in practice most
instances of a class are going to have the same set of fields (or one of
a small number of different sets). Since JSON dictionaries or objects
often come from serialized instances of some kind, this property often
holds in JSON files as well: dictionaries often have the same fields in
the same order, within a JSON file.<br>
This property can be exploited in two ways: on the one hand, it can be
used to again store the deserialized dictionaries in a more memory
efficient way by not using a hashmap in most cases, but instead
splitting the dictionary into a shared description of the set of keys
(the map) and an array of storage with the values. This makes the
deserialized dictionaries smaller if the same set of keys is repeated a
lot. This is completely transparent to the Python programmer, the
dictionary will look completely normal to the Python program but its
internal representation is different.<br>
One downside of using maps is that sometimes files will contain many
dictionaries that have unique key sets. Since maps themselves are quite
large data structures and since dictionaries that use maps contain an
extra level of indirection we want to fall back to using normal hashmaps
to represent the dictionaries where that is the case. To prevent this we
perform some statistics at runtime, how often every map (i.e. set of
keys) is used in the file. For uncommonly used maps, the map is
discarded and the dictionaries that used the map converted into using a
regular hashmap.<br><h3>
Using Maps to Speed up Parsing</h3>
Another benefit of using maps to store deserialized dictionaries is that
we can use them to speed up the parsing process itself. To see how this
works, we need to understand maps a bit better. All the maps produced as
a side-effect of parsing JSON form a tree. The tree root is a map that
describes the object without any attributes. From every tree node we
have a number of edges going to other nodes, each edge for a specific
new attribute added:<br><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="423pt" height="503pt" viewbox="0 0 623 503" version="1.1"><defs><g><symbol overflow="visible" id="glyph0-0"><path style="stroke:none;" d="M 0.640625 2.265625 L 0.640625 -9.015625 L 7.03125 -9.015625 L 7.03125 2.265625 Z M 1.359375 1.546875 L 6.328125 1.546875 L 6.328125 -8.296875 L 1.359375 -8.296875 Z M 1.359375 1.546875 "></path></symbol><symbol overflow="visible" id="glyph0-1"><path style="stroke:none;" d="M 7.1875 -3.78125 L 7.1875 -3.21875 L 1.90625 -3.21875 C 1.957031 -2.425781 2.195312 -1.820312 2.625 -1.40625 C 3.050781 -1 3.644531 -0.796875 4.40625 -0.796875 C 4.84375 -0.796875 5.269531 -0.847656 5.6875 -0.953125 C 6.101562 -1.066406 6.515625 -1.226562 6.921875 -1.4375 L 6.921875 -0.359375 C 6.515625 -0.179688 6.09375 -0.046875 5.65625 0.046875 C 5.21875 0.140625 4.78125 0.1875 4.34375 0.1875 C 3.21875 0.1875 2.328125 -0.132812 1.671875 -0.78125 C 1.023438 -1.4375 0.703125 -2.320312 0.703125 -3.4375 C 0.703125 -4.582031 1.007812 -5.488281 1.625 -6.15625 C 2.25 -6.832031 3.085938 -7.171875 4.140625 -7.171875 C 5.078125 -7.171875 5.816406 -6.863281 6.359375 -6.25 C 6.910156 -5.644531 7.1875 -4.820312 7.1875 -3.78125 Z M 6.046875 -4.125 C 6.035156 -4.75 5.859375 -5.25 5.515625 -5.625 C 5.171875 -6 4.71875 -6.1875 4.15625 -6.1875 C 3.507812 -6.1875 2.992188 -6.003906 2.609375 -5.640625 C 2.222656 -5.285156 2 -4.78125 1.9375 -4.125 Z M 6.046875 -4.125 "></path></symbol><symbol overflow="visible" id="glyph0-2"><path style="stroke:none;" d="M 6.65625 -5.65625 C 6.9375 -6.164062 7.273438 -6.546875 7.671875 -6.796875 C 8.078125 -7.046875 8.550781 -7.171875 9.09375 -7.171875 C 9.820312 -7.171875 10.382812 -6.914062 10.78125 -6.40625 C 11.175781 -5.894531 11.375 -5.164062 11.375 -4.21875 L 11.375 0 L 10.21875 0 L 10.21875 -4.1875 C 10.21875 -4.851562 10.097656 -5.347656 9.859375 -5.671875 C 9.628906 -6.003906 9.269531 -6.171875 8.78125 -6.171875 C 8.1875 -6.171875 7.710938 -5.972656 7.359375 -5.578125 C 7.015625 -5.179688 6.84375 -4.640625 6.84375 -3.953125 L 6.84375 0 L 5.6875 0 L 5.6875 -4.1875 C 5.6875 -4.863281 5.566406 -5.363281 5.328125 -5.6875 C 5.097656 -6.007812 4.734375 -6.171875 4.234375 -6.171875 C 3.648438 -6.171875 3.179688 -5.96875 2.828125 -5.5625 C 2.484375 -5.164062 2.3125 -4.628906 2.3125 -3.953125 L 2.3125 0 L 1.15625 0 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.90625 C 2.582031 -6.332031 2.898438 -6.648438 3.265625 -6.859375 C 3.628906 -7.066406 4.0625 -7.171875 4.5625 -7.171875 C 5.070312 -7.171875 5.503906 -7.039062 5.859375 -6.78125 C 6.222656 -6.519531 6.488281 -6.144531 6.65625 -5.65625 Z M 6.65625 -5.65625 "></path></symbol><symbol overflow="visible" id="glyph0-3"><path style="stroke:none;" d="M 2.3125 -1.046875 L 2.3125 2.65625 L 1.15625 2.65625 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.9375 C 2.5625 -6.351562 2.867188 -6.660156 3.234375 -6.859375 C 3.597656 -7.066406 4.039062 -7.171875 4.5625 -7.171875 C 5.40625 -7.171875 6.09375 -6.832031 6.625 -6.15625 C 7.15625 -5.476562 7.421875 -4.59375 7.421875 -3.5 C 7.421875 -2.394531 7.15625 -1.503906 6.625 -0.828125 C 6.09375 -0.148438 5.40625 0.1875 4.5625 0.1875 C 4.039062 0.1875 3.597656 0.0859375 3.234375 -0.109375 C 2.867188 -0.316406 2.5625 -0.628906 2.3125 -1.046875 Z M 6.234375 -3.5 C 6.234375 -4.34375 6.054688 -5.003906 5.703125 -5.484375 C 5.359375 -5.960938 4.882812 -6.203125 4.28125 -6.203125 C 3.664062 -6.203125 3.179688 -5.960938 2.828125 -5.484375 C 2.484375 -5.003906 2.3125 -4.34375 2.3125 -3.5 C 2.3125 -2.644531 2.484375 -1.976562 2.828125 -1.5 C 3.179688 -1.019531 3.664062 -0.78125 4.28125 -0.78125 C 4.882812 -0.78125 5.359375 -1.019531 5.703125 -1.5 C 6.054688 -1.976562 6.234375 -2.644531 6.234375 -3.5 Z M 6.234375 -3.5 "></path></symbol><symbol overflow="visible" id="glyph0-4"><path style="stroke:none;" d="M 2.34375 -8.984375 L 2.34375 -7 L 4.71875 -7 L 4.71875 -6.109375 L 2.34375 -6.109375 L 2.34375 -2.3125 C 2.34375 -1.738281 2.421875 -1.367188 2.578125 -1.203125 C 2.734375 -1.046875 3.050781 -0.96875 3.53125 -0.96875 L 4.71875 -0.96875 L 4.71875 0 L 3.53125 0 C 2.644531 0 2.03125 -0.164062 1.6875 -0.5 C 1.351562 -0.832031 1.1875 -1.4375 1.1875 -2.3125 L 1.1875 -6.109375 L 0.34375 -6.109375 L 0.34375 -7 L 1.1875 -7 L 1.1875 -8.984375 Z M 2.34375 -8.984375 "></path></symbol><symbol overflow="visible" id="glyph0-5"><path style="stroke:none;" d="M 4.125 0.65625 C 3.789062 1.488281 3.46875 2.03125 3.15625 2.28125 C 2.851562 2.53125 2.445312 2.65625 1.9375 2.65625 L 1.015625 2.65625 L 1.015625 1.703125 L 1.6875 1.703125 C 2 1.703125 2.242188 1.625 2.421875 1.46875 C 2.597656 1.320312 2.789062 0.96875 3 0.40625 L 3.21875 -0.109375 L 0.375 -7 L 1.59375 -7 L 3.78125 -1.53125 L 5.96875 -7 L 7.1875 -7 Z M 4.125 0.65625 "></path></symbol><symbol overflow="visible" id="glyph0-6"><path style="stroke:none;" d="M 4.390625 -3.515625 C 3.460938 -3.515625 2.816406 -3.40625 2.453125 -3.1875 C 2.097656 -2.976562 1.921875 -2.617188 1.921875 -2.109375 C 1.921875 -1.703125 2.050781 -1.378906 2.3125 -1.140625 C 2.582031 -0.898438 2.953125 -0.78125 3.421875 -0.78125 C 4.054688 -0.78125 4.566406 -1.003906 4.953125 -1.453125 C 5.335938 -1.910156 5.53125 -2.515625 5.53125 -3.265625 L 5.53125 -3.515625 Z M 6.671875 -4 L 6.671875 0 L 5.53125 0 L 5.53125 -1.0625 C 5.269531 -0.632812 4.941406 -0.316406 4.546875 -0.109375 C 4.160156 0.0859375 3.679688 0.1875 3.109375 0.1875 C 2.390625 0.1875 1.816406 -0.015625 1.390625 -0.421875 C 0.972656 -0.828125 0.765625 -1.363281 0.765625 -2.03125 C 0.765625 -2.820312 1.023438 -3.414062 1.546875 -3.8125 C 2.078125 -4.21875 2.867188 -4.421875 3.921875 -4.421875 L 5.53125 -4.421875 L 5.53125 -4.53125 C 5.53125 -5.0625 5.351562 -5.46875 5 -5.75 C 4.65625 -6.039062 4.171875 -6.1875 3.546875 -6.1875 C 3.140625 -6.1875 2.75 -6.140625 2.375 -6.046875 C 2 -5.953125 1.632812 -5.8125 1.28125 -5.625 L 1.28125 -6.671875 C 1.695312 -6.835938 2.101562 -6.960938 2.5 -7.046875 C 2.894531 -7.128906 3.28125 -7.171875 3.65625 -7.171875 C 4.675781 -7.171875 5.429688 -6.90625 5.921875 -6.375 C 6.421875 -5.851562 6.671875 -5.0625 6.671875 -4 Z M 6.671875 -4 "></path></symbol><symbol overflow="visible" id="glyph0-7"><path style="stroke:none;" d="M 5.8125 -5.9375 L 5.8125 -9.71875 L 6.953125 -9.71875 L 6.953125 0 L 5.8125 0 L 5.8125 -1.046875 C 5.570312 -0.628906 5.265625 -0.316406 4.890625 -0.109375 C 4.523438 0.0859375 4.082031 0.1875 3.5625 0.1875 C 2.71875 0.1875 2.03125 -0.148438 1.5 -0.828125 C 0.96875 -1.503906 0.703125 -2.394531 0.703125 -3.5 C 0.703125 -4.59375 0.96875 -5.476562 1.5 -6.15625 C 2.03125 -6.832031 2.71875 -7.171875 3.5625 -7.171875 C 4.082031 -7.171875 4.523438 -7.066406 4.890625 -6.859375 C 5.265625 -6.660156 5.570312 -6.351562 5.8125 -5.9375 Z M 1.890625 -3.5 C 1.890625 -2.644531 2.0625 -1.976562 2.40625 -1.5 C 2.757812 -1.019531 3.238281 -0.78125 3.84375 -0.78125 C 4.457031 -0.78125 4.9375 -1.019531 5.28125 -1.5 C 5.632812 -1.976562 5.8125 -2.644531 5.8125 -3.5 C 5.8125 -4.34375 5.632812 -5.003906 5.28125 -5.484375 C 4.9375 -5.960938 4.457031 -6.203125 3.84375 -6.203125 C 3.238281 -6.203125 2.757812 -5.960938 2.40625 -5.484375 C 2.0625 -5.003906 1.890625 -4.34375 1.890625 -3.5 Z M 1.890625 -3.5 "></path></symbol><symbol overflow="visible" id="glyph0-8"><path style="stroke:none;" d=""></path></symbol><symbol overflow="visible" id="glyph0-9"><path style="stroke:none;" d="M 1.5 -1.59375 L 2.8125 -1.59375 L 2.8125 -0.515625 L 1.796875 1.484375 L 0.984375 1.484375 L 1.5 -0.515625 Z M 1.5 -1.59375 "></path></symbol><symbol overflow="visible" id="glyph0-10"><path style="stroke:none;" d="M 6.234375 -3.5 C 6.234375 -4.34375 6.054688 -5.003906 5.703125 -5.484375 C 5.359375 -5.960938 4.882812 -6.203125 4.28125 -6.203125 C 3.664062 -6.203125 3.179688 -5.960938 2.828125 -5.484375 C 2.484375 -5.003906 2.3125 -4.34375 2.3125 -3.5 C 2.3125 -2.644531 2.484375 -1.976562 2.828125 -1.5 C 3.179688 -1.019531 3.664062 -0.78125 4.28125 -0.78125 C 4.882812 -0.78125 5.359375 -1.019531 5.703125 -1.5 C 6.054688 -1.976562 6.234375 -2.644531 6.234375 -3.5 Z M 2.3125 -5.9375 C 2.5625 -6.351562 2.867188 -6.660156 3.234375 -6.859375 C 3.597656 -7.066406 4.039062 -7.171875 4.5625 -7.171875 C 5.40625 -7.171875 6.09375 -6.832031 6.625 -6.15625 C 7.15625 -5.476562 7.421875 -4.59375 7.421875 -3.5 C 7.421875 -2.394531 7.15625 -1.503906 6.625 -0.828125 C 6.09375 -0.148438 5.40625 0.1875 4.5625 0.1875 C 4.039062 0.1875 3.597656 0.0859375 3.234375 -0.109375 C 2.867188 -0.316406 2.5625 -0.628906 2.3125 -1.046875 L 2.3125 0 L 1.15625 0 L 1.15625 -9.71875 L 2.3125 -9.71875 Z M 2.3125 -5.9375 "></path></symbol><symbol overflow="visible" id="glyph0-11"><path style="stroke:none;" d="M 6.25 -6.734375 L 6.25 -5.65625 C 5.914062 -5.832031 5.585938 -5.960938 5.265625 -6.046875 C 4.941406 -6.140625 4.613281 -6.1875 4.28125 -6.1875 C 3.53125 -6.1875 2.945312 -5.953125 2.53125 -5.484375 C 2.125 -5.015625 1.921875 -4.351562 1.921875 -3.5 C 1.921875 -2.644531 2.125 -1.976562 2.53125 -1.5 C 2.945312 -1.03125 3.53125 -0.796875 4.28125 -0.796875 C 4.613281 -0.796875 4.941406 -0.835938 5.265625 -0.921875 C 5.585938 -1.015625 5.914062 -1.148438 6.25 -1.328125 L 6.25 -0.265625 C 5.925781 -0.117188 5.59375 -0.0078125 5.25 0.0625 C 4.90625 0.144531 4.539062 0.1875 4.15625 0.1875 C 3.09375 0.1875 2.25 -0.144531 1.625 -0.8125 C 1.007812 -1.476562 0.703125 -2.375 0.703125 -3.5 C 0.703125 -4.632812 1.015625 -5.53125 1.640625 -6.1875 C 2.273438 -6.84375 3.132812 -7.171875 4.21875 -7.171875 C 4.570312 -7.171875 4.914062 -7.132812 5.25 -7.0625 C 5.59375 -6.988281 5.925781 -6.878906 6.25 -6.734375 Z M 6.25 -6.734375 "></path></symbol><symbol overflow="visible" id="glyph0-12"><path style="stroke:none;" d="M 4.75 -9.71875 L 4.75 -8.765625 L 3.65625 -8.765625 C 3.238281 -8.765625 2.945312 -8.679688 2.78125 -8.515625 C 2.625 -8.347656 2.546875 -8.046875 2.546875 -7.609375 L 2.546875 -7 L 4.4375 -7 L 4.4375 -6.109375 L 2.546875 -6.109375 L 2.546875 0 L 1.390625 0 L 1.390625 -6.109375 L 0.296875 -6.109375 L 0.296875 -7 L 1.390625 -7 L 1.390625 -7.484375 C 1.390625 -8.265625 1.570312 -8.832031 1.9375 -9.1875 C 2.300781 -9.539062 2.875 -9.71875 3.65625 -9.71875 Z M 4.75 -9.71875 "></path></symbol><symbol overflow="visible" id="glyph0-13"><path style="stroke:none;" d="M 7.015625 -7 L 4.5 -3.59375 L 7.15625 0 L 5.796875 0 L 3.765625 -2.75 L 1.71875 0 L 0.375 0 L 3.09375 -3.65625 L 0.59375 -7 L 1.953125 -7 L 3.8125 -4.5 L 5.671875 -7 Z M 7.015625 -7 "></path></symbol><symbol overflow="visible" id="glyph0-14"><path style="stroke:none;" d="M 3.921875 -6.1875 C 3.304688 -6.1875 2.816406 -5.945312 2.453125 -5.46875 C 2.097656 -4.988281 1.921875 -4.332031 1.921875 -3.5 C 1.921875 -2.65625 2.097656 -1.992188 2.453125 -1.515625 C 2.804688 -1.035156 3.296875 -0.796875 3.921875 -0.796875 C 4.535156 -0.796875 5.019531 -1.035156 5.375 -1.515625 C 5.726562 -2.003906 5.90625 -2.664062 5.90625 -3.5 C 5.90625 -4.320312 5.726562 -4.972656 5.375 -5.453125 C 5.019531 -5.941406 4.535156 -6.1875 3.921875 -6.1875 Z M 3.921875 -7.171875 C 4.921875 -7.171875 5.703125 -6.84375 6.265625 -6.1875 C 6.835938 -5.539062 7.125 -4.644531 7.125 -3.5 C 7.125 -2.351562 6.835938 -1.453125 6.265625 -0.796875 C 5.703125 -0.140625 4.921875 0.1875 3.921875 0.1875 C 2.910156 0.1875 2.117188 -0.140625 1.546875 -0.796875 C 0.984375 -1.453125 0.703125 -2.351562 0.703125 -3.5 C 0.703125 -4.644531 0.984375 -5.539062 1.546875 -6.1875 C 2.117188 -6.84375 2.910156 -7.171875 3.921875 -7.171875 Z M 3.921875 -7.171875 "></path></symbol><symbol overflow="visible" id="glyph0-15"><path style="stroke:none;" d="M 7.015625 -4.21875 L 7.015625 0 L 5.875 0 L 5.875 -4.1875 C 5.875 -4.851562 5.742188 -5.347656 5.484375 -5.671875 C 5.222656 -6.003906 4.835938 -6.171875 4.328125 -6.171875 C 3.703125 -6.171875 3.207031 -5.972656 2.84375 -5.578125 C 2.488281 -5.179688 2.3125 -4.640625 2.3125 -3.953125 L 2.3125 0 L 1.15625 0 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.90625 C 2.59375 -6.332031 2.914062 -6.648438 3.28125 -6.859375 C 3.65625 -7.066406 4.085938 -7.171875 4.578125 -7.171875 C 5.378906 -7.171875 5.984375 -6.921875 6.390625 -6.421875 C 6.804688 -5.921875 7.015625 -5.1875 7.015625 -4.21875 Z M 7.015625 -4.21875 "></path></symbol><symbol overflow="visible" id="glyph0-16"><path style="stroke:none;" d="M 5.265625 -5.921875 C 5.128906 -5.992188 4.984375 -6.046875 4.828125 -6.078125 C 4.679688 -6.117188 4.519531 -6.140625 4.34375 -6.140625 C 3.6875 -6.140625 3.179688 -5.925781 2.828125 -5.5 C 2.484375 -5.082031 2.3125 -4.476562 2.3125 -3.6875 L 2.3125 0 L 1.15625 0 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.90625 C 2.5625 -6.332031 2.878906 -6.648438 3.265625 -6.859375 C 3.648438 -7.066406 4.117188 -7.171875 4.671875 -7.171875 C 4.753906 -7.171875 4.84375 -7.164062 4.9375 -7.15625 C 5.03125 -7.144531 5.132812 -7.128906 5.25 -7.109375 Z M 5.265625 -5.921875 "></path></symbol><symbol overflow="visible" id="glyph0-17"><path style="stroke:none;" d="M 5.671875 -6.796875 L 5.671875 -5.703125 C 5.347656 -5.867188 5.007812 -5.992188 4.65625 -6.078125 C 4.300781 -6.160156 3.9375 -6.203125 3.5625 -6.203125 C 3 -6.203125 2.570312 -6.113281 2.28125 -5.9375 C 2 -5.769531 1.859375 -5.507812 1.859375 -5.15625 C 1.859375 -4.882812 1.957031 -4.671875 2.15625 -4.515625 C 2.363281 -4.367188 2.773438 -4.226562 3.390625 -4.09375 L 3.78125 -4 C 4.601562 -3.832031 5.1875 -3.585938 5.53125 -3.265625 C 5.875 -2.941406 6.046875 -2.5 6.046875 -1.9375 C 6.046875 -1.28125 5.785156 -0.757812 5.265625 -0.375 C 4.753906 0 4.050781 0.1875 3.15625 0.1875 C 2.78125 0.1875 2.390625 0.148438 1.984375 0.078125 C 1.578125 0.00390625 1.144531 -0.101562 0.6875 -0.25 L 0.6875 -1.4375 C 1.113281 -1.21875 1.53125 -1.050781 1.9375 -0.9375 C 2.351562 -0.832031 2.765625 -0.78125 3.171875 -0.78125 C 3.710938 -0.78125 4.128906 -0.875 4.421875 -1.0625 C 4.710938 -1.25 4.859375 -1.507812 4.859375 -1.84375 C 4.859375 -2.15625 4.753906 -2.394531 4.546875 -2.5625 C 4.335938 -2.726562 3.875 -2.890625 3.15625 -3.046875 L 2.765625 -3.140625 C 2.046875 -3.285156 1.53125 -3.515625 1.21875 -3.828125 C 0.90625 -4.140625 0.75 -4.566406 0.75 -5.109375 C 0.75 -5.765625 0.976562 -6.269531 1.4375 -6.625 C 1.90625 -6.988281 2.570312 -7.171875 3.4375 -7.171875 C 3.851562 -7.171875 4.25 -7.140625 4.625 -7.078125 C 5 -7.015625 5.347656 -6.921875 5.671875 -6.796875 Z M 5.671875 -6.796875 "></path></symbol><symbol overflow="visible" id="glyph0-18"><path style="stroke:none;" d="M 1.203125 -7 L 2.359375 -7 L 2.359375 0 L 1.203125 0 Z M 1.203125 -9.71875 L 2.359375 -9.71875 L 2.359375 -8.265625 L 1.203125 -8.265625 Z M 1.203125 -9.71875 "></path></symbol><symbol overflow="visible" id="glyph0-19"><path style="stroke:none;" d="M 1.203125 -9.71875 L 2.359375 -9.71875 L 2.359375 0 L 1.203125 0 Z M 1.203125 -9.71875 "></path></symbol><symbol overflow="visible" id="glyph1-0"><path style="stroke:none;" d="M 1.078125 3.84375 L 1.078125 -15.359375 L 11.96875 -15.359375 L 11.96875 3.84375 Z M 2.3125 2.640625 L 10.765625 2.640625 L 10.765625 -14.140625 L 2.3125 -14.140625 Z M 2.3125 2.640625 "></path></symbol><symbol overflow="visible" id="glyph1-1"><path style="stroke:none;" d="M 2.140625 -15.875 L 12.171875 -15.875 L 12.171875 -14.078125 L 4.28125 -14.078125 L 4.28125 -9.375 L 11.84375 -9.375 L 11.84375 -7.5625 L 4.28125 -7.5625 L 4.28125 -1.8125 L 12.375 -1.8125 L 12.375 0 L 2.140625 0 Z M 2.140625 -15.875 "></path></symbol><symbol overflow="visible" id="glyph1-2"><path style="stroke:none;" d="M 11.953125 -11.90625 L 7.640625 -6.109375 L 12.171875 0 L 9.875 0 L 6.40625 -4.671875 L 2.9375 0 L 0.625 0 L 5.25 -6.234375 L 1.015625 -11.90625 L 3.328125 -11.90625 L 6.484375 -7.671875 L 9.640625 -11.90625 Z M 11.953125 -11.90625 "></path></symbol><symbol overflow="visible" id="glyph1-3"><path style="stroke:none;" d="M 7.46875 -5.984375 C 5.882812 -5.984375 4.785156 -5.800781 4.171875 -5.4375 C 3.566406 -5.082031 3.265625 -4.46875 3.265625 -3.59375 C 3.265625 -2.894531 3.492188 -2.34375 3.953125 -1.9375 C 4.410156 -1.53125 5.03125 -1.328125 5.8125 -1.328125 C 6.894531 -1.328125 7.765625 -1.710938 8.421875 -2.484375 C 9.078125 -3.253906 9.40625 -4.273438 9.40625 -5.546875 L 9.40625 -5.984375 Z M 11.375 -6.796875 L 11.375 0 L 9.40625 0 L 9.40625 -1.8125 C 8.96875 -1.082031 8.414062 -0.546875 7.75 -0.203125 C 7.082031 0.140625 6.265625 0.3125 5.296875 0.3125 C 4.078125 0.3125 3.109375 -0.03125 2.390625 -0.71875 C 1.671875 -1.40625 1.3125 -2.320312 1.3125 -3.46875 C 1.3125 -4.8125 1.757812 -5.820312 2.65625 -6.5 C 3.550781 -7.175781 4.890625 -7.515625 6.671875 -7.515625 L 9.40625 -7.515625 L 9.40625 -7.703125 C 9.40625 -8.609375 9.109375 -9.304688 8.515625 -9.796875 C 7.929688 -10.296875 7.101562 -10.546875 6.03125 -10.546875 C 5.351562 -10.546875 4.691406 -10.460938 4.046875 -10.296875 C 3.398438 -10.128906 2.78125 -9.882812 2.1875 -9.5625 L 2.1875 -11.375 C 2.894531 -11.644531 3.585938 -11.847656 4.265625 -11.984375 C 4.941406 -12.128906 5.597656 -12.203125 6.234375 -12.203125 C 7.953125 -12.203125 9.238281 -11.753906 10.09375 -10.859375 C 10.945312 -9.960938 11.375 -8.609375 11.375 -6.796875 Z M 11.375 -6.796875 "></path></symbol><symbol overflow="visible" id="glyph1-4"><path style="stroke:none;" d="M 11.328125 -9.625 C 11.816406 -10.5 12.398438 -11.144531 13.078125 -11.5625 C 13.765625 -11.988281 14.566406 -12.203125 15.484375 -12.203125 C 16.722656 -12.203125 17.675781 -11.765625 18.34375 -10.890625 C 19.019531 -10.023438 19.359375 -8.789062 19.359375 -7.1875 L 19.359375 0 L 17.40625 0 L 17.40625 -7.125 C 17.40625 -8.269531 17.203125 -9.117188 16.796875 -9.671875 C 16.390625 -10.222656 15.769531 -10.5 14.9375 -10.5 C 13.925781 -10.5 13.125 -10.160156 12.53125 -9.484375 C 11.945312 -8.804688 11.65625 -7.890625 11.65625 -6.734375 L 11.65625 0 L 9.6875 0 L 9.6875 -7.125 C 9.6875 -8.269531 9.484375 -9.117188 9.078125 -9.671875 C 8.671875 -10.222656 8.046875 -10.5 7.203125 -10.5 C 6.210938 -10.5 5.421875 -10.160156 4.828125 -9.484375 C 4.242188 -8.804688 3.953125 -7.890625 3.953125 -6.734375 L 3.953125 0 L 1.984375 0 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.0625 C 4.390625 -10.789062 4.921875 -11.328125 5.546875 -11.671875 C 6.171875 -12.023438 6.914062 -12.203125 7.78125 -12.203125 C 8.644531 -12.203125 9.378906 -11.976562 9.984375 -11.53125 C 10.585938 -11.09375 11.035156 -10.457031 11.328125 -9.625 Z M 11.328125 -9.625 "></path></symbol><symbol overflow="visible" id="glyph1-5"><path style="stroke:none;" d="M 3.953125 -1.78125 L 3.953125 4.53125 L 1.984375 4.53125 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.109375 C 4.359375 -10.816406 4.875 -11.34375 5.5 -11.6875 C 6.125 -12.03125 6.875 -12.203125 7.75 -12.203125 C 9.195312 -12.203125 10.375 -11.625 11.28125 -10.46875 C 12.1875 -9.320312 12.640625 -7.8125 12.640625 -5.9375 C 12.640625 -4.070312 12.1875 -2.5625 11.28125 -1.40625 C 10.375 -0.257812 9.195312 0.3125 7.75 0.3125 C 6.875 0.3125 6.125 0.140625 5.5 -0.203125 C 4.875 -0.546875 4.359375 -1.070312 3.953125 -1.78125 Z M 10.609375 -5.9375 C 10.609375 -7.382812 10.3125 -8.515625 9.71875 -9.328125 C 9.125 -10.148438 8.3125 -10.5625 7.28125 -10.5625 C 6.238281 -10.5625 5.421875 -10.148438 4.828125 -9.328125 C 4.242188 -8.515625 3.953125 -7.382812 3.953125 -5.9375 C 3.953125 -4.5 4.242188 -3.367188 4.828125 -2.546875 C 5.421875 -1.734375 6.238281 -1.328125 7.28125 -1.328125 C 8.3125 -1.328125 9.125 -1.734375 9.71875 -2.546875 C 10.3125 -3.367188 10.609375 -4.5 10.609375 -5.9375 Z M 10.609375 -5.9375 "></path></symbol><symbol overflow="visible" id="glyph1-6"><path style="stroke:none;" d="M 2.046875 -16.546875 L 4.015625 -16.546875 L 4.015625 0 L 2.046875 0 Z M 2.046875 -16.546875 "></path></symbol><symbol overflow="visible" id="glyph1-7"><path style="stroke:none;" d="M 12.234375 -6.4375 L 12.234375 -5.484375 L 3.25 -5.484375 C 3.332031 -4.140625 3.734375 -3.113281 4.453125 -2.40625 C 5.179688 -1.695312 6.195312 -1.34375 7.5 -1.34375 C 8.25 -1.34375 8.972656 -1.4375 9.671875 -1.625 C 10.378906 -1.8125 11.082031 -2.085938 11.78125 -2.453125 L 11.78125 -0.609375 C 11.082031 -0.304688 10.363281 -0.078125 9.625 0.078125 C 8.882812 0.234375 8.132812 0.3125 7.375 0.3125 C 5.476562 0.3125 3.972656 -0.238281 2.859375 -1.34375 C 1.753906 -2.457031 1.203125 -3.957031 1.203125 -5.84375 C 1.203125 -7.789062 1.726562 -9.335938 2.78125 -10.484375 C 3.832031 -11.628906 5.253906 -12.203125 7.046875 -12.203125 C 8.640625 -12.203125 9.898438 -11.6875 10.828125 -10.65625 C 11.765625 -9.625 12.234375 -8.21875 12.234375 -6.4375 Z M 10.28125 -7.015625 C 10.269531 -8.085938 9.972656 -8.941406 9.390625 -9.578125 C 8.804688 -10.222656 8.03125 -10.546875 7.0625 -10.546875 C 5.96875 -10.546875 5.09375 -10.234375 4.4375 -9.609375 C 3.78125 -8.992188 3.40625 -8.128906 3.3125 -7.015625 Z M 10.28125 -7.015625 "></path></symbol><symbol overflow="visible" id="glyph1-8"><path style="stroke:none;" d=""></path></symbol><symbol overflow="visible" id="glyph1-9"><path style="stroke:none;" d="M 3.984375 -15.296875 L 3.984375 -11.90625 L 8.015625 -11.90625 L 8.015625 -10.390625 L 3.984375 -10.390625 L 3.984375 -3.921875 C 3.984375 -2.953125 4.113281 -2.328125 4.375 -2.046875 C 4.644531 -1.773438 5.191406 -1.640625 6.015625 -1.640625 L 8.015625 -1.640625 L 8.015625 0 L 6.015625 0 C 4.503906 0 3.457031 -0.28125 2.875 -0.84375 C 2.300781 -1.40625 2.015625 -2.429688 2.015625 -3.921875 L 2.015625 -10.390625 L 0.578125 -10.390625 L 0.578125 -11.90625 L 2.015625 -11.90625 L 2.015625 -15.296875 Z M 3.984375 -15.296875 "></path></symbol><symbol overflow="visible" id="glyph1-10"><path style="stroke:none;" d="M 8.953125 -10.078125 C 8.734375 -10.210938 8.492188 -10.304688 8.234375 -10.359375 C 7.972656 -10.421875 7.6875 -10.453125 7.375 -10.453125 C 6.269531 -10.453125 5.421875 -10.09375 4.828125 -9.375 C 4.242188 -8.65625 3.953125 -7.625 3.953125 -6.28125 L 3.953125 0 L 1.984375 0 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.0625 C 4.359375 -10.78125 4.890625 -11.316406 5.546875 -11.671875 C 6.210938 -12.023438 7.015625 -12.203125 7.953125 -12.203125 C 8.085938 -12.203125 8.234375 -12.191406 8.390625 -12.171875 C 8.554688 -12.148438 8.738281 -12.125 8.9375 -12.09375 Z M 8.953125 -10.078125 "></path></symbol><symbol overflow="visible" id="glyph1-11"><path style="stroke:none;" d="M 11.953125 -7.1875 L 11.953125 0 L 10 0 L 10 -7.125 C 10 -8.25 9.773438 -9.09375 9.328125 -9.65625 C 8.890625 -10.21875 8.234375 -10.5 7.359375 -10.5 C 6.304688 -10.5 5.472656 -10.160156 4.859375 -9.484375 C 4.253906 -8.804688 3.953125 -7.890625 3.953125 -6.734375 L 3.953125 0 L 1.984375 0 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.0625 C 4.410156 -10.78125 4.957031 -11.316406 5.59375 -11.671875 C 6.226562 -12.023438 6.960938 -12.203125 7.796875 -12.203125 C 9.160156 -12.203125 10.191406 -11.773438 10.890625 -10.921875 C 11.597656 -10.078125 11.953125 -8.832031 11.953125 -7.1875 Z M 11.953125 -7.1875 "></path></symbol><symbol overflow="visible" id="glyph1-12"><path style="stroke:none;" d="M 9.640625 -11.5625 L 9.640625 -9.703125 C 9.085938 -9.992188 8.515625 -10.207031 7.921875 -10.34375 C 7.328125 -10.488281 6.710938 -10.5625 6.078125 -10.5625 C 5.097656 -10.5625 4.363281 -10.410156 3.875 -10.109375 C 3.394531 -9.816406 3.15625 -9.375 3.15625 -8.78125 C 3.15625 -8.320312 3.328125 -7.960938 3.671875 -7.703125 C 4.023438 -7.441406 4.726562 -7.195312 5.78125 -6.96875 L 6.4375 -6.8125 C 7.832031 -6.519531 8.820312 -6.101562 9.40625 -5.5625 C 9.988281 -5.019531 10.28125 -4.257812 10.28125 -3.28125 C 10.28125 -2.175781 9.84375 -1.300781 8.96875 -0.65625 C 8.09375 -0.0078125 6.890625 0.3125 5.359375 0.3125 C 4.722656 0.3125 4.054688 0.25 3.359375 0.125 C 2.671875 0 1.945312 -0.1875 1.1875 -0.4375 L 1.1875 -2.453125 C 1.90625 -2.078125 2.613281 -1.796875 3.3125 -1.609375 C 4.019531 -1.421875 4.71875 -1.328125 5.40625 -1.328125 C 6.320312 -1.328125 7.03125 -1.484375 7.53125 -1.796875 C 8.03125 -2.117188 8.28125 -2.566406 8.28125 -3.140625 C 8.28125 -3.671875 8.097656 -4.078125 7.734375 -4.359375 C 7.378906 -4.640625 6.59375 -4.910156 5.375 -5.171875 L 4.703125 -5.34375 C 3.484375 -5.59375 2.601562 -5.984375 2.0625 -6.515625 C 1.53125 -7.046875 1.265625 -7.769531 1.265625 -8.6875 C 1.265625 -9.8125 1.660156 -10.675781 2.453125 -11.28125 C 3.242188 -11.894531 4.375 -12.203125 5.84375 -12.203125 C 6.5625 -12.203125 7.238281 -12.144531 7.875 -12.03125 C 8.519531 -11.925781 9.109375 -11.769531 9.640625 -11.5625 Z M 9.640625 -11.5625 "></path></symbol><symbol overflow="visible" id="glyph1-13"><path style="stroke:none;" d="M 2.046875 -11.90625 L 4.015625 -11.90625 L 4.015625 0 L 2.046875 0 Z M 2.046875 -16.546875 L 4.015625 -16.546875 L 4.015625 -14.078125 L 2.046875 -14.078125 Z M 2.046875 -16.546875 "></path></symbol><symbol overflow="visible" id="glyph1-14"><path style="stroke:none;" d="M 6.671875 -10.546875 C 5.617188 -10.546875 4.785156 -10.132812 4.171875 -9.3125 C 3.566406 -8.488281 3.265625 -7.363281 3.265625 -5.9375 C 3.265625 -4.519531 3.566406 -3.398438 4.171875 -2.578125 C 4.773438 -1.753906 5.609375 -1.34375 6.671875 -1.34375 C 7.710938 -1.34375 8.535156 -1.753906 9.140625 -2.578125 C 9.753906 -3.398438 10.0625 -4.519531 10.0625 -5.9375 C 10.0625 -7.351562 9.753906 -8.472656 9.140625 -9.296875 C 8.535156 -10.128906 7.710938 -10.546875 6.671875 -10.546875 Z M 6.671875 -12.203125 C 8.367188 -12.203125 9.703125 -11.644531 10.671875 -10.53125 C 11.648438 -9.425781 12.140625 -7.894531 12.140625 -5.9375 C 12.140625 -3.988281 11.648438 -2.457031 10.671875 -1.34375 C 9.703125 -0.238281 8.367188 0.3125 6.671875 0.3125 C 4.960938 0.3125 3.625 -0.238281 2.65625 -1.34375 C 1.6875 -2.457031 1.203125 -3.988281 1.203125 -5.9375 C 1.203125 -7.894531 1.6875 -9.425781 2.65625 -10.53125 C 3.625 -11.644531 4.960938 -12.203125 6.671875 -12.203125 Z M 6.671875 -12.203125 "></path></symbol></g></defs><g id="surface53632"><rect x="0" y="0" width="623" height="503" style="fill:rgb(100%,100%,100%);fill-opacity:1;stroke:none;"></rect><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 21 3 L 29 3 L 29 5 L 21 5 Z M 21 3 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-1" x="381.472656" y="65.154405"></use><use xlink:href="#glyph0-2" x="389.347548" y="65.154405"></use><use xlink:href="#glyph0-3" x="401.816081" y="65.154405"></use><use xlink:href="#glyph0-4" x="409.941081" y="65.154405"></use><use xlink:href="#glyph0-5" x="414.959798" y="65.154405"></use></g><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 14 10 L 22 10 L 22 12 L 14 12 Z M 14 10 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="258.09375" y="205.154405"></use></g><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 25 5 L 18.396094 9.716992 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 18.091016 9.934961 L 18.352539 9.441016 L 18.396094 9.716992 L 18.643164 9.847852 Z M 18.091016 9.934961 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="302" y="121.255968"></use><use xlink:href="#glyph0-7" x="309.843696" y="121.255968"></use><use xlink:href="#glyph0-7" x="317.968696" y="121.255968"></use><use xlink:href="#glyph0-8" x="326.093696" y="121.255968"></use><use xlink:href="#glyph0-6" x="330.162435" y="121.255968"></use></g><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 14 17 L 22 17 L 22 19 L 14 19 Z M 14 17 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="249.949219" y="345.154405"></use><use xlink:href="#glyph0-9" x="257.792914" y="345.154405"></use><use xlink:href="#glyph0-8" x="261.861654" y="345.154405"></use><use xlink:href="#glyph0-10" x="265.930393" y="345.154405"></use></g><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 21 24 L 29 24 L 29 26 L 21 26 Z M 21 24 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="382.371094" y="485.154405"></use><use xlink:href="#glyph0-9" x="390.214789" y="485.154405"></use><use xlink:href="#glyph0-8" x="394.283529" y="485.154405"></use><use xlink:href="#glyph0-10" x="398.352268" y="485.154405"></use><use xlink:href="#glyph0-9" x="406.477268" y="485.154405"></use><use xlink:href="#glyph0-8" x="410.546007" y="485.154405"></use><use xlink:href="#glyph0-11" x="414.614746" y="485.154405"></use></g><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 8 24 L 16 24 L 16 26 L 8 26 Z M 8 24 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="123.640625" y="485.154405"></use><use xlink:href="#glyph0-9" x="131.484321" y="485.154405"></use><use xlink:href="#glyph0-8" x="135.55306" y="485.154405"></use><use xlink:href="#glyph0-10" x="139.621799" y="485.154405"></use><use xlink:href="#glyph0-9" x="147.746799" y="485.154405"></use><use xlink:href="#glyph0-8" x="151.815538" y="485.154405"></use><use xlink:href="#glyph0-12" x="155.884277" y="485.154405"></use></g><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 18 12 L 18 16.513281 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 18 16.888281 L 17.75 16.388281 L 18 16.513281 L 18.25 16.388281 Z M 18 16.888281 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-dasharray:1,0.266667,0.1,0.266667,0.1,0.266667;stroke-miterlimit:10;" d="M 18 19 L 12.374023 23.688281 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 12.085938 23.928516 L 12.309961 23.416211 L 12.374023 23.688281 L 12.630078 23.800391 Z M 12.085938 23.928516 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 18 19 L 24.603906 23.716992 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 24.908984 23.934961 L 24.356836 23.847852 L 24.603906 23.716992 L 24.647461 23.441016 Z M 24.908984 23.934961 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="219" y="281.255968"></use><use xlink:href="#glyph0-7" x="226.843696" y="281.255968"></use><use xlink:href="#glyph0-7" x="234.968696" y="281.255968"></use><use xlink:href="#glyph0-8" x="243.093696" y="281.255968"></use><use xlink:href="#glyph0-10" x="247.162435" y="281.255968"></use></g><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="161" y="412.255968"></use><use xlink:href="#glyph0-7" x="168.843696" y="412.255968"></use><use xlink:href="#glyph0-7" x="176.968696" y="412.255968"></use><use xlink:href="#glyph0-8" x="185.093696" y="412.255968"></use><use xlink:href="#glyph0-12" x="189.162435" y="412.255968"></use></g><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="341" y="410.255968"></use><use xlink:href="#glyph0-7" x="348.843696" y="410.255968"></use><use xlink:href="#glyph0-7" x="356.968696" y="410.255968"></use><use xlink:href="#glyph0-8" x="365.093696" y="410.255968"></use><use xlink:href="#glyph0-11" x="369.162435" y="410.255968"></use></g><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 28 10 L 36 10 L 36 12 L 28 12 Z M 28 10 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-13" x="538.230469" y="205.154405"></use></g><path style="fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 28 17 L 36 17 L 36 19 L 28 19 Z M 28 17 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-13" x="530.359375" y="345.154405"></use><use xlink:href="#glyph0-9" x="537.934245" y="345.154405"></use><use xlink:href="#glyph0-8" x="542.002984" y="345.154405"></use><use xlink:href="#glyph0-5" x="546.071723" y="345.154405"></use></g><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-dasharray:1,0.266667,0.1,0.266667,0.1,0.266667;stroke-miterlimit:10;" d="M 25 5 L 31.603906 9.716992 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 31.908984 9.934961 L 31.356836 9.847852 L 31.603906 9.716992 L 31.647461 9.441016 Z M 31.908984 9.934961 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 32 12 L 32 16.513281 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 32 16.888281 L 31.75 16.388281 L 32 16.513281 L 32.25 16.388281 Z M 32 16.888281 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="482" y="122.255968"></use><use xlink:href="#glyph0-7" x="489.843696" y="122.255968"></use><use xlink:href="#glyph0-7" x="497.968696" y="122.255968"></use><use xlink:href="#glyph0-8" x="506.093696" y="122.255968"></use><use xlink:href="#glyph0-13" x="510.162435" y="122.255968"></use></g><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-6" x="551" y="281.255968"></use><use xlink:href="#glyph0-7" x="558.843696" y="281.255968"></use><use xlink:href="#glyph0-7" x="566.968696" y="281.255968"></use><use xlink:href="#glyph0-8" x="575.093696" y="281.255968"></use><use xlink:href="#glyph0-5" x="579.162435" y="281.255968"></use></g><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 5 4 L 9.513281 4 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 9.888281 4 L 9.388281 4.25 L 9.513281 4 L 9.388281 3.75 Z M 9.888281 4 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill:none;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-dasharray:1,0.266667,0.1,0.266667,0.1,0.266667;stroke-miterlimit:10;" d="M 5 7 L 9.513281 7 " transform="matrix(20,0,0,20,-98,-18.75)"></path><path style="fill-rule:evenodd;fill:rgb(0%,0%,0%);fill-opacity:1;stroke-width:0.1;stroke-linecap:butt;stroke-linejoin:miter;stroke:rgb(0%,0%,0%);stroke-opacity:1;stroke-miterlimit:10;" d="M 9.888281 7 L 9.388281 7.25 L 9.513281 7 L 9.388281 6.75 Z M 9.888281 7 " transform="matrix(20,0,0,20,-98,-18.75)"></path><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-11" x="2" y="81.255968"></use><use xlink:href="#glyph0-14" x="9.037489" y="81.255968"></use><use xlink:href="#glyph0-2" x="16.868707" y="81.255968"></use><use xlink:href="#glyph0-2" x="29.33724" y="81.255968"></use><use xlink:href="#glyph0-14" x="41.805773" y="81.255968"></use><use xlink:href="#glyph0-15" x="49.63699" y="81.255968"></use><use xlink:href="#glyph0-8" x="57.74924" y="81.255968"></use><use xlink:href="#glyph0-4" x="61.81798" y="81.255968"></use><use xlink:href="#glyph0-16" x="66.836697" y="81.255968"></use><use xlink:href="#glyph0-6" x="72.099013" y="81.255968"></use><use xlink:href="#glyph0-15" x="79.942708" y="81.255968"></use><use xlink:href="#glyph0-17" x="88.054959" y="81.255968"></use><use xlink:href="#glyph0-18" x="94.723524" y="81.255968"></use><use xlink:href="#glyph0-4" x="98.279839" y="81.255968"></use><use xlink:href="#glyph0-18" x="103.298557" y="81.255968"></use><use xlink:href="#glyph0-14" x="106.854872" y="81.255968"></use><use xlink:href="#glyph0-15" x="114.686089" y="81.255968"></use></g><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph0-19" x="2" y="141.255968"></use><use xlink:href="#glyph0-1" x="5.556315" y="141.255968"></use><use xlink:href="#glyph0-17" x="13.431207" y="141.255968"></use><use xlink:href="#glyph0-17" x="20.099772" y="141.255968"></use><use xlink:href="#glyph0-8" x="26.768338" y="141.255968"></use><use xlink:href="#glyph0-11" x="30.837077" y="141.255968"></use><use xlink:href="#glyph0-14" x="37.874566" y="141.255968"></use><use xlink:href="#glyph0-2" x="45.705783" y="141.255968"></use><use xlink:href="#glyph0-2" x="58.174316" y="141.255968"></use><use xlink:href="#glyph0-14" x="70.642849" y="141.255968"></use><use xlink:href="#glyph0-15" x="78.474067" y="141.255968"></use><use xlink:href="#glyph0-8" x="86.586317" y="141.255968"></use><use xlink:href="#glyph0-4" x="90.655056" y="141.255968"></use><use xlink:href="#glyph0-16" x="95.673774" y="141.255968"></use><use xlink:href="#glyph0-6" x="100.936089" y="141.255968"></use><use xlink:href="#glyph0-15" x="108.779785" y="141.255968"></use><use xlink:href="#glyph0-17" x="116.892036" y="141.255968"></use><use xlink:href="#glyph0-18" x="123.560601" y="141.255968"></use><use xlink:href="#glyph0-4" x="127.116916" y="141.255968"></use><use xlink:href="#glyph0-18" x="132.135634" y="141.255968"></use><use xlink:href="#glyph0-14" x="135.691949" y="141.255968"></use><use xlink:href="#glyph0-15" x="143.523166" y="141.255968"></use></g><g style="fill:rgb(0%,0%,0%);fill-opacity:1;"><use xlink:href="#glyph1-1" x="242" y="21.26709"></use><use xlink:href="#glyph1-2" x="255.758409" y="21.26709"></use><use xlink:href="#glyph1-3" x="268.644965" y="21.26709"></use><use xlink:href="#glyph1-4" x="281.988878" y="21.26709"></use><use xlink:href="#glyph1-5" x="303.200629" y="21.26709"></use><use xlink:href="#glyph1-6" x="317.022786" y="21.26709"></use><use xlink:href="#glyph1-7" x="323.072591" y="21.26709"></use><use xlink:href="#glyph1-8" x="336.469672" y="21.26709"></use><use xlink:href="#glyph1-4" x="343.39133" y="21.26709"></use><use xlink:href="#glyph1-3" x="364.603082" y="21.26709"></use><use xlink:href="#glyph1-5" x="377.946994" y="21.26709"></use><use xlink:href="#glyph1-8" x="391.769151" y="21.26709"></use><use xlink:href="#glyph1-9" x="398.690809" y="21.26709"></use><use xlink:href="#glyph1-10" x="407.228678" y="21.26709"></use><use xlink:href="#glyph1-3" x="416.181315" y="21.26709"></use><use xlink:href="#glyph1-11" x="429.525228" y="21.26709"></use><use xlink:href="#glyph1-12" x="443.326226" y="21.26709"></use><use xlink:href="#glyph1-13" x="454.67117" y="21.26709"></use><use xlink:href="#glyph1-9" x="460.720974" y="21.26709"></use><use xlink:href="#glyph1-13" x="469.258843" y="21.26709"></use><use xlink:href="#glyph1-14" x="475.308648" y="21.26709"></use><use xlink:href="#glyph1-11" x="488.631131" y="21.26709"></use><use xlink:href="#glyph1-8" x="502.432129" y="21.26709"></use><use xlink:href="#glyph1-9" x="509.353787" y="21.26709"></use><use xlink:href="#glyph1-10" x="517.891656" y="21.26709"></use><use xlink:href="#glyph1-7" x="526.365777" y="21.26709"></use><use xlink:href="#glyph1-7" x="539.762858" y="21.26709"></use></g></g></svg><br>
This map tree is the result of parsing a file that has dictionaries with
the keys a, b, c many times, the keys a, b, f less often, and also some
objects with the keys x, y.<br>
When parsing a dictionary we traverse this tree from the root, according
to the keys that we see in the input file. While doing this, we
potentially add new nodes, if we get key combinations that we have never
seen before. The set of keys of a dictionary parsed so far are
represented by the current tree node, while we can store the values into
an array. We can use the tree of nodes to speed up parsing. A lot of the
nodes only have one child, because after reading the first few keys of
an object, the remaining ones are often uniquely determined in a given
file. If we have only one child map node, we can speculatively parse the
next key by doing a <tt class="docutils literal">memcmp</tt> between the key that the map tree says is
likely to come next and the characters that follow the ',' that started
the next entry in the dictionary. If the <tt class="docutils literal">memcmp</tt> returns true this
means that the speculation paid off, and we can transition to the new map
that the edge points to, and parse the corresponding value. If not, we
fall back to general code that parses the string, handles escaping rules
etc. This trick was explained to me by some V8 engineers, the same trick
is supposedly used <a class="reference external" href="https://github.com/v8/v8/blob/master/src/json/json-parser.cc">as part of the V8 JSON parser</a>.<br>
This scheme doesn't immediately work for map tree nodes that have more
than one child. However, since we keep statistics anyway about how often
each map is used as the map of a parsed dictionary, we can speculate
that the most common map transition is taken more often than the others
in the future, and use that as the speculated next node.<br>
So for the example transition tree shown in the figure above the key
speculation would succeed for objects with keys <tt class="docutils literal">a, b, c</tt>. For objects
with keys <tt class="docutils literal">a, b, f</tt> the speculation would succeed for the first two
keys, but not for the third key <tt class="docutils literal">f</tt>. For objects with the keys
<tt class="docutils literal">x, y</tt> the speculation would fail for the first key <tt class="docutils literal">x</tt> but succeed
for the second key <tt class="docutils literal">y</tt>.<br>
For real-world datasets these transition trees can become a lot more
complicated, for example here is a visualization of a part of the
transition tree generated for parsing a New York Times dataset:<br><a href="https://2.bp.blogspot.com/-Jv_p8rFIq8Y/XZubp3WVptI/AAAAAAAAwuY/rhTCqXJpoMUdtEf22tzqK64dcEJmBE6fwCPcBGAYYCw/s1600/2019_json_nytimes.png"><img border="0" height="310" src="https://2.bp.blogspot.com/-Jv_p8rFIq8Y/XZubp3WVptI/AAAAAAAAwuY/rhTCqXJpoMUdtEf22tzqK64dcEJmBE6fwCPcBGAYYCw/s400/2019_json_nytimes.png" width="400"></a>

<br><h2>
Caching Strings</h2>
A rather obvious observation we can use to improve performance of the
parser is the fact that string values repeat a lot in most JSON files.
For strings that are used as dictionary keys this is pretty obvious.
However it happens also for strings that are used as values in
dictionaries (or are stored in lists). We can use this fact to
intern/memoize strings and save memory. This is an approach that many
JSON parsers use, including
<a class="reference external" href="https://github.com/python/cpython/blob/3.7/Modules/_json.c#L749">CPython's</a>.
To do this, I keep a dictionary of strings that we have seen so far
during parsing and look up new strings that are deserialized. If we have
seen the string before, we can re-use the deserialized previous string.
Right now I only consider utf-8 strings for caching that do not contain
any escapes (whether stuff like <tt class="docutils literal">\", \n</tt> or escaped unicode chars).<br>
This simple approach works extremely well for dictionary keys, but needs
a number of improvements to be a win in general. The first observation
is that computing the hash to look up the string in the dictionary of
strings we've seen so far is basically free. We can compute the hash
while scanning the input for the end of the string we are currently
deserializing. Computing the hash while scanning doesn't increase the
time spent scanning much. This is not a new idea, I am sure many other
parsers do the same thing (but CPython doesn't seem to).<br>
Another improvement follows from the observation that inserting every
single deserialized non-key string into a hashmap is too expensive.
Instead, we insert strings into the cache more conservatively, by
keeping a small ring buffer of hashes of recently deserialized strings.
The hash is looked for in the ring buffer, and only if the hash is
present we insert the string into the memoization hashmap. This has the
effect of only inserting strings into the memoization hashmap that
re-occur a second time not too far into the file. This seems to give a
good trade-off between still re-using a lot of strings but keeping the
time spent updating and the size of the memoization hashmap low.<br>
Another twist is that in a lot of situations caching strings is not
useful at all, because it will almost never succeed. Examples of this
are UUIDs (which are unique), or the content of a tweet in a JSON file
with many tweets (which is usually unique). However, in the same file it
might be useful to cache e.g. the user name of the Twitter user, because
many tweets from the same person could be in such a file. Therefore the
usefulness of the string cache depends on which fields of objects we are
deserializing the value off. Therefore we keep statistics per map field
and disable string memoization per individual field if the cache hit
rate falls below a certain threshold. This gives the best of both
worlds: in the cases where string values repeat a lot in certain fields
we use the cache to save time and memory. But for those fields that
mostly contain unique strings we don't waste time looking up and adding
strings in the memoization table. Strings outside of dictionaries are
quite rare anyway, so we just always try to use the cache for them.<br>
The following pseudocode sketches the code to deserialize a string in
the input at a given position. The function also takes a map, which is
the point in the map tree that we are currently deserializing a field
off (if we are deserializing a string in another context, some kind of
dummy map can be used there).<br><pre><code class="python">
def deserialize_string(pos, input, map):
    # input is the input string, pos is the position of the starting " of
    # the string

    # find end of string, check whether it contains escape codes,
    # compute hash, all at the same time
    end, escapes, hash = find_end_of_string(pos + 1, input)
    if end == -1:
        raise ParseError
    if escapes:
        # need to be much more careful with escaping
        return deserialize_string_escapes(pos, input)
    
    # should we cache at all?
    if map.cache_disabled():
        return input[pos + 1:end]

    # if string is in cache, return it
    if hash in cache:
        map.cache_hit += 1
        return cache[hash]

    result = input[pos + 1:end]
    map.cache_miss += 1

    # if hash is in the ring buffer of recently seen hashes,
    # add the string to the cache
    if hash in ring_buffer:
        cache[hash] = result
    else:
        ring_buffer.write(hash)
    return result

</code>
</pre>
<h2>
Evaluation</h2>
To find out how much the various techniques help, I implemented a number
of JSON parsers in PyPy with different combinations of the techniques
enabled. I compared the numbers with the JSON parser of CPython 3.7.3
(simplejson), with ujson, with the JSON parser of Node 12.11.1 (V8) and with
RapidJSON (in DOM mode).<br>
I collected a number of medium-to-large JSON files to try the JSON
parsers on:<br><ul class="simple">
<li>
<a class="reference external" href="https://censys.io/data">Censys</a>: A subset of the Censys port and
protocol scan data for websites in the Alexa top million domains</li>
<li>
<a class="reference external" href="https://www.gharchive.org/">Gharchive</a>: Github activity from
January 15-23, 2015 from Github Archive</li>
<li>
<a class="reference external" href="https://files.pushshift.io/reddit/comments/">Reddit</a>: Reddit
comments from May 2009</li>
<li>Rosie: The nested matches produced using the <a class="reference external" href="https://rosie-lang.org/">Rosie pattern
language</a> <tt class="docutils literal">all.things</tt> pattern on a log
file</li>
<li>Nytimes: Metadata of a collection of New York Times articles</li>
<li>Tpch: The TPC-H database benchmark's deals table as a JSON file</li>
<li>Twitter: A JSON export of the @pypyproject Twitter account data</li>
<li>Wikidata: A file storing a subset of the Wikidata fact dump from Nov
11, 2014</li>
<li>
<a class="reference external" href="https://www.yelp.com/dataset/download">Yelp</a>: A file of yelp
businesses</li>
</ul>
Here are the file sizes of the benchmarks:<br><table class="dataframe">
<thead><tr style="text-align: right;">
<th>Benchmark</th>
      <th>File Size [MiB]</th>
    </tr></thead>
<tbody>
<tr style="text-align: right;">
<td>Censys</td>
      <td>898.45</td>
    </tr>
<tr style="text-align: right;">
<td>Gharchive</td>
      <td>276.34</td>
    </tr>
<tr style="text-align: right;">
<td>NYTimes</td>
      <td>12.98</td>
    </tr>
<tr style="text-align: right;">
<td>Reddit</td>
      <td>931.65</td>
    </tr>
<tr style="text-align: right;">
<td>Rosie</td>
      <td>388.88</td>
    </tr>
<tr style="text-align: right;">
<td>TPCH</td>
      <td>173.86</td>
    </tr>
<tr style="text-align: right;">
<td>Wikidata</td>
      <td>119.75</td>
    </tr>
<tr style="text-align: right;">
<td>Yelp</td>
      <td>167.61</td>
    </tr>
</tbody>
</table>
I measured the times of each benchmark with a number of variations
of the improved PyPy algorithms:<br><ul class="simple">
<li>PyPyBaseline: The PyPy JSON parser as it was before my work with JSON
parsing started (PyPy version 5.8)</li>
<li>PyPyKeyStringCaching: Memoizing the key strings of dictionaries, but
not the other strings in a json file, and not using maps to represent
dictionaries (this is the JSON parser that PyPy has been shipping since
version 5.9, in the benchmarks I used 7.1).</li>
<li>PyPyMapNoCache: Like PyPyKeyStringCaching, but using maps to
represent dictionaries. This includes speculatively parsing the next
key using memcmp, but does not use string caching of non-key strings.</li>
<li>PyPyFull: Like PyPyMapNoCache but uses a string cache for all
strings, not just keys. This is equivalent to what will be released soon as part of PyPy 7.2</li>
</ul>
In addition to wall clock time of parsing, I also measured the increase
in memory use of each implementation after the input string has been
deserialized, i.e. the size of the in-memory representation of every
JSON file.<br><h3>
Contributions of Individual Optimizations</h3>
Let's first look at the contributions of the individual optimizations to the
overall performance and memory usage.<br><img src="https://docs.google.com/uc?id=1oqsebLsZH8pj4exAVbDthaRhERXqg8mN" width="800/"><img src="https://docs.google.com/uc?id=1_3UuTihT0A6wfM-F3sj8j9M9IoQuvcCt" width="800/"><br>
All the benchmarks were run 30 times in new processes, all the numbers are
normalized to PyPyFull.<br>
The biggest individual improvement to both parsing time and memory used comes
from caching just the keys in parsed dictionaries. This is the optimization in
PyPy's JSON parser that has been implemented for a while already. To understand
why this optimization is so useful, let's look at some numbers about each
benchmark, namely the number of total keys across all dictionaries in each
file, as well as the number of unique keys. As we can see, for all benchmarks
the number of unique keys is significantly smaller than the number of keys in
total.<br><table class="dataframe">
<thead><tr style="text-align: right;">
<th>Benchmark</th>
      <th>Number of keys</th>
      <th>Number of unique keys</th>
    </tr></thead>
<tbody>
<tr style="text-align: right;">
<td>Censys</td>
      <td>14 404 234</td>
      <td>163</td>
    </tr>
<tr style="text-align: right;">
<td>Gharchive</td>
      <td>6 637 881</td>
      <td>169</td>
    </tr>
<tr style="text-align: right;">
<td>NYTimes</td>
      <td>417 337</td>
      <td>60</td>
    </tr>
<tr style="text-align: right;">
<td>Reddit</td>
      <td>25 226 397</td>
      <td>21</td>
    </tr>
<tr style="text-align: right;">
<td>Rosie</td>
      <td>28 500 101</td>
      <td>5</td>
    </tr>
<tr style="text-align: right;">
<td>TPCH</td>
      <td>6 700 000</td>
      <td>45</td>
    </tr>
<tr style="text-align: right;">
<td>Wikidata</td>
      <td>6 235 088</td>
      <td>1 602</td>
    </tr>
<tr style="text-align: right;">
<td>Yelp</td>
      <td>5 133 914</td>
      <td>61</td>
    </tr>
</tbody>
</table>
The next big jump in deserialization time and memory comes from introducing
maps to represent deserialized dictionaries. With PyPyMapNoCache
deserialization time goes down because it's much cheaper to walk the tree
of maps and store all deserialized objects into an array of values than to
build hashmaps with the same keys again and again. Memory use goes down
for the same reason: it takes a lot less memory to store the shared
structure of each set of keys in the map, as opposed to repeating it again
and again in every hashmap.<br>
We can look at some numbers about every benchmark again. The table shows how
many map-based dictionaries are deserialized for every benchmark, and how many
hashmap-backed dictionaries. We see that the number of hashmap-backed
dictionaries is often zero, or at most a small percentage of all dictionaries
in each benchmark. Yelp has the biggest number of hashmap-backed dictionaries.
The reason for this is that the input file contains hashmaps that store
combinations of various features of Yelp businesses, and a lot of these
combinations are totally unique to a business. Therefore the heuristics
determine that it's better to store these using hashmaps.<br><table class="dataframe">
<thead><tr style="text-align: right;">
<th>Benchmark</th>
      <th>Map Dicts</th>
      <th>Regular Dicts</th>
      <th>% Regular Dicts</th>
    </tr></thead>
<tbody>
<tr style="text-align: right;">
<td>Censys</td>
      <td>4 049 235</td>
      <td>1 042</td>
      <td>0.03</td>
    </tr>
<tr style="text-align: right;">
<td>Gharchive</td>
      <td>955 301</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
<tr style="text-align: right;">
<td>NYTimes</td>
      <td>80 393</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
<tr style="text-align: right;">
<td>Reddit</td>
      <td>1 201 257</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
<tr style="text-align: right;">
<td>Rosie</td>
      <td>6 248 966</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
<tr style="text-align: right;">
<td>TPCH</td>
      <td>1 000 000</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
<tr style="text-align: right;">
<td>Wikidata</td>
      <td>1 923 460</td>
      <td>46 905</td>
      <td>2.38</td>
    </tr>
<tr style="text-align: right;">
<td>Yelp</td>
      <td>443 140</td>
      <td>52 051</td>
      <td>10.51</td>
    </tr>
</tbody>
</table>

We can also look at numbers about how often the memcmp-based speculative
parsing of the next key of a given map succeeds. Looking at statistics
about each benchmark, we can see that the speculation of what key we
expect next pays off in a significant percentage of cases, between 63% for
Wikidata where the dictionary structures are quite irregular, and 99% for
Reddit, where all the dictionaries have the same set of keys.<br><table class="dataframe">
<thead><tr style="text-align: right;">
<th>Benchmark</th>
      <th>Number of Keys</th>
      <th>Map Transitions</th>
      <th>% Successful Speculation</th>
    </tr></thead>
<tbody>
<tr style="text-align: right;">
<td>Censys</td>
      <td>14 404 234</td>
      <td>14 403 243</td>
      <td>65.79</td>
    </tr>
<tr style="text-align: right;">
<td>Gharchive</td>
      <td>6 637 881</td>
      <td>6 637 881</td>
      <td>86.71</td>
    </tr>
<tr style="text-align: right;">
<td>NYTimes</td>
      <td>417 337</td>
      <td>417 337</td>
      <td>79.85</td>
    </tr>
<tr style="text-align: right;">
<td>Reddit</td>
      <td>25 226 397</td>
      <td>25 226 397</td>
      <td>100.00</td>
    </tr>
<tr style="text-align: right;">
<td>Rosie</td>
      <td>28 500 101</td>
      <td>28 500 101</td>
      <td>90.37</td>
    </tr>
<tr style="text-align: right;">
<td>TPCH</td>
      <td>6 700 000</td>
      <td>6 700 000</td>
      <td>86.57</td>
    </tr>
<tr style="text-align: right;">
<td>Wikidata</td>
      <td>6 235 088</td>
      <td>5 267 744</td>
      <td>63.68</td>
    </tr>
<tr style="text-align: right;">
<td>Yelp</td>
      <td>5 133 914</td>
      <td>4 593 980</td>
      <td>90.43</td>
    </tr>
<tr style="text-align: right;">
<td>geomean</td>
      <td></td>
      <td></td>
      <td>82.04</td>
    </tr>
</tbody>
</table>
General string caching is the most unclear optimization. On the one hand its
impact on memory usage is quite substantial, leading to a 20% reduction for
Gharchive and Reddit, up to a 2× improvement for Yelp. On the other hand, the
effect on performance is less clear, since it even leads to a slowdown in
Gharchive and Reddit, and generally only a small improvement. Choosing the
right heuristic for when to disable the cache also has somewhat unclear effects
and is definitely a topic worthy of further investigation.<br><h3>
Comparison against other JSON Decoders</h3>
To get a more general feeling of the performance and memory usage of the
improved PyPy parser, we compare it against CPython's built-in json
parser, ujson for CPython, Node's (V8) JSON parser and RapidJSON. For
better context for the memory usage I also show the file size of the input
files.<br>
These benchmarks are not really an apples-to-apple comparison. All of the
implementations use different in-memory representations of strings in
the deserialized data-structure (Node uses two bytes per character in
a string, <a href="https://www.python.org/dev/peps/pep-0393/">in CPython it
depends</a> but 4 bytes on my
machine), PyPyBaseline uses four bytes, PyPy and RapidJSON use utf-8). But
it's still interesting to get some ballpark numbers. The results are as
follows:<br><img src="https://docs.google.com/uc?id=1Q-aFNXE-sWJi5kSKTwmQNLz5LI3DDgtm" width="800/"><img src="https://docs.google.com/uc?id=1sgGyqp93_czrxN4IYkXeZ-jFWCAs37bu" width="800/"><br>
As we can see, PyPyFull handily beats CPython and ujson, with a geometric
mean of the improvement of about 2.5×. The memory improvement can be even
more extreme, with an improvement of over 4× against CPython/ujson in some
cases (CPython gives better memory sizes, because its parser caches the
keys of dictionaries as well). Node is often more than 50% slower, whereas
RapidJSON beats us easily, by a factor of 2× on average.<br><h2>
Conclusions</h2>
While the speedup I managed to achieve over the course of this project is
nice and I am certainly happy to beat both CPython and Node, I am
ultimately still annoyed that RapidJSON manages to maintain such a clear
lead over PyPyFull, and would like to get closer to it. One problem that
PyPy suffers compared to RapidJSON is the overhead of garbage collection.
Deserializing large JSON files is pretty much the worst case for the
generational GC that PyPy uses, since none of the deserialized objects die
young (and the GC expects that most objects do). That means that a lot of
the deserialization time of PyPy is wasted allocating the resulting
objects in the nursery, and then copying them into the old generation.
Somehow, this should be done in better ways, but all my attempts to not
have to do the copy did not seem to help much. So maybe more improvements
are possible, if I can come up with more ideas.<br>
On the memory side of things, Node/V8 is beating PyPy clearly which might
indicate more general problems in how we represent Python objects in
memory. On the other hand, I think it's cool that we are competitive with
RapidJSON in terms of memory and often within 2× of the file size.<br>
An effect that I didn't consider at all in this blog post is the fact that
accessing the deserialized objects with constants strings is <i>also</i> faster
than with regular dictionaries, due to them being represented with maps.
More benchmarking work to do in the future!<br>
If you have your own programs that run on PyPy and use the json parser
a lot, please measure them on the new code and let me know whether you see
any difference!
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-7720747467569071952">
        <div class="comment-header">
          <a name="comment-7720747467569071952"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2019-10-09 09:49</span>:
        </div>
        <div class="comment-content">
          <p>Great work! Excited for the new release.<br><br>This makes me wonder if maps are (or can) be used for identical dicts which are constructed in a tight loop (e.g. from a CSV or SQLAlchemy rows).</p>
        </div>
      </div>
      <div class="comment comment-1860683508851371578">
        <div class="comment-header">
          <a name="comment-1860683508851371578"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2019-10-09 11:20</span>:
        </div>
        <div class="comment-content">
          <p>thanks! yes, that should be possible somehow and would indeed be quite cool. If you give us a real benchmark, we can think about it (maybe I should start with csv.DictReader?)</p>
        </div>
      </div>
      <div class="comment comment-4569636828718816104">
        <div class="comment-header">
          <a name="comment-4569636828718816104"></a>
            <span class="author">Alexander Hultnér | Hultnér Technologies</span> wrote on <span class="date">2019-10-09 12:52</span>:
        </div>
        <div class="comment-content">
          <p>Excellent work!<br><br>These posts are always a pleasure to read, and the improvements in PyPy are wounderful. <br>Thanks to you and everyone who's involved in making PyPy the great product it is toady, do keep the great work up!</p>
        </div>
      </div>
      <div class="comment comment-2198005430017006177">
        <div class="comment-header">
          <a name="comment-2198005430017006177"></a>
            <span class="author">peak</span> wrote on <span class="date">2019-10-15 03:12</span>:
        </div>
        <div class="comment-content">
          <p>Great work, but could you please provide links (preferably of the permalink variety) to the datasets you used for benchmarking?  Thanks.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2019/08/a-second-life-for-sandbox-6848726729476245390.html" class="u-url">A second life for the Sandbox</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/armin-rigo.html">Armin Rigo</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2019/08/a-second-life-for-sandbox-6848726729476245390.html" rel="bookmark">
            <time class="published dt-published" datetime="2019-08-07T18:31:00Z" itemprop="datePublished" title="2019-08-07 18:31">2019-08-07 18:31</time></a>
            </p>
                <p class="commentline">1 comment</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Hi all,<br><br><a href="https://anvil.works/" target="_blank">Anvil</a> is a UK-based company sponsoring one month of work to revive PyPy's
"sandbox" mode and upgrade it to PyPy3.  Thanks to them, sandboxing will be
given a second life!<br><br>
The <a href="https://doc.pypy.org/en/latest/sandbox.html">sandboxed PyPy</a> is a special version of PyPy that runs
fully isolated.  It gives a safe way to execute arbitrary Python
programs (<i>whole</i> programs, not small bits of code inside your larger Python
program).  Such scripts can be fully untrusted, and they can try to do
anything—there are no syntax-based restrictions, for example—but whatever
they do, any communication with the external world is not actually done but
delegated to the parent process.  This is similar but much more flexible than
Linux's Seccomp approach, and it is more lightweight than setting up a full
virtual machine.  It also works without operating system support.<br><br>
However, during the course of the years the sandbox mode of PyPy has been
mostly unmaintained and unsupported by the core developers, mostly because of
a lack of interest by users and because it took too much effort to maintain
it.<br><br>
Now we have found that we have an actual user, <a href="https://anvil.works/" target="_blank">Anvil</a>.  As far as I can tell
they are still using a very old version of PyPy, the last one that supported
sandboxing. This is where this contract comes from: the goal is to modernize sandboxing and port it to PyPy3.<br><br>
Part of my motivation for accepting this work is that I may have found a way to
tweak the protocol on the pipe between the sandboxed PyPy and the parent
controller process.  This should make the sandboxed PyPy more resilient against
future developments and easier to maintain; at most, in the future some tweaks will be needed in the
controller process but hopefully not deep inside the guts of the sandboxed
PyPy.  Among the advantages, such a more robust solution should mean that we
can actually get a working sandboxed PyPy—or sandboxed PyPy3 or sandboxed
version of <a href="https://rpython.readthedocs.io/en/latest/examples.html">any other interpreter written in RPython</a>—with just an extra
argument when calling <span>rpython</span> to translate this interpreter.  If everything
works as planned, sandboxing may be given a second life.<br><br>
Armin Rigo</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-8243638429715290894">
        <div class="comment-header">
          <a name="comment-8243638429715290894"></a>
            <span class="author">mark</span> wrote on <span class="date">2020-03-16 11:10</span>:
        </div>
        <div class="comment-content">
          <p>Hi Armin,<br><br>I like your initiative a lot - I tihnk it is very useful to have a safe execution environment for python scripts (a lot can be done, once this is achieved).<br>Please keep us updated about the stated of development.<br>I am wondering, if it is already in a usable condition - descriptions diverge here.<br>Thanks, mark</p>
        </div>
      </div>
         </div>

</div>
</div>
<div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/12/toy-load-store.html" class="listtitle">Load and store forwarding in the Toy Optimizer</a>
      </li>
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (6)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div></div>
</main>
</div>
<div style="clear: both; width: 75%; margin: 1em auto;">
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-41.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-39.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
         
                 <footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2026 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2026-01-17T00:22
  </div>
  <div style="margin-left: auto">
  <a href="../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../assets/js/styles.js"></script></footer>
</body>
</html>