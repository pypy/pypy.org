<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A Faster Python">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PyPy (old posts, page 22) | PyPy</title>
<link href="../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.pypy.org/blog/index-22.html">
<link rel="icon" href="../favicon2.ico" sizes="16x16">
<link rel="icon" href="../favicon32x32.ico" sizes="32x32">
<link rel="prev" href="index-23.html" type="text/html">
<link rel="next" href="index-21.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../assets/css/tipuesearch.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../index.html">
                    <image id="toplogo" src="../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../compat.html">Compatibility</a> </li>  
                    <li> <a href="../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href=".">Index</a> </li>  
                    <li> <a href="../categories/">Tags</a> </li>  
                    <li> <a href="../archive.html">Archive by year</a> </li>  
                    <li> <a href="../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><div class="post">
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/03/py3k-status-update-2-4018939509128176130.html" class="u-url">Py3k status update #2</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/03/py3k-status-update-2-4018939509128176130.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-03-01T19:51:00Z" itemprop="datePublished" title="2012-03-01 19:51">2012-03-01 19:51</time></a>
            </p>
                <p class="commentline">5 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <div class="document" id="py3k-status-update-2">   <p>This is the second status update about my work on the <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/py3k">py3k branch</a>, which I can work on thanks to all of the people who <a class="reference external" href="../posts/2012/01/py3k-and-numpy-first-stage-thanks-to-3008917396290059758.html">donated</a> to the <a class="reference external" href="https://pypy.org/py3donate.html">py3k proposal</a>.</p>
<p>Since my previous <a class="reference external" href="../posts/2012/02/py3k-status-update-8840622949715145821.html">status update</a>, things have improved a lot: first of all, I fixed the syntax of many more tests, which were failing on the branch because they used constructs which are no longer valid in Python 3, such as <tt class="docutils literal">u''</tt> strings, the <tt class="docutils literal">print</tt> statement or the old <tt class="docutils literal">except Exception, e</tt> syntax.  I have to say that this work is tedious and not very rewarding, but it has to be done anyway, so that the real failures can stand up.</p>
<p>Then, I spent most of the rest of the time by killing features which are present in Python 2 and are gone in Python 3.</p>
<p>Some of them were easy and mechnical: for example, I removed all the function attributes such as <tt class="docutils literal">func_code</tt> and <tt class="docutils literal">func_closure</tt>, which has been renamed to <tt class="docutils literal">__code__</tt> and <tt class="docutils literal">__closure__</tt>, and then I had to find and fix all the places which still expected the old ones.</p>
<p>Some were trickier: I removed support for the <tt class="docutils literal">cmp</tt> function and the <tt class="docutils literal">__cmp__</tt> special method, but this also meant that I had to fix a few types which relied on it to be comparable (for example, did you know that the cells contained in <tt class="docutils literal">__closure__</tt> are comparable?). At the same time, I also removed the old behavior which in Python 2 allows us to compare arbitrary objects with <tt class="docutils literal">&lt;</tt>, <tt class="docutils literal">&gt;</tt> &amp; co.: in Python 3 the only comparisons allowed between incompatible types are <tt class="docutils literal">==</tt> and <tt class="docutils literal">!=</tt>.</p>
<p>Speaking of old special methods, <tt class="docutils literal">__hex__</tt> and <tt class="docutils literal">__oct__</tt> are gone as well (and I didn't even know about their existence before removing them :-))</p>
<p>But the most important breakthrough was the removal of the <tt class="docutils literal">_file</tt> module, containing the implementation of the <tt class="docutils literal">file</tt> type in Python 2, which is now gone since in Python 3 files are handled by the <tt class="docutils literal">_io</tt> module.  Killing the module was not straightforward, because some of the importing logic was tightly tied to the internal implementation of files, so it needed some refactoring. Finally, I had to fix the <tt class="docutils literal">marshal</tt> module to correctly detect text files vs. byte files.</p>
<p>Among these things, I fixed tons of smaller issues here and there. As a result, there are many fewer failing tests than a few weeks ago.  Obviously the number itself does not mean much, because sometimes fixing a single test takes hours, and some other times by changing one line one fixes tens of tests. But at the end, seeing it dropping from 999 to <a class="reference external" href="https://buildbot.pypy.org/summary?category=linux32&amp;branch=py3k&amp;recentrev=53071:411bb6d819b1">650</a> always is nice and rewarding :-).</p>
<p>The road for having a pypy3k is still long, but everything is going fine so far. Stay tuned for more updates!</p>
<p>cheers, Antonio</p>
</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-622133816365178652">
        <div class="comment-header">
          <a name="comment-622133816365178652"></a>
            <span class="author">Larry Hastings</span> wrote on <span class="date">2012-03-02 01:17</span>:
        </div>
        <div class="comment-content">
          <p>You might consider leaving the u prefix in--PEP 414 puts it back, and it just got accepted.<br><br>https://www.python.org/dev/peps/pep-0414/</p>
        </div>
      </div>
      <div class="comment comment-2454726041407991855">
        <div class="comment-header">
          <a name="comment-2454726041407991855"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2012-03-02 05:57</span>:
        </div>
        <div class="comment-content">
          <p>It's cleaner to flush them out - the forward porting effort is targeting 3.2, so the stdlib should respect that. (i.e. if it runs on PyPy by default, it should run on CPython 3.2 as well).<br><br>Otherwise we'll end up with confusing cases of "this runs on 3.2 in PyPy, but CPython reports a syntax error"</p>
        </div>
      </div>
      <div class="comment comment-1838507059881736985">
        <div class="comment-header">
          <a name="comment-1838507059881736985"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2012-03-02 05:59</span>:
        </div>
        <div class="comment-content">
          <p>For importing support, you may want to look at the current state of the 3.3 importlib implementation. Brett's on the verge of hooking that up as CPython's native import system - it should be possible for PyPy3k to use it as well.</p>
        </div>
      </div>
      <div class="comment comment-8060524560015868248">
        <div class="comment-header">
          <a name="comment-8060524560015868248"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2012-03-02 08:28</span>:
        </div>
        <div class="comment-content">
          <p>@Larry: yes, I've considered that, but as Nick says we are targeting 3.2, so it's much easier to just kill it in the meantime. Adding it back will be very easy.<br><br>@Nick: yes, using importlib is something which I also have considered. However, I'd prefer not to diverge too much from the "default" branch (because we are going to regularly merge default into py3k for a long time). I suppose that as long as the current importing logic works fine, we'll keep it :-)</p>
        </div>
      </div>
      <div class="comment comment-8057331655562259258">
        <div class="comment-header">
          <a name="comment-8057331655562259258"></a>
            <span class="author">shaurz</span> wrote on <span class="date">2012-03-03 15:01</span>:
        </div>
        <div class="comment-content">
          <p>The u"" syntax is coming back.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/02/py3k-status-update-8840622949715145821.html" class="u-url">Py3k status update</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/02/py3k-status-update-8840622949715145821.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-02-16T12:41:00Z" itemprop="datePublished" title="2012-02-16 12:41">2012-02-16 12:41</time></a>
            </p>
                <p class="commentline">7 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <div class="document" id="py3k-status-update">Thank to all the people who <a class="reference external" href="../posts/2012/01/py3k-and-numpy-first-stage-thanks-to-3008917396290059758.html">donated</a> to the <a class="reference external" href="https://pypy.org/py3donate.html">py3k proposal</a>, we managed to collect enough money to start to work on the first step.  This is a quick summary of what I did since I began working on this.<br>
First of all, many thanks to Amaury Forgeot d'Arc, who started the <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/py3k">py3k branch</a> months ago, and already implemented lots of features including e.g. switching to "unicode everywhere" and the int/long unification, making my job considerably easier :-)<br>
I started to work on the branch at the last <a class="reference external" href="../posts/2011/12/leysin-winter-sprint-6862532189897876336.html">Leysin sprint</a> together with Romain Guillebert, where we worked on various syntactical changes such as extended tuple unpacking and keyword-only arguments.  Working on such features is a good way to learn about a lot of the layers which the PyPy Python interpreter is composed of, because often you have to touch the tokenizer, the parser, the ast builder, the compiler and finally the interpreter.<br>
Then I worked on improving our test machinery in various way, e.g. by optimizing the initialization phase of the object space created by tests, which considerably speeds up small test runs, and adding the possibility to automatically run our tests against CPython 3, to ensure that what we are not trying to fix a test which is meant to fail :-). I also setup our buildbot to run the <a class="reference external" href="https://buildbot.pypy.org/summary?branch=py3k">py3k tests nightly</a>, so that we can have an up to date overview of what is left to do.<br>
Finally I started to look at all the tests in the interpreter/ directory, trying to unmangle the mess of failing tests. Lots of tests were failing because of simple syntax errors (e.g., by using the no longer valid <tt class="docutils literal">except Exception, e</tt> syntax or the old <tt class="docutils literal">print</tt> statement), others for slightly more complex reasons like <tt class="docutils literal">unicode</tt> vs <tt class="docutils literal">bytes</tt> or the now gone int/long distinction.  Others were failing simply because they relied on new features, such as the new <a class="reference external" href="https://bugs.python.org/issue3021">lexical exception handlers</a>.<br>
To give some numbers, at some point in january we had 1621 failing tests in the branch, while today we are <a class="reference external" href="https://buildbot.pypy.org/summary?category=linux32&amp;branch=py3k&amp;recentrev=52508:c1756f5aa63e">under 1000</a> (to be exact: 999, and this is why I've waited until today to post the status update :-)).<br>
Before ending this blog post, I would like to thank once again all the people who donated to PyPy, who let me to do this wonderful job.  That's all for now, I'll post more updates soon.<br>
cheers, Antonio</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-1211704399306122031">
        <div class="comment-header">
          <a name="comment-1211704399306122031"></a>
            <span class="author">Piotr Husiatyński</span> wrote on <span class="date">2012-02-16 16:12</span>:
        </div>
        <div class="comment-content">
          <p>Will the py3 branch be finally merged into main branch and the pypy will be albe to run both 2.x and 3.x depending on the boot switch or the 2.x support will be dropped or the will be no merge?</p>
        </div>
      </div>
      <div class="comment comment-5221757830247702752">
        <div class="comment-header">
          <a name="comment-5221757830247702752"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2012-02-16 16:23</span>:
        </div>
        <div class="comment-content">
          <p>@Piotr: the work in the py3k branch is destroying some of the python2 semantics, so we won't merge the twos as long as we support python2 (and we'll do it for a long time, because pypy itself is written in python2).<br>The current plan is just to keep the development in parallel, and regularly merge "default" into "py3k".</p>
        </div>
      </div>
      <div class="comment comment-7906631675992117008">
        <div class="comment-header">
          <a name="comment-7906631675992117008"></a>
            <span class="author">Alberto Berti</span> wrote on <span class="date">2012-02-16 18:24</span>:
        </div>
        <div class="comment-content">
          <p>Ciao Antonio, <br><br>very good news, i'm glad that my little monetary contribution allowed you to be paid to work on that. Keep us posted! <br><br>Cheers,<br><br>Alberto</p>
        </div>
      </div>
      <div class="comment comment-6761101638509343771">
        <div class="comment-header">
          <a name="comment-6761101638509343771"></a>
            <span class="author">Seb</span> wrote on <span class="date">2012-02-16 23:07</span>:
        </div>
        <div class="comment-content">
          <p>So, it has to be asked: any plan of rewriting PyPy in python 3? :D</p>
        </div>
      </div>
      <div class="comment comment-3515367886848520138">
        <div class="comment-header">
          <a name="comment-3515367886848520138"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2012-02-16 23:30</span>:
        </div>
        <div class="comment-content">
          <p>@Alberto: thank you very much :-)<br><br>@Seb: not in the short/middle term (and it's unclear whether we want to go there at all)</p>
        </div>
      </div>
      <div class="comment comment-4466943022847486591">
        <div class="comment-header">
          <a name="comment-4466943022847486591"></a>
            <span class="author">Echo</span> wrote on <span class="date">2012-02-17 10:21</span>:
        </div>
        <div class="comment-content">
          <p>Good luck preventing the python2 and python3 branches from convergng; it's what merges do, and the alternative is a lot of cherry-picking. A lot of codebases use feature-flipping instead.</p>
        </div>
      </div>
      <div class="comment comment-5082434792944024814">
        <div class="comment-header">
          <a name="comment-5082434792944024814"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2012-02-17 10:30</span>:
        </div>
        <div class="comment-content">
          <p>@Echo: no, the plan is to regularly merge "default" (i.e. python2) into "py3k". Note that in "default" we are mostly developing other parts than the Python interpreter (e.g., the JIT compiler), so this should not be too much of a problem, although it will be annoying sometimes</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/02/larger-example-for-flow-graph-language-6139699450091061040.html" class="u-url">A Larger Example for the Flow Graph Language</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/02/larger-example-for-flow-graph-language-6139699450091061040.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-02-13T14:50:00Z" itemprop="datePublished" title="2012-02-13 14:50">2012-02-13 14:50</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <h2>Part 4 of Comparing Partial Evaluation to Tracing</h2>
<p>This is the fourth and final blog post in a series about comparing partial evaluation and
tracing. We've come a long way: In the <a class="reference external" href="../posts/2012/01/comparing-partial-evaluation-and-7255412724168990164.html">first post of the series</a> I showed an interpreter for a small flow-graph
language together with a partial evaluator it. In the <a class="reference external" href="../posts/2012/01/simple-tracer-for-flow-graph-language-6930951890987229484.html">second post</a> I showed how a tracer for
the same language works and how it relates to both execution and to partial
evaluation. The <a class="reference external" href="../posts/2012/02/optimizing-traces-of-flow-graph-4169388883059419385.html">third post</a> described an optimizer for traces.</p>
<p>In this final post we can compare and contrast the two different approaches of
tracing and partial evaluation by means of an example. The programs in the flow
chart language seen so far have been rather small, so I want to give an example
of a larger program: an interpreter for an extremely simple bytecode
instruction set. I will look at how the partial evaluator deals with that
interpreter, and
what the tracer does with it. The code for
that, as well as all the code of the series can be found here: <a class="reference external" href="https://paste.pocoo.org/show/550282/">https://paste.pocoo.org/show/550282/</a> (some small
additions have been made, such as a nicer way to print traces).</p>
<h2>A Bytecode Interpreter</h2>
<p>Writing programs in the flow graph language is painful, but I still want to give
an example that is a bit more interesting than the tiny ones that we've seen so
far. The example is an interpreter for the bytecode of a very trivial
register-based language. The language has four registers, one of which is an
accumulator on which all the actual operations are performed.</p>
<p>The opcodes of the language are:</p>
<ul class="simple">
<li>
<tt class="docutils literal">jump_if_a</tt>, jumps to a target address when the accumulator is non-zero</li>
<li>
<tt class="docutils literal">mov_a_r0</tt>, <tt class="docutils literal">mov_a_r1</tt>, <tt class="docutils literal">mov_a_r2</tt> move the value of the accumulator to
the respective register</li>
<li>
<tt class="docutils literal">mov_r0_a</tt>, <tt class="docutils literal">mov_r1_a</tt>, <tt class="docutils literal">mov_r2_a</tt> move the value of a register to
the accumulator</li>
<li>
<tt class="docutils literal">add_r0_to_a</tt>, <tt class="docutils literal">add_r1_to_a</tt>, <tt class="docutils literal">add_r2_to_a</tt> add the value of the
register to the accumulator</li>
<li>
<tt class="docutils literal">decr_a</tt> decrement the accumulator</li>
<li>
<tt class="docutils literal">return_a</tt> stop the program and print the accumulator</li>
</ul>
<p>The interpreter has a main loop that reads the opcode at the current program
counter, does a (lengthy) dispatch to the right bytecode via a series of if
statements and then executes the right opcode. Afterwards the next opcode is
treated equivalently.</p>
<p>Here is a part of the source code in the flow graph language. As pseudocode:</p>
<pre class="literal-block">
bytecode_loop:
    opcode = bytecode[pc]
    pc = pc + 1
    c = opcode == 'jump_if_a'
    if c goto op_jump_if_a else goto not_jump_if_a

# select the right bytecode via a long series of if statements
not_jump_if_a:
    c = opcode == 'mov_a_r0'
    if y goto op_mov_a_r0 else goto not_mov_a_r0
not_mov_a_r0:
    c = opcode == 'mov_a_r0'
    if y goto op_mov_a_r1 else goto not_mov_a_r1
...

# bytecode implementations
op_mov_a_r0:
    r0 = a
    goto bytecode_loop

op_jump_if_a:
    c = a == 0
    target = bytecode[pc]
    pc += 1
    if c goto bytecode_loop else goto op_jump_if_a_jump

op_jump_if_a_jump:
    pc = target
    goto bytecode_loop
...
</pre>
<p>And actually working, as Prolog facts (the full implementation can be found at
the link above):</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #0099FF; font-style: italic;">% bytecode dispatch loop</span>
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop</span>,
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">opcode</span>, <span style="color: #CC3300;">readlist</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>), <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>, <span style="color: #CC3300;">add</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">jump_if_a</span>),
      <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">op_jump_if_a</span>, <span style="color: #CC3300;">not_jump_if_a</span>))))).

<span style="color: #0099FF; font-style: italic;">% select the right bytecode via a long series of if statements</span>
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_jump_if_a</span>,
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r0</span>),
      <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">op_mov_a_r0</span>, <span style="color: #CC3300;">not_mov_a_r0</span>))).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_a_r0</span>,
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r1</span>),
      <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">op_mov_a_r1</span>, <span style="color: #CC3300;">not_mov_a_r1</span>))).
...

<span style="color: #0099FF; font-style: italic;">% bytecode implementations</span>
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">op_jump_if_a</span>,
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">target</span>, <span style="color: #CC3300;">readlist</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>), <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>, <span style="color: #CC3300;">add</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
      <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">bytecode_loop</span>, <span style="color: #CC3300;">op_jump_if_a_jump</span>))))).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">op_jump_if_a_jump</span>,
      <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">pc</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">target</span>),
      <span style="color: #CC00FF;">promote</span>(<span style="color: #CC3300;">bytecode</span>, <span style="color: #CC3300;">bytecode_loop</span>))).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">op_mov_a_r0</span>,
      <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r0</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">bytecode_loop</span>))).
...
</pre></div>
<p>The <tt class="docutils literal">bytecode_loop</tt> block is the main dispatch loop. It reads an opcode out of the
bytecode list at the program counter position, then has a long series of <tt class="docutils literal">if</tt>
statements that compares the current opcode to the various existing opcodes.
The full code of the interpreter can be found under the link above.</p>
<p>The bytecodes of the interpreter don't really permit hugely complex
programs, but it can be used to write a program that computes the square of a
number with the following program:</p>
<pre class="literal-block">
mov_a_r0     # r0 = a
mov_a_r1     # r1 = a
# 2:
mov_r0_a     # r0--
decr_a
mov_a_r0
mov_r2_a     # r2 += a
add_r1_to_a
mov_a_r2
mov_r0_a     # if r0!=0: goto 2
jump_if_a 2
mov_r2_a     # return r2
return_a
</pre>
<h2>Partially Evaluating the Bytecode Interpreter</h2>
<p>The partial evaluator from the first blog post can be easily used to partially
evaluate the bytecode interpreter. The static input is the bytecode for
computing the square and the initial program counter value, as given above. The
dynamic input are the content of the accumulator (the number to be squared).
This can be done as follows:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">bytecode_square</span>(<span style="color: #003333;">B</span>),
<span style="color: #003333;">Env</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span><span style="color: #003333;">B</span>, <span style="color: #CC3300;">pc</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>],
<span style="color: #CC00FF;">do_pe</span>(<span style="color: #CC3300;">bytecode_loop</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Label</span>),
<span style="color: #003333;">REnv</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">a</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r0</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>, <span style="color: #CC3300;">r1</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>, <span style="color: #CC3300;">r2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>],
<span style="color: #CC00FF;">interp</span>(<span style="color: #CC00FF;">jump</span>(<span style="color: #003333;">Label</span>), <span style="color: #003333;">REnv</span>), <span style="color: #CC00FF;">listing</span>(<span style="color: #CC3300;">block</span>).
<span style="color: #FF6600;">256</span>
:- <span style="color: #CC3300;">dynamic</span> <span style="color: #CC3300;">block</span><span style="color: #555555;">/</span><span style="color: #FF6600;">2</span>.

<span style="color: #555555;">&lt;</span><span style="color: #CC3300;">lots</span> <span style="color: #CC3300;">of</span> <span style="color: #CC3300;">generated</span> <span style="color: #CC3300;">code</span><span style="color: #555555;">&gt;</span>
</pre></div>
<p>The code that is generated by the partial evaluation process is somewhat hard to
read. It contains a lot of passages like this:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;">...
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">op_return_a1</span>, <span style="color: #CC00FF;">print_and_stop</span>(<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>))).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_decr_a1</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">op_return_a1</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_add_r2_to_a2</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_decr_a1</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_add_r1_to_a2</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_add_r2_to_a2</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_add_r0_to_a3</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_add_r1_to_a2</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_r2_a3</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_add_r0_to_a3</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_r1_a5</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_mov_r2_a3</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_r0_a5</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_mov_r1_a5</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_a_r27</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_mov_r0_a5</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_a_r18</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_mov_a_r27</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_mov_a_r09</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_mov_a_r18</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">not_jump_if_a11</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_mov_a_r09</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop12</span>, <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">not_jump_if_a11</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">op_mov_r2_a2</span>, <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r2</span>), <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">bytecode_loop12</span>))).
...
</pre></div>
<p>I.e. lots of blocks that do nothing but jump to another block, interspersed with
some blocks that contain an actual operation. I cleaned the output up manually
and got something like the following (this sort of cleanup is something a good
partial evaluation system would do itself, after partial evaluation has
occurred):</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop1</span>,
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r0</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r1</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">sub</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r0</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r2</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">add</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r1</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r2</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
    <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">bytecode_loop11</span>, <span style="color: #CC3300;">op_jump_if_a_jump1</span>)))))))))))).

<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop11</span>,
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r2</span>),
    <span style="color: #CC00FF;">print_and_stop</span>(<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>))).

<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">op_jump_if_a_jump1</span>,
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">sub</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r0</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r2</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">add</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r1</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r2</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),
    <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
    <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">bytecode_loop11</span>, <span style="color: #CC3300;">op_jump_if_a_jump1</span>)))))))))).
</pre></div>
<p>What do we see here? The partial evaluator has generated a block <tt class="docutils literal">bytecode_loop1</tt>,
which corresponds to the initialization opcodes <tt class="docutils literal">mov_a_r0</tt> and <tt class="docutils literal">mov_a_r1</tt> together
with one iteration of the loop. Then it either jumps to a copy of the main loop
(label <tt class="docutils literal">op_jump_if_a_jump1</tt>) or to block <tt class="docutils literal">bytecode_loop11</tt>, which prints the result
and then stops. The residual code does exactly what the bytecode did: It
squares the accumulator then prints that. All the uses of the <tt class="docutils literal">bytecode</tt> and
<tt class="docutils literal">pc</tt> variable are gone.</p>
<p>Why did the partial evaluator produce two copies of the main loop that
look the same? The reason for that is that in the second copy, the additional
static information <tt class="docutils literal">target = 2</tt> is known, where <tt class="docutils literal">target</tt> is a variable in
the interpreter source that stores the jump target, for very brief periods of
time. This additional static information does not have any effect on the
residual code, so the same code is uselessly generated twice. This is an
example of overspecialization.</p>
<h2>Tracing the Interpreter</h2>
<p>In this section we will look at what happens if we try to trace the interpreter.
The naive way of doing that yields traces that are not very useful, because they
abort after one iteration. We will look at a way of avoiding this problem. The
problems described in this section are at the core of the paper <a class="reference external" href="https://foss.heptapod.net/pypy/extradoc/-/blob/branch/default/tip/talk/icooolps2009/bolz-tracing-jit-final.pdf">Tracing the
meta-level: PyPy's tracing JIT compiler</a> (that paper uses a slightly more
advanced version of the bytecode interpreter as an example).</p>
<p>To trace the interpreter, it is useful to change the <tt class="docutils literal">bytecode_loop</tt> block from above
to always promote the <tt class="docutils literal">bytecode</tt> and the <tt class="docutils literal">pc</tt> variables, because without
knowing them the trace produced is not really interesting. This is similar to
making these variables static in the partial evaluation example above:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop</span>,
      <span style="color: #CC00FF;">promote</span>(<span style="color: #CC3300;">bytecode</span>, <span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>,
      <span style="color: #CC00FF;">promote</span>(<span style="color: #CC3300;">pc</span>, <span style="color: #CC3300;">bytecode_loop_promote_pc</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">bytecode_loop_promote_pc</span>,
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">opcode</span>, <span style="color: #CC3300;">readlist</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>), <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>, <span style="color: #CC3300;">add</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
      <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">eq</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
      <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">op_jump_if_a</span>, <span style="color: #CC3300;">not_jump_if_a</span>))))).
...
</pre></div>
<p>The rest of the interpreter stays unchanged.</p>
<p>To trace the interpreter we would start naively at the <tt class="docutils literal">bytecode_loop</tt> label, because
that's the label in the interpreter that is jumped to most often (which a
profiler could establish easily). The following command can be used for that
(this output prints traces in a slightly more readable way than in previous blog
posts):</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">bytecode_square</span>(<span style="color: #003333;">B</span>),
        <span style="color: #003333;">A</span> <span style="color: #555555;">=</span> <span style="color: #FF6600;">16</span>, <span style="color: #003333;">Env</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span><span style="color: #003333;">B</span>, <span style="color: #CC3300;">pc</span><span style="color: #555555;">/</span><span style="color: #FF6600;">2</span>, <span style="color: #CC3300;">a</span><span style="color: #555555;">/</span><span style="color: #003333;">A</span>, <span style="color: #CC3300;">r0</span><span style="color: #555555;">/</span><span style="color: #003333;">A</span>, <span style="color: #CC3300;">r1</span><span style="color: #555555;">/</span><span style="color: #003333;">A</span>, <span style="color: #CC3300;">r2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>],
        <span style="color: #CC00FF;">do_trace</span>(<span style="color: #CC3300;">bytecode_loop</span>, <span style="color: #003333;">Env</span>).
<span style="color: #CC3300;">trace</span>
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #FF6600;">2</span>,[],<span style="color: #CC3300;">bytecode_loop_promote_pc</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">opcode</span>,<span style="color: #CC3300;">readlist</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">jump_if_a</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_jump_if_a</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r0</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_mov_a_r0</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r1</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_mov_a_r1</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r2</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_mov_a_r2</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_r0_a</span>))
  <span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">not_mov_r0_a</span>)
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>))
  <span style="color: #CC3300;">loop</span>

<span style="color: #CC3300;">opttrace</span>
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #FF6600;">2</span>,[<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span>[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>]],<span style="color: #CC3300;">bytecode_loop_promote_pc</span>)
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">bytecode</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>([<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>]))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">3</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">opcode</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_r0_a</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>))
  <span style="color: #CC3300;">loop</span>

<span style="color: #FF6600;">256</span>
<span style="color: #003333;">B</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_a_r1</span>, <span style="color: #CC3300;">mov_r0_a</span>, <span style="color: #CC3300;">decr_a</span>, <span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_r2_a</span>, <span style="color: #CC3300;">add_r1_to_a</span>, <span style="color: #CC3300;">mov_a_r2</span>, <span style="color: #CC3300;">mov_r0_a</span>|...],
<span style="color: #003333;">A</span> <span style="color: #555555;">=</span> <span style="color: #FF6600;">16</span>,
<span style="color: #003333;">Env</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span>[<span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_a_r1</span>, <span style="color: #CC3300;">mov_r0_a</span>, <span style="color: #CC3300;">decr_a</span>, <span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_r2_a</span>, <span style="color: #CC3300;">add_r1_to_a</span>|...], <span style="color: #CC3300;">pc</span><span style="color: #555555;">/</span><span style="color: #FF6600;">2</span>, <span style="color: #CC3300;">a</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r0</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r1</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>]
</pre></div>
<p>These traces are very short. They start with promoting the <tt class="docutils literal">bytecode</tt> and the
<tt class="docutils literal">pc</tt>, followed by the execution of the opcode <tt class="docutils literal">mov_r0_a</tt>, which is the
one at position <tt class="docutils literal">2</tt> in the given bytecode. Then they increment the <tt class="docutils literal">pc</tt> and
loop back to the beginning. Looking at the optimized trace, it is clear that the
trace is essentially useless. It will run only for one iteration, because in the
second iteration the <tt class="docutils literal">pc</tt> is <tt class="docutils literal">3</tt>, thus the <tt class="docutils literal">guard_value</tt> at the beginning
will fail.</p>
<p>This problem can be solved by tracing more than just one iteration of the
bytecode dispatch loop, which is called meta-tracing. To get this behaviour, in
this simple example it is enough to start (and thus end) tracing at a different
label, <tt class="docutils literal">op_jump_if_a_jump</tt>. This label is hit when the interpreter executes a
<tt class="docutils literal">jump_if_a</tt> bytecode and the jump is taken. In a loop on the level of the
executed bytecode program there is one such jump. Thus tracing from this label,
a full loop in the bytecode program is traced, containing potentially many
iterations of the bytecode dispatch loop in the control flow graph language.</p>
<p>Doing that yields the following:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">bytecode_square</span>(<span style="color: #003333;">B</span>),
        <span style="color: #003333;">A</span> <span style="color: #555555;">=</span> <span style="color: #FF6600;">16</span>, <span style="color: #003333;">Env</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span><span style="color: #003333;">B</span>, <span style="color: #CC3300;">pc</span><span style="color: #555555;">/</span><span style="color: #FF6600;">11</span>, <span style="color: #CC3300;">a</span><span style="color: #555555;">/</span><span style="color: #003333;">A</span>, <span style="color: #CC3300;">r0</span><span style="color: #555555;">/</span><span style="color: #003333;">A</span>, <span style="color: #CC3300;">r1</span><span style="color: #555555;">/</span><span style="color: #003333;">A</span>, <span style="color: #CC3300;">r2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>, <span style="color: #CC3300;">target</span><span style="color: #555555;">/</span><span style="color: #FF6600;">2</span>],
        <span style="color: #CC00FF;">do_trace</span>(<span style="color: #CC3300;">op_jump_if_a_jump</span>, <span style="color: #003333;">Env</span>).
<span style="color: #CC3300;">trace</span>
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">target</span>))
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #FF6600;">2</span>,[],<span style="color: #CC3300;">bytecode_loop_promote_pc</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">opcode</span>,<span style="color: #CC3300;">readlist</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">jump_if_a</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_jump_if_a</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r0</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_mov_a_r0</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r1</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_mov_a_r1</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_a_r2</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">op_mov_a_r2</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">mov_r0_a</span>))
  <span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">not_mov_r0_a</span>)
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>))
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #FF6600;">3</span>,[],<span style="color: #CC3300;">bytecode_loop_promote_pc</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">opcode</span>,<span style="color: #CC3300;">readlist</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>))
  ...
  <span style="color: #CC3300;">lots</span> <span style="color: #CC3300;">of</span> <span style="color: #CC3300;">operations</span> <span style="color: #CC3300;">ommitted</span>
  ...
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop_promote_bytecode</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #FF6600;">9</span>,[],<span style="color: #CC3300;">bytecode_loop_promote_pc</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">opcode</span>,<span style="color: #CC3300;">readlist</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">opcode</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">jump_if_a</span>))
  <span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">not_jump_if_a</span>)
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">target</span>,<span style="color: #CC3300;">readlist</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">bytecode</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">pc</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">bytecode_loop</span>)
  <span style="color: #CC3300;">loop</span>

<span style="color: #CC3300;">opttrace</span>
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">target</span>))
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">bytecode</span>,[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],[],<span style="color: #CC3300;">bytecode_loop</span>)
  <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #FF6600;">2</span>,[<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span>[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>]],<span style="color: #CC3300;">bytecode_loop_promote_pc</span>)
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r0</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r2</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r1</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">r2</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">a</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">r0</span>))
  <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">eq</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">a</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>))
  <span style="color: #CC00FF;">guard_false</span>(<span style="color: #CC3300;">c</span>,[<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span>[<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>],<span style="color: #CC3300;">pc</span><span style="color: #555555;">/</span><span style="color: #FF6600;">11</span>,<span style="color: #CC3300;">opcode</span><span style="color: #555555;">/</span><span style="color: #CC3300;">jump_if_a</span>,<span style="color: #CC3300;">target</span><span style="color: #555555;">/</span><span style="color: #FF6600;">2</span>],<span style="color: #CC3300;">bytecode_loop</span>)
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">bytecode</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>([<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_a_r1</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">decr_a</span>,<span style="color: #CC3300;">mov_a_r0</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">add_r1_to_a</span>,<span style="color: #CC3300;">mov_a_r2</span>,<span style="color: #CC3300;">mov_r0_a</span>,<span style="color: #CC3300;">jump_if_a</span>,<span style="color: #FF6600;">2</span>,<span style="color: #CC3300;">mov_r2_a</span>,<span style="color: #CC3300;">return_a</span>]))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">pc</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">11</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">opcode</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #CC3300;">jump_if_a</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">target</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>))
  <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">same</span>,<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>))
  <span style="color: #CC3300;">loop</span>

<span style="color: #FF6600;">256</span>
<span style="color: #003333;">B</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_a_r1</span>, <span style="color: #CC3300;">mov_r0_a</span>, <span style="color: #CC3300;">decr_a</span>, <span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_r2_a</span>, <span style="color: #CC3300;">add_r1_to_a</span>, <span style="color: #CC3300;">mov_a_r2</span>, <span style="color: #CC3300;">mov_r0_a</span>|...],
<span style="color: #003333;">A</span> <span style="color: #555555;">=</span> <span style="color: #FF6600;">16</span>,
<span style="color: #003333;">Env</span> <span style="color: #555555;">=</span> [<span style="color: #CC3300;">bytecode</span><span style="color: #555555;">/</span>[<span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_a_r1</span>, <span style="color: #CC3300;">mov_r0_a</span>, <span style="color: #CC3300;">decr_a</span>, <span style="color: #CC3300;">mov_a_r0</span>, <span style="color: #CC3300;">mov_r2_a</span>, <span style="color: #CC3300;">add_r1_to_a</span>|...], <span style="color: #CC3300;">pc</span><span style="color: #555555;">/</span><span style="color: #FF6600;">11</span>, <span style="color: #CC3300;">a</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r0</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r1</span><span style="color: #555555;">/</span><span style="color: #FF6600;">16</span>, <span style="color: #CC3300;">r2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">0</span>, <span style="color: #CC3300;">target</span><span style="color: #555555;">/</span><span style="color: #FF6600;">2</span>] .
</pre></div>
<p>That looks better. The trace corresponds to the interpreter running all the
bytecodes in the loop of the squaring function in the example bytecode above.
The optimized code starts with
two guards (checking that the <tt class="docutils literal">bytecode</tt> is still the one for the squaring
function, checking that the <tt class="docutils literal">pc</tt> is <tt class="docutils literal">2</tt>) and then only does the operations
that actually do the computation. No bytecode dispatching is performed, thus the
interpretation overhead is fully removed, apart from the two <tt class="docutils literal">guard_value</tt>
operations at the beginning.</p>
<p>Many of the assignments in the trace are superfluous, e.g. all the copying back
and forth between registers <tt class="docutils literal">r1</tt>, <tt class="docutils literal">r1</tt>, <tt class="docutils literal">r2</tt> and accumulator <tt class="docutils literal">a</tt>. This
could be easily solved by an even more intelligent optimization utilizing <a class="reference external" href="https://en.wikipedia.org/wiki/Static_single_assignment_form">SSA
form</a>.</p>
<h2>Conclusion About the Interpreter</h2>
<p>Both partial evaluation and meta-tracing can be used to transform the example
bytecode computing a square into a form that shows the essential computation
that is going on, without the interpretation overhead. The naive partial evaluator
produces lots of extra blocks that just jump around, which could be solved with
a post-processing step. The tracer by itself produces uselessly short traces,
but with a simple trick of starting the trace at a different point the results
become a lot better.</p>
<p>In a real meta-tracing system, the meta-tracer would need a way for the author
of the interpreter
to mark which bytecode corresponds to a backward jump. It would also need better
integration with the interpreter to start tracing automatically, as well as
cache the traces. Additionally, it would have to deal better with guards that fail a
lot, attaching new traces to the failing guards. However, all that is "just"
engineering on top of the ideas presented in this series of blog posts.</p>
<h2>High-Level Conclusion</h2>
<p>Some concluding high-level thoughts about the similarities of tracing and
partial evaluation: Tracing and partial evaluation try to tackle a similar
problem, that of automatically reducing the interpreter overhead, their
approaches are slightly different though.</p>
<p>Tracing is very close to normal evaluation, only keeping some extra information
in the process. But then, the optimizer that is used in a tracer
is again very similar in structure to a partial evaluator. The task of the
optimizer is much simpler though, because it does not need to deal with control
flow at all, just a linear list of operations.</p>
<p>So in a sense tracing is taking those parts of partial evaluation that work (the
"just evaluate those things that you can, and leave the others") and replacing
the parts that don't (controlling unfolding) by a much more pragmatic mechanism.
That mechanism observes actual execution runs of the program to choose control
flow paths that are typical. At the same time, the tracer's focus is on loops,
because they are where most programs spend significant amounts of time.</p>
<p>Another point of view of tracing is that it is a form of partial evaluation that
replaces the control components of a partial evaluator with an oracle (the
actual execution runs) that provide the information which paths to look at.</p>
<p>Already in the quite trivial interpreter here the effects of this are visible.
The simple partial evaluator over-specializes the loop and produces two
identical versions of it, that aren't different. The tracer doesn't, and it
also generates only code for the loop itself, not for the initialization
opcodes.</p>
<p>That's it for this series. To those that made it, thanks for following along.
Also thanks to Samuele and Sven, who consistently gave me good feedback on the
posts before I put them here.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/02/pypy-18-business-as-usual-7266036404915945090.html" class="u-url">PyPy 1.8 - business as usual</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/maciej-fijalkowski.html">Maciej Fijalkowski</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/02/pypy-18-business-as-usual-7266036404915945090.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-02-10T09:43:00Z" itemprop="datePublished" title="2012-02-10 09:43">2012-02-10 09:43</time></a>
            </p>
                <p class="commentline">8 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>We're pleased to announce the 1.8 release of PyPy. As habitual this
release brings a lot of bugfixes, together with performance and memory
improvements over the 1.7 release. The main highlight of the release
is the introduction of <a class="reference external" href="../posts/2011/10/more-compact-lists-with-list-strategies-8229304944653956829.html">list strategies</a> which makes homogenous lists
more efficient both in terms of performance and memory. This release
also upgrades us from Python 2.7.1 compatibility to 2.7.2. Otherwise
it's "business as usual" in the sense that performance improved
roughly 10% on average since the previous release.</p>
<p>you can download the PyPy 1.8 release here:</p>
<blockquote>
<a class="reference external" href="https://pypy.org/download.html">https://pypy.org/download.html</a>
</blockquote>
<div class="section" id="what-is-pypy">
<h3>What is PyPy?</h3>
<p>PyPy is a very compliant Python interpreter, almost a drop-in replacement for
CPython 2.7. It's fast (<a class="reference external" href="https://speed.pypy.org">pypy 1.8 and cpython 2.7.1</a> performance comparison)
due to its integrated tracing JIT compiler.</p>
<p>This release supports x86 machines running Linux 32/64, Mac OS X 32/64 or
Windows 32. Windows 64 work has been stalled, we would welcome a volunteer
to handle that.</p>
</div>
<div class="section" id="highlights">
<h3>Highlights</h3>
<ul>
<li>
<p class="first">List strategies. Now lists that contain only ints or only floats should
be as efficient as storing them in a binary-packed array. It also improves
the JIT performance in places that use such lists. There are also special
strategies for unicode and string lists.</p>
</li>
<li>
<p class="first">As usual, numerous performance improvements. There are many examples
of python constructs that now should be faster; too many to list them.</p>
</li>
<li>
<p class="first">Bugfixes and compatibility fixes with CPython.</p>
</li>
<li>
<p class="first">Windows fixes.</p>
</li>
<li>
<p class="first">NumPy effort progress; for the exact list of things that have been done,
consult the <a class="reference external" href="https://buildbot.pypy.org/numpy-status/latest.html">numpy status page</a>. A tentative list of things that has
been done:</p>
<ul class="simple">
<li>multi dimensional arrays</li>
<li>various sizes of dtypes</li>
<li>a lot of ufuncs</li>
<li>a lot of other minor changes</li>
</ul>
<p>Right now the <cite>numpy</cite> module is available under both <cite>numpy</cite> and <cite>numpypy</cite>
names. However, because it's incomplete, you have to <cite>import numpypy</cite> first
before doing any imports from <cite>numpy</cite>.</p>
</li>
<li>
<p class="first">New JIT hooks that allow you to hook into the JIT process from your python
program. There is a <a class="reference external" href="https://doc.pypy.org/en/latest/jit-hooks.html">brief overview</a> of what they offer.</p>
</li>
<li>
<p class="first">Standard library upgrade from 2.7.1 to 2.7.2.</p>
</li>
</ul>
</div>
<div class="section" id="ongoing-work">
<h3>Ongoing work</h3>
<p>As usual, there is quite a bit of ongoing work that either didn't make it to
the release or is not ready yet. Highlights include:</p>
<ul class="simple">
<li>Non-x86 backends for the JIT: ARMv7 (almost ready) and PPC64 (in progress)</li>
<li>Specialized type instances - allocate instances as efficient as C structs,
including type specialization</li>
<li>More numpy work</li>
<li>Since the last release there was a significant breakthrough in PyPy's
fundraising. We now have enough funds to work on first stages of <a class="reference external" href="https://pypy.org/numpydonate.html">numpypy</a>
and <a class="reference external" href="https://pypy.org/py3donate.html">py3k</a>. We would like to thank again to everyone who donated.</li>
<li>It's also probably worth noting, we're considering donations for the
Software Transactional Memory project. You can read more about <a class="reference external" href="../posts/2012/01/transactional-memory-ii-7225309560970774590.html">our plans</a>
</li>
</ul>
<p>Cheers,<br>
The PyPy Team</p>
</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-7112051955341429289">
        <div class="comment-header">
          <a name="comment-7112051955341429289"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-10 11:08</span>:
        </div>
        <div class="comment-content">
          <p>As usual, excellent work!<br>The faster Pypy becomes, the less the need to use limited languages just for speed considerations.<br>List specialization is really cool and seems to boost performance and reduce memory usage considerably. I'd love seeing specializations for tuples of ints/floats/strings as structs.<br>On a side note, what stops people from using RPython as a compiled language (in terms of speed) with a nicer syntax?</p>
        </div>
      </div>
      <div class="comment comment-7655677355628148985">
        <div class="comment-header">
          <a name="comment-7655677355628148985"></a>
            <span class="author">Daivd</span> wrote on <span class="date">2012-02-10 12:57</span>:
        </div>
        <div class="comment-content">
          <p>Well done!<br><br>I find nothing on the comparison page about memory (maybe because it's called speed.pypy.org...). How are you stacking up against CPython there, on benchmarks and real word examples? I realize a JIT will always need some memory overhead, but perhaps you have done enough clever things now, like list strategies, to be competitive anyway?</p>
        </div>
      </div>
      <div class="comment comment-3586404333417191529">
        <div class="comment-header">
          <a name="comment-3586404333417191529"></a>
            <span class="author">halfaleague</span> wrote on <span class="date">2012-02-10 14:03</span>:
        </div>
        <div class="comment-content">
          <p>I would donate to this.<br>Would this give us 'true' multithreading?  a la clojure?</p>
        </div>
      </div>
      <div class="comment comment-4110671643992433635">
        <div class="comment-header">
          <a name="comment-4110671643992433635"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2012-02-10 17:45</span>:
        </div>
        <div class="comment-content">
          <p>Seems like you guys are ahead of the curve with STM: https://arstechnica.com/business/news/2012/02/transactional-memory-going-mainstream-with-intel-haswell.ars</p>
        </div>
      </div>
      <div class="comment comment-1482071229890804429">
        <div class="comment-header">
          <a name="comment-1482071229890804429"></a>
            <span class="author">kurdakov</span> wrote on <span class="date">2012-02-12 11:29</span>:
        </div>
        <div class="comment-content">
          <p>Did anybody test if it works with<br>pypy?<br><br>https://github.com/mvantellingen/psycopg2-ctypes<br><br>would be great to have out of the box postgresql support for Django</p>
        </div>
      </div>
      <div class="comment comment-827681827167971423">
        <div class="comment-header">
          <a name="comment-827681827167971423"></a>
            <span class="author">Joko Susilo</span> wrote on <span class="date">2012-02-13 11:02</span>:
        </div>
        <div class="comment-content">
          <p>i will try it first</p>
        </div>
      </div>
      <div class="comment comment-7359800290914138230">
        <div class="comment-header">
          <a name="comment-7359800290914138230"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-13 14:23</span>:
        </div>
        <div class="comment-content">
          <p>Just donated for py3k. I think it would make sense to allow donations for STM as well.</p>
        </div>
      </div>
      <div class="comment comment-2152544189467270714">
        <div class="comment-header">
          <a name="comment-2152544189467270714"></a>
            <span class="author">One Wellness Place</span> wrote on <span class="date">2012-04-20 10:44</span>:
        </div>
        <div class="comment-content">
          <p>I will try it.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/02/introductionary-article-about-rpython-5386281283454207551.html" class="u-url">Introductory Article About RPython</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/02/introductionary-article-about-rpython-5386281283454207551.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-02-08T15:16:00Z" itemprop="datePublished" title="2012-02-08 15:16">2012-02-08 15:16</time></a>
            </p>
                <p class="commentline">3 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <a href="https://tratt.net/laurie">Laurence Tratt</a> from King's College London has written a long and detailed introduction to the <a href="https://tratt.net/laurie/tech_articles/articles/fast_enough_vms_in_fast_enough_time">goals and significance of RPython</a> over on <a href="https://tratt.net/laurie/tech_articles/">his blog</a>. Laurie has been implementing his <a href="https://convergepl.org/">Converge Language</a> in RPython in the last months. He is one of the first people external to the PyPy team who have pushed a sizeable RPython-based VM quite far, adding and tuning JIT hints. The post describes some of that work and his impressions of RPython and PyPy.<br><br><blockquote class="tr_bq">
"RPython, to my mind, is an astonishing project. It has, almost single-handedly, opened up an entirely new approach to VM implementation. As my experience shows, creating a decent RPython VM is not a huge amount of work (despite some frustrations). In short: never again do new languages need come with unusably slow VMs. That the the PyPy / RPython team have shown that these ideas scale up to a fast implementation of a large, real-world language (Python) is another feather in their cap."  </blockquote>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-2937468965712242508">
        <div class="comment-header">
          <a name="comment-2937468965712242508"></a>
            <span class="author">Luis</span> wrote on <span class="date">2012-02-10 01:38</span>:
        </div>
        <div class="comment-content">
          <p>My English is not very good, but I suspect "Introductionary" is not a word. I would use "introductory" instead.</p>
        </div>
      </div>
      <div class="comment comment-7817067923217645838">
        <div class="comment-header">
          <a name="comment-7817067923217645838"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2012-02-10 10:07</span>:
        </div>
        <div class="comment-content">
          <p>It probably wasn't before, but now it is! (and a pretty nice word, no?)<br><br>Fixed.</p>
        </div>
      </div>
      <div class="comment comment-8263335236072410236">
        <div class="comment-header">
          <a name="comment-8263335236072410236"></a>
            <span class="author">Luis</span> wrote on <span class="date">2012-02-10 23:56</span>:
        </div>
        <div class="comment-content">
          <p>"It probably wasn't before, but now it is! (and a pretty nice word, no?)"<br><br>Well, it surely sounds more sophisticated :-)</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/02/optimizing-traces-of-flow-graph-4169388883059419385.html" class="u-url">Optimizing Traces of the Flow Graph Language</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/02/optimizing-traces-of-flow-graph-4169388883059419385.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-02-07T16:01:00Z" itemprop="datePublished" title="2012-02-07 16:01">2012-02-07 16:01</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <h2>Part 3 of Comparing Partial Evaluation to Tracing</h2>
<p>This is the third blog post in a series about comparing partial evaluation and
tracing. In the <a class="reference external" href="../posts/2012/01/comparing-partial-evaluation-and-7255412724168990164.html">first post of the series</a> I introduced a small flow-graph
language together with an interpreter for it. Then I showed a partial evaluator
for the language. In the <a class="reference external" href="../posts/2012/01/simple-tracer-for-flow-graph-language-6930951890987229484.html">second post of the series</a> I showed how a tracer for
the same language works and how it relates to both execution and to partial
evaluation. Then I added support for promotion to that tracer.</p>
<p>In this post I will show how to optimize the traces that are produced by the
tracer and compare the structure of the optimizer to that of partial
evaluation.</p>
<p>The code from this post can be found here: <a class="reference external" href="https://paste.pocoo.org/show/547304/">https://paste.pocoo.org/show/547304/</a></p>
<h2>Optimizing Traces</h2>
<p>In the last post we saw how to produce a linear trace with guards by
interpreting a control flow graph program in a special mode. A trace always end with
a <tt class="docutils literal">loop</tt> statement, which jumps to the beginning. The tracer is just logging
the operations that are done while interpreting, so the trace can contain
superfluous operations. On the other hand, the trace also contains some of the
runtime values through promotions and some decisions made on them which can be
exploited by optimization. An example for this is the trace produced by the
promotion example from the last post:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">ge</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">l_done</span>,
<span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>,<span style="color: #FF6600;">5</span>,[],<span style="color: #CC3300;">b2</span>,
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x2</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>),
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x3</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x2</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x3</span>),
<span style="color: #CC3300;">loop</span>))))))
</pre></div>
<p>After the <tt class="docutils literal">guard_value(x, 5, <span class="pre">...)</span></tt> operation, <tt class="docutils literal">x</tt> is know to be <tt class="docutils literal">5</tt>: If
it isn't <tt class="docutils literal">5</tt>, execution falls back to the interpreter. Therefore, operations
on <tt class="docutils literal">x</tt> after the guard can be constant-folded. To do that sort of
constant-folding,
an extra optimization step is needed. That optimization step walks along the
trace, remembers which variables are constants and what their values are using a
partial environment. The opimizer removes operations that have only constant
arguments and leaves the others in the trace. This process is actually
remarkably similar to partial evaluation: Some variables are known to be
constants, operations on only constant arguments are optimized away, the rest
remains.</p>
<p>The code for optimizing operations looks as follows:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">optimize</span>(<span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">NewOp</span>) :-
    <span style="color: #CC00FF;">presolve</span>(<span style="color: #003333;">Arg</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">RArg</span>),
    (<span style="color: #003333;">RArg</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">C</span>) <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">C</span>, <span style="color: #003333;">Res</span>),
        <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #003333;">RestResidual</span>
    ;
        <span style="color: #CC00FF;">remove_env</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">NEnv</span>),
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg</span>, <span style="color: #003333;">RestResidual</span>)
    ),
    <span style="color: #CC00FF;">optimize</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">RestResidual</span>).

<span style="color: #CC00FF;">optimize</span>(<span style="color: #CC00FF;">op2</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">NewOp</span>) :-
    <span style="color: #CC00FF;">presolve</span>(<span style="color: #003333;">Arg1</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">RArg1</span>),
    <span style="color: #CC00FF;">presolve</span>(<span style="color: #003333;">Arg2</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">RArg2</span>),
    (<span style="color: #003333;">RArg1</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">C1</span>), <span style="color: #003333;">RArg2</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">C2</span>) <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">C1</span>, <span style="color: #003333;">C2</span>, <span style="color: #003333;">Res</span>),
        <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #003333;">RestResidual</span>
    ;
        <span style="color: #CC00FF;">remove_env</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">NEnv</span>),
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">op2</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg1</span>, <span style="color: #003333;">RArg2</span>, <span style="color: #003333;">RestResidual</span>)
    ),
    <span style="color: #CC00FF;">optimize</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">RestResidual</span>).
</pre></div>
<p>Just like partial evaluation! It even reuses the helper functions <tt class="docutils literal">presolve</tt>
from the partial evaluator and a partial environment <tt class="docutils literal">PEnv</tt>. When the
arguments of the operation are known constants in the partial environment, the
operation can be executed at optimization time and removed from the trace.
Otherwise, the operation has to stay in the output trace. The result variable
(as in the partial evaluator) needs to be removed from the partial environment,
because it was just overwritten by an unknown result.</p>
<p>Now we need to deal with guards in the trace.</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">optimize</span>(<span style="color: #CC00FF;">guard_true</span>(<span style="color: #003333;">V</span>, [], <span style="color: #003333;">L</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">NewOp</span>) :-
    <span style="color: #CC00FF;">plookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">C</span>) <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #003333;">RestResidual</span>
    ;
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">guard_true</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">L</span>, <span style="color: #003333;">RestResidual</span>)
    ),
    <span style="color: #CC00FF;">optimize</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">RestResidual</span>).

<span style="color: #CC00FF;">optimize</span>(<span style="color: #CC00FF;">guard_false</span>(<span style="color: #003333;">V</span>, [], <span style="color: #003333;">L</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">NewOp</span>) :-
    <span style="color: #CC00FF;">plookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">C</span>) <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #003333;">RestResidual</span>,
        <span style="color: #003333;">NEnv</span> <span style="color: #555555;">=</span> <span style="color: #003333;">PEnv</span>
    ;
        <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">V</span>, <span style="color: #FF6600;">0</span>, <span style="color: #003333;">NEnv</span>),
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">guard_false</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">L</span>, <span style="color: #003333;">RestResidual</span>)
    ),
    <span style="color: #CC00FF;">optimize</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">RestResidual</span>).
</pre></div>
<p>When the variable that is being guarded is actually known to be a constant, we
can remove the guard. Note that it is not possible that the guard of that
constant fails: The tracer recorded the operation while running with real
values, therefore the guards <em>have</em> to succeed for values the optimizer
discovers to be constant.</p>
<p><tt class="docutils literal">guard_false</tt> is slightly different from <tt class="docutils literal">guard_true</tt>: after the former we
know that the argument is actually <tt class="docutils literal">0</tt>. After <tt class="docutils literal">guard_true</tt> we only know that
it is not equal to zero, but not which precise value it has.</p>
<p>Another point to note in the optimization of guards is that the second argument
of the guard operation, which was so far always just an empty list, is now
replaced by the partial environment <tt class="docutils literal">PEnv</tt>. I will discuss further down why
this is needed.</p>
<p>Optimizing <tt class="docutils literal">guard_value</tt> is very similar, except that it really gives precise
information about the variable involved:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">optimize</span>(<span style="color: #CC00FF;">guard_value</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">C</span>, [], <span style="color: #003333;">L</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">NewOp</span>) :-
    <span style="color: #CC00FF;">plookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">C1</span>) <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #003333;">RestResidual</span>,
        <span style="color: #003333;">NEnv</span> <span style="color: #555555;">=</span> <span style="color: #003333;">PEnv</span>
    ;
        <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">V</span>, <span style="color: #003333;">C</span>, <span style="color: #003333;">NEnv</span>),
        <span style="color: #003333;">NewOp</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">guard_value</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">C</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">L</span>, <span style="color: #003333;">RestResidual</span>)
    ),
    <span style="color: #CC00FF;">optimize</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">RestResidual</span>).
</pre></div>
<p>This operation is the main way how the optimizer gains constant variables that
it then exploits to do constant-folding on later operations. This is a chief
difference from partial evaluation: There the optimizer knows the value of some
variables from the start. When optimizing traces, at the beginning the value of
no variable is known. Knowledge about some variables is only later gained
through guards.</p>
<p>Now we are missing what happens with the <tt class="docutils literal">loop</tt> statement. In principle, it is
turned into a <tt class="docutils literal">loop</tt> statement again. However, at the loop statement a few
additional operations need to be emitted. The reason is that we optimized away
operations and thus assignments when the result value of the variable was a
constant. That means the involved variable still potentially has some older
value. The next iteration of the loop would continue with this older value,
which is obviously wrong. Therefore we need to emit some assignments before the
loop statement, one per entry in the partial environment:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">optimize</span>(<span style="color: #CC3300;">loop</span>, <span style="color: #003333;">PEnv</span>, <span style="color: #003333;">T</span>) :-
    <span style="color: #CC00FF;">generate_assignments</span>(<span style="color: #003333;">PEnv</span>, <span style="color: #003333;">T</span>).

<span style="color: #CC00FF;">generate_assignments</span>([], <span style="color: #CC3300;">loop</span>).
<span style="color: #CC00FF;">generate_assignments</span>([<span style="color: #003333;">Var</span><span style="color: #555555;">/</span><span style="color: #003333;">Val</span> | <span style="color: #003333;">Tail</span>], <span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">Var</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #003333;">Val</span>), <span style="color: #003333;">T</span>)) :-
    <span style="color: #CC00FF;">generate_assignments</span>(<span style="color: #003333;">Tail</span>, <span style="color: #003333;">T</span>).
</pre></div>
<p>As an example of how <tt class="docutils literal">generate_assignments</tt> assignments works, let's look at
the following example. When the partial environment is, <tt class="docutils literal">[x/5, y/10]</tt> the
following assignments are generated:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">generate_assignments</span>([<span style="color: #CC3300;">x</span><span style="color: #555555;">/</span><span style="color: #FF6600;">5</span>, <span style="color: #CC3300;">y</span><span style="color: #555555;">/</span><span style="color: #FF6600;">10</span>], <span style="color: #003333;">Out</span>).
<span style="color: #003333;">Out</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">5</span>), <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">y</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">10</span>), <span style="color: #CC3300;">loop</span>)).
</pre></div>
<p>That's all the code of the optimizer. While the basic structure is quite similar to partial evaluation,
it's a lot less complex as well. What made the partial evaluator hard was that
it needs to deal with control flow statements and with making sure that code is
reused if the same block is partially evaluated with the same constants. Here,
all these complexities go away. The tracer has already removed all control flow
and replaced it with guards and one <tt class="docutils literal">loop</tt> operation at the end. Thus, the
optimizer can simply do one pass over the operations, removing some (with some
extra care around the <tt class="docutils literal">loop</tt> statement).</p>
<p>With this machinery in place, we can optimize the trace from the promotion
example of the last post:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">optimize</span>(
    <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>,<span style="color: #FF6600;">3</span>,[],<span style="color: #CC3300;">b2</span>,
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x2</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x3</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x2</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x3</span>),
    <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">ge</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
    <span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">l_done</span>, <span style="color: #CC3300;">loop</span>)))))),
    [],
    <span style="color: #003333;">LoopOut</span>).
<span style="color: #003333;">LoopOut</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>, <span style="color: #FF6600;">3</span>, [], <span style="color: #CC3300;">b2</span>, <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>, <span style="color: #CC3300;">sub</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">7</span>), <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">ge</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>), <span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>, [<span style="color: #CC3300;">x</span><span style="color: #555555;">/</span><span style="color: #FF6600;">3</span>, <span style="color: #CC3300;">x2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">6</span>, <span style="color: #CC3300;">x3</span><span style="color: #555555;">/</span><span style="color: #FF6600;">7</span>], <span style="color: #CC3300;">l_done</span>, <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">3</span>), <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x2</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">6</span>), <span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x3</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">7</span>), <span style="color: #CC3300;">loop</span>)))))))
</pre></div>
<p>More readably, the optimized version is:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>, <span style="color: #FF6600;">3</span>, [], <span style="color: #CC3300;">b2</span>,
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>, <span style="color: #CC3300;">sub</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">7</span>),
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">ge</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>, [<span style="color: #CC3300;">x</span><span style="color: #555555;">/</span><span style="color: #FF6600;">3</span>, <span style="color: #CC3300;">x2</span><span style="color: #555555;">/</span><span style="color: #FF6600;">6</span>, <span style="color: #CC3300;">x3</span><span style="color: #555555;">/</span><span style="color: #FF6600;">7</span>], <span style="color: #CC3300;">l_done</span>,
<span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">3</span>),
<span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x2</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">6</span>),
<span style="color: #CC00FF;">op1</span>(<span style="color: #CC3300;">x3</span>, <span style="color: #CC3300;">same</span>, <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">7</span>),
<span style="color: #CC3300;">loop</span>)))))))
</pre></div>
<p>As intended, the operations on <tt class="docutils literal">x</tt> after the <tt class="docutils literal">guard_value</tt> have all been
removed. However, some additional assignments (to <tt class="docutils literal">x</tt>, <tt class="docutils literal">x2</tt>, <tt class="docutils literal">x3</tt>) at the end have been generated as
well. The assignments look superfluous, but the optimizer does not have
enough information to easily recognize this. That can be fixed, but only at the
cost of additional complexity. (A real system would transform the trace into
<a class="reference external" href="https://en.wikipedia.org/wiki/Static_single_assignment_form">static single assignment form</a> to answer such questions.)</p>
<h2>Resuming to the Interpreter</h2>
<p>Why does the code above need to add the partial environment to
the guards that cannot be optimized away? The reason is related to why we needed
to generate assignments before the <tt class="docutils literal">loop</tt> statement. The problem is that the optimizer
removes assignments to variables when it knows the values of these variables.
That means that when switching back from running the optimized trace to the
interpreter, a number of variables are not updated in the environment, making
the execution in the interpreter incorrect.</p>
<p>In the example above, this applies to the variables <tt class="docutils literal">x2</tt> and <tt class="docutils literal">x3</tt>. When the
second guard fails, they have not been assigned in the optimized case.
Therefore, the guard lists them and their (always constant) values.</p>
<p>When switching back these assignments need to be made. Thus we need to adapt the
<tt class="docutils literal">resume_interp</tt> function from the last blog post as follows:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">write_resumevars</span>([], <span style="color: #003333;">Env</span>, <span style="color: #003333;">Env</span>).
<span style="color: #CC00FF;">write_resumevars</span>([<span style="color: #003333;">Key</span> <span style="color: #555555;">/</span> <span style="color: #003333;">Value</span> | <span style="color: #003333;">Rest</span>], <span style="color: #003333;">Env</span>, <span style="color: #003333;">NEnv</span>) :-
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">Key</span>, <span style="color: #003333;">Value</span>, <span style="color: #003333;">Env1</span>),
    <span style="color: #CC00FF;">write_resumevars</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">Env1</span>, <span style="color: #003333;">NEnv</span>).

<span style="color: #CC00FF;">resume_interp</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>) :-
    <span style="color: #CC00FF;">write_resumevars</span>(<span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">block</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">Block</span>),
    <span style="color: #CC00FF;">interp</span>(<span style="color: #003333;">Block</span>, <span style="color: #003333;">NEnv</span>).
</pre></div>
<p>On resuming, the <tt class="docutils literal">ResumeVars</tt> (a former partial environment) are simply added
back to the normal environment before going back to the interpreter.</p>
<p>The data attached to guards about what needs to be done to resume to the
interpreter when the guard fails is often a very complex part of a tracing
system. The data can become big, yet most guards never fail. Therefore, most
real systems try hard to compress the attached data or try to share it between
subsequent guards.</p>
<h2>Summary</h2>
<p>In this post we have shown how to optimize traces by applying a variant of the
partial evaluation principle: Perform all the operations that have only constant
arguments, leave the others alone. However, optimizing traces is much simpler,
because no control flow is involved. All the questions about control flow have
already been solved by the tracing component.</p>
<p>In the next and final post of the series I will show a larger example of how
tracing and partial evaluation can be used to optimize a small bytecode
interpreter.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/02/almost-there-pypys-arm-backend_01-3216759488618774525.html" class="u-url">Almost There - PyPy's ARM Backend</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/david-schneider.html">David Schneider</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/02/almost-there-pypys-arm-backend_01-3216759488618774525.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-02-01T09:43:00Z" itemprop="datePublished" title="2012-02-01 09:43">2012-02-01 09:43</time></a>
            </p>
                <p class="commentline">18 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <div style="text-align: left;">
In this post I want to give an update on the status of the ARM backend for PyPy's JIT and describe some of the issues and details of the backend.</div>
<div class="section" id="current-status">
<br><h2>




Current Status</h2>
It has been a more than a year that I have been working on the ARM backend. Now it is in a shape, that we can measure meaningful numbers and also ask for some feedback. Since the <a class="reference external" href="../posts/2011/01/jit-backend-for-arm-processors-5994810755839586463.html">last post about the backend</a> we have added support floating point operations as well as for PyPy's framework GC's. Another area of work was to keep up with the constant improvements done in the main development branch, such as out-of-line guards, labels, etc. It has been possible for about a year to cross-translate the PyPy Python interpreter and other interpreters such as <a class="reference external" href="https://bitbucket.org/cfbolz/pyrolog/">Pyrolog</a>, with a JIT, to run benchmarks on ARM. Up until now there remained some hard to track bugs that would cause the interpreter to crash with a segmentation fault in certain cases when running with the JIT on ARM. Lately it was possible to run all benchmarks without problems, but when running the translation toolchain itself it would crash. During the last PyPy sprint in <a class="reference external" href="../posts/2011/12/leysin-winter-sprint-6862532189897876336.html">Leysin</a> Armin and I managed to fix several of these hard to track bugs in the ARM backend with the result that, it is now possible to run the PyPy translator on ARM itself (at least unless until it runs out of memory), which is a kind of litmus test for the backend itself and used to crash before. Just to point it out, we are not able to complete a PyPy translation on ARM, because on the hardware we have currently available there is not enough memory. But up to the point we run out of memory the JIT does not hit any issues.<br><br>
</div>
<div class="section" id="implementation-details">
<h2>




Implementation Details</h2>
The hardware requirements to run the JIT on ARM follow those for Ubuntu on ARM which targets ARMv7 with a VFP unit running in little endian mode. The JIT can be translated without floating point support, but there might be a few places that need to be fixed to fully work in this setting. We are targeting the ARM instruction set, because at least at the time we decided to use it seemed to be the best choice in terms of speed while having some size overhead compared to the Thumb2 instruction set. It appears that the Thumb2 instruction set should give comparable speed with better code density but has a few restriction on the number of registers available and the use of conditional execution. Also the implementation is a bit easier using a fixed width instruction set and we can use the full set of registers in the generated code when using the ARM instruction set.<br><br>
</div>
<div class="section" id="the-calling-convention-on-arm">
<h2>




The calling convention on ARM</h2>
The calling convention on ARM uses 4 of the general purpose registers to pass arguments to functions, further arguments are passed on the stack. The presence of a floating point unit is not required for ARM cores, for this reason there are different ways of handling floats with relation to the calling convention. There is a so called soft-float calling convention that is independent of the presence of a floating point unit. For this calling convention floating point arguments to functions are stored in the general purpose registers and on the stack. Passing floats around this way works with software and hardware floating point implementations. But in presence of a floating point unit it produces some overhead, because floating point numbers need to be moved from the floating point unit to the core registers to do a call and moved back to the floating point registers by the callee. The alternative calling convention is the so-called hard-float calling convention which requires the presence of a floating point unit but has the advantage of getting rid of the overhead of moving floating point values around when performing a call. Although it would be better in the long term to support the hard-float calling convention, we need to be able to interoperate with external code compiled for the operating system we are running on. For this reason at the moment we only support the soft-float to interoperate with external code. We implemented and tested the backend on a <a class="reference external" href="https://beagleboard.org/hardware-xM/">BeagleBoard-xM</a> with a <a class="reference external" href="https://www.arm.com/products/processors/cortex-a/cortex-a8.php">Cortex-A8</a> processor running <a class="reference external" href="https://wiki.ubuntu.com/ARM">Ubuntu 11.04 for ARM</a>.<br><br>
</div>
<div class="section" id="translating-for-arm">
<h2>




Translating for ARM</h2>
The toolchain used to translate PyPy currently is based on a <a class="reference external" href="https://maemo.gitorious.org/scratchbox2/pages/Home">Scratchbox2</a>. Scratchbox2 is a cross-compiling environment. Development had stopped for a while, but it seems to have revived again. We run a 32-bit Python interpreter on the host system and perform all calls to the compiler using a Scratchbox2 based environment. A description on how to setup the cross translation toolchain can be found <a class="reference external" href="https://bitbucket.org/pypy/pypy/src/1f07ea8076c9/pypy/doc/arm.rst">here</a>.<br><br>
</div>
<div class="section" id="results">
<h2>




Results</h2>
The current results on ARM, as shown in the graph below, show that the JIT currently gives a speedup of about 3.5 times compared to CPython on ARM. The benchmarks were run on the before mentioned BeagleBoard-xM with a 1GHz ARM Cortex-A8 processor and 512MB of memory. The operating system on the board is Ubuntu 11.04 for ARM. We measured the PyPy interpreter with the JIT enabled and disabled comparing each to CPython Python 2.7.1+ (r271:86832) for ARM. The graph shows the speedup or slowdown of both PyPy versions for the different benchmarks from our benchmark suite normalized to the runtime of CPython. The data used for the graph can be seen below.<br><div class="separator" style="clear: both; text-align: center;">
<a href="https://2.bp.blogspot.com/-uckc9tOWgnM/TykHMuuGT9I/AAAAAAAAAKg/J8_fC6RS-QA/s1600/graph.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="258" src="https://2.bp.blogspot.com/-uckc9tOWgnM/TykHMuuGT9I/AAAAAAAAAKg/J8_fC6RS-QA/s400/graph.png" width="400"></a>
</div>
<br>
The speedup is less than the speedup of 5.2 times we currently  get on x86 on our own benchmark suite (see <a class="reference external" href="https://speed.pypy.org/">https://speed.pypy.org</a> for details). There are several possible reasons for this. Comparing the results for the interpreter without the JIT on ARM and x86 suggests that the interpreter generated by PyPy, without the JIT, has a worse performance when compared to CPython that it does on x86. Also it is quite possible that the code we are generating with the JIT is not yet optimal. Also there are some architectural constraints produce some overhead. One of these differences is the handling of constants, most ARM instructions only support 8 bit (that can be shifted) immediate values, larger constants need to be loaded into a register, something that is not necessary on x86.<br><br><table border="1" class="docutils">
<colgroup></colgroup>
<colgroup><col width="40%"></colgroup>
<colgroup><col width="32%"></colgroup>
<colgroup><col width="28%"></colgroup>
<tbody valign="top">
<tr>
<td>Benchmark</td>
<td>PyPy JIT</td>
<td>PyPy no JIT</td>
</tr>
<tr>
<td>ai</td>
<td>0.484439780047</td>
<td>3.72756749625</td>
</tr>
<tr>
<td>chaos</td>
<td>0.0807291691934</td>
<td>2.2908692212</td>
</tr>
<tr>
<td>crypto_pyaes</td>
<td>0.0711114832245</td>
<td>3.30112318509</td>
</tr>
<tr>
<td>django</td>
<td>0.0977743245519</td>
<td>2.56779947601</td>
</tr>
<tr>
<td>fannkuch</td>
<td>0.210423735698</td>
<td>2.49163632938</td>
</tr>
<tr>
<td>float</td>
<td>0.154275334675</td>
<td>2.12053281495</td>
</tr>
<tr>
<td>go</td>
<td>0.330483034202</td>
<td>5.84628320479</td>
</tr>
<tr>
<td>html5lib</td>
<td>0.629264389862</td>
<td>3.60333138526</td>
</tr>
<tr>
<td>meteor-contest</td>
<td>0.984747426912</td>
<td>2.93838610037</td>
</tr>
<tr>
<td>nbody_modified</td>
<td>0.236969593082</td>
<td>1.40027234936</td>
</tr>
<tr>
<td>pyflate-fast</td>
<td>0.367447191807</td>
<td>2.72472422146</td>
</tr>
<tr>
<td>raytrace-simple</td>
<td>0.0290527461437</td>
<td>1.97270054339</td>
</tr>
<tr>
<td>richards</td>
<td>0.034575573553</td>
<td>3.29767342015</td>
</tr>
<tr>
<td>slowspitfire</td>
<td>0.786642551908</td>
<td>3.7397367403</td>
</tr>
<tr>
<td>spambayes</td>
<td>0.660324379456</td>
<td>3.29059863111</td>
</tr>
<tr>
<td>spectral-norm</td>
<td>0.063610783731</td>
<td>4.01788986233</td>
</tr>
<tr>
<td>spitfire</td>
<td>0.43617131165</td>
<td>2.72050579076</td>
</tr>
<tr>
<td>spitfire_cstringio</td>
<td>0.255538702134</td>
<td>1.7418593111</td>
</tr>
<tr>
<td>telco</td>
<td>0.102918930413</td>
<td>3.86388866047</td>
</tr>
<tr>
<td>twisted_iteration</td>
<td>0.122723986805</td>
<td>4.33632475491</td>
</tr>
<tr>
<td>twisted_names</td>
<td>2.42367797135</td>
<td>2.99878698076</td>
</tr>
<tr>
<td>twisted_pb</td>
<td>1.30991837431</td>
<td>4.48877805486</td>
</tr>
<tr>
<td>twisted_tcp</td>
<td>0.927033354055</td>
<td>2.8161624665</td>
</tr>
<tr>
<td>waf</td>
<td>1.02059811932</td>
<td>1.03793427321</td>
</tr>
</tbody>
</table>
</div>
<br><br><div class="section" id="the-next-steps-and-call-for-help">
<h2>




The next steps and call for help</h2>
Although there probably still are some remaining issues which have not surfaced yet, the JIT backend for ARM is working. Before we can merge the backend into the main development line there are some things that we would like to do first, in particular it we are looking for a way to run the all PyPy tests to verify that things work on ARM before we can merge. Additionally there are some other longterm ideas. To do this we are looking for people willing to help, either by contributing to implement the open features or that can help us with hardware to test.<br><br>
The incomplete list of open topics:<br><ul class="simple">
<li>We are looking for a better way to translate PyPy for ARM, than the one describe above. I am not sure if there currently is hardware with enough memory to directly translate PyPy on an ARM based system, this would require between 1.5 or 2 Gig of memory. A fully <a class="reference external" href="https://wiki.qemu.org/Main_Page">QEMU</a> based approach could also work, instead of Scratchbox2 that uses QEMU under the hood.</li>
<li>Test the JIT on different hardware.</li>
<li>Experiment with the JIT settings to find the optimal thresholds for ARM.</li>
<li>Continuous integration: We are looking for a way to run the PyPy test suite to make sure everything works as expected on ARM, here QEMU also might provide an alternative.</li>
<li>A long term plan would be to port the backend to ARMv5 ISA and improve the support for systems without a floating point unit. This would require to implement the ISA and create different code paths and improve the instruction selection depending on the target architecture.</li>
<li>Review of the generated machine code the JIT generates on ARM to see if the instruction selection makes sense for ARM.</li>
<li>Build a version that runs on Android.</li>
<li>Improve the tools, i.e. integrate with <a class="reference external" href="https://bitbucket.org/pypy/jitviewer">jitviewer</a>.</li>
</ul>
So if you are interested or willing to help in any way contact us.</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-7465482082921266586">
        <div class="comment-header">
          <a name="comment-7465482082921266586"></a>
            <span class="author">Michael Hudson-Doyle</span> wrote on <span class="date">2012-02-02 00:20</span>:
        </div>
        <div class="comment-content">
          <p>Awesome news.  We might be able to donate some time in the Linaro validation lab to running tests, I'll see what we can do...</p>
        </div>
      </div>
      <div class="comment comment-8507175046008718049">
        <div class="comment-header">
          <a name="comment-8507175046008718049"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-02 21:55</span>:
        </div>
        <div class="comment-content">
          <p>"Just to point it out, we are not able to complete a PyPy translation on ARM, because on the hardware we have currently available there is not enough memory."<br><br>Can't you just add more swap?</p>
        </div>
      </div>
      <div class="comment comment-4486072884680676135">
        <div class="comment-header">
          <a name="comment-4486072884680676135"></a>
            <span class="author">Jan Ziak (atomsymbol)</span> wrote on <span class="date">2012-02-03 09:08</span>:
        </div>
        <div class="comment-content">
          <p>You wrote: "The speedup is less than the speedup of 5.2 times you currently get on x86."<br><br>The removed comment was meant to point out that the author of the blog post does not (and cannot) know the actual speedups (and slowdowns) people are getting on their machines.<br><br>The speedup of 5.2 you mentioned is contradicting my own experience.<br><br>I suggest you rewrite your sentence into "The speedup is less than the speedup of 5.2 times we currently get on x86."</p>
        </div>
      </div>
      <div class="comment comment-4864633761964548991">
        <div class="comment-header">
          <a name="comment-4864633761964548991"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2012-02-03 09:15</span>:
        </div>
        <div class="comment-content">
          <p>"The speedup of 5.2 you mentioned is contradicting my own experience."<br><br>Did you run the very same benchmark suite or some arbitrary programs? If arbitrary programs then sorry, but it's seriously impossible for us to optimize stuff we don't know about. Please submit bug tracker issues for that.<br><br>I agree the speedup should be qualified "on our own benchmark suite", but if you don't contribute benchmarks, you can't complain.</p>
        </div>
      </div>
      <div class="comment comment-5546022386257269483">
        <div class="comment-header">
          <a name="comment-5546022386257269483"></a>
            <span class="author">David Schneider</span> wrote on <span class="date">2012-02-03 11:30</span>:
        </div>
        <div class="comment-content">
          <p>@⚛ to avoid misunderstandings I updated the sentence in question to make it clear that I was comparing the performance of the ARM backend running our own benchmark suite to the results of the benchmarks as shown on speed.pypy.org.</p>
        </div>
      </div>
      <div class="comment comment-357867687383619487">
        <div class="comment-header">
          <a name="comment-357867687383619487"></a>
            <span class="author">Naos</span> wrote on <span class="date">2012-02-03 23:19</span>:
        </div>
        <div class="comment-content">
          <p>Every time I visit comments to blog posts on this page I see some hater or two or even more who, don't know why, have wierd problems without a reason. People chill out, you get this brilliant piece of software and you do not have to pay for it.</p>
        </div>
      </div>
      <div class="comment comment-649719125364436650">
        <div class="comment-header">
          <a name="comment-649719125364436650"></a>
            <span class="author">Jan Ziak (atomsymbol)</span> wrote on <span class="date">2012-02-04 08:36</span>:
        </div>
        <div class="comment-content">
          <p>@Naos: I do *not* hate PyPy. I like it and want to make it better. To do that, I am using a method different from your method. I would like the PyPy team to figure out how to run my benchmark faster without me disclosing the name of the benchmark. I believe that in the end this method will lead to a couple of universal optimizations in PyPy.</p>
        </div>
      </div>
      <div class="comment comment-3697214829700473557">
        <div class="comment-header">
          <a name="comment-3697214829700473557"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2012-02-04 09:38</span>:
        </div>
        <div class="comment-content">
          <p>@⚛ Contrary to what you might believe, this ends up with you being annoying and nothing else. If you think we don't think all the time about general improvements, you're wrong, but pointless, unscientific complaining is not welcomed here.</p>
        </div>
      </div>
      <div class="comment comment-5737333706142015107">
        <div class="comment-header">
          <a name="comment-5737333706142015107"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-06 10:55</span>:
        </div>
        <div class="comment-content">
          <p>will it work on the raspberry pi or does it use a different arm architecture?<br><br>(i am confused by arms. :) apparently it isn't like in the x86 world where everything is compatible with each other.)</p>
        </div>
      </div>
      <div class="comment comment-1987835752350568972">
        <div class="comment-header">
          <a name="comment-1987835752350568972"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-06 11:46</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous<br><br>&gt; The hardware requirements to run the JIT on ARM follow those for Ubuntu on ARM which targets ARMv7 with a VFP unit running in little endian mode.<br><br>This is higher than Raspberry Pi's ARMv6.</p>
        </div>
      </div>
      <div class="comment comment-1284420885683877247">
        <div class="comment-header">
          <a name="comment-1284420885683877247"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-06 22:14</span>:
        </div>
        <div class="comment-content">
          <b>A long term plan would be to port the backend to ARMv5 ISA and improve the support for systems without a floating point unit. This would require to implement the ISA and create different code paths and improve the instruction selection depending on the target architecture.</b><br><br>so someday it will support the v6 too? or isn't v5 and v6 compatible either?
        </div>
      </div>
      <div class="comment comment-1799650818342377804">
        <div class="comment-header">
          <a name="comment-1799650818342377804"></a>
            <span class="author">David Schneider</span> wrote on <span class="date">2012-02-09 14:18</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous ARMv6 should be backwards compatible to the ARMv5 ISA. So it should be possible to use the JIT on ARMv6 once it works for ARMv5.</p>
        </div>
      </div>
      <div class="comment comment-1722977824918113754">
        <div class="comment-header">
          <a name="comment-1722977824918113754"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-02-10 08:10</span>:
        </div>
        <div class="comment-content">
          <p>Really nice with raspberry Pi being released and ARM proto boards gaining traction. Looking forward to develop w/ this on rPi</p>
        </div>
      </div>
      <div class="comment comment-2372873309925743589">
        <div class="comment-header">
          <a name="comment-2372873309925743589"></a>
            <span class="author">d.q.</span> wrote on <span class="date">2012-03-14 16:42</span>:
        </div>
        <div class="comment-content">
          <p>I have an arm system with enough swap, microsd or cifs or both... though a setup like this will probably take until next release to translate pypy, won't it?<br>Can also do usermode qemu of course.</p>
        </div>
      </div>
      <div class="comment comment-2339667312085320662">
        <div class="comment-header">
          <a name="comment-2339667312085320662"></a>
            <span class="author">David Schneider</span> wrote on <span class="date">2012-04-18 10:05</span>:
        </div>
        <div class="comment-content">
          <p>@d.q. It would at least take until the next release, if not several...<br>A qemu based solution would be interesting. If you are interested I would propose you join #pypy on IRC to discuss</p>
        </div>
      </div>
      <div class="comment comment-8392965845470921501">
        <div class="comment-header">
          <a name="comment-8392965845470921501"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-03-01 01:28</span>:
        </div>
        <div class="comment-content">
          <p>I'm pretty sure the guys over at Boundary Devices are making a SabreLite variant with 2GB ram.<br><br>https://boundarydevices.com/imx6-options-single-dual-core-2gb-ddr/<br><br>You may need to email them directly to purchase it still, but they're responsive and a pleasure to work with.</p>
        </div>
      </div>
      <div class="comment comment-4878646708367241892">
        <div class="comment-header">
          <a name="comment-4878646708367241892"></a>
            <span class="author">Eric van Riet Paap</span> wrote on <span class="date">2013-03-19 14:15</span>:
        </div>
        <div class="comment-content">
          <p>Anyone try to create a qemu based solution? Even if only a build system. I would be interested in having some documentation about how to build pypy for Raspberry Pi. I know it's a non-compatible ARM version but we have to start somewhere. Plus I have a very RPi's laying around  to play with...</p>
        </div>
      </div>
      <div class="comment comment-290956699714032338">
        <div class="comment-header">
          <a name="comment-290956699714032338"></a>
            <span class="author">Eric van Riet Paap</span> wrote on <span class="date">2013-03-19 14:17</span>:
        </div>
        <div class="comment-content">
          <p>Anyone tried to build with a qemu setup? I have several Raspberry Pi's around that I could play with. I know the JIT will not work because of the difference in ARM versions but it's a start.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/01/simple-tracer-for-flow-graph-language-6930951890987229484.html" class="u-url">A Simple Tracer for the Flow Graph Language</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/01/simple-tracer-for-flow-graph-language-6930951890987229484.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-01-31T14:16:00Z" itemprop="datePublished" title="2012-01-31 14:16">2012-01-31 14:16</time></a>
            </p>
                <p class="commentline">4 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <h2>Part 2 of Comparing Partial Evaluation to Tracing</h2>
<p>This is the second blog post in a series about comparing partial evaluation and
tracing. In the <a class="reference external" href="../posts/2012/01/comparing-partial-evaluation-and-7255412724168990164.html">first post of the series</a> I introduced a small flow-graph
language together with an interpreter for it. Then I showed a partial evaluator
for the language. In this post I will show how a tracer for the same language
works and how it relates to both execution and to partial evaluation.
The code from this post can be found here: <a class="reference external" href="https://paste.pocoo.org/show/543542/">https://paste.pocoo.org/show/543542/</a></p>
<h2>Tracing Execution</h2>
<p>The idea of a tracer (for the described language and also in general) is to do completely normal
interpretation but at the same time keep a log of all the normal operations
(i.e. non-control-flow operations) that were performed. This continues until the
tracer executes the code block where it started at, in which case the trace
corresponds to a closed loop. Then tracing stops and the last operation is
replaced by a jump to the start. After tracing has ended, the trace can be
executed, optionally optimizing it before that.</p>
<p>To write a tracer, we start from the rules of the interpreter, rename the
predicate to <tt class="docutils literal">trace</tt> and add some extra arguments. Thus, the following rules
in the interpreter:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">interp</span>(<span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg</span>),
    <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg</span>, <span style="color: #003333;">Res</span>),
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">interp</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>).

<span style="color: #CC00FF;">interp</span>(<span style="color: #CC00FF;">op2</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg1</span>),
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg2</span>),
    <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg1</span>, <span style="color: #003333;">RArg2</span>, <span style="color: #003333;">Res</span>),
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">interp</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>).
</pre></div>
<p>become the following rules in the tracer:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg</span>, <span style="color: #003333;">T</span>), <span style="color: #003333;">TraceAnchor</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg</span>),
    <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg</span>, <span style="color: #003333;">Res</span>),
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">trace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">T</span>, <span style="color: #003333;">TraceAnchor</span>).

<span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">op2</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #CC00FF;">op2</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Arg2</span>, <span style="color: #003333;">T</span>), <span style="color: #003333;">TraceAnchor</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg1</span>),
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg2</span>),
    <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg1</span>, <span style="color: #003333;">RArg2</span>, <span style="color: #003333;">Res</span>),
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">trace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">T</span>, <span style="color: #003333;">TraceAnchor</span>).
</pre></div>
<p>Note how the bodies of the <tt class="docutils literal">trace</tt> rules correspond exactly to the bodies of
the <tt class="docutils literal">interp</tt> rules, the only difference is the recursive call to <tt class="docutils literal">trace</tt>.
The meaning of the arguments of <tt class="docutils literal">trace</tt> is as follows: The first and second argument are
the operation currently executed and the environment,
like in the interpreter. The argument
after that is an output argument that collects the currently traced operation,
in the example above it is exactly like the operation that was executed.
<tt class="docutils literal">TraceAnchor</tt> is additional information about the trace that is being built
right now, most of the time it is just handed on to the recursive call of
<tt class="docutils literal">trace</tt>. We will see later what it contains.</p>
<p>The rule for <tt class="docutils literal">print_and_stop</tt> is very simple, as execution (and therefore also
tracing) simply stops there:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">print_and_stop</span>(<span style="color: #003333;">V</span>), <span style="color: #003333;">Env</span>, <span style="color: #CC00FF;">print_and_stop</span>(<span style="color: #003333;">V</span>), <span style="color: #006699; font-weight: bold;">_</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Val</span>),
    <span style="color: #CC00FF;">print</span>(<span style="color: #003333;">Val</span>), <span style="color: #CC3300;">nl</span>.
</pre></div>
<p>Left are the rules for the control operations <tt class="docutils literal">jump</tt> and <tt class="docutils literal">if</tt>. A trace
linearizes one execution path, it contains no jumps. However, when a jump to the
starting label is reached, tracing should stop. Therefore, the implementation of
<tt class="docutils literal">jump</tt> contains two cases:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">jump</span>(<span style="color: #003333;">L</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">T</span>, <span style="color: #003333;">TraceAnchor</span>) :-
    (<span style="color: #003333;">TraceAnchor</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">traceanchor</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">FullTrace</span>) <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #003333;">T</span> <span style="color: #555555;">=</span> <span style="color: #CC3300;">loop</span>,
        <span style="color: #CC00FF;">write</span>(<span style="color: #CC3300;">trace</span>), <span style="color: #CC3300;">nl</span>, <span style="color: #CC00FF;">write</span>(<span style="color: #003333;">FullTrace</span>), <span style="color: #CC3300;">nl</span>,
        <span style="color: #CC00FF;">do_optimize</span>(<span style="color: #003333;">FullTrace</span>, <span style="color: #003333;">OptTrace</span>),
        <span style="color: #CC00FF;">write</span>(<span style="color: #CC3300;">opttrace</span>), <span style="color: #CC3300;">nl</span>, <span style="color: #CC00FF;">write</span>(<span style="color: #003333;">OptTrace</span>), <span style="color: #CC3300;">nl</span>,
        <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">OptTrace</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">OptTrace</span>)
    ;
        <span style="color: #CC00FF;">block</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">Block</span>),
        <span style="color: #CC00FF;">trace</span>(<span style="color: #003333;">Block</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">T</span>, <span style="color: #003333;">TraceAnchor</span>)
    ).
</pre></div>
<p>Let's disect this code in small increments. First, we see what <tt class="docutils literal">TraceAnchor</tt>
is. It is a term of the form
<tt class="docutils literal">traceanchor(StartLabel, FullTrace)</tt>. <tt class="docutils literal">StartLabel</tt> is a label in the program
where tracing started (and where it should end as well, when the loop is
closed). The argument <tt class="docutils literal">FullTrace</tt> is an accumulator which contains the full
trace that is being built right now.</p>
<p>The condition at the start of the rule checks whether the taget-label <tt class="docutils literal">L</tt> is
the same as the one stored in the trace anchor. If that is the case, we can stop
tracing. The rest of the trace <tt class="docutils literal">T</tt> is assigned the operation <tt class="docutils literal">loop</tt>, which
jumps back to the beginning of the trace. Afterwards we print and optimize the
trace, then run it, using the <tt class="docutils literal">FullTrace</tt> part of the <tt class="docutils literal">traceanchor</tt>.</p>
<p>If the label we jump to is <em>not</em> the <tt class="docutils literal">StartLabel</tt> we simply continue tracing
without recording any operation. This part of the rule is again extremely
similar to the interpretation of <tt class="docutils literal">jump</tt>.</p>
<p>For now, we will not use any interesting optimizations, just return the
unoptimized trace unchanged:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">do_optimize</span>(<span style="color: #003333;">FullTrace</span>, <span style="color: #003333;">FullTrace</span>).
</pre></div>
<p>The missing operation now is <tt class="docutils literal">if</tt>. An if statement needs special treatment,
because it is a way where control flow can diverge from the trace. The trace is
linear, therefore it can only record one of the two possible paths. When
executing the trace it is possible for the other path to be taken. Therefore
we need to make sure that the same conditions that were true or false during
tracing are still true or false during the execution of the trace. This is done
with a guard operation, which checks for this condition. The following rule
implements it:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">if</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">L1</span>, <span style="color: #003333;">L2</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">T</span>, <span style="color: #003333;">TraceAnchor</span>) :-
    <span style="color: #CC00FF;">lookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">==</span> <span style="color: #FF6600;">0</span> <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #003333;">L</span> <span style="color: #555555;">=</span> <span style="color: #003333;">L2</span>, <span style="color: #003333;">T</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">guard_false</span>(<span style="color: #003333;">V</span>, [], <span style="color: #003333;">L1</span>, <span style="color: #003333;">NT</span>)
    ;
        <span style="color: #003333;">L</span> <span style="color: #555555;">=</span> <span style="color: #003333;">L1</span>, <span style="color: #003333;">T</span> <span style="color: #555555;">=</span> <span style="color: #CC00FF;">guard_true</span>(<span style="color: #003333;">V</span>, [], <span style="color: #003333;">L2</span>, <span style="color: #003333;">NT</span>)
    ),
    <span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">jump</span>(<span style="color: #003333;">L</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">NT</span>, <span style="color: #003333;">TraceAnchor</span>).
</pre></div>
<p>It is very similar to the <tt class="docutils literal">interp</tt> rule of <tt class="docutils literal">if</tt>. The rule inserts a
<tt class="docutils literal">guard_true</tt> into the case, if the condition is true, and a <tt class="docutils literal">guard_false</tt> if
the condition is false. The arguments of the guard are: The variable that is
being guarded, an empty list (the reason for that will be explained in a later
post), the label where execution needs to continue when the guard fails and the
rest of the trace.</p>
<p>Let's also add a small helper predicate that can be used to conveniently start
tracing:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">do_trace</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">Env</span>) :-
    <span style="color: #CC00FF;">block</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">StartBlock</span>),
    <span style="color: #CC00FF;">trace</span>(<span style="color: #003333;">StartBlock</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">ProducedTrace</span>, <span style="color: #CC00FF;">traceanchor</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">ProducedTrace</span>)).
</pre></div>
<p>The predicate takes a label and an environment and executes the label with the
given environment by first producing a trace, then executing the trace and
eventually jumping back to interpretation, if a guard fails. It does this by
reading the code at label <tt class="docutils literal">L</tt> with the <tt class="docutils literal">block</tt> statement, and then calling
trace with an unbound variable <tt class="docutils literal">ProducedTrace</tt> to hold the trace and a trace
anchor that contains the label where tracing started and the produced trace
variable.</p>
<p>With that predicate and the trace so far we can already trace the <tt class="docutils literal">power</tt>
implementation from the last blog post, just not execute the trace (which we
will do in the next section):</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">do_trace</span>(<span style="color: #CC3300;">power_rec</span>, [<span style="color: #CC3300;">res</span><span style="color: #555555;">/</span><span style="color: #FF6600;">1</span>, <span style="color: #CC3300;">x</span><span style="color: #555555;">/</span><span style="color: #FF6600;">10</span>, <span style="color: #CC3300;">y</span><span style="color: #555555;">/</span><span style="color: #FF6600;">20</span>]).
<span style="color: #CC3300;">trace</span>
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">res</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">res</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">y</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">y</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">y</span>,[],<span style="color: #CC3300;">power_done</span>,<span style="color: #CC3300;">loop</span>)))
<span style="color: #CC3300;">opttrace</span>
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">res</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">res</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">y</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">y</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">y</span>,[],<span style="color: #CC3300;">power_done</span>,<span style="color: #CC3300;">loop</span>)))
...
</pre></div>
<p>The computed trace is:</p>
<pre class="literal-block">
op2(res,mul,var(res),var(x),
op2(y,sub,var(y),const(1),
guard_true(y,[],power_done,
loop)))
</pre>
<p>which is exactly the content of the loop from <tt class="docutils literal">power_rec</tt>. Note how the <tt class="docutils literal">if</tt>
is turned into a <tt class="docutils literal">guard_true</tt> which jumps to <tt class="docutils literal">power_done</tt> if the guard
fails.</p>
<p>A real tracing system would need a way for the tracer to get started, e.g. by
doing profiling in an interpreter and starting the tracer for labels that are
jumped to often. Also, traces for the same label are usually cached in some way.
These details are left out in this simple model.</p>
<h2>Executing Traces</h2>
<p>In a real tracing system, the traces would be turned into machine code and
executed by the CPU. In our small model, we will simply write another
interpreter for them. This interpreter is very simple and looks again very
similar to <tt class="docutils literal">interp</tt>.</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">runtrace</span>(<span style="color: #CC00FF;">op1</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg</span>),
    <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg</span>, <span style="color: #003333;">Res</span>),
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">TraceFromStart</span>).

<span style="color: #CC00FF;">runtrace</span>(<span style="color: #CC00FF;">op2</span>(<span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Op</span>, <span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>) :-
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg1</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg1</span>),
    <span style="color: #CC00FF;">resolve</span>(<span style="color: #003333;">Arg2</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">RArg2</span>),
    <span style="color: #CC00FF;">do_op</span>(<span style="color: #003333;">Op</span>, <span style="color: #003333;">RArg1</span>, <span style="color: #003333;">RArg2</span>, <span style="color: #003333;">Res</span>),
    <span style="color: #CC00FF;">write_env</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResultVar</span>, <span style="color: #003333;">Res</span>, <span style="color: #003333;">NEnv</span>),
    <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">NEnv</span>, <span style="color: #003333;">TraceFromStart</span>).
</pre></div>
<p>These rules are completely equivalent to the <tt class="docutils literal">interp</tt> rules for <tt class="docutils literal">op1</tt> and
<tt class="docutils literal">op2</tt>. <tt class="docutils literal">runtrace</tt> needs an extra argument, <tt class="docutils literal">TraceFromStart</tt>, which is
always just handed over to the recursive call of <tt class="docutils literal">runtrace</tt>.</p>
<p>When the end of the trace is reached and the <tt class="docutils literal">loop</tt> statement is encountered,
we simply start from the beginning:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">runtrace</span>(<span style="color: #CC3300;">loop</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>) :-
    <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">TraceFromStart</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>).
</pre></div>
<p>The remaining question is what to do when encountering guards. In that case the
guard condition needs to be checked. If the guard succeeds, executing the trace can
continue. Otherwise the trace is aborted and the interpreter resumes execution:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">runtrace</span>(<span style="color: #CC00FF;">guard_true</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>) :-
    <span style="color: #CC00FF;">lookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">==</span> <span style="color: #FF6600;">0</span> <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #CC00FF;">resume_interp</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>)
    ;
        <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>)
    ).

<span style="color: #CC00FF;">runtrace</span>(<span style="color: #CC00FF;">guard_false</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>) :-
    <span style="color: #CC00FF;">lookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">==</span> <span style="color: #FF6600;">0</span> <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>)
    ;
        <span style="color: #CC00FF;">resume_interp</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>)
    ).


<span style="color: #CC00FF;">resume_interp</span>(<span style="color: #003333;">Env</span>, [], <span style="color: #003333;">L</span>) :-
    <span style="color: #CC00FF;">block</span>(<span style="color: #003333;">L</span>, <span style="color: #003333;">Block</span>),
    <span style="color: #CC00FF;">interp</span>(<span style="color: #003333;">Block</span>, <span style="color: #003333;">Env</span>).
</pre></div>
<p>Note how the execution is handed over to the interpreter at the label that was
encoded as the third argument in the guard operation.
What the <tt class="docutils literal">ResumeVars</tt> are for we will see in a later post. For now we assume
that it is always an empty list.</p>
<p>With this interpreter for traces we can now trace and then execute the example:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;">:- <span style="color: #CC00FF;">do_trace</span>(<span style="color: #CC3300;">power_rec</span>, [<span style="color: #CC3300;">res</span><span style="color: #555555;">/</span><span style="color: #FF6600;">1</span>, <span style="color: #CC3300;">x</span><span style="color: #555555;">/</span><span style="color: #FF6600;">10</span>, <span style="color: #CC3300;">y</span><span style="color: #555555;">/</span><span style="color: #FF6600;">20</span>]).
<span style="color: #CC3300;">trace</span>
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">res</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">res</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">y</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">y</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">y</span>,[],<span style="color: #CC3300;">power_done</span>,<span style="color: #CC3300;">loop</span>)))
<span style="color: #CC3300;">opttrace</span>
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">res</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">res</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">y</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">y</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">y</span>,[],<span style="color: #CC3300;">power_done</span>,<span style="color: #CC3300;">loop</span>)))
<span style="color: #FF6600;">100000000000000000000</span>
</pre></div>
<p>Of course this is example is not very exciting, because the trace looks more or less exactly
like the original code as well. There will be more exciting examples in a later
post.</p>
<h2>Extension: Promotion</h2>
<p>As it is, the tracer does not actually add much to the interpreter. It
linearizes control flow, but nothing deeply advanced happens. In this section I
will add a crucial but simple to implement extension to the control flow language that allows the tracer
to do more interesting things. This extension is called <em>promotion</em>.</p>
<p>Promotion is basically a hint that the programmer can add to her control flow
graph program. A promotion is an operation <tt class="docutils literal">promote(V, L)</tt> that takes a
variable <tt class="docutils literal">V</tt> and a label <tt class="docutils literal">L</tt>. When the interpreter runs this statement, it
simply jumps to the label <tt class="docutils literal">L</tt> and ignores the variable:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">interp</span>(<span style="color: #CC00FF;">promote</span>(<span style="color: #006699; font-weight: bold;">_</span>, <span style="color: #003333;">L</span>), <span style="color: #003333;">Env</span>) :-
    <span style="color: #CC00FF;">interp</span>(<span style="color: #CC00FF;">jump</span>(<span style="color: #003333;">L</span>), <span style="color: #003333;">Env</span>).
</pre></div>
<p>However, the tracer does something much more interesting. For the tracer, the
<tt class="docutils literal">promote</tt> statement is a hint that it would be very useful to know the value
of <tt class="docutils literal">V</tt> and that the rest of the trace should keep that value as a constant.
Therefore, when the tracer encounters a promotion, it inserts a special kind of
guard called <tt class="docutils literal">guard_value</tt></p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">promote</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">L</span>), <span style="color: #003333;">Env</span>, <span style="color: #CC00FF;">guard_value</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Val</span>, [], <span style="color: #003333;">L</span>, <span style="color: #003333;">T</span>), <span style="color: #003333;">TraceAnchor</span>) :-
    <span style="color: #CC00FF;">lookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Val</span>),
    <span style="color: #CC00FF;">trace</span>(<span style="color: #CC00FF;">jump</span>(<span style="color: #003333;">L</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">T</span>, <span style="color: #003333;">TraceAnchor</span>).
</pre></div>
<p>The <tt class="docutils literal">guard_value</tt> is an interesting operation, because it freezes the current
value <tt class="docutils literal">FVal</tt> of variable <tt class="docutils literal">V</tt> into the trace. When the trace is executed, the
guard checks that the current value of the variable and the frozen value are the
same. If yes, execution continues, if not, the trace is aborted:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">runtrace</span>(<span style="color: #CC00FF;">guard_value</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">FVal</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>, <span style="color: #003333;">Rest</span>), <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>) :-
    <span style="color: #CC00FF;">lookup</span>(<span style="color: #003333;">V</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">Val</span>),
    (<span style="color: #003333;">Val</span> <span style="color: #555555;">==</span> <span style="color: #003333;">FVal</span> <span style="color: #CC3300;">-&gt;</span>
        <span style="color: #CC00FF;">runtrace</span>(<span style="color: #003333;">Rest</span>, <span style="color: #003333;">Env</span>, <span style="color: #003333;">TraceFromStart</span>)
    ;
        <span style="color: #CC00FF;">resume_interp</span>(<span style="color: #003333;">Env</span>, <span style="color: #003333;">ResumeVars</span>, <span style="color: #003333;">L</span>)
    ).
</pre></div>
<p>What can this operation be used for? It's a way to communicate to the tracer
that variable <tt class="docutils literal">V</tt> is not changing very often and that it is therefore useful
to freeze the current value into the trace. This can be done even without
knowing the value of <tt class="docutils literal">V</tt> in advance.</p>
<p>Let's look at a (slightly contrived) example:</p>
<pre class="literal-block">
l:
    c = i &gt;= 0
    if c goto b else goto l_done

l_done:
    print_and_stop(var(i))

b:
    promote(x, b2)

b2:
    x2 = x * 2
    x3 = x2 + 1
    i = i - x3
    goto l
</pre>
<p>Encoded in Prolog syntax:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">l</span>, <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">ge</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
         <span style="color: #CC00FF;">if</span>(<span style="color: #CC3300;">c</span>, <span style="color: #CC3300;">b</span>, <span style="color: #CC3300;">l_done</span>))).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">l_done</span>, <span style="color: #CC00FF;">print_and_stop</span>(<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>))).

<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">b</span>, <span style="color: #CC00FF;">promote</span>(<span style="color: #CC3300;">x</span>, <span style="color: #CC3300;">b2</span>)).
<span style="color: #CC00FF;">block</span>(<span style="color: #CC3300;">b2</span>, <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x2</span>, <span style="color: #CC3300;">mul</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>),
          <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x3</span>, <span style="color: #CC3300;">add</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x2</span>), <span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
          <span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>, <span style="color: #CC3300;">sub</span>, <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>), <span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x3</span>),
          <span style="color: #CC00FF;">jump</span>(<span style="color: #CC3300;">l</span>))))).
</pre></div>
<p>This is a simple loop that counts down in steps of <tt class="docutils literal">x * 2 + 1</tt>, whatever <tt class="docutils literal">x</tt>
might be, until <tt class="docutils literal">i &gt;= 0</tt> is no longer true. Assuming that <tt class="docutils literal">x</tt> doesn't change
often, it is worth to promote it to be able to constant-fold <tt class="docutils literal">x * 2 + 1</tt> to
not have to redo it every iteration. This is done with the promotion of <tt class="docutils literal">x</tt>
(of course optimizing this loop with loop invariant code motion would work as
well, because <tt class="docutils literal">x</tt> doesn't actually change during the loop).</p>
<p>To trace this, we can run the following query:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC3300;">?-</span> <span style="color: #CC00FF;">do_trace</span>(<span style="color: #CC3300;">b</span>, [<span style="color: #CC3300;">i</span><span style="color: #555555;">/</span><span style="color: #FF6600;">100</span>, <span style="color: #CC3300;">x</span><span style="color: #555555;">/</span><span style="color: #FF6600;">5</span>]).
<span style="color: #CC3300;">trace</span>
<span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>,<span style="color: #FF6600;">5</span>,[],<span style="color: #CC3300;">b2</span>,<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x2</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x3</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x2</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x3</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">ge</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">l_done</span>,<span style="color: #CC3300;">loop</span>))))))
<span style="color: #CC3300;">opttrace</span>
<span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>,<span style="color: #FF6600;">5</span>,[],<span style="color: #CC3300;">b2</span>,<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x2</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x3</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x2</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x3</span>),<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">ge</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">l_done</span>,<span style="color: #CC3300;">loop</span>))))))
<span style="color: #555555;">-</span><span style="color: #FF6600;">10</span>
</pre></div>
<p>Writing the trace in a more readable way:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #CC00FF;">guard_value</span>(<span style="color: #CC3300;">x</span>,<span style="color: #FF6600;">3</span>,[],<span style="color: #CC3300;">b2</span>,
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x2</span>,<span style="color: #CC3300;">mul</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">2</span>),
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">x3</span>,<span style="color: #CC3300;">add</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x2</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">1</span>),
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">i</span>,<span style="color: #CC3300;">sub</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">x3</span>),
<span style="color: #CC00FF;">op2</span>(<span style="color: #CC3300;">c</span>,<span style="color: #CC3300;">ge</span>,<span style="color: #CC00FF;">var</span>(<span style="color: #CC3300;">i</span>),<span style="color: #CC00FF;">const</span>(<span style="color: #FF6600;">0</span>),
<span style="color: #CC00FF;">guard_true</span>(<span style="color: #CC3300;">c</span>,[],<span style="color: #CC3300;">l_done</span>,
<span style="color: #CC3300;">loop</span>))))))
</pre></div>
<p>After the <tt class="docutils literal">guard_value</tt> the operations performed on <tt class="docutils literal">x</tt> could be
constant-folded away, because the guard ensures that <tt class="docutils literal">x</tt> is <tt class="docutils literal">5</tt> before
execution continues. To actually do the constant-folding we would need some
optimization component that optimizes traces. This will be done in the next blog
post.</p>
<p>In this section I mostly talked about how promotion is realized in the tracer,
not what and how to use to use it for. Promotion is one of the most important
ingredients that's responsible for the success of PyPy's tracing approach. How
this works is discussed in detail in the paper "<a class="reference external" href="https://foss.heptapod.net/pypy/extradoc/-/blob/branch/default/tip/talk/icooolps2011/bolz-hints-final.pdf">Runtime feedback in a
meta-tracing JIT for efficient dynamic languages</a>".</p>
<h2>Conclusion</h2>
<p>In this blog post we have seen a very minimalistic tracer and an interpreter for
the produced traces. The tracer is very much like the original interpreter, it
just also keeps track of which operations were executed, in addition to
executing the program. Tracing stops when a loop is closed, then the trace can
be optimized and run. Running a trace continues until a failing guard is hit. At
that point, execution goes back to the normal interpreter (and stays there, in
this very simple implementation).</p>
<p>I also presented an extension of tracing that makes it possible to add a hint
called <tt class="docutils literal">promote</tt> to the original program that tells the tracer to feed back a
runtime value into the trace and freeze it there. This extension would be
impossible to do in the partial evaluator from the last post, because partial
evaluation is done strictly before run time, so if a variable isn't already
known, its likely runtime value cannot be found out.</p>
<p>In the next post I will show how to optimize traces before executing them and
how the optimizer for traces is related to partial evaluation.</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-3472829740130276365">
        <div class="comment-header">
          <a name="comment-3472829740130276365"></a>
            <span class="author">larsr</span> wrote on <span class="date">2012-02-01 13:54</span>:
        </div>
        <div class="comment-content">
          <p>Hi, these posts are great!<br><br>A question:  shouldn't runtrace resume tracing instead of running the interpreter (in resume_interp)? <br><br>And perhaps a clarification: when the blog post calls do_trace all of the necessary code has not been shown yet, so one can't really follow along at the keyboard there just yet.</p>
        </div>
      </div>
      <div class="comment comment-6887431208440914757">
        <div class="comment-header">
          <a name="comment-6887431208440914757"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2012-02-02 15:36</span>:
        </div>
        <div class="comment-content">
          <p>@larsr: thanks!<br><br>Yes, in principle you are right that there could be a mechanism that stars to trace from the point where a guard fails. This is an element of tracing JITs that the current code leaves off, it would need to be solved together with the caching of traces.<br><br>A lot of things are just sketched in this implementation, e.g. only one trace ever is started, once you end up in the interpreter the tracer never starts again.</p>
        </div>
      </div>
      <div class="comment comment-3255752652377434431">
        <div class="comment-header">
          <a name="comment-3255752652377434431"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-03-04 11:46</span>:
        </div>
        <div class="comment-content">
          <p>trace(if(V, L1, L2), Env, T, TraceAnchor) :-<br>    lookup(V, Env, Val),<br>    (Val == 0 -&gt;<br>        L = L2, T = guard_false(V, [], L1, NT)<br>    ;<br>        L = L1, T = guard_true(V, [], L2, NT)<br>    ),<br>    trace(jump(L), Env, NT, TraceAnchor). This trac is okay, but python IDE is not Adroid supported. <a href="https://www.bglen-fan.net/" rel="nofollow">ビーグレン</a></p>
        </div>
      </div>
      <div class="comment comment-3913654534209887117">
        <div class="comment-header">
          <a name="comment-3913654534209887117"></a>
            <span class="author">quadhier</span> wrote on <span class="date">2020-08-04 15:52</span>:
        </div>
        <div class="comment-content">
          <p>Hi! Great posts. But the source code url is invalid now, could you please provide the source code again? THANKS!</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/01/numpypy-status-update-6434340612277938795.html" class="u-url">NumPyPy status update</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/maciej-fijalkowski.html">Maciej Fijalkowski</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/01/numpypy-status-update-6434340612277938795.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-01-28T13:06:00Z" itemprop="datePublished" title="2012-01-28 13:06">2012-01-28 13:06</time></a>
            </p>
                <p class="commentline">3 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Hello.</p>
<p>This is just a quick status update on the NumPy in PyPy project that very
recently became my day job. I should give my thanks once again to Getco,
Nate Lawson and other contributors who donated above $40000 towards the goal.</p>
<p>Recently we (Alex Gaynor, Matti Picus and me) implemented a few interesting things
that a lot of people use:</p>
<ul class="simple">
<li>more ufuncs</li>
<li>most ufuncs now accept the <tt class="docutils literal">axis</tt> parameter (except <tt class="docutils literal">all</tt> and <tt class="docutils literal">any</tt>)</li>
<li>fixed string representation of arrays, now it's identical to numpy (uses
pretty much the same code)</li>
<li>
<tt class="docutils literal">ndarray.flat</tt> should be working correctly</li>
<li>
<tt class="docutils literal">ndarray.flatten</tt>, <tt class="docutils literal">ndarray.ravel</tt>, <tt class="docutils literal">ndarray.take</tt>
</li>
<li>indexing arrays by boolean arrays of the same size</li>
<li>and various bugfixes.</li>
</ul>
<p>We would also like to introduce the <a class="reference external" href="https://buildbot.pypy.org/numpy-status/latest.html">nightly report</a> of numpy status. This
is an automated tool that does package introspection. While it gives some
sort of idea how much of numpy is implemented, it's not by far the authority.
Your tests should be the authority. It won't report whether functions
support all kinds of parameters (for example masked arrays and <tt class="docutils literal">out</tt> parameter
are completely unsupported) or that functions work <strong>at all</strong>. We also
reserve the right to incorporate jokes in that website, so don't treat it
that seriously overall :-)</p>
<p>Thanks, and stay tuned.  We hope to post here regular updates on the
progress.</p>
<p>Cheers,<br>
fijal &amp; the PyPy team</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-6059790892169819528">
        <div class="comment-header">
          <a name="comment-6059790892169819528"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-01-28 14:54</span>:
        </div>
        <div class="comment-content">
          <p>I use "out" parameter very often in my code (with numpy.take), without this one my code would run much worse (because huge arrays of hundreds MB would copy many times inside a big cycle). How currently the "out" parameter is handled (warning, error, nothing)?</p>
        </div>
      </div>
      <div class="comment comment-3661039179908282204">
        <div class="comment-header">
          <a name="comment-3661039179908282204"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2012-01-28 15:01</span>:
        </div>
        <div class="comment-content">
          <p>It just errors with more or less acceptable error message. Note that pypy does not create intermediates for most of operations, so if you have a lot of them chained actually using out will be worse than not using it.</p>
        </div>
      </div>
      <div class="comment comment-3140775928561689956">
        <div class="comment-header">
          <a name="comment-3140775928561689956"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-01-29 23:31</span>:
        </div>
        <div class="comment-content">
          <p>I'm new to python but not to Cpython/numpy/scipy/matplotlib and I fail to understand what you are doing.<br><br>* In a nutshell, what's numpypy? Is it a rewrite of the numpy code to make it compatible with pypy? or are you working on pypy itself to be able to run numpy as it is??<br><br>* if numpypy is a rewrite of numpy, that's good but how do you plan to keep numpy and numpypy sync (in terms of functionalities)??<br><br>* Using numpy with pypy will be great but what about scipy qnd matplotlib??<br>Many users need at least these two modules on top of numpy;<br><br>I would be very happy with pypy being able to work with unpachted numpy/scipy/matplotlib.<br><br>I think your website should summarise these issues on its front page.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2012/01/py3k-and-numpy-first-stage-thanks-to-3008917396290059758.html" class="u-url">Py3k and Numpy First Stage: Thanks to all who Gave</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/maciej-fijalkowski.html">Maciej Fijalkowski</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2012/01/py3k-and-numpy-first-stage-thanks-to-3008917396290059758.html" rel="bookmark">
            <time class="published dt-published" datetime="2012-01-27T09:46:00Z" itemprop="datePublished" title="2012-01-27 09:46">2012-01-27 09:46</time></a>
            </p>
                <p class="commentline">4 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Last year was quite successful for PyPy fundraising through the <a class="reference external" href="https://sfconservancy.org/">Software Freedom Conservancy</a>, and Conservancy and PyPy are very excited to announce that enough was raised to begin the first stages on the <a class="reference external" href="https://pypy.org/py3donate.html">Py3k</a> and <a class="reference external" href="https://pypy.org/numpydonate.html">Numpy</a> grant proposals.</p>
<p>As of the end of 2011, 135 different individuals gave to the <a class="reference external" href="https://pypy.org/py3donate.html">Py3k</a> campaign, and 114 to the <a class="reference external" href="https://pypy.org/numpydonate.html">Numpy</a> campaign.  We thank each of you who donated to help make this work possible.  Meanwhile, if you haven't given to support these projects, we do hope you'll give generously now to help fund their second stages later this year!</p>
<p>We're also particularly excited that a few donors gave particularly large donations to support this work; those big donations really filled in the gap to help us get started!</p>
<p>Specifically, we're pleased to announce that <a class="reference external" href="https://google.com">Google</a>  donated $35000 towards implementing Python 3 in PyPy.   Google's general support of the Python community is well known, and their specific support of our grant proposal is much appreciated.</p>
<p>Meanwhile, Numpy was supported in part by contributions from Nate Lawson, <a class="reference external" href="https://www.cantabcapital.com/">Cantab Capital Partners</a>, and <a class="reference external" href="https://www.getcollc.com/">Getco</a>, as well as more than a hundred other contributors.</p>
<p>With these donations combined with many others, we're now starting work on both projects.  This week, the <a class="reference external" href="https://sfconservancy.org/">Conservancy</a> signed contracts with <a class="reference external" href="https://twitter.com/#!/antocuni">Antonio Cuni</a> and Benjamin Peterson to work towards the Stage 1.1 goals in Py3k proposal (and is negotiating for another contractor as well), and with <a class="reference external" href="https://baroquesoftware.com/~fijal/">Maciej Fijałkowski</a> to work towards the Stage 1 goals in the Numpy proposal.</p>
<p>In 2012, PyPy will continue regular <a class="reference external" href="../posts/2011/12/leysin-winter-sprint-6862532189897876336.html">sprint meetings</a>, at which Py3K and Numpy efforts will certainly have a place.  We have some limited funds to fund travels of contributors to those meetings.</p>
<p>We're very thankful for all who donated so far to support these efforts, and we hope that now that work has begun, even more donors will come forward to help us finish the job.  In the meantime, watch for the commits showing up from these developers and other contributors in the PyPy repositories!</p>
<p>Cheers, The PyPy Team</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-1600807579226727093">
        <div class="comment-header">
          <a name="comment-1600807579226727093"></a>
            <span class="author">Gaëtan de Menten</span> wrote on <span class="date">2012-01-28 20:35</span>:
        </div>
        <div class="comment-content">
          <p>It seems strange to me that Amaury Forgeot d'Arc wasn't the first one to be contracted for working on Py3k support. From the commit messages, he seems to have done most of the work in the py3k branch so far, or is he the unnamed third contractor?</p>
        </div>
      </div>
      <div class="comment comment-281616704896314722">
        <div class="comment-header">
          <a name="comment-281616704896314722"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-01-28 23:12</span>:
        </div>
        <div class="comment-content">
          <p>What about a Py2k8, is there any hope? Will at least 2.7 still be supported?</p>
        </div>
      </div>
      <div class="comment comment-644903643211057067">
        <div class="comment-header">
          <a name="comment-644903643211057067"></a>
            <span class="author">Amaury Forgeot d'Arc</span> wrote on <span class="date">2012-01-28 23:22</span>:
        </div>
        <div class="comment-content">
          <p>@Gaëtan: The reason is simple: I already have a regular day job, 40 hours a week, and I cannot have another remuneration without consent of my employer.<br><br>Actually I started the py3k branch before the funding proposal, and even before that I've been trying different ways to do the transition from str to unicode.<br>Then, my understanding of the JIT and other optimizations is very poor. And there are important changes to do around the representation of unicode for example, or the int/long unification, if we want pypy3k to be as fast as 2.7.<br><br>I am quite happy of the current state: some people are paid to do and finish the real job, and volunteers can have fun and help in some parts, working on the most interesting project around Python.</p>
        </div>
      </div>
      <div class="comment comment-8545768132335737967">
        <div class="comment-header">
          <a name="comment-8545768132335737967"></a>
            <span class="author">Amaury Forgeot d'Arc</span> wrote on <span class="date">2012-01-28 23:27</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous: there won't be any Python 2.8 (search for PEP404 for the reasons), but as stated in the py3k grant proposal: https://pypy.org/py3donate.html<br>"The goal of the PyPy community is to support both Python 2 and Python 3 for the forseeable future"</p>
        </div>
      </div>
         </div>

</div>
</div>
<div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/12/toy-load-store.html" class="listtitle">Load and store forwarding in the Toy Optimizer</a>
      </li>
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (6)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div></div>
</main>
</div>
<div style="clear: both; width: 75%; margin: 1em auto;">
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-23.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-21.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
         
                 <footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2026 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2026-01-17T00:22
  </div>
  <div style="margin-left: auto">
  <a href="../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../assets/js/styles.js"></script></footer>
</body>
</html>