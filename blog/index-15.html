<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A Faster Python">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PyPy (old posts, page 15) | PyPy</title>
<link href="../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://www.pypy.org/blog/index-15.html">
<link rel="icon" href="../favicon2.ico" sizes="16x16">
<link rel="icon" href="../favicon32x32.ico" sizes="32x32">
<link rel="prev" href="index-16.html" type="text/html">
<link rel="next" href="index-14.html" type="text/html">
<!--[if lt IE 9]><script src="../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../assets/css/tipuesearch.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../index.html">
                    <image id="toplogo" src="../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../compat.html">Compatibility</a> </li>  
                    <li> <a href="../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href=".">Index</a> </li>  
                    <li> <a href="../categories/">Tags</a> </li>  
                    <li> <a href="../archive.html">Archive by year</a> </li>  
                    <li> <a href="../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Searchâ€¦" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><div class="post">
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/10/peace-of-green-4230271053903469504.html" class="u-url">The peace of green</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/10/peace-of-green-4230271053903469504.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-10-25T15:24:00Z" itemprop="datePublished" title="2010-10-25 15:24">2010-10-25 15:24</time></a>
            </p>
                <p class="commentline">2 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>No, we are not going to talk about the environment (i.e., the set of variables
as printed by <tt class="docutils literal">/usr/bin/env</tt>. What else? :-)).</p>
<p>After months in which we had a couple of tests failing every day, we finally
managed to turn (almost) everything green today, at least on Linux.  Enjoy
this screenshoot taken from the <a class="reference external" href="https://buildbot.pypy.org/nightly/trunk/">nightly build</a> page:</p>

<a href="https://2.bp.blogspot.com/_4gR6Ggu8oHQ/TMWkBA_G-cI/AAAAAAAAAKU/4iLaPoSPGx0/s1600/pypy-builds.png"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5532008054646045122" src="https://2.bp.blogspot.com/_4gR6Ggu8oHQ/TMWkBA_G-cI/AAAAAAAAAKU/4iLaPoSPGx0/s400/pypy-builds.png" style="cursor: pointer; cursor: hand; width: 400px; height: 98px;"></a>


<p>As usual, the full <a class="reference external" href="https://buildbot.pypy.org/">buildbot</a> results can be seen from the <a class="reference external" href="https://buildbot.pypy.org/summary?branch=%3Ctrunk%3E">summary</a> page.</p>
<p>cheers,
Anto</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-5221273170669322151">
        <div class="comment-header">
          <a name="comment-5221273170669322151"></a>
            <span class="author">intgr</span> wrote on <span class="date">2010-10-25 16:32</span>:
        </div>
        <div class="comment-content">
          <p>Am I sensing a PyPy 1.4 release?</p>
        </div>
      </div>
      <div class="comment comment-6837337243396831991">
        <div class="comment-header">
          <a name="comment-6837337243396831991"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2010-10-25 21:05</span>:
        </div>
        <div class="comment-content">
          <p>@intgr: "yes", although we don't have any concrete plan to do a release. But it's true that if we keep all our tests green, doing a release it's much less effort</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/10/phd-thesis-about-pypys-cli-jit-backend-969267841095296323.html" class="u-url">PhD Thesis about PyPy's CLI JIT Backend</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/10/phd-thesis-about-pypys-cli-jit-backend-969267841095296323.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-10-22T12:49:00Z" itemprop="datePublished" title="2010-10-22 12:49">2010-10-22 12:49</time></a>
            </p>
                <p class="commentline">6 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Hi all,</p>
<p>few months ago I finished the PhD studies and now my <a class="reference external" href="https://codespeak.net/~antocuni/Cuni_PhD_Thesis.pdf">thesis</a> is available,
just in case someone does not have anything better to do than read it :-).</p>
<p>The title of the thesis is <strong>High performance implementation of Python for
CLI/.NET with JIT compiler generation for dynamic languages</strong>, and its mainly
based on my work on the CLI backend for the PyPy JIT (note that the CLI JIT
backend is currently broken on trunk, but it's still working in the <a class="reference external" href="https://codespeak.net/svn/pypy/branch/cli-jit/">cli-jit
branch</a>).</p>
<p>The thesis might be useful also for people that are not directly interested in
the CLI JIT backend, as it also contains general information about the inner
workings of PyPy which are independent from the backend: in particular,
chapters 5 and 6 explain how the JIT frontend works.</p>
<dl class="docutils">
<dt>Here is the summary of chapters:</dt>
<dd><ol class="first last arabic simple">
<li>Introduction</li>
<li>The problem</li>
<li>Enter PyPy</li>
<li>Characterization of the target platform</li>
<li>Tracing JITs in a nutshell</li>
<li>The PyPy JIT compiler generator</li>
<li>The CLI JIT backend</li>
<li>Benchmarks</li>
<li>Conclusion and Future Work</li>
</ol></dd>
</dl>
<p>cheers,
Anto</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-7488028915246694475">
        <div class="comment-header">
          <a name="comment-7488028915246694475"></a>
            <span class="author">The Cannon Family</span> wrote on <span class="date">2010-10-22 18:42</span>:
        </div>
        <div class="comment-content">
          <p>congratulations.</p>
        </div>
      </div>
      <div class="comment comment-2341180008650983497">
        <div class="comment-header">
          <a name="comment-2341180008650983497"></a>
            <span class="author">Eric van Riet Paap</span> wrote on <span class="date">2010-10-22 18:43</span>:
        </div>
        <div class="comment-content">
          <p>Yes Anto, congratulations!</p>
        </div>
      </div>
      <div class="comment comment-2142088818918238256">
        <div class="comment-header">
          <a name="comment-2142088818918238256"></a>
            <span class="author">Lino</span> wrote on <span class="date">2010-10-23 01:26</span>:
        </div>
        <div class="comment-content">
          <p>Impressive work, Antonio.<br><br>ciao</p>
        </div>
      </div>
      <div class="comment comment-9167535626216028997">
        <div class="comment-header">
          <a name="comment-9167535626216028997"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-10-23 08:36</span>:
        </div>
        <div class="comment-content">
          <p>Very interesting stuff, still busily reading... could you write a short bibtex entry for citation? Thanks</p>
        </div>
      </div>
      <div class="comment comment-115018792063442505">
        <div class="comment-header">
          <a name="comment-115018792063442505"></a>
            <span class="author">glyph</span> wrote on <span class="date">2010-10-23 20:56</span>:
        </div>
        <div class="comment-content">
          <p>Congratulations!<br><br>(but when are we going to see it merged to trunk... ;-))</p>
        </div>
      </div>
      <div class="comment comment-4682831138433074653">
        <div class="comment-header">
          <a name="comment-4682831138433074653"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2010-10-24 10:08</span>:
        </div>
        <div class="comment-content">
          <p>thank you, guys :-)<br><br>@anonymous: here you can find the bibtex for the thesis, as wall as for other PyPy related papers: https://codespeak.net/svn/pypy/extradoc/talk/bibtex.bib<br><br>@glyph: unfortunately, trunk has diverged a lot since the cli-jit branch, and merging is not an easy issue. There are also fundamental features that on CLI cannot be implemented as efficently as on x86.  It's on my todo list, but no concrete plan so far :-(</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/10/next-pypy-sprint-4850394963147107623.html" class="u-url">Next PyPy sprint</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/armin-rigo.html">Armin Rigo</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/10/next-pypy-sprint-4850394963147107623.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-10-01T11:45:00Z" itemprop="datePublished" title="2010-10-01 11:45">2010-10-01 11:45</time></a>
            </p>
            
        </div>
    </header><div class="p-summary entry-summary">
    <p>Hi all,</p>

<p>The next PyPy sprint is scheduled for the end of the month, from the 25th to the 31st of October 2010.  It will be done at the university of DÃ¼sseldorf, Germany, where three of us are working.</p>

<p>Please see <a href="https://codespeak.net/svn/pypy/extradoc/sprintinfo/ddorf2010/announce.txt">this link</a> for more information.</p>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/09/pypy-in-googles-summer-of-code-2010-1267220161643618015.html" class="u-url">PyPy in Google's Summer of Code 2010</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/maciej-fijalkowski.html">Maciej Fijalkowski</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/09/pypy-in-googles-summer-of-code-2010-1267220161643618015.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-09-23T10:06:00Z" itemprop="datePublished" title="2010-09-23 10:06">2010-09-23 10:06</time></a>
            </p>
                <p class="commentline">1 comment</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Hello.</p>
<p>This year we had a record of two and a half applications (one was on a cross
section of PyPy and numpy) accepted for the <a class="reference external" href="https://code.google.com/soc/">Google
SoC program</a>. Since it ended a couple of weeks ago, we wanted to present the results that
were achieved. All three projects were completed successfully, although the rate
of success varied quite a bit.</p>
<p>The <a class="reference external" href="https://ademan.wordpress.com/">Numpy proposal</a> progress significantly on making numpy compatible with
PyPy's CPython's <a class="reference external" href="../posts/2010/04/using-cpython-extension-modules-with-5864754772659599217.html">extension module support</a>, but failed to bring PyPy's numpy
implementation into a usable shape (which is a somewhat ambitious goal, one
might argue). The experiments done during the projects are living on the
<a class="reference external" href="https://codespeak.net/svn/pypy/branch/micronumpy/">micronumpy</a> branch.</p>
<p>The <a class="reference external" href="https://hack.bartskowron.com/">Fast ctypes</a> proposal did some useful experiments on how to JIT external
calls from PyPy to C, however, the actual code as of now is not very
interesting and it's quite far from providing a full ctypes replacement (or
equivalent).</p>
<p>Definitely the most successful proposal was a <a class="reference external" href="https://jcreigh.blogspot.com/2010/08/pypy-gsoc-64-bit-jit-merged-to-trunk.html">64bit (x86_64) backend</a> for PyPy's
JIT. It not only includes working 64bit JIT (merged into PyPy trunk), but also
a working asmgcc for x86_64 linux platform, that makes it possible to run the JIT
on this architecture with our advanced garbage collectors. One can say that
x64_64 is now no longer a second-class citizen for PyPy, although it definitely
didn't receive as much testing as the x86 platform. Expect this to be a major
selling point for the next PyPy release :-)</p>
<p>Cheers,
fijal &amp; the PyPy team</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-1668735801389942297">
        <div class="comment-header">
          <a name="comment-1668735801389942297"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-09-24 05:26</span>:
        </div>
        <div class="comment-content">
          <p>Awesome news.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/09/using-escape-analysis-across-loop-2887031293132023676.html" class="u-url">Using Escape Analysis Across Loop Boundaries for Specialization</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/09/using-escape-analysis-across-loop-2887031293132023676.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-09-22T15:30:00Z" itemprop="datePublished" title="2010-09-22 15:30">2010-09-22 15:30</time></a>
            </p>
                <p class="commentline">1 comment</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>This blog post is a successor to the one about <a class="reference external" href="../posts/2010/09/escape-analysis-in-pypys-jit-1780048403046080197.html">escape analysis in PyPy's
JIT</a>. The examples from there will be continued here. This post is a bit
science-fictiony. The algorithm that PyPy currently uses is significantly more
complex and much harder than the one that is described here. The resulting
behaviour is very similar, however, so we will use the simpler version (and we
might switch to that at some point in the actual implementation).</p>
<p>In the last blog post we described how escape analysis can be used to remove
many of the allocations of short-lived objects and many of the type dispatches
that are present in a non-optimized trace. In this post we will improve the
optimization to also handle more cases.</p>
<p>To understand some more what the optimization described in the last blog post
can achieve, look at the following figure:</p>
<p>

<img alt="new lifetimes" src="https://3.bp.blogspot.com/_zICyAWqZbLA/TJohiRZtjZI/AAAAAAAAALs/Tns2pB_gVPY/s1600/obj-lifetime.png"></p>
<p>The figure shows a trace before optimization, together with the lifetime of
various kinds of objects created in the trace. It is executed from top to
bottom. At the bottom, a jump is used to execute the same loop another time.
For clarity, the figure shows two iterations of the loop.
The loop is executed until one of the guards in the trace fails, and the
execution is aborted.</p>
<p>Some of the operations within this trace are <tt class="docutils literal">new</tt> operations, which each create a
new instance of some class. These instances are used for a while, e.g. by
calling methods on them, reading and writing their fields. Some of these
instances escape, which means that they are stored in some globally accessible
place or are passed into a function.</p>
<p>Together with the <tt class="docutils literal">new</tt> operations, the figure shows the lifetimes of the
created objects. Objects in category 1 live for a while, and are then just not
used any more. The creation of these objects is removed by the
optimization described in the last blog post.</p>
<p>Objects in category 2 live for a while and then escape. The optimization of the
last post deals with them too: the <tt class="docutils literal">new</tt> that creates them and
the field accesses are deferred, until the point where the object escapes.</p>
<p>The objects in category 3 and 4 are in principle like the objects in category 1
and 2. They are created, live for a while, but are then passed as an argument
to the <tt class="docutils literal">jump</tt> operation. In the next iteration they can either die (category
3) or escape (category 4).</p>
<p>The optimization of the last post considered the passing of an object along a
jump to be equivalent to escaping. It was thus treating objects in category 3
and 4 like those in category 2.</p>
<p>The improved optimization described in this post will make it possible to deal
better with objects in category 3 and 4. This will have two consequences: on
the one hand, more allocations are removed from the trace (which is clearly
good). As a side-effect of this, the traces will also be type-specialized.</p>
<div class="section" id="optimizing-across-the-jump">
<h2>Optimizing Across the Jump</h2>
<p>Let's look at the final trace obtained in the last post for the example loop.
The final trace was much better than the original one, because many allocations
were removed from it. However, it also still contained allocations:</p>
<div class="figure">
<img alt="step 1" src="https://3.bp.blogspot.com/_zICyAWqZbLA/TJoiO1zH8II/AAAAAAAAAL0/N2CSp4EnMAw/s1600/step1.png">
</div>
<p>The two new <tt class="docutils literal">BoxedIntegers</tt> stored in <tt class="docutils literal">p15</tt> and <tt class="docutils literal">p10</tt> are passed into
the next iteration of the loop. The next iteration will check that they are
indeed <tt class="docutils literal">BoxedIntegers</tt>, read their <tt class="docutils literal">intval</tt> fields and then not use them
any more. Thus those instances are in category 3.</p>
<p>In its current state the loop
allocates two <tt class="docutils literal">BoxedIntegers</tt> at the end of every iteration, that then die
very quickly in the next iteration. In addition, the type checks at the start
of the loop are superfluous, at least after the first iteration.</p>
<p>The reason why we cannot optimize the remaining allocations away is because
their lifetime crosses the jump. To improve the situation, a little trick is
needed. The trace above represents a loop, i.e. the jump at the end jumps to
the beginning. Where in the loop the jump occurs is arbitrary, since the loop
can only be left via failing guards anyway. Therefore it does not change the
semantics of the loop to put the jump at another point into the trace and we
can move the <tt class="docutils literal">jump</tt> operation just above the allocation of the objects that
appear in the current <tt class="docutils literal">jump</tt>. This needs some care, because the arguments to
<tt class="docutils literal">jump</tt> are all currently live variables, thus they need to be adapted.</p>
<p>If we do that for our example trace above, the trace looks like this:</p>
<div class="figure">
<img alt="step 2" src="https://1.bp.blogspot.com/_zICyAWqZbLA/TJoiPTYjwgI/AAAAAAAAAL8/X7RrjkpzKwc/s1600/step2.png">
</div>
<p>Now the lifetime of the remaining allocations no longer crosses the jump, and
we can run our escape analysis a second time, to get the following trace:</p>
<div class="figure">
<img alt="step3" src="https://1.bp.blogspot.com/_zICyAWqZbLA/TJoiP8o9rNI/AAAAAAAAAME/XHA-nsDB1kI/s1600/step3.png">
</div>
<p>This result is now really good. The code performs the same operations than
the original code, but using direct CPU arithmetic and no boxing, as opposed to
the original version which used dynamic dispatching and boxing.</p>
<p>Looking at the final trace it is also completely clear that specialization has
happened. The trace corresponds to the situation in which the trace was
originally recorded, which happened to be a loop where <tt class="docutils literal">BoxedIntegers</tt> were
used. The now resulting loop does not refer to the <tt class="docutils literal">BoxedInteger</tt> class at
all any more, but it still has the same behaviour. If the original loop had
used <tt class="docutils literal">BoxedFloats</tt>, the final loop would use <tt class="docutils literal">float_*</tt> operations
everywhere instead (or even be very different, if the object model had
user-defined classes).</p>
</div>
<div class="section" id="entering-the-loop">
<h2>Entering the Loop</h2>
<p>The approach of placing the <tt class="docutils literal">jump</tt> at some other point in the loop leads to
one additional complication that we glossed over so far. The beginning of the
original loop corresponds to a point in the original program, namely the
<tt class="docutils literal">while</tt> loop in the function <tt class="docutils literal">f</tt> from the last post.</p>
<p>Now recall that in a VM that uses a tracing JIT, all programs start by being
interpreted. This means that when <tt class="docutils literal">f</tt> is executed by the interpreter, it is
easy to go from the interpreter to the first version of the compiled loop.
After the <tt class="docutils literal">jump</tt> is moved and the escape analysis optimization is applied a
second time, this is no longer easily possible.  In particular, the new loop
expects two integers as input arguments, while the old one expected two
instances.</p>
<p>To make it possible to enter the loop directly from the intepreter, there
needs to be some additional code that enters the loop by taking as input
arguments what is available to the interpreter, i.e. two instances. This
additional code corresponds to one iteration of the loop, which is thus
<a class="reference external" href="https://en.wikipedia.org/wiki/Loop_splitting#Loop_peeling">peeled off</a>:</p>
<div class="figure">
<img alt="step 4" src="https://4.bp.blogspot.com/_zICyAWqZbLA/TJoiPwXQ-gI/AAAAAAAAAMM/AzQUy5Hy23Q/s1600/step4.png">
</div>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>The optimization described in this post can be used to optimize away
allocations in category 3 and improve allocations in category 4, by deferring
them until they are no longer avoidable. A side-effect of these optimizations
is also that the optimized loops are specialized for the types of the variables
that are used inside them.</p>
</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-4444843635366691870">
        <div class="comment-header">
          <a name="comment-4444843635366691870"></a>
            <span class="author">Ole Laursen</span> wrote on <span class="date">2010-09-24 17:18</span>:
        </div>
        <div class="comment-content">
          <p>Interesting, like the previous post. Keep 'em coming. :)</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/09/escape-analysis-in-pypys-jit-1780048403046080197.html" class="u-url">Escape Analysis in PyPy's JIT</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/09/escape-analysis-in-pypys-jit-1780048403046080197.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-09-13T14:33:00Z" itemprop="datePublished" title="2010-09-13 14:33">2010-09-13 14:33</time></a>
            </p>
                <p class="commentline">3 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>The goal of a just-in-time compiler for a dynamic language is obviously to
improve the speed of the language over an implementation of the language that
uses interpretation. The first goal of a JIT is thus to remove the
interpretation overhead, i.e. the overhead of bytecode (or AST) dispatch and the
overhead of the interpreter's data structures, such as operand stack etc. The
second important problem that any JIT for a dynamic language needs to solve is
how to deal with the overhead of boxing of primitive types and of type
dispatching. Those are problems that are usually not present in statically typed
languages.</p>
<p>Boxing of primitive types means that dynamic languages need to be able to handle
all objects, even integers, floats, etc. in the same way as user-defined
instances. Thus those primitive types are usually <em>boxed</em>, i.e. a small
heap-structure is allocated for them, that contains the actual value.</p>
<p>Type dispatching is the process of finding the concrete implementation that is
applicable to the objects at hand when doing a generic operation at hand. An
example would be the addition of two objects: The addition needs to check what
the concrete objects are that should be added are, and choose the implementation
that is fitting for them.</p>
<p>Last year, we wrote a <a class="reference external" href="../posts/2009/03/applying-tracing-jit-to-interpreter-3287844903778799266.html">blog post</a>  and <a class="reference external" href="https://portal.acm.org/citation.cfm?id=1565827">a paper about how PyPy's meta-JIT
approach works</a>. These explain how the meta-tracing JIT can remove the overhead
of bytecode dispatch. In this post (and probably a followup) we want to explain
how the traces that are produced by our meta-tracing JIT are then optimized to
also remove some of the overhead more closely associated to dynamic languages,
such as boxing overhead and type dispatching. The most important technique to
achieve this is a form of <a class="reference external" href="https://en.wikipedia.org/wiki/Escape_analysis">escape analysis</a> that we call <em>virtual objects</em>.
This is best explained via an example.</p>
<div class="section" id="running-example">
<h2>Running Example</h2>
<p>For the purpose of this blog post, we are going to use a very simple object
model, that just supports an integer and a float type. The objects support only
two operations, <tt class="docutils literal">add</tt>, which adds two objects (promoting ints to floats in a
mixed addition) and <tt class="docutils literal">is_positive</tt>, which returns whether the number is greater
than zero. The implementation of <tt class="docutils literal">add</tt> uses classical Smalltalk-like
double-dispatching. These classes could be part of the implementation of a very
simple interpreter written in RPython.</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #006699; font-weight: bold;">class</span> <span style="color: #00AA88; font-weight: bold;">Base</span>(<span style="color: #336666;">object</span>):
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add</span>(<span style="color: #336666;">self</span>, other):
        <span style="color: #CC3300; font-style: italic;">""" add self to other """</span>
        <span style="color: #006699; font-weight: bold;">raise</span> <span style="color: #CC0000; font-weight: bold;">NotImplementedError</span>(<span style="color: #CC3300;">"abstract base"</span>)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add__int</span>(<span style="color: #336666;">self</span>, intother):
        <span style="color: #CC3300; font-style: italic;">""" add intother to self, where intother is a Python integer """</span>
        <span style="color: #006699; font-weight: bold;">raise</span> <span style="color: #CC0000; font-weight: bold;">NotImplementedError</span>(<span style="color: #CC3300;">"abstract base"</span>)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add__float</span>(<span style="color: #336666;">self</span>, floatother):
        <span style="color: #CC3300; font-style: italic;">""" add floatother to self, where floatother is a Python float """</span>
        <span style="color: #006699; font-weight: bold;">raise</span> <span style="color: #CC0000; font-weight: bold;">NotImplementedError</span>(<span style="color: #CC3300;">"abstract base"</span>)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">is_positive</span>(<span style="color: #336666;">self</span>):
        <span style="color: #CC3300; font-style: italic;">""" returns whether self is positive """</span>
        <span style="color: #006699; font-weight: bold;">raise</span> <span style="color: #CC0000; font-weight: bold;">NotImplementedError</span>(<span style="color: #CC3300;">"abstract base"</span>)

<span style="color: #006699; font-weight: bold;">class</span> <span style="color: #00AA88; font-weight: bold;">BoxedInteger</span>(Base):
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">__init__</span>(<span style="color: #336666;">self</span>, intval):
        <span style="color: #336666;">self</span><span style="color: #555555;">.</span>intval <span style="color: #555555;">=</span> intval
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add</span>(<span style="color: #336666;">self</span>, other):
        <span style="color: #006699; font-weight: bold;">return</span> other<span style="color: #555555;">.</span>add__int(<span style="color: #336666;">self</span><span style="color: #555555;">.</span>intval)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add__int</span>(<span style="color: #336666;">self</span>, intother):
        <span style="color: #006699; font-weight: bold;">return</span> BoxedInteger(intother <span style="color: #555555;">+</span> <span style="color: #336666;">self</span><span style="color: #555555;">.</span>intval)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add__float</span>(<span style="color: #336666;">self</span>, floatother):
        <span style="color: #006699; font-weight: bold;">return</span> BoxedFloat(floatother <span style="color: #555555;">+</span> <span style="color: #336666;">float</span>(<span style="color: #336666;">self</span><span style="color: #555555;">.</span>intval))
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">is_positive</span>(<span style="color: #336666;">self</span>):
        <span style="color: #006699; font-weight: bold;">return</span> <span style="color: #336666;">self</span><span style="color: #555555;">.</span>intval <span style="color: #555555;">&gt;</span> <span style="color: #FF6600;">0</span>

<span style="color: #006699; font-weight: bold;">class</span> <span style="color: #00AA88; font-weight: bold;">BoxedFloat</span>(Base):
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">__init__</span>(<span style="color: #336666;">self</span>, floatval):
        <span style="color: #336666;">self</span><span style="color: #555555;">.</span>floatval <span style="color: #555555;">=</span> floatval
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add</span>(<span style="color: #336666;">self</span>, other):
        <span style="color: #006699; font-weight: bold;">return</span> other<span style="color: #555555;">.</span>add__float(<span style="color: #336666;">self</span><span style="color: #555555;">.</span>floatval)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add__int</span>(<span style="color: #336666;">self</span>, intother):
        <span style="color: #006699; font-weight: bold;">return</span> BoxedFloat(<span style="color: #336666;">float</span>(intother) <span style="color: #555555;">+</span> <span style="color: #336666;">self</span><span style="color: #555555;">.</span>floatval)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">add__float</span>(<span style="color: #336666;">self</span>, floatother):
        <span style="color: #006699; font-weight: bold;">return</span> BoxedFloat(floatother <span style="color: #555555;">+</span> <span style="color: #336666;">self</span><span style="color: #555555;">.</span>floatval)
    <span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">is_positive</span>(<span style="color: #336666;">self</span>):
        <span style="color: #006699; font-weight: bold;">return</span> <span style="color: #336666;">self</span><span style="color: #555555;">.</span>floatval <span style="color: #555555;">&gt;</span> <span style="color: #FF6600;">0.0</span>
</pre></div>
<p>Using these classes to implement arithmetic shows the basic problem that a
dynamic language implementation has. All the numbers are instances of either
<tt class="docutils literal">BoxedInteger</tt> or <tt class="docutils literal">BoxedFloat</tt>, thus they consume space on the heap. Performing many
arithmetic operations produces lots of garbage quickly, thus putting pressure on
the garbage collector. Using double dispatching to implement the numeric tower
needs two method calls per arithmetic operation, which is costly due to the
method dispatch.</p>
<p>To understand the problems more directly, let us consider a simple function that
uses the object model:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">f</span>(y):
    res <span style="color: #555555;">=</span> BoxedInteger(<span style="color: #FF6600;">0</span>)
    <span style="color: #006699; font-weight: bold;">while</span> y<span style="color: #555555;">.</span>is_positive():
        res <span style="color: #555555;">=</span> res<span style="color: #555555;">.</span>add(y)<span style="color: #555555;">.</span>add(BoxedInteger(<span style="color: #555555;">-</span><span style="color: #FF6600;">100</span>))
        y <span style="color: #555555;">=</span> y<span style="color: #555555;">.</span>add(BoxedInteger(<span style="color: #555555;">-</span><span style="color: #FF6600;">1</span>))
    <span style="color: #006699; font-weight: bold;">return</span> res
</pre></div>
<p>The loop iterates <tt class="docutils literal">y</tt> times, and computes something in the process. To
understand the reason why executing this function is slow, here is the trace
that is produced by the tracing JIT when executing the function with <tt class="docutils literal">y</tt>
being a <tt class="docutils literal">BoxedInteger</tt>:</p>
<pre class="literal-block">
# arguments to the trace: p0, p1
# inside f: res.add(y)
guard_class(p1, BoxedInteger)
    # inside BoxedInteger.add
    i2 = getfield_gc(p1, intval)
    guard_class(p0, BoxedInteger)
        # inside BoxedInteger.add__int
        i3 = getfield_gc(p0, intval)
        i4 = int_add(i2, i3)
        p5 = new(BoxedInteger)
            # inside BoxedInteger.__init__
            setfield_gc(p5, i4, intval)
# inside f: BoxedInteger(-100)
p6 = new(BoxedInteger)
    # inside BoxedInteger.__init__
    setfield_gc(p6, -100, intval)

# inside f: .add(BoxedInteger(-100))
guard_class(p5, BoxedInteger)
    # inside BoxedInteger.add
    i7 = getfield_gc(p5, intval)
    guard_class(p6, BoxedInteger)
        # inside BoxedInteger.add__int
        i8 = getfield_gc(p6, intval)
        i9 = int_add(i7, i8)
        p10 = new(BoxedInteger)
            # inside BoxedInteger.__init__
            setfield_gc(p10, i9, intval)

# inside f: BoxedInteger(-1)
p11 = new(BoxedInteger)
    # inside BoxedInteger.__init__
    setfield_gc(p11, -1, intval)

# inside f: y.add(BoxedInteger(-1))
guard_class(p0, BoxedInteger)
    # inside BoxedInteger.add
    i12 = getfield_gc(p0, intval)
    guard_class(p11, BoxedInteger)
        # inside BoxedInteger.add__int
        i13 = getfield_gc(p11, intval)
        i14 = int_add(i12, i13)
        p15 = new(BoxedInteger)
            # inside BoxedInteger.__init__
            setfield_gc(p15, i14, intval)

# inside f: y.is_positive()
guard_class(p15, BoxedInteger)
    # inside BoxedInteger.is_positive
    i16 = getfield_gc(p15, intval)
    i17 = int_gt(i16, 0)
# inside f
guard_true(i17)
jump(p15, p10)
</pre>
<p>(indentation corresponds to the stack level of the traced functions).</p>
<p>The trace is inefficient for a couple of reasons. One problem is that it checks
repeatedly and redundantly for the class of the objects around, using a
<tt class="docutils literal">guard_class</tt> instruction. In addition, some new <tt class="docutils literal">BoxedInteger</tt> instances are
constructed using the <tt class="docutils literal">new</tt> operation, only to be used once and then forgotten
a bit later. In the next section, we will see how this can be improved upon,
using escape analysis.</p>
</div>
<div class="section" id="virtual-objects">
<h2>Virtual Objects</h2>
<p>The main insight to improve the code shown in the last section is that some of
the objects created in the trace using a <tt class="docutils literal">new</tt> operation don't survive very
long and are collected by the garbage collector soon after their allocation.
Moreover, they are used only inside the loop, thus we can easily prove that
nobody else in the program stores a reference to them. The
idea for improving the code is thus to analyze which objects never escape the
loop and may thus not be allocated at all.</p>
<p>This process is called <em>escape analysis</em>. The escape analysis of
our tracing JIT works by using <em>virtual objects</em>: The trace is walked from
beginning to end and whenever a <tt class="docutils literal">new</tt> operation is seen, the operation is
removed and a virtual object is constructed. The virtual object summarizes the
shape of the object that is allocated at this position in the original trace,
and is used by the escape analysis to improve the trace. The shape describes
where the values that would be stored in the fields of the allocated objects
come from. Whenever the optimizer sees a <tt class="docutils literal">setfield</tt> that writes into a virtual
object, that shape summary is thus updated and the operation can be removed.
When the optimizer encounters a <tt class="docutils literal">getfield</tt> from a virtual, the result is read
from the virtual object, and the operation is also removed.</p>
<p>In the example from last section, the following operations would produce two
virtual objects, and be completely removed from the optimized trace:</p>
<pre class="literal-block">
p5 = new(BoxedInteger)
setfield_gc(p5, i4, intval)
p6 = new(BoxedInteger)
setfield_gc(p6, -100, intval)
</pre>
<p>The virtual object stored in <tt class="docutils literal">p5</tt> would know that it is an <tt class="docutils literal">BoxedInteger</tt>, and that
the <tt class="docutils literal">intval</tt> field contains <tt class="docutils literal">i4</tt>, the one stored in <tt class="docutils literal">p6</tt> would know that
its <tt class="docutils literal">intval</tt> field contains the constant -100.</p>
<p>The following operations, that use <tt class="docutils literal">p5</tt> and <tt class="docutils literal">p6</tt> could then be
optimized using that knowledge:</p>
<pre class="literal-block">
guard_class(p5, BoxedInteger)
i7 = getfield_gc(p5, intval)
# inside BoxedInteger.add
guard_class(p6, BoxedInteger)
# inside BoxedInteger.add__int
i8 = getfield_gc(p6, intval)
i9 = int_add(i7, i8)
</pre>
<p>The <tt class="docutils literal">guard_class</tt> operations can be removed, because the classes of <tt class="docutils literal">p5</tt> and
<tt class="docutils literal">p6</tt> are known to be <tt class="docutils literal">BoxedInteger</tt>. The <tt class="docutils literal">getfield_gc</tt> operations can be removed
and <tt class="docutils literal">i7</tt> and <tt class="docutils literal">i8</tt> are just replaced by <tt class="docutils literal">i4</tt> and -100. Thus the only
remaining operation in the optimized trace would be:</p>
<pre class="literal-block">
i9 = int_add(i4, -100)
</pre>
<p>The rest of the trace is optimized similarly.</p>
<p>So far we have only described what happens when virtual objects are used in
operations that read and write their fields. When the virtual object is used in
any other operation, it cannot stay virtual. For example, when a virtual object
is stored in a globally accessible place, the object needs to actually be
allocated, as it will live longer than one iteration of the loop.</p>
<p>This is what happens at the end of the trace above, when the <tt class="docutils literal">jump</tt> operation
is hit. The arguments of the jump are at this point virtual objects. Before the
jump is emitted, they are <em>forced</em>. This means that the optimizers produces code
that allocates a new object of the right type and sets its fields to the field
values that the virtual object has. This means that instead of the jump, the
following operations are emitted:</p>
<pre class="literal-block">
p15 = new(BoxedInteger)
setfield_gc(p15, i14, intval)
p10 = new(BoxedInteger)
setfield_gc(p10, i9, intval)
jump(p15, p10)
</pre>
<p>Note how the operations for creating these two instances has been moved down the
trace. It looks like for these operations we actually didn't win much, because
the objects are still allocated at the end. However, the optimization was still
worthwhile even in this case, because some operations that have been performed
on the forced virtual objects have been removed (some <tt class="docutils literal">getfield_gc</tt> operations
and <tt class="docutils literal">guard_class</tt> operations).</p>
<p>The final optimized trace of the example looks like this:</p>
<pre class="literal-block">
# arguments to the trace: p0, p1
guard_class(p1, BoxedInteger)
i2 = getfield_gc(p1, intval)
guard_class(p0, BoxedInteger)
i3 = getfield_gc(p0, intval)
i4 = int_add(i2, i3)
i9 = int_add(i4, -100)

guard_class(p0, BoxedInteger)
i12 = getfield_gc(p0, intval)
i14 = int_add(i12, -1)

i17 = int_gt(i14, 0)
guard_true(i17)
p15 = new(BoxedInteger)
setfield_gc(p15, i14, intval)
p10 = new(BoxedInteger)
setfield_gc(p10, i9, intval)
jump(p15, p10)
</pre>
<p>The optimized trace contains only two allocations, instead of the original five,
and only three <tt class="docutils literal">guard_class</tt> operations, from the original seven.</p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>In this blog post we described how simple escape analysis within the scope of
one loop works. This optimizations reduces the allocation of many intermediate
data structures that become garbage quickly in an interpreter. It also removes a
lot of the type dispatching overhead. In a later post, we will explain how this
optimization can be improved further.</p>
</div>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-4131467704728575042">
        <div class="comment-header">
          <a name="comment-4131467704728575042"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-09-13 19:38</span>:
        </div>
        <div class="comment-content">
          <p>Beautiful post. I love it when people dare to broach more 'advanced' subjects in blog format.</p>
        </div>
      </div>
      <div class="comment comment-320183401486789978">
        <div class="comment-header">
          <a name="comment-320183401486789978"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2010-09-14 11:49</span>:
        </div>
        <div class="comment-content">
          <p>Thanks a lot :-).</p>
        </div>
      </div>
      <div class="comment comment-5798111857912137537">
        <div class="comment-header">
          <a name="comment-5798111857912137537"></a>
            <span class="author">jdb</span> wrote on <span class="date">2010-09-15 10:21</span>:
        </div>
        <div class="comment-content">
          <p>+1, thanks</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/08/europython-2010-videos-available-8446190660370796142.html" class="u-url">EuroPython 2010 Videos available</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/08/europython-2010-videos-available-8446190660370796142.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-08-17T10:51:00Z" itemprop="datePublished" title="2010-08-17 10:51">2010-08-17 10:51</time></a>
            </p>
                <p class="commentline">4 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Hi all,</p>
<p>the videos of the talks from <a class="reference external" href="../posts/2010/07/europython-2010-report-7803731360759120212.html">EuroPython 2010</a> are now available on
<a class="reference external" href="https://europythonvideos.blip.tv/?user=europythonvideos;nsfw=dc;s=posts">blip.tv</a>: in particular, there are the three videos of the <a class="reference external" href="https://codespeak.net/svn/pypy/extradoc/talk/ep2010/talk/talk.pdf">PyPy talk</a>.</p>
<p>Part 1: What's news in PyPy 1.2 and 1.3 (by Antonio Cuni)</p>
<p>Part 2: Just in Time compilation (by Armin Rigo)</p>
<p>Part 3: cpyext (by Amaury Forgeot d'Arc)</p>
<p>Moreover, here is Mark Shannon's talk which compares HotPy, Unladen Swallow
and PyPy:</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-4488268770901514732">
        <div class="comment-header">
          <a name="comment-4488268770901514732"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-17 18:36</span>:
        </div>
        <div class="comment-content">
          <p>Can you post the links to the blip.tv pages, so I can go there and download the videos?<br><br>The blip.tv viewer applet has no such link, and even digging the source isn't helpful (it seems that they use different identifiers for embed applets than for the same videos on their own website). Grrr!</p>
        </div>
      </div>
      <div class="comment comment-7989005601776912107">
        <div class="comment-header">
          <a name="comment-7989005601776912107"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2010-08-17 20:07</span>:
        </div>
        <div class="comment-content">
          <p>Sure, here are the links:<br>Part 1: https://europythonvideos.blip.tv/file/3981017/<br><br>Part 2: https://europythonvideos.blip.tv/file/3981028/<br><br>Part 3: https://europythonvideos.blip.tv/file/4000720/<br><br>HotPy: https://europythonvideos.blip.tv/file/3980963/</p>
        </div>
      </div>
      <div class="comment comment-4411077347859156391">
        <div class="comment-header">
          <a name="comment-4411077347859156391"></a>
            <span class="author">Lucian</span> wrote on <span class="date">2010-08-18 01:10</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous<br><br>You can also click the title of the video in the Blip.tv embedded player.</p>
        </div>
      </div>
      <div class="comment comment-7231492106980723297">
        <div class="comment-header">
          <a name="comment-7231492106980723297"></a>
            <span class="author">horace</span> wrote on <span class="date">2010-08-19 18:51</span>:
        </div>
        <div class="comment-content">
          <p>if i remember correctly, a while ago you were looking for alternative names for pypy.<br><br>i just came across the wikipeda article for the "black mamba" which states that it is the fastest snake of the world.<br><br>how about the name "black mamba"? :)</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/08/call-for-benchmarks-2605012131351543912.html" class="u-url">Call for Benchmarks</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/08/call-for-benchmarks-2605012131351543912.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-08-17T09:50:00Z" itemprop="datePublished" title="2010-08-17 09:50">2010-08-17 09:50</time></a>
            </p>
                <p class="commentline">25 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>As you know, a lot of PyPy's recent development effort has gone into <a class="reference external" href="https://speed.pypy.org">speeding up</a>
execution of Python programs. However, an additional good property of PyPy's
Python interpreter is that most objects are represented in a much more <a class="reference external" href="../posts/2009/10/gc-improvements-6174120095428192954.html">compact
way</a> than in CPython. We would like to investigate some more advanced techniques
to reduce the memory usage of Python programs further.</p>
<p>To do this it is necessary to investigate the memory behaviour of real programs
with large heaps. For speed measurements there are standard benchmarks, but for
memory improvements there is nothing comparable, the memory behaviour of large
programs is not that well understood. Therefore we are looking for programs that we
can study and use as benchmarks.</p>
<p>Specifically we are looking for Python programs with the following properties:</p>
<ul class="simple">
<li>large heaps of about 10MB-1GB</li>
<li>should have non-trivial runtime as well (in the range of a few seconds), to
judge the speed impact of optimizations</li>
<li>ideally pure-Python programs that don't use extension modules so that they run
under both CPython and PyPy (this is optional, but makes my life much easier).</li>
</ul>
<p>We are also rather interested in programs that do a lot of string/unicode
processing.</p>
<p>We would be grateful for all ideas. Telling us about a program also has the
advantage that we will work on optimizing PyPy for it :-).</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-2066080468962149927">
        <div class="comment-header">
          <a name="comment-2066080468962149927"></a>
            <span class="author">lasi</span> wrote on <span class="date">2010-08-17 12:15</span>:
        </div>
        <div class="comment-content">
          <p>I'm not think very much about it. But Zodb, durus or dobbin could be useful.</p>
        </div>
      </div>
      <div class="comment comment-749614996344268865">
        <div class="comment-header">
          <a name="comment-749614996344268865"></a>
            <span class="author">Zeev</span> wrote on <span class="date">2010-08-17 12:26</span>:
        </div>
        <div class="comment-content">
          <p>portage, the official Gentoo Linux package manager, does package dependency resolution and can take a few seconds for large updates. It parses package metadata from text files.</p>
        </div>
      </div>
      <div class="comment comment-8606529887826280879">
        <div class="comment-header">
          <a name="comment-8606529887826280879"></a>
            <span class="author">Peter Goodman</span> wrote on <span class="date">2010-08-17 12:31</span>:
        </div>
        <div class="comment-content">
          <p>You could run a program that determinizes a large NFA. Given an existing Python program that can determinize an NFA, you could give it an expanded version of the NFA on page 15 here: https://www.springerlink.com/content/cq16j1uv511g793g/fulltext.pdf. Another way is to take some complex NFAs, concatenate them, and determinize.</p>
        </div>
      </div>
      <div class="comment comment-8517444787283058964">
        <div class="comment-header">
          <a name="comment-8517444787283058964"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-17 13:09</span>:
        </div>
        <div class="comment-content">
          <p>Bazaar and mercurial take a lot of memory (time as well) when updating/merging etc. large repositories, especially if they contain large files.</p>
        </div>
      </div>
      <div class="comment comment-8983332598853558585">
        <div class="comment-header">
          <a name="comment-8983332598853558585"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-17 13:23</span>:
        </div>
        <div class="comment-content">
          <p>Pylint (https://www.logilab.org/project/pylint) could be a nice target. Pure Python, the size of the heap and run time depend on what kind of code you throw at it.</p>
        </div>
      </div>
      <div class="comment comment-1560248798600788857">
        <div class="comment-header">
          <a name="comment-1560248798600788857"></a>
            <span class="author">VanL</span> wrote on <span class="date">2010-08-17 14:15</span>:
        </div>
        <div class="comment-content">
          <p>You could try loading and manipulating a large graph with NetworkX. Pure Python, and the size and runtime could be tuned by varying the size of the graph and the algorithms that are run.</p>
        </div>
      </div>
      <div class="comment comment-3313111650906282728">
        <div class="comment-header">
          <a name="comment-3313111650906282728"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2010-08-17 14:51</span>:
        </div>
        <div class="comment-content">
          <a href="https://bitbucket.org/mchaput/whoosh/wiki/Home" rel="nofollow">Whoosh</a> comes to mind. People will always be grateful if you speed up search for them :)
        </div>
      </div>
      <div class="comment comment-872293078176552355">
        <div class="comment-header">
          <a name="comment-872293078176552355"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-17 15:15</span>:
        </div>
        <div class="comment-content">
          <p>The CDPedia creates and manipulates its index with a pure-python inverted index implementation.<br><br>It could be extracted and made into a benchmark - there are other pure-python inverted indices around, those could also work.<br><br>They do tend to use lots and lots of memory, the CDPedia's implementation uses the builtin array module for byte sequence manipulation and bare strings as data store (it's highly optimized for lowering CPython's memory usage), but there are a few dict-heavy places yet.</p>
        </div>
      </div>
      <div class="comment comment-3623019467165482688">
        <div class="comment-header">
          <a name="comment-3623019467165482688"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-17 16:32</span>:
        </div>
        <div class="comment-content">
          <p>Agreed that Bazaar and Mercurial would be interesting use cases, especially for projects with large revision history graphs.<br><br>Memory usage analysis has come up recently on the bzr list:<br>https://lists.ubuntu.com/archives/bazaar/2010q3/069549.html</p>
        </div>
      </div>
      <div class="comment comment-8097000242139162194">
        <div class="comment-header">
          <a name="comment-8097000242139162194"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2010-08-17 16:33</span>:
        </div>
        <div class="comment-content">
          <p>All great ideas, thanks a lot!</p>
        </div>
      </div>
      <div class="comment comment-3508182845018884924">
        <div class="comment-header">
          <a name="comment-3508182845018884924"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-17 17:42</span>:
        </div>
        <div class="comment-content">
          <p>Python Natural Language Toolkit<br>https://www.nltk.org/<br><br>Give a huge corpus (Wikipedia?) and do any operation on it -- nltk will take huge loads of memory in all kinds of custom objects, lists and tuples.</p>
        </div>
      </div>
      <div class="comment comment-8510538298926889120">
        <div class="comment-header">
          <a name="comment-8510538298926889120"></a>
            <span class="author">Pingveno</span> wrote on <span class="date">2010-08-17 21:25</span>:
        </div>
        <div class="comment-content">
          <p>From what I understand, PyExcelerator, a writer/reader for Excel files, takes huge amounts of memory for very large files. It uses pure Python objects for each cell, which kills memory use when you're writing many millions of cells.</p>
        </div>
      </div>
      <div class="comment comment-724373237383529537">
        <div class="comment-header">
          <a name="comment-724373237383529537"></a>
            <span class="author">Dan Stromberg</span> wrote on <span class="date">2010-08-17 22:53</span>:
        </div>
        <div class="comment-content">
          <p>A couple of possibilities from my own OSS code:<br><br>https://stromberg.dnsalias.org/~strombrg/treap<br><br>https://stromberg.dnsalias.org/~strombrg/pyindex.html<br><br><br><br>I'd most likely be happy to relicense the treap code as needed to facilitate inclusion.  The pyindex code is under a UCI (I believe it's BSDish) license, and would probably need to remain so.</p>
        </div>
      </div>
      <div class="comment comment-2688607034022574309">
        <div class="comment-header">
          <a name="comment-2688607034022574309"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-18 15:18</span>:
        </div>
        <div class="comment-content">
          <p>I really didn't think about it much, I'm just trying to chew through my RSS backlog, and ran into a <a href="https://ferringb.wordpress.com/2010/08/03/reducing-dict-footprints/" rel="nofollow">post</a> about pkgcore dealing with memory issues just a few minutes after I read this call for benchmarks.<br><br><i>Maybe</i> you could use that.</p>
        </div>
      </div>
      <div class="comment comment-1603669053102755731">
        <div class="comment-header">
          <a name="comment-1603669053102755731"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-18 23:45</span>:
        </div>
        <div class="comment-content">
          <p>You might want to lok at MiniLight:<br><br>https://www.hxa.name/minilight/#comparison</p>
        </div>
      </div>
      <div class="comment comment-3818265681473855357">
        <div class="comment-header">
          <a name="comment-3818265681473855357"></a>
            <span class="author">none</span> wrote on <span class="date">2010-08-20 13:40</span>:
        </div>
        <div class="comment-content">
          <p>I'm the author of a scientific application that can be suited to your needs. It runs both with Python 2.x and PyPy, so I bundled a distribution with some example benchmarks if this interests you: https://dl.dropbox.com/u/7931953/pypy-bench.tar.bz2 (see bench.README)<br><br>An interesting observation in my opinion is that on small runs, CPython outperforms PyPy but this progressively reverses on longer runs.</p>
        </div>
      </div>
      <div class="comment comment-2840712948689290237">
        <div class="comment-header">
          <a name="comment-2840712948689290237"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2010-08-20 14:44</span>:
        </div>
        <div class="comment-content">
          <p>@all: thanks for the proposals, I am looking at them.<br><br>@Franck: This is probably due to the JIT, which needs some time to compile at the beginning. Later, the assembler exists and executes quickly. Will look at your code, thanks for providing it.</p>
        </div>
      </div>
      <div class="comment comment-9126211972153734080">
        <div class="comment-header">
          <a name="comment-9126211972153734080"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-20 18:58</span>:
        </div>
        <div class="comment-content">
          <p>Hello, i am the author of an chess program being written entirely in python. I haven't published it jet, because i am a bit ashame of its poor quality. However it should suffice for the sole purpose of benchmarking. Please drop me a note if you are interested. My email adress is:  larudwer at freenet dot de <br><br>Some Notes:<br>The Program is just console mode (UCI), no gui.<br><br>it eats up all the memory you have <br><br>cpython is almost twice as fast as pypy-1.3 on this program and psyco accelerates it by another factor of two.</p>
        </div>
      </div>
      <div class="comment comment-545666257058601975">
        <div class="comment-header">
          <a name="comment-545666257058601975"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2010-08-21 17:33</span>:
        </div>
        <div class="comment-content">
          <p>You could consider Tahoe-LAFS. A good reason to use it is that it is a practicality-oriented, widely deployed tool with significant memory usage that we routinely spend engineering effort to track and manage.<br><br>Here are some graphs of the memory usage of different versions of Tahoe-LAFS over time:<br><br>32-bit machine:<br>https://tahoe-lafs.org/tahoe-figleaf-graph/hanford.allmydata.com-tahoe_memstats.html<br><br>64-bit machine:<br>https://tahoe-lafs.org/tahoe-figleaf-graph/hanford.allmydata.com-tahoe_memstats_64.html<br><br>Here are some open tickets about memory usage in our issue tracker:<br><br>https://tahoe-lafs.org/trac/tahoe-lafs/query?status=!closed&amp;keywords=~memory&amp;order=priority<br><br>The reason not to use Tahoe-LAFS as a subject is that it uses several native-code libraries to for the CPU-intensive inner loops (cryptography, erasure coding). I really want those libraries, and hence Tahoe-LAFS, to be usable with cpyext as soon as possible, but I haven't tried and I assume that cpyext isn't 100% there yet.<br><br>By the way the easiest way to measure the performance of Tahoe-LAFS would be to run its unit tests and measure the memory usage and runtime. This is not only the easiest way, but it is also a pressing issue for us! Tahoe-LAFS unit tests take too long to run, and this causes problems for us, and we very much like it if they could run to completion faster. <br><br>https://tahoe-lafs.org/trac/tahoe-lafs/ticket/20# unit tests take too long<br><br>Here are our buildbots showing unit test runtime among other things:<br><br>https://tahoe-lafs.org/buildbot/waterfall?show_events=true&amp;builder=Kyle+OpenBSD-4.6+amd64&amp;builder=hardy-amd64&amp;builder=Arthur+lenny+c7+32bit&amp;builder=Eugen+lenny-amd64&amp;builder=David+A.+OpenSolaris+i386&amp;builder=Ruben+Fedora&amp;builder=Zooko+zomp+Mac-amd64+10.6+py2.6&amp;builder=FreeStorm+WinXP-x86+py2.6&amp;builder=tarballs</p>
        </div>
      </div>
      <div class="comment comment-2474524409411232676">
        <div class="comment-header">
          <a name="comment-2474524409411232676"></a>
            <span class="author">Adam Sampson</span> wrote on <span class="date">2010-08-22 16:22</span>:
        </div>
        <div class="comment-content">
          <p>rawdog (disclosure of bias: I wrote it) sounds like it might be of use. It's an RSS aggregator that generates static HTML. Pure Python 2, with lots of string processing, mostly in the feedparser module. Memory usage and runtime depends on how many feeds it's reading and how much history it keeps, since it does everything in memory at the moment, using pickle for persistant state. (With my 800-odd feeds and two-month history, writing the entire store to HTML will use a few hundred meg of memory and run for several minutes.)<br><br>A future redesign will use a more sensible database-backed approach...</p>
        </div>
      </div>
      <div class="comment comment-2876345754903177218">
        <div class="comment-header">
          <a name="comment-2876345754903177218"></a>
            <span class="author">Bob Ziuchkovski</span> wrote on <span class="date">2010-08-24 00:10</span>:
        </div>
        <div class="comment-content">
          <p>Scapy would be a great one to benchmark.  Depending on the size of the packet capture, it can consume quite a bit of proc/mem when loading and dissecting large captures.  I run it at work on Cpython and would love to see it running/optimized under pypy.  The only problem is that I believe it uses some 2.6 pythonisms.</p>
        </div>
      </div>
      <div class="comment comment-1297615752190212537">
        <div class="comment-header">
          <a name="comment-1297615752190212537"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2010-08-27 19:03</span>:
        </div>
        <div class="comment-content">
          <p>Thanks again for all the additional pointers. Still investigating all of them.</p>
        </div>
      </div>
      <div class="comment comment-6518807218261174109">
        <div class="comment-header">
          <a name="comment-6518807218261174109"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-09-05 05:01</span>:
        </div>
        <div class="comment-content">
          <p>How about Nucular, a search engine written in python by aaron watters.<br><br>https://nucular.sourceforge.net/</p>
        </div>
      </div>
      <div class="comment comment-2893019868472013997">
        <div class="comment-header">
          <a name="comment-2893019868472013997"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-09-10 20:27</span>:
        </div>
        <div class="comment-content">
          <p>In my view, the natural competitors to PyPy (in the domain of fast interpreters for dynamic languages) are Tracemonkey and V8.  Therefore, translations of the Sunspider, V8, and Dromaeo benchmarks would be appropriate.</p>
        </div>
      </div>
      <div class="comment comment-5383592972377334821">
        <div class="comment-header">
          <a name="comment-5383592972377334821"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-09-17 14:58</span>:
        </div>
        <div class="comment-content">
          <p>bitbake looks like a good candidate. It's a derivative of portage, and used to crosscompile linux distro for embedded device. <br><br>With non trivial distro, it can use up to 400Mb. It already use psyco if available, and can be interesting compare speed/memory usage with pypy.</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/08/pyohio-2568618480482575546.html" class="u-url">PyOhio</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/alex.html">Alex</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/08/pyohio-2568618480482575546.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-08-02T21:33:00Z" itemprop="datePublished" title="2010-08-02 21:33">2010-08-02 21:33</time></a>
            </p>
                <p class="commentline">7 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>This weekend I delivered a talk at <a class="reference external" href="https://pyohio.org/">PyOhio</a> (an annual conference in Columbus, OH, USA) on PyPy and Unladen Swallow.  The talk covered reasons that Python, the language, is hard to optimize, why CPython is slow, and a few optimizations that PyPy and Unladen Swallow have implemented.  The slides from my talk are <a class="reference external" href="https://www.scribd.com/doc/35240506/Making-Python-Fast-PyPy-and-Unladen-Swallow">online</a>, and the talk was recorded so a video will follow.  I gave a similar talk to <a class="reference external" href="https://chipy.org/">ChiPy</a> (the Chicago Python user group), which was also recorded and the video is <a class="reference external" href="https://carlfk.blip.tv/file/3866910">available</a>.  Both audiences were excited about the futures for PyPy and Unladen Swallow, and for the future of a faster Python.</p>
<p>Alex</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-328493480308370519">
        <div class="comment-header">
          <a name="comment-328493480308370519"></a>
            <span class="author">tucuman87</span> wrote on <span class="date">2010-08-05 13:55</span>:
        </div>
        <div class="comment-content">
          <p>I do not understand why is python so hard to optimize- after all, LuaJIT is VERY fast, and I thought Lua has the same dynamical features as python. I'm no Python nor Lua expert, but it would be nice knowing...<br><br>Thanks!</p>
        </div>
      </div>
      <div class="comment comment-8200518278312974476">
        <div class="comment-header">
          <a name="comment-8200518278312974476"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2010-08-05 13:57</span>:
        </div>
        <div class="comment-content">
          <p>Did you actually watch the video? it's explained there.</p>
        </div>
      </div>
      <div class="comment comment-7653483226730406006">
        <div class="comment-header">
          <a name="comment-7653483226730406006"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2010-08-05 19:27</span>:
        </div>
        <div class="comment-content">
          <p>Any chance of putting the slides somewhere that can be directed downloaded?</p>
        </div>
      </div>
      <div class="comment comment-1386162189049009959">
        <div class="comment-header">
          <a name="comment-1386162189049009959"></a>
            <span class="author">Alex</span> wrote on <span class="date">2010-08-05 19:33</span>:
        </div>
        <div class="comment-content">
          <p>There's a link to download the slides on the right hand side.  This link: https://www.scribd.com/document_downloads/direct/35240506?extension=pdf&amp;ft=1281033139&amp;lt=1281036749&amp;uahk=mAWsHOEi/etYRUUXWst+oYKiWIU<br> should also work.</p>
        </div>
      </div>
      <div class="comment comment-1427871232713234977">
        <div class="comment-header">
          <a name="comment-1427871232713234977"></a>
            <span class="author">tucuman87</span> wrote on <span class="date">2010-08-05 20:42</span>:
        </div>
        <div class="comment-content">
          <p>I've seen the video, and the question I asked is not answered: what dynamic feature Python has that Lua doesn't?<br><br>is such a specific feature responsible for the fast LuaJIT?<br><br>Thanks.</p>
        </div>
      </div>
      <div class="comment comment-2626257240660748394">
        <div class="comment-header">
          <a name="comment-2626257240660748394"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2010-08-05 20:47</span>:
        </div>
        <div class="comment-content">
          <p>The main meta-reason is that Python is a very complex language compared to lua, so you have to take into account a lot of things that you don't care about in lua. one example is new style classes with insane semantics about descriptors.</p>
        </div>
      </div>
      <div class="comment comment-480886624450435789">
        <div class="comment-header">
          <a name="comment-480886624450435789"></a>
            <span class="author">Luis</span> wrote on <span class="date">2010-08-06 04:16</span>:
        </div>
        <div class="comment-content">
          <p>The author of Luajit, Mike Pall, participated in a long thread posted here https://lambda-the-ultimate.org/node/3851#comment-57700 , as well as Maciej and others.<br><br>There, he said about python:<br>"Python (the core language) just has different quirks that need to be worked around. But no show stoppers.<br>What is more challenging, is to efficiently handle Python (the programming environment) with all of its classes and methods. In particular the plethora of container types, since you really want to inline their accessors.<br>Since I don't believe in multi-language VMs, LuaJIT is pretty Lua-specific on all levels. Your best bet right now is to join the PyPy effort (they already handle the issues I mentioned)."</p>
        </div>
      </div>
         </div>

    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="../posts/2010/08/using-virtualenv-with-pypy-7238942727709530503.html" class="u-url">Using virtualenv with PyPy</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                <a href="../authors/antonio-cuni.html">Antonio Cuni</a>
            </span></p>
            <p class="dateline">
            <a href="../posts/2010/08/using-virtualenv-with-pypy-7238942727709530503.html" rel="bookmark">
            <time class="published dt-published" datetime="2010-08-02T14:55:00Z" itemprop="datePublished" title="2010-08-02 14:55">2010-08-02 14:55</time></a>
            </p>
                <p class="commentline">11 comments</p>

        </div>
    </header><div class="p-summary entry-summary">
    <p>Thanks to the work that was recently done on the <a class="reference external" href="https://codespeak.net/pipermail/pypy-svn/2010-June/041686.html">sys-prefix</a> branch, it is
now possible to use <a class="reference external" href="https://pypi.python.org/pypi/virtualenv">virtualenv</a> with PyPy.</p>
<p>To try it, you need:</p>
<blockquote>
<ul class="simple">
<li>a recent version of PyPy: PyPy 1.3 does not contain the necessary logic to
work with virtualenv, so you need a more recent PyPy from subversion
trunk. You can either <a class="reference external" href="https://codespeak.net/pypy/dist/pypy/doc/getting-started-python.html#translating-the-pypy-python-interpreter">build it by yourself</a> or download one of our
precompiled <a class="reference external" href="https://buildbot.pypy.org/nightly/trunk/">nightly builds</a>
</li>
<li>a copy of <a class="reference external" href="https://bitbucket.org/antocuni/virtualenv-pypy/">virtualenv-pypy</a>: this is a fork of virtualenv that contains
all the patches needed to work with PyPy, and hopefully will be <a class="reference external" href="https://bitbucket.org/ianb/virtualenv/issue/53/virtualenv-with-pypy">merged
back</a> at some point.  It should be totally compatible with the official
version of virtualenv, so it is safe to use it even to create non-PyPy
environments.  If you notice some weird behavior that does not happen with
the standard virtualenv, please let us know.</li>
</ul>
</blockquote>
<p>The directory layout has been redesigned in a way that it is possible to use
virtualenv to install a PyPy both from a precompiled tarball or from an svn
checkout:</p>
<pre class="literal-block">
# from a tarball
$ virtualenv -p /opt/pypy-c-jit-76426-linux/bin/pypy my-pypy-env

# from the svn checkout
$ virtualenv -p /path/to/pypy-trunk/pypy/translator/goal/pypy-c my-pypy-env
</pre>
<p>Once the environment has been created, you can enter it as usual. Note that
<tt class="docutils literal">bin/python</tt> is now a symlink to <tt class="docutils literal">bin/pypy</tt>.</p>
<p>Enjoy it :-)</p>
    </div>
    </article><div class="comment-level comment-level-1">
      <div class="comment comment-3091256415441189845">
        <div class="comment-header">
          <a name="comment-3091256415441189845"></a>
            <span class="author">RenÃ© Dudfield</span> wrote on <span class="date">2010-08-02 17:13</span>:
        </div>
        <div class="comment-content">
          <p>Another great step for pypy being used in more productions.</p>
        </div>
      </div>
      <div class="comment comment-1568446058480949985">
        <div class="comment-header">
          <a name="comment-1568446058480949985"></a>
            <span class="author">Konrad</span> wrote on <span class="date">2010-08-03 17:50</span>:
        </div>
        <div class="comment-content">
          <p>Good job!</p>
        </div>
      </div>
      <div class="comment comment-6218103162675511050">
        <div class="comment-header">
          <a name="comment-6218103162675511050"></a>
            <span class="author">Alexei Boronine</span> wrote on <span class="date">2010-08-05 16:22</span>:
        </div>
        <div class="comment-content">
          <p>I recently made a script called <a href="https://github.com/alexeiboronine/pypyenv" rel="nofollow">pypyenv</a> for easily installing PyPy in a virtualenv side by side with CPython, sharing site-packages. It will allow one to experiment with PyPy in a working virtualenv without breaking current code.</p>
        </div>
      </div>
      <div class="comment comment-8756700725521226531">
        <div class="comment-header">
          <a name="comment-8756700725521226531"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2010-08-05 19:16</span>:
        </div>
        <div class="comment-content">
          <p>@Alex: nice. pypyenv is obviously something different that virtualenv-pypy, but it might be useful if someone wants to try PyPy.<br><br>However, I don't think that sharing site-packages is a good idea: it works as long as you have only pure python packages, but it stops as soon as you build some C extension, as the .so produced by PyPy are incompatible with CPython</p>
        </div>
      </div>
      <div class="comment comment-8474667846161975813">
        <div class="comment-header">
          <a name="comment-8474667846161975813"></a>
            <span class="author">Alexei Boronine</span> wrote on <span class="date">2010-08-06 00:58</span>:
        </div>
        <div class="comment-content">
          <p>@Antonio<br><br>Interesting point, I'll mention it in the README. (by the way, thank you for your work, PyPy rocks my socks!)</p>
        </div>
      </div>
      <div class="comment comment-6109587195824817825">
        <div class="comment-header">
          <a name="comment-6109587195824817825"></a>
            <span class="author">Xiong Chiamiov</span> wrote on <span class="date">2010-08-11 23:31</span>:
        </div>
        <div class="comment-content">
          <p>A bit unrelated, but would it be possible to have nightly releases with consistent filenames?  Right now, they all include the svn revision number (I assume that's what it is), which makes it difficult to write a script that downloads and installs the latest version.<br><br>Specifically, I'm looking to create an Arch pkgbuild, because it takes too damn long to compile on my notebook, and I don't want to use the stable release.</p>
        </div>
      </div>
      <div class="comment comment-6123819019957554380">
        <div class="comment-header">
          <a name="comment-6123819019957554380"></a>
            <span class="author">jezdez</span> wrote on <span class="date">2010-09-03 15:10</span>:
        </div>
        <div class="comment-content">
          <p>FYI, the fixes have been merged in virtualenv's main repo.</p>
        </div>
      </div>
      <div class="comment comment-1562616395915689333">
        <div class="comment-header">
          <a name="comment-1562616395915689333"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-12-14 10:28</span>:
        </div>
        <div class="comment-content">
          <p>it seems there's no pypy/translator/goal/pypy-c anymore?<br>how to init virtualenv from pypy source now?</p>
        </div>
      </div>
      <div class="comment comment-6347350920860936668">
        <div class="comment-header">
          <a name="comment-6347350920860936668"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-12-14 10:31</span>:
        </div>
        <div class="comment-content">
          <p>It's not in a checkout you have to compile it first.</p>
        </div>
      </div>
      <div class="comment comment-2976979927870935163">
        <div class="comment-header">
          <a name="comment-2976979927870935163"></a>
            <span class="author">Asmo</span> wrote on <span class="date">2012-04-20 12:47</span>:
        </div>
        <div class="comment-content">
          <p>Is the information here still valid? Or should virtualenv work fine with pypy?</p>
        </div>
      </div>
      <div class="comment comment-2827880163008510084">
        <div class="comment-header">
          <a name="comment-2827880163008510084"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2012-04-20 12:50</span>:
        </div>
        <div class="comment-content">
          <p>Virtualenv should work just fine</p>
        </div>
      </div>
         </div>

</div>
</div>
<div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div></div>
</main>
</div>
<div style="clear: both; width: 75%; margin: 1em auto;">
        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-16.html" rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-14.html" rel="next">Older posts</a>
            </li>
        </ul></nav>
</div>
         
                 <footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    Â© 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
    Â 
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
    Â 
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../assets/js/styles.js"></script></footer>
</body>
</html>