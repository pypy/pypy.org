<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Announcing Topaz, an RPython powered Ruby interpreter | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2013/02/announcing-topaz-rpython-powered-ruby-6662407703061538341.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Carl Friedrich Bolz-Tereick">
<link rel="prev" href="cffi-05-1630643916751622710.html" title="CFFI 0.5" type="text/html">
<link rel="next" href="hello-everyone-4718797989680066222.html" title="PyCon Silicon Valley and San Francisco visit" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Announcing Topaz, an RPython powered Ruby interpreter">
<meta property="og:url" content="https://www.pypy.org/posts/2013/02/announcing-topaz-rpython-powered-ruby-6662407703061538341.html">
<meta property="og:description" content="Hello everyone

Last week, Alex Gaynor announced the first public release of
Topaz,
a Ruby interpreter written in RPython. This is the culmination of a
part-time effort over the past 10 months to prov">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-02-12T16:17:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Announcing Topaz, an RPython powered Ruby interpreter</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2013-02-12T16:17:00Z" itemprop="datePublished" title="2013-02-12 16:17">2013-02-12 16:17</time></a>
            </p>
                <p class="commentline">4 comments</p>

                <p class="commentline">            <a href="announcing-topaz-rpython-powered-ruby-6662407703061538341.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>Hello everyone</p>

<p>Last week, <a href="https://alexgaynor.net/">Alex Gaynor</a> announced the first public release of
<a href="https://topaz.readthedocs.org/en/latest/blog/announcing-topaz/">Topaz</a>,
a Ruby interpreter written in RPython. This is the culmination of a
part-time effort over the past 10 months to provide a Ruby interpreter
that implements enough interesting constructs in Ruby to show that the
RPython toolchain can produce a Ruby implementation fast enough to
beat what is out there.</p>

<h4 id="disclaimer">Disclaimer<a href="#disclaimer" class="headerlink" title="Permalink to this heading">¶</a></h4>

<p>Obviously the implementation is very incomplete currently in terms of
available standard library. We are working on getting it useable. If
you want to try it, grab a
<a href="https://topazruby.com/builds/">nightly build</a>.</p>

<p>We have run some benchmarks from the
<a href="https://github.com/acangiano/ruby-benchmark-suite">Ruby benchmark suite</a>
and the
<a href="https://github.com/ltratt/metatracing_vms_experiment">metatracing VMs experiment</a>. The
preliminary results are promising, but at this point we are missing so
many method implementations that most benchmarks won't run yet. So instead of
performance, I'm going to talk about the high-level structure of the
implementation.</p>

<h4 id="architecture">Architecture<a href="#architecture" class="headerlink" title="Permalink to this heading">¶</a></h4>

<p>Topaz interprets a custom bytecode set. The basics are similar to
Smalltalk VMs, with bytecodes for loading and storing locals and
instance variables, sending messages, and stack management. Some
syntactical features of Ruby, such as defining classes and modules,
literal regular expressions, hashes, ranges, etc also have their own
bytecodes. The third kind of bytecodes are for control flow constructs
in Ruby, such as loops, exception handling, break, continue, etc.</p>

<p>In trying to get from Ruby source code to bytecode, we found that the
easiest way to support all of the Ruby syntax is to write a custom
lexer and use an RPython port of <a href="https://github.com/dabeaz/ply">PLY</a>
(fittingly called <a href="https://github.com/alex/rply">RPly</a>) to create the
parser from the Ruby yacc grammar.</p>

<p>The Topaz interpreter uses an <code>ObjectSpace</code> (similar to how PyPy does
it), to interact with the Ruby world. The object space contains all
the logic for wrapping and interacting with Ruby objects from the
VM. It's <code>__init__</code> method sets up the core classes, initial globals,
and creates the main thread (the only one right now, as we do not have
threading, yet).</p>

<p>Classes are mostly written in Python. We use ClassDef objects to
define the Ruby hierarchy and attach RPython methods to Ruby via
ClassDef decorators. These two points warrant a little explanation.</p>

<h5 id="hierarchies">Hierarchies<a href="#hierarchies" class="headerlink" title="Permalink to this heading">¶</a></h5>

<p>All Ruby classes ultimately inherit from <code>BasicObject</code>. However, most
objects are below <code>Object</code> (which is a direct subclass of
<code>BasicObject</code>). This includes objects of type <code>Fixnum</code>, <code>Float</code>,
<code>Class</code>, and <code>Module</code>, which may not need all of the facilities of
full objects most of the time.</p>

<p>Most VMs treat such objects specially, using tagged pointers to
represent Fixnums, for example. Other VMs (for example from the
<a href="https://www.hpi.uni-potsdam.de/hirschfeld/projects/som/index.html#overview">SOM Family</a>)
don't. In the latter case, the implementation hierarchy matches the
language hierarchy, which means that objects like Fixnum share a
representation with all other objects (e.g. they have class pointers
and some kind of instance variable storage).</p>

<p>In Topaz, implementation hierarchy and language hierarchy are
separate. The first is defined through the Python inheritance. The
other is defined through the ClassDef for each Python class, where the
appropriate Ruby superclass is chosen. The diagram below shows how the
implementation class <code>W_FixnumObject</code> inherits directly from
<code>W_RootObject</code>.  Note that <code>W_RootObject</code> doesn't have any attrs,
specifically no storage for instance variables and no map (for
determining the class - we'll get to that). These attributes are
instead defined on <code>W_Object</code>, which is what most other implementation
classes inherit from. However, on the Ruby side, Fixnum correctly
inherits (via <code>Numeric</code> and <code>Integer</code>) from <code>Object</code>.</p>

<div class="separator" style="clear: both; text-align: center;">
<a href="https://3.bp.blogspot.com/-i-L-NdwW7I0/URpqZK9u8VI/AAAAAAAACJM/jseKbfD_wEw/s1600/Topaz-Parallel-Hierarchies.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="384" src="https://3.bp.blogspot.com/-i-L-NdwW7I0/URpqZK9u8VI/AAAAAAAACJM/jseKbfD_wEw/s400/Topaz-Parallel-Hierarchies.png" width="305"></a>
</div>

<p>This simple structural optimization gives a huge speed boost, but
there are VMs out there that do not have it and suffer performance
hits for it.</p>

<h5 id="decorators">Decorators<a href="#decorators" class="headerlink" title="Permalink to this heading">¶</a></h5>

<p>Ruby methods can have symbols in its names that are not allowed as
part of Python method names, for example <strong>!</strong>, <strong>?</strong>, or <strong>=</strong>, so we
cannot simply define Python methods and expose them to Ruby by the
same name. </p>

<p>For defining the Ruby method name of a function, as well as argument
number checking, Ruby type coercion and unwrapping of Ruby objects to
their Python equivalents, we use decorators defined on ClassDef. When
the ObjectSpace initializes, it builds all Ruby classes from their
respective ClassDef objects. For each method in an implementation
class that has a ClassDef decorator, a wrapper method is generated and
exposed to Ruby. These wrappers define the name of the Ruby method,
coerce Ruby arguments, and unwrap them for the Python method.</p>

<p>Here is a simple example:</p>

<pre><code>@classdef.method("*", times="int")
def method_times(self, space, times):
    return self.strategy.mul(space, self.str_storage, times)
</code></pre>

<p>This defines the method <code>*</code> on the Ruby String class. When this is
called, the first argument is converted into a Ruby Fixnum object
using the appropriate coercion method, and then unwrapped into a plain
Python int and passed as argument to <code>method_times</code>. The wrapper
method also supplies the space argument.</p>

<h4 id="object-structure">Object Structure<a href="#object-structure" class="headerlink" title="Permalink to this heading">¶</a></h4>

<p>Ruby objects have dynamically defined instance variables and may
change their class at any time in the program (a concept called
<a href="https://ola-bini.blogspot.de/2006/09/ruby-singleton-class.html">singleton class</a>
in Ruby - it allows each object to have unique behaviour). To still
efficiently access instance variables, you want to avoid dictionary
lookups and let the JIT know about objects of the same class that have
the same instance variables. Topaz, like PyPy (which got it from
Self), implements instances using maps, which transforms dictionary
lookups into array accesses. See the
<a href="../../2010/11/efficiently-implementing-python-objects-3838329944323946932.html">blog post</a>
for the details.</p>

<p>This is only a rough overview of the architecture. If you're
interested, get in touch on
<a href="https://botbot.me/freenode/topaz/">#topaz.freenode.net</a>, follow the
Topaz <a href="https://twitter.com/topazproject">Twitter account</a> or contribute
on <a href="https://github.com/topazproject/topaz">GitHub</a>.</p>

<a href="https://blog.bithug.org">Tim Felgentreff</a>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="cffi-05-1630643916751622710.html" rel="prev" title="CFFI 0.5">Previous post</a>
            </li>
            <li class="next">
                <a href="hello-everyone-4718797989680066222.html" rel="next" title="PyCon Silicon Valley and San Francisco visit">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-7569873444228516218">
        <div class="comment-header">
          <a name="comment-7569873444228516218"></a>
            <span class="author">Shin Guey</span> wrote on <span class="date">2013-02-12 19:25</span>:
        </div>
        <div class="comment-content">
          <p>Interesting. Although I code a lot in python but still quite like Ruby. Am looking forward for a fast ruby...</p>
        </div>
      </div>
      <div class="comment comment-4040858814428629161">
        <div class="comment-header">
          <a name="comment-4040858814428629161"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2013-02-12 20:37</span>:
        </div>
        <div class="comment-content">
          <p>Does this mean that JVM is now obsolete?</p>
        </div>
      </div>
      <div class="comment comment-6425227628851658404">
        <div class="comment-header">
          <a name="comment-6425227628851658404"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-02-13 14:36</span>:
        </div>
        <div class="comment-content">
          <p>Don't worry. JVM will outlive you and your grandgrandchildren.</p>
        </div>
      </div>
      <div class="comment comment-1350458280120001447">
        <div class="comment-header">
          <a name="comment-1350458280120001447"></a>
            <span class="author">smurfix</span> wrote on <span class="date">2013-02-17 09:05</span>:
        </div>
        <div class="comment-content">
          <p>"Its __init__ method", not "It's".</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>