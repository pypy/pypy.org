<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Update on STM | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2013/08/update-on-stm-8705514488940872802.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Armin Rigo">
<link rel="prev" href="numpypy-status-update-3401163348519734658.html" title="NumPyPy Status Update" type="text/html">
<link rel="next" href="preliminary-london-demo-evening-agenda-5254002451136674320.html" title="Preliminary London Demo Evening Agenda" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Update on STM">
<meta property="og:url" content="https://www.pypy.org/posts/2013/08/update-on-stm-8705514488940872802.html">
<meta property="og:description" content='Hi all,

A quick update on Software Transactional Memory.  We are
working on two fronts.

On the one hand, the integration of the "c4" C library with PyPy is done
and works well, but is still subject '>
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-08-18T18:54:00Z">
<meta property="article:tag" content="stm">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Searchâ€¦" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Update on STM</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/armin-rigo.html">Armin Rigo</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2013-08-18T18:54:00Z" itemprop="datePublished" title="2013-08-18 18:54">2013-08-18 18:54</time></a>
            </p>
                <p class="commentline">7 comments</p>

                <p class="commentline">            <a href="update-on-stm-8705514488940872802.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>Hi all,</p>

<p>A quick update on Software Transactional Memory.  We are
working on two fronts.</p>

<p>On the one hand, the integration of the "c4" C library with PyPy is done
and works well, but is still subject to improvements.  The "PyPy-STM"
executable (without the JIT)
seems to be stable, as far as it has been tested.  It runs a simple
benchmark like Richards with a 3.2x slow-down over a regular JIT-less
PyPy.</p>

<p>The main factor of this slow-down: the numerous "barriers" in
the code --- checks that are needed a bit everywhere to verify that a
pointer to an object points to a recent enough version, and if not, to
go to the most recent version.  These barriers are inserted automatically
during the translation; there is no need for us to manually put 42 million
barriers in the source code of PyPy.  But this automatic insertion uses a
primitive algorithm right now, which usually ends up putting more barriers than the
theoretical optimum.  I (Armin) am trying to improve that --- and progressing:
last week the slow-down was around 4.5x.  This is done in the branch
<a href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/stmgc-static-barrier">stmgc-static-barrier</a>.</p>

<p>On the other hand, Remi is progressing on the JIT integration in
the branch <a href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/stmgc-c4">stmgc-c4</a>. 
This has been working in simple cases since a couple of weeks by now, but the
resulting "PyPy-JIT-STM" often crashes.  This is because while the
basics are not really hard, we keep hitting new issues that must be
resolved.</p>

<p>The basics are that whenever the JIT is about to generate
assembler corresponding to a load or a store in a GC object, it must
first generate a bit of extra assembler that corresponds to the barrier
that we need.  This works fine by now (but could benefit from the same
kind of optimizations described above, to reduce the number of barriers).
The additional issues are all more subtle.  I will describe the current
one as an example: it is how to write constant pointers inside the assembler.</p>

<p>Remember that the STM library classifies objects as either
"public" or "protected/private".  A "protected/private" object
is one which has not been seen by another thread so far.
This is essential as an optimization, because we know that no
other thread will access our protected or private objects in parallel,
and thus we are free to modify their content in place.  By contrast,
public objects are frozen, and to do any change, we first need to
build a different (protected) copy of the object.  See this
<a href="../06/stm-on-drawing-board-1028082727566254104.html">blog
post</a> for more details.</p>

<p>So far so good, but the JIT will sometimes (actually often) hard-code
constant pointers into the assembler it produces.  For example, this is the
case when the Python code being JITted creates an instance of a known class;
the corresponding assembler produced by the JIT will reserve the memory for
the instance and then write the constant type pointer in it.  This type
pointer is a GC object (in the simple model, it's the Python class object;
in PyPy it's actually the "map" object, which is
<a href="../../2011/03/controlling-tracing-of-interpreter-with_21-6524148550848694588.html">a different story</a>).</p>

<p>The problem right now is that this constant pointer may point to a
protected object.  This is a problem because the same piece of assembler
can later be executed by a different thread.  If it does, then this
different thread will create instances whose type pointer is bogus: looking
like a protected object, but actually protected by a different thread.
Any attempt to use this type pointer to change anything on the class
itself will likely crash: the threads will all think they can safely change it
in-place.  To fix this, we need to make sure we only write pointers to
public objects in the assembler.  This is a bit involved because we need
to ensure that there <i>is</i> a public version of the object to start with.</p>

<p>When this is done, we will likely hit the next problem, and the next one;
but at some point it should converge (hopefully!) and we'll give you our first
PyPy-JIT-STM ready to try.  Stay tuned :-)</p>

<p>A bientÃ´t,</p>

<p>Armin.</p>
      </div>
      <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/stm.html" rel="tag">stm</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="numpypy-status-update-3401163348519734658.html" rel="prev" title="NumPyPy Status Update">Previous post</a>
            </li>
            <li class="next">
                <a href="preliminary-london-demo-evening-agenda-5254002451136674320.html" rel="next" title="Preliminary London Demo Evening Agenda">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-6389834796906028011">
        <div class="comment-header">
          <a name="comment-6389834796906028011"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-08-19 11:06</span>:
        </div>
        <div class="comment-content">
          <p>*assembly</p>
        </div>
      </div>
      <div class="comment comment-9085338239827648667">
        <div class="comment-header">
          <a name="comment-9085338239827648667"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2013-08-20 21:31</span>:
        </div>
        <div class="comment-content">
          <p>Thanks for the update; glad it's coming together! I'm really looking forward to seeing how it stacks up once the JIT work is complete.<br><br>Do you think that it'll be possible to ever get better than a 2x slowdown for serial operations? Or is that the minimal possible? Naively, it makes sense that it'll never be as fast, but if 1.5x or lower were possible, that would be very exciting.<br><br>Also, is the end goal that you would have a module you import to "turn on" STM? Or would it always be a separate build of pypy, just like JIT/JIT-less?</p>
        </div>
      </div>
      <div class="comment comment-5211777373385768105">
        <div class="comment-header">
          <a name="comment-5211777373385768105"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2013-08-21 09:05</span>:
        </div>
        <div class="comment-content">
          <p>@Christopher: the slow-down we'll get is still unknown, but I fear it won't really go well under 2x.<br><br>I see it mainly as a separate build: either you want to run all these barrier instructions everywhere (which gives the slow-down) or not.  It could be possible in theory to have a version that has the barriers everywhere, but creates JIT-generated assembler that doesn't, and thus runs almost as fast as a regular PyPy as long as you don't "turn on" STM.  We will see if that makes sense.</p>
        </div>
      </div>
      <div class="comment comment-3507422045925510245">
        <div class="comment-header">
          <a name="comment-3507422045925510245"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2013-08-21 09:12</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous: ah, thanks :-)  I think I now learned the difference between "assembler" and "assembly" in English, which was never quite clear to me.  Note that in french the same word ("assembleur") is used to mean both terms.</p>
        </div>
      </div>
      <div class="comment comment-6106623681571194221">
        <div class="comment-header">
          <a name="comment-6106623681571194221"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2013-08-22 17:14</span>:
        </div>
        <div class="comment-content">
          <p>@Armin: Ah, I see. Well, from a user's perspective, what I most write in python these days is either GUI applications (for which I've never been able to use pypy due to lack of bindings, but that's another issue entirely), or for small services, for which pypy has provided a rather nice speed improvement.<br><br>In a perfect world, I'd be able to use pypy for both of these tasks, not using STM for my GUI applications, but turning it on for the services I write (well, once they reach a certain point where I'd gain something from concurrency).<br><br>I suspect having a separate build would make such a use-case awkward.<br><br>Also, my interest is a bit self-motivated; at work we current use node.js for a lot of our services. Pypy compares decently for a lot of our tasks, but it not 'clearly better'. Once STM is stable, however, several of our services that we've struggled scaling to multiple cores on node.js could be rewritten in pypy STM, and should scale much easier. (Manual process management is painful!)<br><br>Again, if pypy STM were a seperate build, we'd have to manage having both installed in the case where we have servers running services that need concurrency, or ones that work well enough with a very fast async implementation. Not impossible, just a bit awkward. :)<br><br>Either way, I'm pretty excited!</p>
        </div>
      </div>
      <div class="comment comment-4877793269843688351">
        <div class="comment-header">
          <a name="comment-4877793269843688351"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2013-10-16 15:22</span>:
        </div>
        <div class="comment-content">
          <p>Are there any plans or experiments going on related to Hardware Transactional Memory?</p>
        </div>
      </div>
      <div class="comment comment-5381354260304283933">
        <div class="comment-header">
          <a name="comment-5381354260304283933"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2013-10-16 15:55</span>:
        </div>
        <div class="comment-content">
          <p>@Ignacio Hernandez: for HTM, our position is still as described last year in: https://morepypy.blogspot.com/2012/08/multicore-programming-in-pypy-and.html</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    Â© 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
    Â 
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
    Â 
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>