<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controlling the Tracing of an Interpreter With Hints, Part 4: Benchmarks | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2011/03/controlling-tracing-of-interpreter-with_26-3072929156700508140.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Carl Friedrich Bolz-Tereick">
<link rel="prev" href="thank-you-to-psf-5934275567667314914.html" title="A thank you to the PSF" type="text/html">
<link rel="next" href="../04/pypy-goteborg-post-easter-sprint-april-16274563331982977.html" title="PyPy Göteborg Post-Easter Sprint April 25 - May 1 2011" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Controlling the Tracing of an Interpreter With Hints, Part 4: Benchmar">
<meta property="og:url" content="https://www.pypy.org/posts/2011/03/controlling-tracing-of-interpreter-with_26-3072929156700508140.html">
<meta property="og:description" content="This is part 4 and the final part of the series on how to speed up an interpreter
written with PyPy by adding JIT hints to the interpreter. Part 1 described how
to control the extent of tracing. Part ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2011-03-26T17:44:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Controlling the Tracing of an Interpreter With Hints, Part 4: Benchmarks</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2011-03-26T17:44:00Z" itemprop="datePublished" title="2011-03-26 17:44">2011-03-26 17:44</time></a>
            </p>
                <p class="commentline">9 comments</p>

                <p class="commentline">            <a href="controlling-tracing-of-interpreter-with_26-3072929156700508140.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>This is part 4 and the <strong>final</strong> part of the series on how to speed up an interpreter
written with PyPy by adding JIT hints to the interpreter. Part 1 described how
to <a class="reference external" href="controlling-tracing-of-interpreter-with-871085470935630424.html">control the extent of tracing</a>. Part 2 described how to <a class="reference external" href="controlling-tracing-of-interpreter-with_15-3281215865169782921.html">influence the
optimizer with promotion and pure functions</a>. Part 3 described a <a class="reference external" href="controlling-tracing-of-interpreter-with_21-6524148550848694588.html">simple object
model and how it can be optimized</a> by doing small rewrites. In this (short) post
I present some benchmarks.</p>
<div class="section" id="benchmarks">
<h2>Benchmarks<a href="#benchmarks" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>For the benchmarks I ran a subset of the benchmarks on <a class="reference external" href="https://speed.pypy.org">https://speed.pypy.org</a>
with CPython and four different executables of PyPy's Python interpreter (all
with a JIT). The executables contain all combinations of enabling maps (which
make instance attributes fast) and type versions (which makes method lookup
fast).</p>
<ul class="simple">
<li>
<strong>pypy-slow</strong>: contains neither maps nor type versions.</li>
<li>
<strong>pypy-map</strong>: contains maps but not type versions.</li>
<li>
<strong>pypy-version</strong>: contains type versions but not maps.</li>
<li>
<strong>pypy-full</strong>: contains both maps <em>and</em> type versions</li>
</ul>
<p>The results are as follows:</p>
<a href="https://2.bp.blogspot.com/-tzvNLyIUk2g/TY4mMvBzHYI/AAAAAAAAAP8/1Kc6uR3Mb14/s1600/bench-objmodel.png"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5588446187837660546" src="https://2.bp.blogspot.com/-tzvNLyIUk2g/TY4mMvBzHYI/AAAAAAAAAP8/1Kc6uR3Mb14/s600/bench-objmodel.png" style="display: block; margin: 0px auto 10px; text-align: center; cursor: pointer; cursor: hand; width: 600px;"></a>
<p>The graph shows the speedup over CPython's numbers. The results are quite
interesting. Maps by themselves do not speed up much over the bare JIT, whereas
typed versions alone improve on the JIT baseline in many cases. However, maps
are not useless. In combination with type versions they add a nice improvement
over just type versions in a number of benchmarks (most notably
<tt class="docutils literal"><span class="pre">raytrace-simple</span></tt> and <tt class="docutils literal">richards</tt> but also in <tt class="docutils literal"><span class="pre">crypto-pyaes</span></tt>, <tt class="docutils literal">django</tt>
and <tt class="docutils literal">go</tt>).</p>
<p>It's clear that type versions can be arbitrarily effective. A method lookup on a
class can be arbitrarily slow, if the inheritance hierarchy becomes deeper and
deeper. The full lookup is replaced by one promotion if type versions are
enabled.</p>
<p>Maps on the other hand always replace one dict lookup with one promotion. Since
dict lookups are already very fast, this by itself does not lead to a gigantic
improvement. Only in combination with type versions do they show their full
potential.</p>
</div>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="thank-you-to-psf-5934275567667314914.html" rel="prev" title="A thank you to the PSF">Previous post</a>
            </li>
            <li class="next">
                <a href="../04/pypy-goteborg-post-easter-sprint-april-16274563331982977.html" rel="next" title="PyPy Göteborg Post-Easter Sprint April 25 - May 1 2011">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-8521252991658760917">
        <div class="comment-header">
          <a name="comment-8521252991658760917"></a>
            <span class="author">Winston Ewert</span> wrote on <span class="date">2011-03-26 20:17</span>:
        </div>
        <div class="comment-content">
          <p>It's not clear to me why version + maps combine so well. Maps should effectively eliminate lookups on the instance dict and versions eliminate lookups on the class dict. Both versions would seem to eliminate different classes of lookups, so I'm not seeing why we have dramatic improvement when using them together.</p>
        </div>
      </div>
      <div class="comment comment-6850712540526590285">
        <div class="comment-header">
          <a name="comment-6850712540526590285"></a>
            <span class="author">Alex</span> wrote on <span class="date">2011-03-26 20:19</span>:
        </div>
        <div class="comment-content">
          <p>I'm not an expert at CPU architecture, but ISTM eliminating both can eliminate a large number of memory reads which would help with pipelining and other very low level optimizations.</p>
        </div>
      </div>
      <div class="comment comment-8246456973299056880">
        <div class="comment-header">
          <a name="comment-8246456973299056880"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2011-03-26 21:33</span>:
        </div>
        <div class="comment-content">
          <p>@Winston: I actually have no clue :-). The numbers are hard to deny though. I plan to stare at the traces a bit next week, can comment here if I find something interesting.</p>
        </div>
      </div>
      <div class="comment comment-5202002475509570499">
        <div class="comment-header">
          <a name="comment-5202002475509570499"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2011-03-27 14:52</span>:
        </div>
        <div class="comment-content">
          <p>@Winston: ok, I probably found out. Your reasoning is too simple because usually you do several lookups on the same object in a row. Every lookup looks first in the class, then in the instance. So it looks a bit like this:<br><br>lookup name1 in obj.__class__<br>lookup name1 in obj.__dict__<br>lookup name2 in obj.__class__<br>lookup name2 in obj.__dict__<br>lookup name2 in obj.__class__<br>lookup name2 in obj.__dict__<br><br>when using maps, every lookup in the dict is simply reading the map, promoting it and then a read. after the promotion of the map, the instance's layout is fully known. however, if type versions are disabled, the lookups in the class are complex operations that are opaque to the JIT. Therefore the JIT assumes they can change the layout and thus the map of the object.<br><br>If you also enable type versions, then the class lookups are understandable to the JIT. therefore the JIT can see that the class lookup didn't change the layout of the class. This means that after the first instance lookup, the following instance lookups cost nothing at all.</p>
        </div>
      </div>
      <div class="comment comment-7570150962796741243">
        <div class="comment-header">
          <a name="comment-7570150962796741243"></a>
            <span class="author">klaussfreire</span> wrote on <span class="date">2011-03-28 15:04</span>:
        </div>
        <div class="comment-content">
          <p>I think an important improvement brought about by maps is the memory footprint reduction.<br><br>It won't matter all the time, but it makes all classes as space-efficient as if they used __slots__, all automagically, which is no small thing.<br><br>For programs that handle lots of small objects, this can really make a difference, in memory consumption and speed (less memory to shuffle around will invariably be faster)<br><br>Perhaps the benchmark suite doesn't have enough of those cases.</p>
        </div>
      </div>
      <div class="comment comment-8177981225971493179">
        <div class="comment-header">
          <a name="comment-8177981225971493179"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-03-28 22:16</span>:
        </div>
        <div class="comment-content">
          <p>@cfbolz I think one reason why maps+version tags are fast is because we lack jit.unroll_safe on several lookup functions when version tags are disabled. Marking them as unrollable would speed things up.<br><br>The reasoning behind this is that old style classes which have maps, but no version tags are much faster than new style classes with version tags disabled.</p>
        </div>
      </div>
      <div class="comment comment-8842178111548556511">
        <div class="comment-header">
          <a name="comment-8842178111548556511"></a>
            <span class="author">Winston Ewert</span> wrote on <span class="date">2011-03-30 00:41</span>:
        </div>
        <div class="comment-content">
          <p>Thanks for taking the time to answer my query. <br><br>The use of class versions eliminates the opaque function being called because the JIT knows the return will be constant. This allows optimizations to work correctly. But this makes me wonder how much of the improvement is due to class versions and how much is due to lack of opaqueness. <br><br>At any rate, I always find the posts on this blog very interesting. It definitely some neat stuff you are doing here.</p>
        </div>
      </div>
      <div class="comment comment-7610808792454764481">
        <div class="comment-header">
          <a name="comment-7610808792454764481"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2011-03-30 11:30</span>:
        </div>
        <div class="comment-content">
          <p>@fijal I thought old-style classes had celldicts? That's yet another thing, but your point is still correct.</p>
        </div>
      </div>
      <div class="comment comment-8051443532853181425">
        <div class="comment-header">
          <a name="comment-8051443532853181425"></a>
            <span class="author">Benjamin</span> wrote on <span class="date">2011-04-27 22:48</span>:
        </div>
        <div class="comment-content">
          <p>I'd love to see a blog post about conventions to favor or avoid while writing python code to best take advantage of these excellent features.  For example, your previous post implied something like this would be faster than changing the class directly:<br><br>class Counter(object):<br>....def __init__(self):<br>........self.count = 0<br>....def increment(self):<br>........self.count += 1<br><br>class Many(object):<br>....counter = Counter()<br>....def __init__(self):<br>........self.counter.increment()<br><br>Granted, it would be preferable, from a coding standpoint, to just use a simple class attribute, but the adaptations that would likely work best for the pypy JIT seem like far smaller divergences from the 'ideal' python than many other lengths people go to when coding for speed, particularly compared to something like cython.</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>