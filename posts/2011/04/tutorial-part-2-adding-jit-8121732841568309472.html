<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tutorial Part 2: Adding a JIT | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2011/04/tutorial-part-2-adding-jit-8121732841568309472.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Carl Friedrich Bolz-Tereick">
<link rel="prev" href="tutorial-writing-interpreter-with-pypy-3785910476193156295.html" title="Tutorial: Writing an Interpreter with PyPy, Part 1" type="text/html">
<link rel="next" href="using-tkinter-and-idle-with-pypy-6156563216925585965.html" title="Using Tkinter and IDLE with PyPy" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Tutorial Part 2: Adding a JIT">
<meta property="og:url" content="https://www.pypy.org/posts/2011/04/tutorial-part-2-adding-jit-8121732841568309472.html">
<meta property="og:description" content="This is the second part of a tutorial written by Andrew Brown. The first
part described how to write an interpreter with PyPy.

Adding JIT
Translating RPython to C is pretty cool, but one of the best ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2011-04-06T13:51:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Tutorial Part 2: Adding a JIT</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2011-04-06T13:51:00Z" itemprop="datePublished" title="2011-04-06 13:51">2011-04-06 13:51</time></a>
            </p>
                <p class="commentline">10 comments</p>

                <p class="commentline">            <a href="tutorial-part-2-adding-jit-8121732841568309472.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>This is the second part of a tutorial written by <a class="reference external" href="https://codespeak.net/pipermail/pypy-dev/2011q2/007128.html">Andrew Brown</a>. The first
part described how to <a class="reference external" href="tutorial-writing-interpreter-with-pypy-3785910476193156295.html">write an interpreter with PyPy</a>.</p>
<div class="section" id="adding-jit">
<h2>Adding JIT<a href="#adding-jit" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Translating RPython to C is pretty cool, but one of the best features of PyPy
is its ability to <em>generate just-in-time compilers for your interpreter</em>.
That's right, from just a couple hints on how your interpreter is structured,
PyPy will generate and include a JIT compiler that will, at runtime, translate
the interpreted code of our BF language to machine code!</p>
<p>So what do we need to tell PyPy to make this happen? First it needs to know
where the start of your bytecode evaluation loop is. This lets it keep track of
instructions being executed in the target language (BF).</p>
<p>We also need to let it know what defines a particular execution frame. Since
our language doesn't really have stack frames, this boils down to what's
constant for the execution of a particular instruction, and what's not. These
are called "green" and "red" variables, respectively.</p>
<p>Refer back to <a class="reference external" href="https://bitbucket.org/brownan/pypy-tutorial/src/tip/example2.py">example2.py</a> for the following.</p>
<p>In our main loop, there are four variables used: pc, program, bracket_map, and
tape. Of those, pc, program, and bracket_map are all green variables. They
<em>define</em> the execution of a particular instruction. If the JIT routines see the
same combination of green variables as before, it knows it's skipped back and
must be executing a loop.  The variable "tape" is our red variable, it's what's
being manipulated by the execution.</p>
<p>So let's tell PyPy this info. Start by importing the JitDriver class and making
an instance:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #006699; font-weight: bold;">from</span> <span style="color: #00CCFF; font-weight: bold;">pypy.rlib.jit</span> <span style="color: #006699; font-weight: bold;">import</span> JitDriver
jitdriver <span style="color: #555555;">=</span> JitDriver(greens<span style="color: #555555;">=</span>[<span style="color: #CC3300;">'pc'</span>, <span style="color: #CC3300;">'program'</span>, <span style="color: #CC3300;">'bracket_map'</span>],
        reds<span style="color: #555555;">=</span>[<span style="color: #CC3300;">'tape'</span>])
</pre></div>
<p>And we add this line to the very top of the while loop in the mainloop
function:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;">jitdriver<span style="color: #555555;">.</span>jit_merge_point(pc<span style="color: #555555;">=</span>pc, tape<span style="color: #555555;">=</span>tape, program<span style="color: #555555;">=</span>program,
        bracket_map<span style="color: #555555;">=</span>bracket_map)
</pre></div>
<p>We also need to define a JitPolicy. We're not doing anything fancy, so this is
all we need somewhere in the file:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">jitpolicy</span>(driver):
    <span style="color: #006699; font-weight: bold;">from</span> <span style="color: #00CCFF; font-weight: bold;">pypy.jit.codewriter.policy</span> <span style="color: #006699; font-weight: bold;">import</span> JitPolicy
    <span style="color: #006699; font-weight: bold;">return</span> JitPolicy()
</pre></div>
<p>See this example at <a class="reference external" href="https://bitbucket.org/brownan/pypy-tutorial/src/tip/example3.py">example3.py</a></p>
<p>Now try translating again, but with the flag <tt class="docutils literal"><span class="pre">--opt=jit</span></tt>:</p>
<pre class="literal-block">
$ python ./pypy/pypy/translator/goal/translate.py --opt=jit example3.py
</pre>
<p>It will take significantly longer to translate with JIT enabled, almost 8
minutes on my machine, and the resulting binary will be much larger. When it's
done, try having it run the mandelbrot program again. A world of difference,
from 12 seconds compared to 45 seconds before!</p>
<p>Interestingly enough, you can see when the JIT compiler switches from
interpreted to machine code with the mandelbrot example. The first few lines of
output come out pretty fast, and then the program gets a boost of speed and
gets even faster.</p>
</div>
<div class="section" id="a-bit-about-tracing-jit-compilers">
<h2>A bit about Tracing JIT Compilers<a href="#a-bit-about-tracing-jit-compilers" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>It's worth it at this point to read up on how tracing JIT compilers work.
Here's a brief explanation: The interpreter is usually running your interpreter
code as written. When it detects a loop of code in the target language (BF) is
executed often, that loop is considered "hot" and marked to be traced. The next
time that loop is entered, the interpreter gets put in tracing mode where every
executed instruction is logged.</p>
<p>When the loop is finished, tracing stops. The trace of the loop is sent to an
optimizer, and then to an assembler which outputs machine code. That machine
code is then used for subsequent loop iterations.</p>
<p>This machine code is often optimized for the most common case, and depends on
several assumptions about the code. Therefore, the machine code will contain
guards, to validate those assumptions. If a guard check fails, the runtime
falls back to regular interpreted mode.</p>
<p>A good place to start for more information is
<a class="reference external" href="https://en.wikipedia.org/wiki/Just-in-time_compilation">https://en.wikipedia.org/wiki/Just-in-time_compilation</a></p>
</div>
<div class="section" id="debugging-and-trace-logs">
<h2>Debugging and Trace Logs<a href="#debugging-and-trace-logs" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Can we do any better? How can we see what the JIT is doing? Let's do two
things.</p>
<p>First, let's add a get_printable_location function, which is used during debug
trace logging:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">get_location</span>(pc, program, bracket_map):
    <span style="color: #006699; font-weight: bold;">return</span> <span style="color: #CC3300;">"</span><span style="color: #AA0000;">%s</span><span style="color: #CC3300;">_</span><span style="color: #AA0000;">%s</span><span style="color: #CC3300;">_</span><span style="color: #AA0000;">%s</span><span style="color: #CC3300;">"</span> <span style="color: #555555;">%</span> (
            program[:pc], program[pc], program[pc<span style="color: #555555;">+</span><span style="color: #FF6600;">1</span>:]
            )
jitdriver <span style="color: #555555;">=</span> JitDriver(greens<span style="color: #555555;">=</span>[<span style="color: #CC3300;">'pc'</span>, <span style="color: #CC3300;">'program'</span>, <span style="color: #CC3300;">'bracket_map'</span>], reds<span style="color: #555555;">=</span>[<span style="color: #CC3300;">'tape'</span>],
        get_printable_location<span style="color: #555555;">=</span>get_location)
</pre></div>
<p>This function is passed in the green variables, and should return a string.
Here, we're printing out the BF code, surrounding the currently executing
instruction with underscores so we can see where it is.</p>
<p>Download this as <a class="reference external" href="https://bitbucket.org/brownan/pypy-tutorial/src/tip/example4.py">example4.py</a> and translate it the same as example3.py.</p>
<p>Now let's run a test program (test.b, which just prints the letter "A" 15 or so
times in a loop) with trace logging:</p>
<pre class="literal-block">
$ PYPYLOG=jit-log-opt:logfile ./example4-c test.b
</pre>
<p>Now take a look at the file "logfile". This file is quite hard to read, so
here's my best shot at explaining it.</p>
<p>The file contains a log of every trace that was performed, and is essentially a
glimpse at what instructions it's compiling to machine code for you. It's
useful to see if there are unnecessary instructions or room for optimization.</p>
<p>Each trace starts with a line that looks like this:</p>
<pre class="literal-block">
[3c091099e7a4a7] {jit-log-opt-loop
</pre>
<p>and ends with a line like this:</p>
<pre class="literal-block">
[3c091099eae17d jit-log-opt-loop}
</pre>
<p>The next line tells you which loop number it is, and how many ops are in it.
In my case, the first trace looks like this:</p>
<table class="highlighttable"><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td>
<td class="code">
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;">  [<span style="color: #FF6600;">3</span>c167c92b9118f] {jit<span style="color: #555555;">-</span>log<span style="color: #555555;">-</span>opt<span style="color: #555555;">-</span>loop
  <span style="color: #0099FF; font-style: italic;"># Loop 0 : loop with 26 ops</span>
  [p0, p1, i2, i3]
  debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[_&gt;_+&lt;-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
  debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;_+_&lt;-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
  i4 <span style="color: #555555;">=</span> getarrayitem_gc(p1, i2, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
  i6 <span style="color: #555555;">=</span> int_add(i4, <span style="color: #FF6600;">1</span>)
  setarrayitem_gc(p1, i2, i6, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
  debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;+_&lt;_-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
  debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;+&lt;_-_]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
  i7 <span style="color: #555555;">=</span> getarrayitem_gc(p1, i3, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
  i9 <span style="color: #555555;">=</span> int_sub(i7, <span style="color: #FF6600;">1</span>)
  setarrayitem_gc(p1, i3, i9, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
  debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;+&lt;-_]_&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
  i10 <span style="color: #555555;">=</span> int_is_true(i9)
  guard_true(i10, descr<span style="color: #555555;">=&lt;</span>Guard2<span style="color: #555555;">&gt;</span>) [p0]
  i14 <span style="color: #555555;">=</span> call(ConstClass(ll_dict_lookup__dicttablePtr_Signed_Signed), ConstPtr(ptr12), <span style="color: #FF6600;">90</span>, <span style="color: #FF6600;">90</span>, descr<span style="color: #555555;">=&lt;</span>SignedCallDescr<span style="color: #555555;">&gt;</span>)
  guard_no_exception(, descr<span style="color: #555555;">=&lt;</span>Guard3<span style="color: #555555;">&gt;</span>) [i14, p0]
  i16 <span style="color: #555555;">=</span> int_and(i14, <span style="color: #555555;">-</span><span style="color: #FF6600;">9223372036854775808</span>)
  i17 <span style="color: #555555;">=</span> int_is_true(i16)
  guard_false(i17, descr<span style="color: #555555;">=&lt;</span>Guard4<span style="color: #555555;">&gt;</span>) [i14, p0]
  i19 <span style="color: #555555;">=</span> call(ConstClass(ll_get_value__dicttablePtr_Signed), ConstPtr(ptr12), i14, descr<span style="color: #555555;">=&lt;</span>SignedCallDescr<span style="color: #555555;">&gt;</span>)
  guard_no_exception(, descr<span style="color: #555555;">=&lt;</span>Guard5<span style="color: #555555;">&gt;</span>) [i19, p0]
  i21 <span style="color: #555555;">=</span> int_add(i19, <span style="color: #FF6600;">1</span>)
  i23 <span style="color: #555555;">=</span> int_lt(i21, <span style="color: #FF6600;">114</span>)
  guard_true(i23, descr<span style="color: #555555;">=&lt;</span>Guard6<span style="color: #555555;">&gt;</span>) [i21, p0]
  guard_value(i21, <span style="color: #FF6600;">86</span>, descr<span style="color: #555555;">=&lt;</span>Guard7<span style="color: #555555;">&gt;</span>) [i21, p0]
  debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[_&gt;_+&lt;-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
  jump(p0, p1, i2, i3, descr<span style="color: #555555;">=&lt;</span>Loop0<span style="color: #555555;">&gt;</span>)
  [<span style="color: #FF6600;">3</span>c167c92bc6a15] jit<span style="color: #555555;">-</span>log<span style="color: #555555;">-</span>opt<span style="color: #555555;">-</span>loop}
</pre></div>
</td>
</tr></table>
<p>I've trimmed the debug_merge_point lines a bit, they were really long.</p>
<p>So let's see what this does. This trace takes 4 parameters: 2 object pointers
(p0 and p1) and 2 integers (i2 and i3). Looking at the debug lines, it seems to
be tracing one iteration of this loop: "[&gt;+&lt;-]"</p>
<p>It starts executing the first operation on line 4, a "&gt;", but immediately
starts executing the next operation. The "&gt;" had no instructions, and looks
like it was optimized out completely.  This loop must always act on the same
part of the tape, the tape pointer is constant for this trace. An explicit
advance operation is unnecessary.</p>
<p>Lines 5 to 8 are the instructions for the "+" operation. First it gets the
array item from the array in pointer p1 at index i2 (line 6), adds 1 to it and
stores it in i6 (line 7), and stores it back in the array (line 8).</p>
<p>Line 9 starts the "&lt;" instruction, but it is another no-op. It seems that i2
and i3 passed into this routine are the two tape pointers used in this loop
already calculated. Also deduced is that p1 is the tape array. It's not clear
what p0 is.</p>
<p>Lines 10 through 13 perform the "-" operation: get the array value (line 11),
subtract (line 12) and set the array value (line 13).</p>
<p>Next, on line 14, we come to the "]" operation. Lines 15 and 16 check whether
i9 is true (non-zero). Looking up, i9 is the array value that we just
decremented and stored, now being checked as the loop condition, as expected
(remember the definition of "]").  Line 16 is a guard, if the condition is not
met, execution jumps somewhere else, in this case to the routine called
&lt;Guard2&gt; and is passed one parameter: p0.</p>
<p>Assuming we pass the guard, lines 17 through 23 are doing the dictionary lookup
to bracket_map to find where the program counter should jump to.  I'm not too
familiar with what the instructions are actually doing, but it looks like there
are two external calls and 3 guards. This seems quite expensive, especially
since we know bracket_map will never change (PyPy doesn't know that).  We'll
see below how to optimize this.</p>
<p>Line 24 increments the newly acquired instruction pointer. Lines 25 and 26 make
sure it's less than the program's length.</p>
<p>Additionally, line 27 guards that i21, the incremented instruction pointer, is
exactly 86. This is because it's about to jump to the beginning (line 29) and
the instruction pointer being 86 is a precondition to this block.</p>
<p>Finally, the loop closes up at line 28 so the JIT can jump to loop body &lt;Loop0&gt;
to handle that case (line 29), which is the beginning of the loop again. It
passes in parameters (p0, p1, i2, i3).</p>
</div>
<div class="section" id="optimizing">
<h2>Optimizing<a href="#optimizing" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>As mentioned, every loop iteration does a dictionary lookup to find the
corresponding matching bracket for the final jump. This is terribly
inefficient, the jump target is not going to change from one loop to the next.
This information is constant and should be compiled in as such.</p>
<p>The problem is that the lookups are coming from a dictionary, and PyPy is
treating it as opaque. It doesn't know the dictionary isn't being modified or
isn't going to return something different on each query.</p>
<p>What we need to do is provide another hint to the translation to say that the
dictionary query is a pure function, that is, its output depends <em>only</em> on its
inputs and the same inputs should always return the same output.</p>
<p>To do this, we use a provided function decorator pypy.rlib.jit.purefunction,
and wrap the dictionary call in a decorated function:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;"><span style="color: #9999FF;">@purefunction</span>
<span style="color: #006699; font-weight: bold;">def</span> <span style="color: #CC00FF;">get_matching_bracket</span>(bracket_map, pc):
    <span style="color: #006699; font-weight: bold;">return</span> bracket_map[pc]
</pre></div>
<p>This version can be found at <a class="reference external" href="https://bitbucket.org/brownan/pypy-tutorial/src/tip/example5.py">example5.py</a></p>
<p>Translate again with the JIT option and observe the speedup. Mandelbrot now
only takes 6 seconds!  (from 12 seconds before this optimization)</p>
<p>Let's take a look at the trace from the same function:</p>
<div class="highlight" style="background: #f0f3f3;"><pre style="line-height: 125%;">[<span style="color: #FF6600;">3</span>c29fad7b792b0] {jit<span style="color: #555555;">-</span>log<span style="color: #555555;">-</span>opt<span style="color: #555555;">-</span>loop
<span style="color: #0099FF; font-style: italic;"># Loop 0 : loop with 15 ops</span>
[p0, p1, i2, i3]
debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[_&gt;_+&lt;-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;_+_&lt;-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
i4 <span style="color: #555555;">=</span> getarrayitem_gc(p1, i2, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
i6 <span style="color: #555555;">=</span> int_add(i4, <span style="color: #FF6600;">1</span>)
setarrayitem_gc(p1, i2, i6, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;+_&lt;_-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;+&lt;_-_]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
i7 <span style="color: #555555;">=</span> getarrayitem_gc(p1, i3, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
i9 <span style="color: #555555;">=</span> int_sub(i7, <span style="color: #FF6600;">1</span>)
setarrayitem_gc(p1, i3, i9, descr<span style="color: #555555;">=&lt;</span>SignedArrayDescr<span style="color: #555555;">&gt;</span>)
debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[&gt;+&lt;-_]_&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
i10 <span style="color: #555555;">=</span> int_is_true(i9)
guard_true(i10, descr<span style="color: #555555;">=&lt;</span>Guard2<span style="color: #555555;">&gt;</span>) [p0]
debug_merge_point(<span style="color: #CC3300;">'+&lt;[&gt;[_&gt;_+&lt;-]&gt;.[&lt;+&gt;-]&lt;&lt;-]++++++++++.'</span>, <span style="color: #FF6600;">0</span>)
jump(p0, p1, i2, i3, descr<span style="color: #555555;">=&lt;</span>Loop0<span style="color: #555555;">&gt;</span>)
[<span style="color: #FF6600;">3</span>c29fad7ba32ec] jit<span style="color: #555555;">-</span>log<span style="color: #555555;">-</span>opt<span style="color: #555555;">-</span>loop}
</pre></div>
<p>Much better! Each loop iteration is an add, a subtract, two array loads, two
array stores, and a guard on the exit condition. That's it! This code doesn't
require <em>any</em> program counter manipulation.</p>
<p>I'm no expert on optimizations, this tip was suggested by Armin Rigo on the
pypy-dev list. Carl Friedrich has a series of posts on how to optimize your
interpreter that are also very useful: <a class="reference external" href="https://bit.ly/bundles/cfbolz/1">https://bit.ly/bundles/cfbolz/1</a></p>
</div>
<div class="section" id="final-words">
<h2>Final Words<a href="#final-words" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>I hope this has shown some of you what PyPy is all about other than a faster
implementation of Python.</p>
<p>For those that would like to know more about how the process works, there are
several academic papers explaining the process in detail that I recommend. In
particular: Tracing the Meta-Level: PyPy's Tracing JIT Compiler.</p>
<p>See <a class="reference external" href="https://readthedocs.org/docs/pypy/en/latest/extradoc.html">https://readthedocs.org/docs/pypy/en/latest/extradoc.html</a></p>
</div>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="tutorial-writing-interpreter-with-pypy-3785910476193156295.html" rel="prev" title="Tutorial: Writing an Interpreter with PyPy, Part 1">Previous post</a>
            </li>
            <li class="next">
                <a href="using-tkinter-and-idle-with-pypy-6156563216925585965.html" rel="next" title="Using Tkinter and IDLE with PyPy">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-6085380460859434897">
        <div class="comment-header">
          <a name="comment-6085380460859434897"></a>
            <span class="author">Winston Ewert</span> wrote on <span class="date">2011-04-06 21:59</span>:
        </div>
        <div class="comment-content">
          <p>Some interpreters are written to evaluate directly from the AST. i.e. they never generate bytecode, instead each node in the ast simply has the code to execute it as a "virtual" function. Could PyPy JIT such an interpreter? Or does it essentially assume a bytecode based interpreter?</p>
        </div>
      </div>
      <div class="comment comment-1902484944946012766">
        <div class="comment-header">
          <a name="comment-1902484944946012766"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-04-07 05:56</span>:
        </div>
        <div class="comment-content">
          <p>In theory it should be able to, if it's written in RPython. Perhaps it would be harder to place the hints for the jit engine?<br><br>As far as I understand it, it still traces some kind of bytecode (generated from the RPython code), but uses the can_enter_jit hints to determine what to trace and the length of a trace.<br><br>If it'll be fast is another question though. Why not give it a try? (E.g. one could implement the LLVM kaleidoscope language in RPython.)</p>
        </div>
      </div>
      <div class="comment comment-8500050776770522416">
        <div class="comment-header">
          <a name="comment-8500050776770522416"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-04-07 06:05</span>:
        </div>
        <div class="comment-content">
          <p>@Winston in theory nothing prevents JIT from working on AST-based interpreters. In practice however, it would require a bit of engineering to convince the JIT that the green (constant) argument is a complex object structure. That's however just engineering</p>
        </div>
      </div>
      <div class="comment comment-5452355239319367469">
        <div class="comment-header">
          <a name="comment-5452355239319367469"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2011-04-07 09:24</span>:
        </div>
        <div class="comment-content">
          <p>It's actually not a problem at all to have an AST-based interpreter. In fact, the Prolog uses "ASTs" (Prolog is homoiconic, so the ASTs are just Prologs normal data structures).<br><br>Maciej: that's not a problem if your ASTs are actually immutable. If they aren't you have a problem which indeed requires some engineering.</p>
        </div>
      </div>
      <div class="comment comment-6194582595663977823">
        <div class="comment-header">
          <a name="comment-6194582595663977823"></a>
            <span class="author">Quiz</span> wrote on <span class="date">2011-04-07 10:45</span>:
        </div>
        <div class="comment-content">
          <p>The effect of the loop "[&gt;+&lt;-]" is <br><br>tape[position+1] += tape[position]<br>tape[position] = 0<br><br>We saw that PyPy can optimize the program counter away in this loop--but this loop could be executed in constant time. Will PyPy ever be able to optimize it to that degree?</p>
        </div>
      </div>
      <div class="comment comment-4017602435873791161">
        <div class="comment-header">
          <a name="comment-4017602435873791161"></a>
            <span class="author">Winston Ewert</span> wrote on <span class="date">2011-04-10 01:53</span>:
        </div>
        <div class="comment-content">
          <p>Well, you finally motivated me to give it a try. I optimized the BF example and managed to get some pretty nice speed boosts all without dipping into the low level (aside from reading the log)</p>
        </div>
      </div>
      <div class="comment comment-4240220600091975575">
        <div class="comment-header">
          <a name="comment-4240220600091975575"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-04-13 09:50</span>:
        </div>
        <div class="comment-content">
          <p>Great article, man! Many thanks and keep on rocking!</p>
        </div>
      </div>
      <div class="comment comment-2274397798855994473">
        <div class="comment-header">
          <a name="comment-2274397798855994473"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-08-07 08:47</span>:
        </div>
        <div class="comment-content">
          <p>Great tutorial, but where can I find the 'test.b' file (mentioned for the tracing JIT) for a try?</p>
        </div>
      </div>
      <div class="comment comment-5488699696338796997">
        <div class="comment-header">
          <a name="comment-5488699696338796997"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2012-11-22 10:50</span>:
        </div>
        <div class="comment-content">
          <p>hi guys.  can jit merge points not be put inside methods?  Going off example3.py, if I take the body of the while loop and move it into a method of the Tape class (along with the jitdriver), all the speed gains go away.  can anyone explain why this happens?  Thanks!</p>
        </div>
      </div>
      <div class="comment comment-4631403739625499910">
        <div class="comment-header">
          <a name="comment-4631403739625499910"></a>
            <span class="author">Sarah Mount</span> wrote on <span class="date">2016-07-30 23:12</span>:
        </div>
        <div class="comment-content">
          <p>BTW the link to https://bit.ly/bundles/cfbolz/1 has bit-rotted.</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>