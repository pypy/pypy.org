<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Numpy in PyPy - status and roadmap | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2011/05/numpy-in-pypy-status-and-roadmap-8332894230779779992.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Maciej Fijalkowski">
<link rel="prev" href="../04/pypy-15-released-catching-up-302997959079576809.html" title="PyPy 1.5 Released: Catching Up" type="text/html">
<link rel="next" href="numpy-follow-up-6928627691060102514.html" title="NumPy Follow up" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Numpy in PyPy - status and roadmap">
<meta property="og:url" content="https://www.pypy.org/posts/2011/05/numpy-in-pypy-status-and-roadmap-8332894230779779992.html">
<meta property="og:description" content="Hello.
NumPy integration is one of the single most requested features for PyPy. This
post tries to describe where we are, what we plan (or what we don't plan), and
how you can help.
Short version for ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2011-05-04T17:04:00Z">
<meta property="article:tag" content="numpy">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Numpy in PyPy - status and roadmap</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/maciej-fijalkowski.html">Maciej Fijalkowski</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2011-05-04T17:04:00Z" itemprop="datePublished" title="2011-05-04 17:04">2011-05-04 17:04</time></a>
            </p>
                <p class="commentline">41 comments</p>

                <p class="commentline">            <a href="numpy-in-pypy-status-and-roadmap-8332894230779779992.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>Hello.</p>
<p>NumPy integration is one of the single most requested features for PyPy. This
post tries to describe where we are, what we plan (or what we don't plan), and
how you can help.</p>
<p><strong>Short version for the impatient: we are doing experiments, which show that
PyPy+numpy can be faster and better than CPython+numpy.  We have a plan on how
to move forward, but at the moment there is lack of dedicated people or money
to tackle it.</strong></p>
<div class="section" id="the-longer-version">
<h3>The slightly longer version<a href="#the-longer-version" class="headerlink" title="Permalink to this heading">¶</a></h3>
<p>Integrating numpy in PyPy has been my pet project on an on-and-off (mostly off)
basis over the past two years. There were <a class="reference external" href="../../2009/07/pypy-numeric-experiments-2221073696038673235.html">some experiments</a>, then a long
pause, and then some more experiments which are documented below.</p>
<p>The general idea is <strong>not</strong> to use the existing CPython module, but to
reimplement numpy in RPython (i.e. the language PyPy is implemented in), thus
letting our JIT achieve extra speedups. The really cool thing about this part
is that numpy will automatically benefit of any general JIT improvements,
without any need of extra tweaking.</p>
<p>At the moment, there is branch called <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/numpy-exp/">numpy-exp</a> which contains a
translatable version of a very minimal version of numpy in the module called
<tt class="docutils literal">micronumpy</tt>. <a class="reference external" href="https://foss.heptapod.net/pypy/pypy/-/tree/branch/numpy-exp/pypy/module/micronumpy/bench/">Example benchmarks</a> show the following:</p>
<table border="1" class="docutils">
<colgroup>
<col width="53%">
<col width="25%">
<col width="22%">
</colgroup>
<tbody valign="top">
<tr>
<td> </td>
<td>add</td>
<td>iterate</td>
</tr>
<tr>
<td>CPython 2.6.5 with numpy 1.3.0</td>
<td>0.260s (1x)</td>
<td>4.2 (1x)</td>
</tr>
<tr>
<td>PyPy numpy-exp @ 3a9d77b789e1</td>
<td>0.120s (2.2x)</td>
<td>0.087 (48x)</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal">add</tt> benchmark spends most of the time inside the <tt class="docutils literal">+</tt> operator on
arrays (doing <tt class="docutils literal">a + a + a + a + a</tt>), , which in CPython is implemented in C.
As you can see from the table above, the PyPy version is already ~2 times
faster. (Although <a class="reference external" href="https://code.google.com/p/numexpr/">numexpr</a> is still faster than PyPy, but we're working on it).</p>
<p>The exact way array addition is implemented is worth another blog post, but in
short it lazily evaluates the expression and computes it at the end, avoiding
intermediate results. This approach scales much better than numexpr
and can lead to speeding up all the operations that you can perform on matrices.</p>
<p>The next obvious step to get even more speedups would be to extend the JIT to
use SSE operations on x86 CPUs, which should speed it up by about additional
2x, as well as using multiple threads to do operations.</p>
<p><tt class="docutils literal">iterate</tt> is also interesting, but for entirely different reasons. On CPython
it spends most of the time inside a Python loop; the PyPy version is ~48 times
faster, because the JIT can optimize across the python/numpy boundary, showing
the potential of this approach, users are not grossly penalized for writing
their loops in Python.</p>
<p>The drawback of this approach is that we need to reimplement numpy in RPython,
which takes time.  A very rough estimate is that it would be possible to
implement an useful subset of it (for some definition of useful) in a period
of time comprised between one and three man-months.</p>
<p>It also seems that the result will be faster for most cases and the same speed
as original numpy for other cases. The only problem is finding the dedicated
persons willing to spend quite some time on this and however, I am willing to
both mentor such a person and encourage him or her.</p>
<p>The good starting point for helping would be to look at what's already
implemented in micronumpy modules and try extending it. Adding a <cite>-</cite> operator
or adding integers would be an interesting start. Drop by on #pypy on
irc.freenode.net or get in contact with developers via some other channel (such
as the pypy-dev mailing list) if you want to help.</p>
<p>Another option would be to sponsor NumPy development. In case you're
interested, please get in touch with us or leave your email in comments.</p>
<p>Cheers,<br>
fijal</p>
</div>
      </div>
      <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/numpy.html" rel="tag">numpy</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../04/pypy-15-released-catching-up-302997959079576809.html" rel="prev" title="PyPy 1.5 Released: Catching Up">Previous post</a>
            </li>
            <li class="next">
                <a href="numpy-follow-up-6928627691060102514.html" rel="next" title="NumPy Follow up">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-9056975848487561351">
        <div class="comment-header">
          <a name="comment-9056975848487561351"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2011-05-04 17:30</span>:
        </div>
        <div class="comment-content">
          <p>While the RPython approach does sound valuable long-term, do you know if anyone has experimented with cpyext and the CPython extension module as a near-term alternative?</p>
        </div>
      </div>
      <div class="comment comment-699878451885874216">
        <div class="comment-header">
          <a name="comment-699878451885874216"></a>
            <span class="author">matt harrison</span> wrote on <span class="date">2011-05-04 17:30</span>:
        </div>
        <div class="comment-content">
          <p>Great post. (I'm another person who would like numpy on pypy).<br>What are the guidelines for when something should be implemented in RPython? For me personally there are a few instances I would trade some of the dynamicism of Python for speed in my own code.</p>
        </div>
      </div>
      <div class="comment comment-9140869541816362581">
        <div class="comment-header">
          <a name="comment-9140869541816362581"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-04 17:35</span>:
        </div>
        <div class="comment-content">
          <p>@Nick the mixed approach (use cpyext and pieces in RPython) sounds maybe valuable short term, but it can burn people easily. RPython-only is way more elegant and gives you wins upfront. Since there is noone willing to invest time in short term approach, this sounds like a no-brainer.<br><br>@matt almost nothing should be implemented in RPython, except the interpreter itself. Writing Python should be fast enough. Numpy is a notable example where we want to leverage last bits and pieces of JIT and be really really fast. For example you can't really leverage SSE from Python layer.</p>
        </div>
      </div>
      <div class="comment comment-6078143734070117874">
        <div class="comment-header">
          <a name="comment-6078143734070117874"></a>
            <span class="author">Davide</span> wrote on <span class="date">2011-05-04 18:12</span>:
        </div>
        <div class="comment-content">
          <p>Are you in touch with Numpy developers? Are they eager to "stop" using Python and move to RPython? I mean, if this work needs to be redone for each version of Numpy, we will be always lagging behind, and always spend lot of efforts. On the other hand, if Numpy devs will start using the RPython for and let die the pure-Python one, then, the porting effort would me much more meaningful, and I believe it will be easier to find a group of people interested in doing it (myself, maybe)</p>
        </div>
      </div>
      <div class="comment comment-3624033370253490620">
        <div class="comment-header">
          <a name="comment-3624033370253490620"></a>
            <span class="author">Davide</span> wrote on <span class="date">2011-05-04 18:13</span>:
        </div>
        <div class="comment-content">
          <p>And what about SciPy?</p>
        </div>
      </div>
      <div class="comment comment-589843590338335994">
        <div class="comment-header">
          <a name="comment-589843590338335994"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-04 18:15</span>:
        </div>
        <div class="comment-content">
          <p>I've got to say that this worries me more than it encourages me.<br><br>1) It doesn't sound like this path will lead to easier integration of scipy. If I'm wrong please let me know! But if I'm right, the reality is that most of the reason I care about numpy is because scipy depends on it, and I care about scipy.<br><br>2) What about the numpy refactoring effort, which is supposed to be making a better C interface for numpy, which works with IronPython as well as CPython (https://lists.ironpython.com/pipermail/users-ironpython.com/2010-December/014059.html)? Why not just encourage that effort, and leverage it for PyPy integration? Is there a reason it won't work for numpy even though it works for both IronPython and CPython? (</p>
        </div>
      </div>
      <div class="comment comment-6887645392084744330">
        <div class="comment-header">
          <a name="comment-6887645392084744330"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-04 18:27</span>:
        </div>
        <div class="comment-content">
          <p>@Davide it's not Python vs RPython, it's C (which numpy is implemented in) vs RPython. No numpy users will be requires to use RPython for anything.<br><br>@Gary I believe you're wrong. The idea stays the same - you can call arbitrary C code that will manipulate raw memory and do what it wants to do. The idea is to implement only the interface part (which uses CPython C API) and not the C part, which will work anyway. So at the end, we hope to leverage that effort. Also we're not microsoft and we can't pay large sums of money to do it and having small subset of numpy that's really fast appeals much more to me than a large effort that only gives numpy for pypy (that's not faster than cpython's one).</p>
        </div>
      </div>
      <div class="comment comment-8031929221130276180">
        <div class="comment-header">
          <a name="comment-8031929221130276180"></a>
            <span class="author">Davide</span> wrote on <span class="date">2011-05-04 19:12</span>:
        </div>
        <div class="comment-content">
          <p>@Maciej: It was clear to me that numpy users shouldn't change anything, but I thought you intended to change only the Python part of Numpy, not the C part. <br><br>Now, if you plan to change the whole C sections, that's a huge job. What are your plans for dependencies like  the BLAS, LAPACK and the likes? Would you reimplement them in RPython as well?<br><br>And regardless of the answer, my question is still valid: do you see this project as a "catch-up porting" of Numpy, with the version for CPython going on by itself? Or do you see the RPython fork becoming the mainstream Numpy? And if it's the latter, how that would perform on CPython? I think these questions are the key of the matter.</p>
        </div>
      </div>
      <div class="comment comment-3499269873134208179">
        <div class="comment-header">
          <a name="comment-3499269873134208179"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-04 19:18</span>:
        </div>
        <div class="comment-content">
          <p>see my reply above about BLAS/LAPACK etc. Regarding the C part, it's a big task, but I think not too big. Also it's relatively easy to come up with working piece that's not full, nontheless useful.<br><br>This won't work on CPython, period.</p>
        </div>
      </div>
      <div class="comment comment-9161103187966752212">
        <div class="comment-header">
          <a name="comment-9161103187966752212"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-04 19:25</span>:
        </div>
        <div class="comment-content">
          <p>@Maciej -- sorry if I'm being dense, but are you saying that the approach you're outlining will allow for scipy to work with numpy?</p>
        </div>
      </div>
      <div class="comment comment-1429781699895470733">
        <div class="comment-header">
          <a name="comment-1429781699895470733"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-04 19:29</span>:
        </div>
        <div class="comment-content">
          <p>@Gary an uneducated guess would be "yes". Probably with some work and scipy refactoring.</p>
        </div>
      </div>
      <div class="comment comment-2134789461597939594">
        <div class="comment-header">
          <a name="comment-2134789461597939594"></a>
            <span class="author">cool-RR</span> wrote on <span class="date">2011-05-04 19:34</span>:
        </div>
        <div class="comment-content">
          <p>Thanks for writing this post Maciej! It's great to have some visibility on your plans about this issue.</p>
        </div>
      </div>
      <div class="comment comment-4852756270232197481">
        <div class="comment-header">
          <a name="comment-4852756270232197481"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-04 19:47</span>:
        </div>
        <div class="comment-content">
          <p>OK. As I've argued before in various pypy groups, I think one of the groups that will most strongly benefit from pypy's speed is the scientific community -- but they need numpy and scipy. So now that I know that this plan will (hopefully) allow for both of those to be used from pypy, I'm encouraged by it.</p>
        </div>
      </div>
      <div class="comment comment-1655110803084557894">
        <div class="comment-header">
          <a name="comment-1655110803084557894"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-04 19:49</span>:
        </div>
        <div class="comment-content">
          <p>@Maciej: The parts of Scipy written in Python are for the most part not large. The main work would be in reimplementing the C code that uses Numpy's C-API, and figuring out a way to interface with Fortran code.</p>
        </div>
      </div>
      <div class="comment comment-6736832127986887682">
        <div class="comment-header">
          <a name="comment-6736832127986887682"></a>
            <span class="author">Joseph</span> wrote on <span class="date">2011-05-04 20:21</span>:
        </div>
        <div class="comment-content">
          <p>You say you lack sufficient resources to put in a large effort, but your answers to CPython extensions is "reimplement everything RPython".  Would it not make more sense to improve cpyext so that you get good performance out of it (maybe even JIT compatible)?  This seems like a better answer then re-writing every single CPython extension and trying to keep the RPython implementation in sync.</p>
        </div>
      </div>
      <div class="comment comment-747028980015142463">
        <div class="comment-header">
          <a name="comment-747028980015142463"></a>
            <span class="author">Peter Cock</span> wrote on <span class="date">2011-05-04 20:33</span>:
        </div>
        <div class="comment-content">
          <p>Have you tried micronumpy under Jython? I'm assuming RPython, being just a subset of Python, should also work there, and might double as a way to get (some of) NumPy on Jython.</p>
        </div>
      </div>
      <div class="comment comment-122183432660524903">
        <div class="comment-header">
          <a name="comment-122183432660524903"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-04 20:34</span>:
        </div>
        <div class="comment-content">
          <p>@Joseph cpyext will always be only a semi-permanent compatibility layer. Making numpy work with cpyext is both unrewarding (hard work with obscure bugs), but also significantly harder to make fast, in some places completely impossible. Yes, it doesn't make sense for all extensions, it doesn't even make sense for most. Numpy is however special, since speed is the reason of it's existence. Also, frankly, when it comes down to my free time "let's make this cool JITed code run 50x faster than CPython" beats "let's stare puzzled at this segfault".</p>
        </div>
      </div>
      <div class="comment comment-1974210686499739537">
        <div class="comment-header">
          <a name="comment-1974210686499739537"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-04 20:35</span>:
        </div>
        <div class="comment-content">
          <p>@Joseph anyway, it's exactly for the same reason "why write another interpreter if you can just improve CPython". Because it's easier at the end.</p>
        </div>
      </div>
      <div class="comment comment-4295932918866258069">
        <div class="comment-header">
          <a name="comment-4295932918866258069"></a>
            <span class="author">Corbin Simpson</span> wrote on <span class="date">2011-05-04 21:45</span>:
        </div>
        <div class="comment-content">
          <p>To everybody asking why we cannot just use cpyext: I already tried it. It's not gonna happen without hacking the crap out of numpy. Additionally, it's going to be slow: Numpy is not fast for most operations, because of double-unboxing. Only vector ops are fast. JITing the operations is going to be a big win.<br><br>For those of you not believing numpy is slow, look at numexpr (https://code.google.com/p/numexpr/) which implements many of the same ideas that we are planning on implementing.</p>
        </div>
      </div>
      <div class="comment comment-927489968304976130">
        <div class="comment-header">
          <a name="comment-927489968304976130"></a>
            <span class="author">Jonas B.</span> wrote on <span class="date">2011-05-04 21:45</span>:
        </div>
        <div class="comment-content">
          <p>Extremely exciting! Perhaps this is a good time to document the internals of NumPy a bit better while your scour the source to reimplement in RPython.<br><br>Perhaps this is a good fit for a Kickstarter (or similar) project? I believe this requires very talented and dedicated developers and paying the professionally by raising money on the Internet should be possible. It's been done before.</p>
        </div>
      </div>
      <div class="comment comment-5858151857643088722">
        <div class="comment-header">
          <a name="comment-5858151857643088722"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-04 22:58</span>:
        </div>
        <div class="comment-content">
          <p>Yes, having a couple of Kickstarter projects for PyPy would be nice. It seems the current view is "we'll wait for someone wanting a feature enough to fund it". Picking one or two known valuable features to put on Kickstarter would provide for a nice test: can you raise more money by asking for it in a targeted way?</p>
        </div>
      </div>
      <div class="comment comment-7996340174067405828">
        <div class="comment-header">
          <a name="comment-7996340174067405828"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-05 01:23</span>:
        </div>
        <div class="comment-content">
          <p>Two comments: <br><br>One, you guys need to make up your minds with respect to how people are supposed to interface C code with PyPy, and make one well-supported way. The sooner, the better.<br><br>Two, as long as your numpy clone implements the (new-style) Python array interface, it should "just work" with Scipy, with everything else being a Scipy bug. (Correct me if I'm wrong.)<br><br>Andreas</p>
        </div>
      </div>
      <div class="comment comment-7856571393061690648">
        <div class="comment-header">
          <a name="comment-7856571393061690648"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-05-05 01:58</span>:
        </div>
        <div class="comment-content">
          <p>Doesn't getting SciPy to work involve interfacing with a lot of Fortran code?</p>
        </div>
      </div>
      <div class="comment comment-3523410906178854946">
        <div class="comment-header">
          <a name="comment-3523410906178854946"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2011-05-05 04:47</span>:
        </div>
        <div class="comment-content">
          <p>To address some of the criticism you're receiving, it may be worth making another post clarifying the points made in the comments and elsewhere:<br><br>- numpy+cpyext has been tried and found wanting (and very hard to debug)<br>- no developers available that are interested in beating their heads against that particular wall<br>- pure C and Python components of numpy should remain largely the same<br>- only the Python bindings layer that uses the CPython C API needs to be reimplemented<br>- RPython has its own FFI which is PyPy's preferred way to interface to non-Python code (https://pypy.readthedocs.org/en/latest/rffi.html)<br>- cpyext is a useful tool for compatibility with relatively simple C extensions that don't stress the C API greatly, but numpy is not such an extension.</p>
        </div>
      </div>
      <div class="comment comment-6209779911657565885">
        <div class="comment-header">
          <a name="comment-6209779911657565885"></a>
            <span class="author">david</span> wrote on <span class="date">2011-05-05 09:42</span>:
        </div>
        <div class="comment-content">
          <p>Hi maciej, I am david (we quickly met at pycon where I presented myself as a numpy guy).<br><br>I think part of the misunderstanding is around the meaning of "numpy in pypy". Rewriting an array class on top of pypy is certainly valuable, and I am in no position to tell other people what to do in their free time. But I don't think it can realistically mean people will be able to use this instead of numpy after 2-3 man months: how will interfacing with BLAS/LAPACK work ? How will interfacing with the vast amount of fortran code in scipy work ?<br><br>If cpyext is indeed a dead-end, it would valuable to know why. Personally, I would certainly be happy to fix parts of numpy that makes cpyext impractically, even if it meant it were twice slower than on cpython. Because I could still benefit from pypy *elsewhere*, without having to rewrite all the numpy/scipy/etc... code.</p>
        </div>
      </div>
      <div class="comment comment-7429330112381871796">
        <div class="comment-header">
          <a name="comment-7429330112381871796"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-05-05 09:53</span>:
        </div>
        <div class="comment-content">
          <p>@david please look above at my responses. there will still be a piece of memory you can pass to LAPACK or BLAS or something. the RPython part is about the interface only and not C-only part. If you want to improve numpy, please separate C-only parts from interface parts as much as possible, using C from RPython is a no-brainer.</p>
        </div>
      </div>
      <div class="comment comment-6666222417147385549">
        <div class="comment-header">
          <a name="comment-6666222417147385549"></a>
            <span class="author">Dániel Varga</span> wrote on <span class="date">2011-05-05 10:34</span>:
        </div>
        <div class="comment-content">
          <p>Maciej, let me second Nick's polite request for a more detailed post about the plan.<br><br>If even David, an actual numpy developer can misunderstand your description, what do you expect from the unwashed masses of scipy users like me? :) Fortunately it does not take too much effort to alleviate the worries. All you have to do is explain to everyone that the plan takes into account the giant amount of C and Fortran code in numpy/scipy, and takes into account the fact that forking numpy/scipy is infeasible.</p>
        </div>
      </div>
      <div class="comment comment-3887595756602312846">
        <div class="comment-header">
          <a name="comment-3887595756602312846"></a>
            <span class="author">Bluebird</span> wrote on <span class="date">2011-05-05 11:49</span>:
        </div>
        <div class="comment-content">
          <p>Didn't you say in another post that the JIT is more efficient at optimizing Python code than RPython ?</p>
        </div>
      </div>
      <div class="comment comment-523419541167745548">
        <div class="comment-header">
          <a name="comment-523419541167745548"></a>
            <span class="author">cournape</span> wrote on <span class="date">2011-05-05 12:17</span>:
        </div>
        <div class="comment-content">
          <p>@daniel: I don't think there is a misunderstanding as much as a different people wanting different things. I believe that Maciej and other pypy people are more interested in leveraging pypy and its JIT do to things which are indeed quite complicated in numpy today (avoid temporary, fast  iterators in python, etc...). I have little doubt that pypy is a better platform than cpython to experiment this kind of things.<br><br>I am more surprised about the claim that numpy is so tight to cpyhon internals. It certainly depends on the C API, but mostly public API, documented as such.</p>
        </div>
      </div>
      <div class="comment comment-794885362234099588">
        <div class="comment-header">
          <a name="comment-794885362234099588"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2011-05-05 12:45</span>:
        </div>
        <div class="comment-content">
          <p>@nick: thank you very much for giving all relevant pieces of information that are missing from the original post!</p>
        </div>
      </div>
      <div class="comment comment-3232894066846469423">
        <div class="comment-header">
          <a name="comment-3232894066846469423"></a>
            <span class="author">glyph</span> wrote on <span class="date">2011-05-05 19:32</span>:
        </div>
        <div class="comment-content">
          <p>Hey Maciej!  This sounds absolutely awesome.  I hope you can find someone to do the necessary work.  I think you might need to explain a little better in a separate post where that 48x speedup comes from, and why RPython is a necessary part of it.  I <i>think</i> I understand why, but clearly some of the commenters don't :).</p>
        </div>
      </div>
      <div class="comment comment-2341935567828828932">
        <div class="comment-header">
          <a name="comment-2341935567828828932"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-06-21 22:50</span>:
        </div>
        <div class="comment-content">
          <p>Well, if the answer of "How to make numpy available in pypy" is "do a complicated rewrite of numpy," then I'm pretty skeptical about the pypy project. I primarily use numpy, but also scipy sometimes and Image sometimes. As a user it's most important to me that code runs. Speed is not as critical. For example if I take stddev() of an array I first want that to run, and only secondarily want it efficient. If there's a library that I might want to use, and I can't expend a reasonable amount of effort to wrap it, or else someone else can do that, then I don't find pypy that encouraging at all. Since there are lots of libraries out there, and it has been convincingly argued that Python's primary utility is its library support.</p>
        </div>
      </div>
      <div class="comment comment-1220489740614067231">
        <div class="comment-header">
          <a name="comment-1220489740614067231"></a>
            <span class="author">Alex</span> wrote on <span class="date">2011-06-21 22:56</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous: While you may not be concerned with performance, a great many people are.  The only way to have arbitrary numpy stuff work in theory would be CPyExt, but as we've said that's frought with complications in that a) it won't work out of the box on something that uses as many corners of the CPython C-API as NumPy, and b) will always be slow.  Given people's desire for speed with respect to NumPy we consider reimplementing it a reasonable course.</p>
        </div>
      </div>
      <div class="comment comment-2628687017680674584">
        <div class="comment-header">
          <a name="comment-2628687017680674584"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-06-22 00:33</span>:
        </div>
        <div class="comment-content">
          <p>Alex -- I'm not saying speed is unimportant. What I'm saying is being able to easily make existing CPython extension modules compile against numpy is very important to people. If there is a 20% slowdown or a 10% speedup of the C extension in many cases that is no big deal. Most importantly it would put PyPy on rather equal standing with CPython. And then the JIT pure Python code might win out for efficiency, so PyPy might be a net win for many users.<br><br>On the other hand doing research into lazy evaluation and vectorizing and loop restructuring, can obviously make numpy faster, but is more of a tangent, than being helpful to the majority of users who just want to run their CPython extensions at roughly the same speed under PyPy. Until people can actually run their extensions easily (which I argue is the major value that Python has) I doubt there will be much adoption of PyPy.<br><br>Say I can already add lists of floats and take their standard deviation using numpy, using the C extension library. It isn't clear to me why this should be substantially less efficient under PyPy than under CPython.<br><br>We see the same issue with Python 3.0 adoption. Personally I think it makes bad language changes such as getting rid of string % operator which I use constantly, so I'd avoid it for that reason. But far more importantly it can't run a lot of the libraries I use, with comparable performance. So it's completely a no go to me for that reason.<br><br>So I am suggesting that optimizing a single library by rewriting it, seems a case of premature optimization when most libraries can't even run with PyPy.</p>
        </div>
      </div>
      <div class="comment comment-1022234359494186624">
        <div class="comment-header">
          <a name="comment-1022234359494186624"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-06-22 07:36</span>:
        </div>
        <div class="comment-content">
          <p>It's a tough call, but for me most libraries run under PyPy. There are few that don't but I can usually work around that. Regarding numpy - noone wants slower numpy *no matter what*. Besides, it's not clear whether making numpy behave using CPyext would take less effort than writing it from scratch - the first reasonable subset can be expected *much* faster, when doing a rewrite.<br><br>Numpy really *is* special, for all my needs, I want a small subset that performs reasonably well, not a whole thing that performs poorly. It's a matter of taste, but it's also much more fun, which plays a lot in terms of people spending free time on it. Would you rather add functionality for X that you need or fix next obscure segfault?<br><br>Cheers,<br>fijal</p>
        </div>
      </div>
      <div class="comment comment-2151221303214453177">
        <div class="comment-header">
          <a name="comment-2151221303214453177"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-06-22 10:14</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous Clarifying: We're hoping to reuse most parts of numpy (and scipy), especially those written in pure C. The "only" part requiring rewriting is the part that uses CPython C API, which is mostly the array interface.</p>
        </div>
      </div>
      <div class="comment comment-7872819680191736730">
        <div class="comment-header">
          <a name="comment-7872819680191736730"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2011-06-23 04:23</span>:
        </div>
        <div class="comment-content">
          <p>Maciej -- I didn't realize large parts of these libraries could be reused. So maybe once the PyPy C extension facilities are working well enough that important 3rd party libraries can be compiled, I'll just switch to PyPy for performance. It sure does sound more fun to make numpy functions compile down to heavily optimized RPython and get big speed gains. But I still maintain that users would appreciate being able to get all arbitrary libraries to build in the first place, e.g. if scipy or library X depends on the numpy C interface, and that gets broken in the PyPy numpy implementation, then users won't be able to use their desired library at all. So I guess I'm just arguing that the most C extension modules that can work with numpy, the better. Since if we wanted fast but no libraries we'd be using C :-).</p>
        </div>
      </div>
      <div class="comment comment-1021785887355477972">
        <div class="comment-header">
          <a name="comment-1021785887355477972"></a>
            <span class="author">Davide</span> wrote on <span class="date">2011-06-23 16:19</span>:
        </div>
        <div class="comment-content">
          <p>Maciej (et all),<br>it looks like this issue isn't clear yet to people. Let's see if I can help.<br><br>Numpy is made of 3 "piece" (doesn't matter if they are separate pieces or mingled together, they are there): a pure python part, a pure C part and a C-to-python "glue". All of them are very important to numpy, but the C-to-python glue is special, in that both python and C need to access the same data structures without any conversion or copy (otherwise it will be slow). I'm not sure what exactly numpy is doing for this "special glue" part, but that's the point where pypy suffer: of course pypy works just fine with pure python, and doesn't "care" at all about the C sections. So one option is to rewrite the C-to-python pieces of numpy. I'm sorry but it's still unclear to me if you want also to rewrite the C part or not (here you said kind-of-yes: https://morepypy.blogspot.com/2011/05/numpy-in-pypy-status-and-roadmap.html?showComment=1304533136864#c3499269873134208179 and here you said no: https://morepypy.blogspot.com/2011/05/numpy-in-pypy-status-and-roadmap.html?showComment=1308734098907#c2151221303214453177 so probably you should clarify better)<br><br>Now, if I understand it right, your plan is to fork numpy for this purpose (either rewrite the C-to-python glue only, or the C part also). I believe this will fail, and the reason is pretty simple: first, even before you start, you already say that you don't have people/money/time to commit to this project. Second, maintaining a fork is a huge, huge task. You might easily introduce bugs, break feature, etc - while people are expecting something that "just works" as drop-in replacement, so even a "almost success" from a technical point of view, can be a big failure for adopter, if it doesn't behave. Last, but not least, numpy is a moving target, and you'll always play catch up. Is this the game you want to play??<br><br>Now, I don't want to tell you what you have to do for fun, but if you want to have chances of success, you have to change the "politics" of your plan. I trust you that technically your plan is fine, but rather than implementing it within a numpy fork (or worst: rewrite), I suggest that you work with the numpy and/or CPython community, to see if you can write a wrapper around cpyext (or whatever they are using for C-to-Python glue). This wrapper (at compiler time) should either become cpyext (or whatever) if you are using CPython, or become "something else" if you are using pypy. If you persuade numpy people to use this wrapper you'll have the same numpy code base working as is in CPython and pypy. Sure you will not be exploiting the faster-than-C capabilities of pypy, but you can get there more smoothly: improving the speed one feature at time, while the rest of the framework is still working and thus useful, and thus increasing its user base, people interested in it (and some of them may become contributors).<br><br>Instead your plan sounds like:  implement one feature at time, while the rest of the framework doesn't work and thus nobody uses it in production, let alone care about its speed. On top of which, you'll be trying to catch-up with numpy.</p>
        </div>
      </div>
      <div class="comment comment-3360544717131026146">
        <div class="comment-header">
          <a name="comment-3360544717131026146"></a>
            <span class="author">Maciej Fijalkowski</span> wrote on <span class="date">2011-06-23 18:12</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous there are many things I disagree with and I'm not going to fork numpy.<br><br>The basis is - I claim there is more use for fast numpy which is incomplete than slow complete numpy.<br><br>I would refer you to yet another blog post (personal this time) explaining more why I do what I do: https://lostinjit.blogspot.com</p>
        </div>
      </div>
      <div class="comment comment-8155415493954380647">
        <div class="comment-header">
          <a name="comment-8155415493954380647"></a>
            <span class="author">Connelly Barnes</span> wrote on <span class="date">2011-08-24 04:13</span>:
        </div>
        <div class="comment-content">
          <p>Here is a completely different approach taken by IronPython for Scipy+Numpy compatibility:<br><br>https://www.johndcook.com/blog/2009/03/19/ironclad-ironpytho/<br><br>It's basically a bidirectional FFI. Have a CPython and an IronPython both running, and wrap objects so that IronPython objects can be used by CPython and vice versa. This requires some platform specific binary level compatibility, in their case, DLL hacking, to allow the FFI to work in both directions.<br><br>It seems like that approach should be practical for getting all of large libraries such as Scipy or Numpy working in Pypy. Since it's already been demonstrated to work for IronPython.<br><br>The above roadmap proposes instead speeding up the core array object by coding it in RPython.<br><br>But I wonder if these two approaches could work together. For example Numpy could be configured to use ordinary CPython array objects, or PyPy compiled RPython array objects. Then the FFI just has to take care to wrap objects appropriately that are in the "other interpreter".<br><br>Thoughts?</p>
        </div>
      </div>
      <div class="comment comment-9205286314643064344">
        <div class="comment-header">
          <a name="comment-9205286314643064344"></a>
            <span class="author">Connelly Barnes</span> wrote on <span class="date">2011-10-13 00:30</span>:
        </div>
        <div class="comment-content">
          <p>As a follow up to my previous comment, I noticed there is a bidirectional FFI for Python called RPyC that was previously discussed on the Pypy blog:<br><br>https://morepypy.blogspot.com/2009/11/using-cpython-extension-modules-with.html<br><br>I have no idea if it has been tried  with Numpy yet.</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>