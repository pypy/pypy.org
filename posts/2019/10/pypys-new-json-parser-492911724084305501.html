<html><body><h2>
Introduction</h2>
In the last year or two I have worked on and off on making PyPy's
<a class="reference external" href="https://www.json.org/">JSON</a> faster, particularly when parsing large
JSON files. In this post I am going to document those techniques and
measure their performance impact. Note that I am quite a lot more
constrained in what optimizations I can apply here, compared to some of
the much more advanced approaches like
<a class="reference external" href="https://www.microsoft.com/en-us/research/publication/mison-fast-json-parser-data-analytics/">Mison</a>,
<a class="reference external" href="https://dawn.cs.stanford.edu/2018/08/07/sparser/">Sparser</a> or
<a class="reference external" href="https://arxiv.org/abs/1902.08318">SimdJSON</a> because I don't want to
change the <tt class="docutils literal">json.loads</tt> API that Python programs expect, and because I
don't want to only support CPUs with wide SIMD extensions. With a more
expressive API, more optimizations would be possible.<br>
There are a number of problems of working with huge JSON files:
deserialization takes a long time on the one hand, and the resulting
data structures often take a lot of memory (usually they can be many
times bigger than the size of the file they originated from). Of course
these problems are related, because allocating and initializing a big
data structure takes longer than a smaller data structure. Therefore I
always tried to attack both of these problems at the same time.<br>
One common theme of the techniques I am describing is that of optimizing
the parser for how JSON files are typically used, not how they could
theoretically be used. This is a similar approach to the way dynamic
languages are optimized more generally: most JITs will optimize for
typical patterns of usage, at the cost of less common usage patterns,
which might even become slower as a result of the optimizations.<br>
<h2>
Maps</h2>
The first technique I investigated is to use maps in the JSON parser.
Maps, also called hidden classes or shapes, are a fairly common way to
(generally, not just in the context of JSON parsing) <a class="reference external" href="https://morepypy.blogspot.com/2010/11/efficiently-implementing-python-objects.html">optimize instances
of
classes</a>
in dynamic language VMs. Maps exploit the fact that while it is in
theory possible to add arbitrary fields to an instance, in practice most
instances of a class are going to have the same set of fields (or one of
a small number of different sets). Since JSON dictionaries or objects
often come from serialized instances of some kind, this property often
holds in JSON files as well: dictionaries often have the same fields in
the same order, within a JSON file.<br>
This property can be exploited in two ways: on the one hand, it can be
used to again store the deserialized dictionaries in a more memory
efficient way by not using a hashmap in most cases, but instead
splitting the dictionary into a shared description of the set of keys
(the map) and an array of storage with the values. This makes the
deserialized dictionaries smaller if the same set of keys is repeated a
lot. This is completely transparent to the Python programmer, the
dictionary will look completely normal to the Python program but its
internal representation is different.<br>
One downside of using maps is that sometimes files will contain many
dictionaries that have unique key sets. Since maps themselves are quite
large data structures and since dictionaries that use maps contain an
extra level of indirection we want to fall back to using normal hashmaps
to represent the dictionaries where that is the case. To prevent this we
perform some statistics at runtime, how often every map (i.e. set of
keys) is used in the file. For uncommonly used maps, the map is
discarded and the dictionaries that used the map converted into using a
regular hashmap.<br>
<h3>
Using Maps to Speed up Parsing</h3>
Another benefit of using maps to store deserialized dictionaries is that
we can use them to speed up the parsing process itself. To see how this
works, we need to understand maps a bit better. All the maps produced as
a side-effect of parsing JSON form a tree. The tree root is a map that
describes the object without any attributes. From every tree node we
have a number of edges going to other nodes, each edge for a specific
new attribute added:<br>

<svg height="503pt" version="1.1" viewbox="0 0 623 503" width="423pt" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
<g>

<path d="M 0.640625 2.265625 L 0.640625 -9.015625 L 7.03125 -9.015625 L 7.03125 2.265625 Z M 1.359375 1.546875 L 6.328125 1.546875 L 6.328125 -8.296875 L 1.359375 -8.296875 Z M 1.359375 1.546875 ">


<path d="M 7.1875 -3.78125 L 7.1875 -3.21875 L 1.90625 -3.21875 C 1.957031 -2.425781 2.195312 -1.820312 2.625 -1.40625 C 3.050781 -1 3.644531 -0.796875 4.40625 -0.796875 C 4.84375 -0.796875 5.269531 -0.847656 5.6875 -0.953125 C 6.101562 -1.066406 6.515625 -1.226562 6.921875 -1.4375 L 6.921875 -0.359375 C 6.515625 -0.179688 6.09375 -0.046875 5.65625 0.046875 C 5.21875 0.140625 4.78125 0.1875 4.34375 0.1875 C 3.21875 0.1875 2.328125 -0.132812 1.671875 -0.78125 C 1.023438 -1.4375 0.703125 -2.320312 0.703125 -3.4375 C 0.703125 -4.582031 1.007812 -5.488281 1.625 -6.15625 C 2.25 -6.832031 3.085938 -7.171875 4.140625 -7.171875 C 5.078125 -7.171875 5.816406 -6.863281 6.359375 -6.25 C 6.910156 -5.644531 7.1875 -4.820312 7.1875 -3.78125 Z M 6.046875 -4.125 C 6.035156 -4.75 5.859375 -5.25 5.515625 -5.625 C 5.171875 -6 4.71875 -6.1875 4.15625 -6.1875 C 3.507812 -6.1875 2.992188 -6.003906 2.609375 -5.640625 C 2.222656 -5.285156 2 -4.78125 1.9375 -4.125 Z M 6.046875 -4.125 ">


<path d="M 6.65625 -5.65625 C 6.9375 -6.164062 7.273438 -6.546875 7.671875 -6.796875 C 8.078125 -7.046875 8.550781 -7.171875 9.09375 -7.171875 C 9.820312 -7.171875 10.382812 -6.914062 10.78125 -6.40625 C 11.175781 -5.894531 11.375 -5.164062 11.375 -4.21875 L 11.375 0 L 10.21875 0 L 10.21875 -4.1875 C 10.21875 -4.851562 10.097656 -5.347656 9.859375 -5.671875 C 9.628906 -6.003906 9.269531 -6.171875 8.78125 -6.171875 C 8.1875 -6.171875 7.710938 -5.972656 7.359375 -5.578125 C 7.015625 -5.179688 6.84375 -4.640625 6.84375 -3.953125 L 6.84375 0 L 5.6875 0 L 5.6875 -4.1875 C 5.6875 -4.863281 5.566406 -5.363281 5.328125 -5.6875 C 5.097656 -6.007812 4.734375 -6.171875 4.234375 -6.171875 C 3.648438 -6.171875 3.179688 -5.96875 2.828125 -5.5625 C 2.484375 -5.164062 2.3125 -4.628906 2.3125 -3.953125 L 2.3125 0 L 1.15625 0 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.90625 C 2.582031 -6.332031 2.898438 -6.648438 3.265625 -6.859375 C 3.628906 -7.066406 4.0625 -7.171875 4.5625 -7.171875 C 5.070312 -7.171875 5.503906 -7.039062 5.859375 -6.78125 C 6.222656 -6.519531 6.488281 -6.144531 6.65625 -5.65625 Z M 6.65625 -5.65625 ">


<path d="M 2.3125 -1.046875 L 2.3125 2.65625 L 1.15625 2.65625 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.9375 C 2.5625 -6.351562 2.867188 -6.660156 3.234375 -6.859375 C 3.597656 -7.066406 4.039062 -7.171875 4.5625 -7.171875 C 5.40625 -7.171875 6.09375 -6.832031 6.625 -6.15625 C 7.15625 -5.476562 7.421875 -4.59375 7.421875 -3.5 C 7.421875 -2.394531 7.15625 -1.503906 6.625 -0.828125 C 6.09375 -0.148438 5.40625 0.1875 4.5625 0.1875 C 4.039062 0.1875 3.597656 0.0859375 3.234375 -0.109375 C 2.867188 -0.316406 2.5625 -0.628906 2.3125 -1.046875 Z M 6.234375 -3.5 C 6.234375 -4.34375 6.054688 -5.003906 5.703125 -5.484375 C 5.359375 -5.960938 4.882812 -6.203125 4.28125 -6.203125 C 3.664062 -6.203125 3.179688 -5.960938 2.828125 -5.484375 C 2.484375 -5.003906 2.3125 -4.34375 2.3125 -3.5 C 2.3125 -2.644531 2.484375 -1.976562 2.828125 -1.5 C 3.179688 -1.019531 3.664062 -0.78125 4.28125 -0.78125 C 4.882812 -0.78125 5.359375 -1.019531 5.703125 -1.5 C 6.054688 -1.976562 6.234375 -2.644531 6.234375 -3.5 Z M 6.234375 -3.5 ">


<path d="M 2.34375 -8.984375 L 2.34375 -7 L 4.71875 -7 L 4.71875 -6.109375 L 2.34375 -6.109375 L 2.34375 -2.3125 C 2.34375 -1.738281 2.421875 -1.367188 2.578125 -1.203125 C 2.734375 -1.046875 3.050781 -0.96875 3.53125 -0.96875 L 4.71875 -0.96875 L 4.71875 0 L 3.53125 0 C 2.644531 0 2.03125 -0.164062 1.6875 -0.5 C 1.351562 -0.832031 1.1875 -1.4375 1.1875 -2.3125 L 1.1875 -6.109375 L 0.34375 -6.109375 L 0.34375 -7 L 1.1875 -7 L 1.1875 -8.984375 Z M 2.34375 -8.984375 ">


<path d="M 4.125 0.65625 C 3.789062 1.488281 3.46875 2.03125 3.15625 2.28125 C 2.851562 2.53125 2.445312 2.65625 1.9375 2.65625 L 1.015625 2.65625 L 1.015625 1.703125 L 1.6875 1.703125 C 2 1.703125 2.242188 1.625 2.421875 1.46875 C 2.597656 1.320312 2.789062 0.96875 3 0.40625 L 3.21875 -0.109375 L 0.375 -7 L 1.59375 -7 L 3.78125 -1.53125 L 5.96875 -7 L 7.1875 -7 Z M 4.125 0.65625 ">


<path d="M 4.390625 -3.515625 C 3.460938 -3.515625 2.816406 -3.40625 2.453125 -3.1875 C 2.097656 -2.976562 1.921875 -2.617188 1.921875 -2.109375 C 1.921875 -1.703125 2.050781 -1.378906 2.3125 -1.140625 C 2.582031 -0.898438 2.953125 -0.78125 3.421875 -0.78125 C 4.054688 -0.78125 4.566406 -1.003906 4.953125 -1.453125 C 5.335938 -1.910156 5.53125 -2.515625 5.53125 -3.265625 L 5.53125 -3.515625 Z M 6.671875 -4 L 6.671875 0 L 5.53125 0 L 5.53125 -1.0625 C 5.269531 -0.632812 4.941406 -0.316406 4.546875 -0.109375 C 4.160156 0.0859375 3.679688 0.1875 3.109375 0.1875 C 2.390625 0.1875 1.816406 -0.015625 1.390625 -0.421875 C 0.972656 -0.828125 0.765625 -1.363281 0.765625 -2.03125 C 0.765625 -2.820312 1.023438 -3.414062 1.546875 -3.8125 C 2.078125 -4.21875 2.867188 -4.421875 3.921875 -4.421875 L 5.53125 -4.421875 L 5.53125 -4.53125 C 5.53125 -5.0625 5.351562 -5.46875 5 -5.75 C 4.65625 -6.039062 4.171875 -6.1875 3.546875 -6.1875 C 3.140625 -6.1875 2.75 -6.140625 2.375 -6.046875 C 2 -5.953125 1.632812 -5.8125 1.28125 -5.625 L 1.28125 -6.671875 C 1.695312 -6.835938 2.101562 -6.960938 2.5 -7.046875 C 2.894531 -7.128906 3.28125 -7.171875 3.65625 -7.171875 C 4.675781 -7.171875 5.429688 -6.90625 5.921875 -6.375 C 6.421875 -5.851562 6.671875 -5.0625 6.671875 -4 Z M 6.671875 -4 ">


<path d="M 5.8125 -5.9375 L 5.8125 -9.71875 L 6.953125 -9.71875 L 6.953125 0 L 5.8125 0 L 5.8125 -1.046875 C 5.570312 -0.628906 5.265625 -0.316406 4.890625 -0.109375 C 4.523438 0.0859375 4.082031 0.1875 3.5625 0.1875 C 2.71875 0.1875 2.03125 -0.148438 1.5 -0.828125 C 0.96875 -1.503906 0.703125 -2.394531 0.703125 -3.5 C 0.703125 -4.59375 0.96875 -5.476562 1.5 -6.15625 C 2.03125 -6.832031 2.71875 -7.171875 3.5625 -7.171875 C 4.082031 -7.171875 4.523438 -7.066406 4.890625 -6.859375 C 5.265625 -6.660156 5.570312 -6.351562 5.8125 -5.9375 Z M 1.890625 -3.5 C 1.890625 -2.644531 2.0625 -1.976562 2.40625 -1.5 C 2.757812 -1.019531 3.238281 -0.78125 3.84375 -0.78125 C 4.457031 -0.78125 4.9375 -1.019531 5.28125 -1.5 C 5.632812 -1.976562 5.8125 -2.644531 5.8125 -3.5 C 5.8125 -4.34375 5.632812 -5.003906 5.28125 -5.484375 C 4.9375 -5.960938 4.457031 -6.203125 3.84375 -6.203125 C 3.238281 -6.203125 2.757812 -5.960938 2.40625 -5.484375 C 2.0625 -5.003906 1.890625 -4.34375 1.890625 -3.5 Z M 1.890625 -3.5 ">


<path d="">


<path d="M 1.5 -1.59375 L 2.8125 -1.59375 L 2.8125 -0.515625 L 1.796875 1.484375 L 0.984375 1.484375 L 1.5 -0.515625 Z M 1.5 -1.59375 ">


<path d="M 6.234375 -3.5 C 6.234375 -4.34375 6.054688 -5.003906 5.703125 -5.484375 C 5.359375 -5.960938 4.882812 -6.203125 4.28125 -6.203125 C 3.664062 -6.203125 3.179688 -5.960938 2.828125 -5.484375 C 2.484375 -5.003906 2.3125 -4.34375 2.3125 -3.5 C 2.3125 -2.644531 2.484375 -1.976562 2.828125 -1.5 C 3.179688 -1.019531 3.664062 -0.78125 4.28125 -0.78125 C 4.882812 -0.78125 5.359375 -1.019531 5.703125 -1.5 C 6.054688 -1.976562 6.234375 -2.644531 6.234375 -3.5 Z M 2.3125 -5.9375 C 2.5625 -6.351562 2.867188 -6.660156 3.234375 -6.859375 C 3.597656 -7.066406 4.039062 -7.171875 4.5625 -7.171875 C 5.40625 -7.171875 6.09375 -6.832031 6.625 -6.15625 C 7.15625 -5.476562 7.421875 -4.59375 7.421875 -3.5 C 7.421875 -2.394531 7.15625 -1.503906 6.625 -0.828125 C 6.09375 -0.148438 5.40625 0.1875 4.5625 0.1875 C 4.039062 0.1875 3.597656 0.0859375 3.234375 -0.109375 C 2.867188 -0.316406 2.5625 -0.628906 2.3125 -1.046875 L 2.3125 0 L 1.15625 0 L 1.15625 -9.71875 L 2.3125 -9.71875 Z M 2.3125 -5.9375 ">


<path d="M 6.25 -6.734375 L 6.25 -5.65625 C 5.914062 -5.832031 5.585938 -5.960938 5.265625 -6.046875 C 4.941406 -6.140625 4.613281 -6.1875 4.28125 -6.1875 C 3.53125 -6.1875 2.945312 -5.953125 2.53125 -5.484375 C 2.125 -5.015625 1.921875 -4.351562 1.921875 -3.5 C 1.921875 -2.644531 2.125 -1.976562 2.53125 -1.5 C 2.945312 -1.03125 3.53125 -0.796875 4.28125 -0.796875 C 4.613281 -0.796875 4.941406 -0.835938 5.265625 -0.921875 C 5.585938 -1.015625 5.914062 -1.148438 6.25 -1.328125 L 6.25 -0.265625 C 5.925781 -0.117188 5.59375 -0.0078125 5.25 0.0625 C 4.90625 0.144531 4.539062 0.1875 4.15625 0.1875 C 3.09375 0.1875 2.25 -0.144531 1.625 -0.8125 C 1.007812 -1.476562 0.703125 -2.375 0.703125 -3.5 C 0.703125 -4.632812 1.015625 -5.53125 1.640625 -6.1875 C 2.273438 -6.84375 3.132812 -7.171875 4.21875 -7.171875 C 4.570312 -7.171875 4.914062 -7.132812 5.25 -7.0625 C 5.59375 -6.988281 5.925781 -6.878906 6.25 -6.734375 Z M 6.25 -6.734375 ">


<path d="M 4.75 -9.71875 L 4.75 -8.765625 L 3.65625 -8.765625 C 3.238281 -8.765625 2.945312 -8.679688 2.78125 -8.515625 C 2.625 -8.347656 2.546875 -8.046875 2.546875 -7.609375 L 2.546875 -7 L 4.4375 -7 L 4.4375 -6.109375 L 2.546875 -6.109375 L 2.546875 0 L 1.390625 0 L 1.390625 -6.109375 L 0.296875 -6.109375 L 0.296875 -7 L 1.390625 -7 L 1.390625 -7.484375 C 1.390625 -8.265625 1.570312 -8.832031 1.9375 -9.1875 C 2.300781 -9.539062 2.875 -9.71875 3.65625 -9.71875 Z M 4.75 -9.71875 ">


<path d="M 7.015625 -7 L 4.5 -3.59375 L 7.15625 0 L 5.796875 0 L 3.765625 -2.75 L 1.71875 0 L 0.375 0 L 3.09375 -3.65625 L 0.59375 -7 L 1.953125 -7 L 3.8125 -4.5 L 5.671875 -7 Z M 7.015625 -7 ">


<path d="M 3.921875 -6.1875 C 3.304688 -6.1875 2.816406 -5.945312 2.453125 -5.46875 C 2.097656 -4.988281 1.921875 -4.332031 1.921875 -3.5 C 1.921875 -2.65625 2.097656 -1.992188 2.453125 -1.515625 C 2.804688 -1.035156 3.296875 -0.796875 3.921875 -0.796875 C 4.535156 -0.796875 5.019531 -1.035156 5.375 -1.515625 C 5.726562 -2.003906 5.90625 -2.664062 5.90625 -3.5 C 5.90625 -4.320312 5.726562 -4.972656 5.375 -5.453125 C 5.019531 -5.941406 4.535156 -6.1875 3.921875 -6.1875 Z M 3.921875 -7.171875 C 4.921875 -7.171875 5.703125 -6.84375 6.265625 -6.1875 C 6.835938 -5.539062 7.125 -4.644531 7.125 -3.5 C 7.125 -2.351562 6.835938 -1.453125 6.265625 -0.796875 C 5.703125 -0.140625 4.921875 0.1875 3.921875 0.1875 C 2.910156 0.1875 2.117188 -0.140625 1.546875 -0.796875 C 0.984375 -1.453125 0.703125 -2.351562 0.703125 -3.5 C 0.703125 -4.644531 0.984375 -5.539062 1.546875 -6.1875 C 2.117188 -6.84375 2.910156 -7.171875 3.921875 -7.171875 Z M 3.921875 -7.171875 ">


<path d="M 7.015625 -4.21875 L 7.015625 0 L 5.875 0 L 5.875 -4.1875 C 5.875 -4.851562 5.742188 -5.347656 5.484375 -5.671875 C 5.222656 -6.003906 4.835938 -6.171875 4.328125 -6.171875 C 3.703125 -6.171875 3.207031 -5.972656 2.84375 -5.578125 C 2.488281 -5.179688 2.3125 -4.640625 2.3125 -3.953125 L 2.3125 0 L 1.15625 0 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.90625 C 2.59375 -6.332031 2.914062 -6.648438 3.28125 -6.859375 C 3.65625 -7.066406 4.085938 -7.171875 4.578125 -7.171875 C 5.378906 -7.171875 5.984375 -6.921875 6.390625 -6.421875 C 6.804688 -5.921875 7.015625 -5.1875 7.015625 -4.21875 Z M 7.015625 -4.21875 ">


<path d="M 5.265625 -5.921875 C 5.128906 -5.992188 4.984375 -6.046875 4.828125 -6.078125 C 4.679688 -6.117188 4.519531 -6.140625 4.34375 -6.140625 C 3.6875 -6.140625 3.179688 -5.925781 2.828125 -5.5 C 2.484375 -5.082031 2.3125 -4.476562 2.3125 -3.6875 L 2.3125 0 L 1.15625 0 L 1.15625 -7 L 2.3125 -7 L 2.3125 -5.90625 C 2.5625 -6.332031 2.878906 -6.648438 3.265625 -6.859375 C 3.648438 -7.066406 4.117188 -7.171875 4.671875 -7.171875 C 4.753906 -7.171875 4.84375 -7.164062 4.9375 -7.15625 C 5.03125 -7.144531 5.132812 -7.128906 5.25 -7.109375 Z M 5.265625 -5.921875 ">


<path d="M 5.671875 -6.796875 L 5.671875 -5.703125 C 5.347656 -5.867188 5.007812 -5.992188 4.65625 -6.078125 C 4.300781 -6.160156 3.9375 -6.203125 3.5625 -6.203125 C 3 -6.203125 2.570312 -6.113281 2.28125 -5.9375 C 2 -5.769531 1.859375 -5.507812 1.859375 -5.15625 C 1.859375 -4.882812 1.957031 -4.671875 2.15625 -4.515625 C 2.363281 -4.367188 2.773438 -4.226562 3.390625 -4.09375 L 3.78125 -4 C 4.601562 -3.832031 5.1875 -3.585938 5.53125 -3.265625 C 5.875 -2.941406 6.046875 -2.5 6.046875 -1.9375 C 6.046875 -1.28125 5.785156 -0.757812 5.265625 -0.375 C 4.753906 0 4.050781 0.1875 3.15625 0.1875 C 2.78125 0.1875 2.390625 0.148438 1.984375 0.078125 C 1.578125 0.00390625 1.144531 -0.101562 0.6875 -0.25 L 0.6875 -1.4375 C 1.113281 -1.21875 1.53125 -1.050781 1.9375 -0.9375 C 2.351562 -0.832031 2.765625 -0.78125 3.171875 -0.78125 C 3.710938 -0.78125 4.128906 -0.875 4.421875 -1.0625 C 4.710938 -1.25 4.859375 -1.507812 4.859375 -1.84375 C 4.859375 -2.15625 4.753906 -2.394531 4.546875 -2.5625 C 4.335938 -2.726562 3.875 -2.890625 3.15625 -3.046875 L 2.765625 -3.140625 C 2.046875 -3.285156 1.53125 -3.515625 1.21875 -3.828125 C 0.90625 -4.140625 0.75 -4.566406 0.75 -5.109375 C 0.75 -5.765625 0.976562 -6.269531 1.4375 -6.625 C 1.90625 -6.988281 2.570312 -7.171875 3.4375 -7.171875 C 3.851562 -7.171875 4.25 -7.140625 4.625 -7.078125 C 5 -7.015625 5.347656 -6.921875 5.671875 -6.796875 Z M 5.671875 -6.796875 ">


<path d="M 1.203125 -7 L 2.359375 -7 L 2.359375 0 L 1.203125 0 Z M 1.203125 -9.71875 L 2.359375 -9.71875 L 2.359375 -8.265625 L 1.203125 -8.265625 Z M 1.203125 -9.71875 ">


<path d="M 1.203125 -9.71875 L 2.359375 -9.71875 L 2.359375 0 L 1.203125 0 Z M 1.203125 -9.71875 ">


<path d="M 1.078125 3.84375 L 1.078125 -15.359375 L 11.96875 -15.359375 L 11.96875 3.84375 Z M 2.3125 2.640625 L 10.765625 2.640625 L 10.765625 -14.140625 L 2.3125 -14.140625 Z M 2.3125 2.640625 ">


<path d="M 2.140625 -15.875 L 12.171875 -15.875 L 12.171875 -14.078125 L 4.28125 -14.078125 L 4.28125 -9.375 L 11.84375 -9.375 L 11.84375 -7.5625 L 4.28125 -7.5625 L 4.28125 -1.8125 L 12.375 -1.8125 L 12.375 0 L 2.140625 0 Z M 2.140625 -15.875 ">


<path d="M 11.953125 -11.90625 L 7.640625 -6.109375 L 12.171875 0 L 9.875 0 L 6.40625 -4.671875 L 2.9375 0 L 0.625 0 L 5.25 -6.234375 L 1.015625 -11.90625 L 3.328125 -11.90625 L 6.484375 -7.671875 L 9.640625 -11.90625 Z M 11.953125 -11.90625 ">


<path d="M 7.46875 -5.984375 C 5.882812 -5.984375 4.785156 -5.800781 4.171875 -5.4375 C 3.566406 -5.082031 3.265625 -4.46875 3.265625 -3.59375 C 3.265625 -2.894531 3.492188 -2.34375 3.953125 -1.9375 C 4.410156 -1.53125 5.03125 -1.328125 5.8125 -1.328125 C 6.894531 -1.328125 7.765625 -1.710938 8.421875 -2.484375 C 9.078125 -3.253906 9.40625 -4.273438 9.40625 -5.546875 L 9.40625 -5.984375 Z M 11.375 -6.796875 L 11.375 0 L 9.40625 0 L 9.40625 -1.8125 C 8.96875 -1.082031 8.414062 -0.546875 7.75 -0.203125 C 7.082031 0.140625 6.265625 0.3125 5.296875 0.3125 C 4.078125 0.3125 3.109375 -0.03125 2.390625 -0.71875 C 1.671875 -1.40625 1.3125 -2.320312 1.3125 -3.46875 C 1.3125 -4.8125 1.757812 -5.820312 2.65625 -6.5 C 3.550781 -7.175781 4.890625 -7.515625 6.671875 -7.515625 L 9.40625 -7.515625 L 9.40625 -7.703125 C 9.40625 -8.609375 9.109375 -9.304688 8.515625 -9.796875 C 7.929688 -10.296875 7.101562 -10.546875 6.03125 -10.546875 C 5.351562 -10.546875 4.691406 -10.460938 4.046875 -10.296875 C 3.398438 -10.128906 2.78125 -9.882812 2.1875 -9.5625 L 2.1875 -11.375 C 2.894531 -11.644531 3.585938 -11.847656 4.265625 -11.984375 C 4.941406 -12.128906 5.597656 -12.203125 6.234375 -12.203125 C 7.953125 -12.203125 9.238281 -11.753906 10.09375 -10.859375 C 10.945312 -9.960938 11.375 -8.609375 11.375 -6.796875 Z M 11.375 -6.796875 ">


<path d="M 11.328125 -9.625 C 11.816406 -10.5 12.398438 -11.144531 13.078125 -11.5625 C 13.765625 -11.988281 14.566406 -12.203125 15.484375 -12.203125 C 16.722656 -12.203125 17.675781 -11.765625 18.34375 -10.890625 C 19.019531 -10.023438 19.359375 -8.789062 19.359375 -7.1875 L 19.359375 0 L 17.40625 0 L 17.40625 -7.125 C 17.40625 -8.269531 17.203125 -9.117188 16.796875 -9.671875 C 16.390625 -10.222656 15.769531 -10.5 14.9375 -10.5 C 13.925781 -10.5 13.125 -10.160156 12.53125 -9.484375 C 11.945312 -8.804688 11.65625 -7.890625 11.65625 -6.734375 L 11.65625 0 L 9.6875 0 L 9.6875 -7.125 C 9.6875 -8.269531 9.484375 -9.117188 9.078125 -9.671875 C 8.671875 -10.222656 8.046875 -10.5 7.203125 -10.5 C 6.210938 -10.5 5.421875 -10.160156 4.828125 -9.484375 C 4.242188 -8.804688 3.953125 -7.890625 3.953125 -6.734375 L 3.953125 0 L 1.984375 0 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.0625 C 4.390625 -10.789062 4.921875 -11.328125 5.546875 -11.671875 C 6.171875 -12.023438 6.914062 -12.203125 7.78125 -12.203125 C 8.644531 -12.203125 9.378906 -11.976562 9.984375 -11.53125 C 10.585938 -11.09375 11.035156 -10.457031 11.328125 -9.625 Z M 11.328125 -9.625 ">


<path d="M 3.953125 -1.78125 L 3.953125 4.53125 L 1.984375 4.53125 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.109375 C 4.359375 -10.816406 4.875 -11.34375 5.5 -11.6875 C 6.125 -12.03125 6.875 -12.203125 7.75 -12.203125 C 9.195312 -12.203125 10.375 -11.625 11.28125 -10.46875 C 12.1875 -9.320312 12.640625 -7.8125 12.640625 -5.9375 C 12.640625 -4.070312 12.1875 -2.5625 11.28125 -1.40625 C 10.375 -0.257812 9.195312 0.3125 7.75 0.3125 C 6.875 0.3125 6.125 0.140625 5.5 -0.203125 C 4.875 -0.546875 4.359375 -1.070312 3.953125 -1.78125 Z M 10.609375 -5.9375 C 10.609375 -7.382812 10.3125 -8.515625 9.71875 -9.328125 C 9.125 -10.148438 8.3125 -10.5625 7.28125 -10.5625 C 6.238281 -10.5625 5.421875 -10.148438 4.828125 -9.328125 C 4.242188 -8.515625 3.953125 -7.382812 3.953125 -5.9375 C 3.953125 -4.5 4.242188 -3.367188 4.828125 -2.546875 C 5.421875 -1.734375 6.238281 -1.328125 7.28125 -1.328125 C 8.3125 -1.328125 9.125 -1.734375 9.71875 -2.546875 C 10.3125 -3.367188 10.609375 -4.5 10.609375 -5.9375 Z M 10.609375 -5.9375 ">


<path d="M 2.046875 -16.546875 L 4.015625 -16.546875 L 4.015625 0 L 2.046875 0 Z M 2.046875 -16.546875 ">


<path d="M 12.234375 -6.4375 L 12.234375 -5.484375 L 3.25 -5.484375 C 3.332031 -4.140625 3.734375 -3.113281 4.453125 -2.40625 C 5.179688 -1.695312 6.195312 -1.34375 7.5 -1.34375 C 8.25 -1.34375 8.972656 -1.4375 9.671875 -1.625 C 10.378906 -1.8125 11.082031 -2.085938 11.78125 -2.453125 L 11.78125 -0.609375 C 11.082031 -0.304688 10.363281 -0.078125 9.625 0.078125 C 8.882812 0.234375 8.132812 0.3125 7.375 0.3125 C 5.476562 0.3125 3.972656 -0.238281 2.859375 -1.34375 C 1.753906 -2.457031 1.203125 -3.957031 1.203125 -5.84375 C 1.203125 -7.789062 1.726562 -9.335938 2.78125 -10.484375 C 3.832031 -11.628906 5.253906 -12.203125 7.046875 -12.203125 C 8.640625 -12.203125 9.898438 -11.6875 10.828125 -10.65625 C 11.765625 -9.625 12.234375 -8.21875 12.234375 -6.4375 Z M 10.28125 -7.015625 C 10.269531 -8.085938 9.972656 -8.941406 9.390625 -9.578125 C 8.804688 -10.222656 8.03125 -10.546875 7.0625 -10.546875 C 5.96875 -10.546875 5.09375 -10.234375 4.4375 -9.609375 C 3.78125 -8.992188 3.40625 -8.128906 3.3125 -7.015625 Z M 10.28125 -7.015625 ">


<path d="">


<path d="M 3.984375 -15.296875 L 3.984375 -11.90625 L 8.015625 -11.90625 L 8.015625 -10.390625 L 3.984375 -10.390625 L 3.984375 -3.921875 C 3.984375 -2.953125 4.113281 -2.328125 4.375 -2.046875 C 4.644531 -1.773438 5.191406 -1.640625 6.015625 -1.640625 L 8.015625 -1.640625 L 8.015625 0 L 6.015625 0 C 4.503906 0 3.457031 -0.28125 2.875 -0.84375 C 2.300781 -1.40625 2.015625 -2.429688 2.015625 -3.921875 L 2.015625 -10.390625 L 0.578125 -10.390625 L 0.578125 -11.90625 L 2.015625 -11.90625 L 2.015625 -15.296875 Z M 3.984375 -15.296875 ">


<path d="M 8.953125 -10.078125 C 8.734375 -10.210938 8.492188 -10.304688 8.234375 -10.359375 C 7.972656 -10.421875 7.6875 -10.453125 7.375 -10.453125 C 6.269531 -10.453125 5.421875 -10.09375 4.828125 -9.375 C 4.242188 -8.65625 3.953125 -7.625 3.953125 -6.28125 L 3.953125 0 L 1.984375 0 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.0625 C 4.359375 -10.78125 4.890625 -11.316406 5.546875 -11.671875 C 6.210938 -12.023438 7.015625 -12.203125 7.953125 -12.203125 C 8.085938 -12.203125 8.234375 -12.191406 8.390625 -12.171875 C 8.554688 -12.148438 8.738281 -12.125 8.9375 -12.09375 Z M 8.953125 -10.078125 ">


<path d="M 11.953125 -7.1875 L 11.953125 0 L 10 0 L 10 -7.125 C 10 -8.25 9.773438 -9.09375 9.328125 -9.65625 C 8.890625 -10.21875 8.234375 -10.5 7.359375 -10.5 C 6.304688 -10.5 5.472656 -10.160156 4.859375 -9.484375 C 4.253906 -8.804688 3.953125 -7.890625 3.953125 -6.734375 L 3.953125 0 L 1.984375 0 L 1.984375 -11.90625 L 3.953125 -11.90625 L 3.953125 -10.0625 C 4.410156 -10.78125 4.957031 -11.316406 5.59375 -11.671875 C 6.226562 -12.023438 6.960938 -12.203125 7.796875 -12.203125 C 9.160156 -12.203125 10.191406 -11.773438 10.890625 -10.921875 C 11.597656 -10.078125 11.953125 -8.832031 11.953125 -7.1875 Z M 11.953125 -7.1875 ">


<path d="M 9.640625 -11.5625 L 9.640625 -9.703125 C 9.085938 -9.992188 8.515625 -10.207031 7.921875 -10.34375 C 7.328125 -10.488281 6.710938 -10.5625 6.078125 -10.5625 C 5.097656 -10.5625 4.363281 -10.410156 3.875 -10.109375 C 3.394531 -9.816406 3.15625 -9.375 3.15625 -8.78125 C 3.15625 -8.320312 3.328125 -7.960938 3.671875 -7.703125 C 4.023438 -7.441406 4.726562 -7.195312 5.78125 -6.96875 L 6.4375 -6.8125 C 7.832031 -6.519531 8.820312 -6.101562 9.40625 -5.5625 C 9.988281 -5.019531 10.28125 -4.257812 10.28125 -3.28125 C 10.28125 -2.175781 9.84375 -1.300781 8.96875 -0.65625 C 8.09375 -0.0078125 6.890625 0.3125 5.359375 0.3125 C 4.722656 0.3125 4.054688 0.25 3.359375 0.125 C 2.671875 0 1.945312 -0.1875 1.1875 -0.4375 L 1.1875 -2.453125 C 1.90625 -2.078125 2.613281 -1.796875 3.3125 -1.609375 C 4.019531 -1.421875 4.71875 -1.328125 5.40625 -1.328125 C 6.320312 -1.328125 7.03125 -1.484375 7.53125 -1.796875 C 8.03125 -2.117188 8.28125 -2.566406 8.28125 -3.140625 C 8.28125 -3.671875 8.097656 -4.078125 7.734375 -4.359375 C 7.378906 -4.640625 6.59375 -4.910156 5.375 -5.171875 L 4.703125 -5.34375 C 3.484375 -5.59375 2.601562 -5.984375 2.0625 -6.515625 C 1.53125 -7.046875 1.265625 -7.769531 1.265625 -8.6875 C 1.265625 -9.8125 1.660156 -10.675781 2.453125 -11.28125 C 3.242188 -11.894531 4.375 -12.203125 5.84375 -12.203125 C 6.5625 -12.203125 7.238281 -12.144531 7.875 -12.03125 C 8.519531 -11.925781 9.109375 -11.769531 9.640625 -11.5625 Z M 9.640625 -11.5625 ">


<path d="M 2.046875 -11.90625 L 4.015625 -11.90625 L 4.015625 0 L 2.046875 0 Z M 2.046875 -16.546875 L 4.015625 -16.546875 L 4.015625 -14.078125 L 2.046875 -14.078125 Z M 2.046875 -16.546875 ">


<path d="M 6.671875 -10.546875 C 5.617188 -10.546875 4.785156 -10.132812 4.171875 -9.3125 C 3.566406 -8.488281 3.265625 -7.363281 3.265625 -5.9375 C 3.265625 -4.519531 3.566406 -3.398438 4.171875 -2.578125 C 4.773438 -1.753906 5.609375 -1.34375 6.671875 -1.34375 C 7.710938 -1.34375 8.535156 -1.753906 9.140625 -2.578125 C 9.753906 -3.398438 10.0625 -4.519531 10.0625 -5.9375 C 10.0625 -7.351562 9.753906 -8.472656 9.140625 -9.296875 C 8.535156 -10.128906 7.710938 -10.546875 6.671875 -10.546875 Z M 6.671875 -12.203125 C 8.367188 -12.203125 9.703125 -11.644531 10.671875 -10.53125 C 11.648438 -9.425781 12.140625 -7.894531 12.140625 -5.9375 C 12.140625 -3.988281 11.648438 -2.457031 10.671875 -1.34375 C 9.703125 -0.238281 8.367188 0.3125 6.671875 0.3125 C 4.960938 0.3125 3.625 -0.238281 2.65625 -1.34375 C 1.6875 -2.457031 1.203125 -3.988281 1.203125 -5.9375 C 1.203125 -7.894531 1.6875 -9.425781 2.65625 -10.53125 C 3.625 -11.644531 4.960938 -12.203125 6.671875 -12.203125 Z M 6.671875 -12.203125 ">

</path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></g>
</defs>
<g id="surface53632">
<rect height="503" width="623" x="0" y="0">
<path d="M 21 3 L 29 3 L 29 5 L 21 5 Z M 21 3 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="381.472656" xlink:href="#glyph0-1" xmlns:xlink="http://www.w3.org/1999/xlink" y="65.154405">
  <use x="389.347548" xlink:href="#glyph0-2" xmlns:xlink="http://www.w3.org/1999/xlink" y="65.154405">
  <use x="401.816081" xlink:href="#glyph0-3" xmlns:xlink="http://www.w3.org/1999/xlink" y="65.154405">
  <use x="409.941081" xlink:href="#glyph0-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="65.154405">
  <use x="414.959798" xlink:href="#glyph0-5" xmlns:xlink="http://www.w3.org/1999/xlink" y="65.154405">
</use></use></use></use></use></g>
<path d="M 14 10 L 22 10 L 22 12 L 14 12 Z M 14 10 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="258.09375" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="205.154405">
</use></g>
<path d="M 25 5 L 18.396094 9.716992 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 18.091016 9.934961 L 18.352539 9.441016 L 18.396094 9.716992 L 18.643164 9.847852 Z M 18.091016 9.934961 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="302" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="121.255968">
  <use x="309.843696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="121.255968">
  <use x="317.968696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="121.255968">
  <use x="326.093696" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="121.255968">
  <use x="330.162435" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="121.255968">
</use></use></use></use></use></g>
<path d="M 14 17 L 22 17 L 22 19 L 14 19 Z M 14 17 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="249.949219" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
  <use x="257.792914" xlink:href="#glyph0-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
  <use x="261.861654" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
  <use x="265.930393" xlink:href="#glyph0-10" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
</use></use></use></use></g>
<path d="M 21 24 L 29 24 L 29 26 L 21 26 Z M 21 24 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="382.371094" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="390.214789" xlink:href="#glyph0-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="394.283529" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="398.352268" xlink:href="#glyph0-10" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="406.477268" xlink:href="#glyph0-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="410.546007" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="414.614746" xlink:href="#glyph0-11" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
</use></use></use></use></use></use></use></g>
<path d="M 8 24 L 16 24 L 16 26 L 8 26 Z M 8 24 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="123.640625" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="131.484321" xlink:href="#glyph0-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="135.55306" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="139.621799" xlink:href="#glyph0-10" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="147.746799" xlink:href="#glyph0-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="151.815538" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
  <use x="155.884277" xlink:href="#glyph0-12" xmlns:xlink="http://www.w3.org/1999/xlink" y="485.154405">
</use></use></use></use></use></use></use></g>
<path d="M 18 12 L 18 16.513281 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 18 16.888281 L 17.75 16.388281 L 18 16.513281 L 18.25 16.388281 Z M 18 16.888281 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 18 19 L 12.374023 23.688281 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 12.085938 23.928516 L 12.309961 23.416211 L 12.374023 23.688281 L 12.630078 23.800391 Z M 12.085938 23.928516 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 18 19 L 24.603906 23.716992 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 24.908984 23.934961 L 24.356836 23.847852 L 24.603906 23.716992 L 24.647461 23.441016 Z M 24.908984 23.934961 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="219" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="226.843696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="234.968696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="243.093696" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="247.162435" xlink:href="#glyph0-10" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
</use></use></use></use></use></g>
<g>
  <use x="161" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="412.255968">
  <use x="168.843696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="412.255968">
  <use x="176.968696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="412.255968">
  <use x="185.093696" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="412.255968">
  <use x="189.162435" xlink:href="#glyph0-12" xmlns:xlink="http://www.w3.org/1999/xlink" y="412.255968">
</use></use></use></use></use></g>
<g>
  <use x="341" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="410.255968">
  <use x="348.843696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="410.255968">
  <use x="356.968696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="410.255968">
  <use x="365.093696" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="410.255968">
  <use x="369.162435" xlink:href="#glyph0-11" xmlns:xlink="http://www.w3.org/1999/xlink" y="410.255968">
</use></use></use></use></use></g>
<path d="M 28 10 L 36 10 L 36 12 L 28 12 Z M 28 10 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="538.230469" xlink:href="#glyph0-13" xmlns:xlink="http://www.w3.org/1999/xlink" y="205.154405">
</use></g>
<path d="M 28 17 L 36 17 L 36 19 L 28 19 Z M 28 17 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="530.359375" xlink:href="#glyph0-13" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
  <use x="537.934245" xlink:href="#glyph0-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
  <use x="542.002984" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
  <use x="546.071723" xlink:href="#glyph0-5" xmlns:xlink="http://www.w3.org/1999/xlink" y="345.154405">
</use></use></use></use></g>
<path d="M 25 5 L 31.603906 9.716992 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 31.908984 9.934961 L 31.356836 9.847852 L 31.603906 9.716992 L 31.647461 9.441016 Z M 31.908984 9.934961 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 32 12 L 32 16.513281 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 32 16.888281 L 31.75 16.388281 L 32 16.513281 L 32.25 16.388281 Z M 32 16.888281 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="482" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="122.255968">
  <use x="489.843696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="122.255968">
  <use x="497.968696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="122.255968">
  <use x="506.093696" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="122.255968">
  <use x="510.162435" xlink:href="#glyph0-13" xmlns:xlink="http://www.w3.org/1999/xlink" y="122.255968">
</use></use></use></use></use></g>
<g>
  <use x="551" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="558.843696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="566.968696" xlink:href="#glyph0-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="575.093696" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
  <use x="579.162435" xlink:href="#glyph0-5" xmlns:xlink="http://www.w3.org/1999/xlink" y="281.255968">
</use></use></use></use></use></g>
<path d="M 5 4 L 9.513281 4 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 9.888281 4 L 9.388281 4.25 L 9.513281 4 L 9.388281 3.75 Z M 9.888281 4 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 5 7 L 9.513281 7 " transform="matrix(20,0,0,20,-98,-18.75)">
<path d="M 9.888281 7 L 9.388281 7.25 L 9.513281 7 L 9.388281 6.75 Z M 9.888281 7 " transform="matrix(20,0,0,20,-98,-18.75)">
<g>
  <use x="2" xlink:href="#glyph0-11" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="9.037489" xlink:href="#glyph0-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="16.868707" xlink:href="#glyph0-2" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="29.33724" xlink:href="#glyph0-2" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="41.805773" xlink:href="#glyph0-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="49.63699" xlink:href="#glyph0-15" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="57.74924" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="61.81798" xlink:href="#glyph0-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="66.836697" xlink:href="#glyph0-16" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="72.099013" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="79.942708" xlink:href="#glyph0-15" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="88.054959" xlink:href="#glyph0-17" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="94.723524" xlink:href="#glyph0-18" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="98.279839" xlink:href="#glyph0-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="103.298557" xlink:href="#glyph0-18" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="106.854872" xlink:href="#glyph0-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
  <use x="114.686089" xlink:href="#glyph0-15" xmlns:xlink="http://www.w3.org/1999/xlink" y="81.255968">
</use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></g>
<g>
  <use x="2" xlink:href="#glyph0-19" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="5.556315" xlink:href="#glyph0-1" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="13.431207" xlink:href="#glyph0-17" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="20.099772" xlink:href="#glyph0-17" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="26.768338" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="30.837077" xlink:href="#glyph0-11" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="37.874566" xlink:href="#glyph0-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="45.705783" xlink:href="#glyph0-2" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="58.174316" xlink:href="#glyph0-2" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="70.642849" xlink:href="#glyph0-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="78.474067" xlink:href="#glyph0-15" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="86.586317" xlink:href="#glyph0-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="90.655056" xlink:href="#glyph0-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="95.673774" xlink:href="#glyph0-16" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="100.936089" xlink:href="#glyph0-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="108.779785" xlink:href="#glyph0-15" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="116.892036" xlink:href="#glyph0-17" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="123.560601" xlink:href="#glyph0-18" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="127.116916" xlink:href="#glyph0-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="132.135634" xlink:href="#glyph0-18" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="135.691949" xlink:href="#glyph0-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
  <use x="143.523166" xlink:href="#glyph0-15" xmlns:xlink="http://www.w3.org/1999/xlink" y="141.255968">
</use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></g>
<g>
  <use x="242" xlink:href="#glyph1-1" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="255.758409" xlink:href="#glyph1-2" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="268.644965" xlink:href="#glyph1-3" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="281.988878" xlink:href="#glyph1-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="303.200629" xlink:href="#glyph1-5" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="317.022786" xlink:href="#glyph1-6" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="323.072591" xlink:href="#glyph1-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="336.469672" xlink:href="#glyph1-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="343.39133" xlink:href="#glyph1-4" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="364.603082" xlink:href="#glyph1-3" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="377.946994" xlink:href="#glyph1-5" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="391.769151" xlink:href="#glyph1-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="398.690809" xlink:href="#glyph1-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="407.228678" xlink:href="#glyph1-10" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="416.181315" xlink:href="#glyph1-3" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="429.525228" xlink:href="#glyph1-11" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="443.326226" xlink:href="#glyph1-12" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="454.67117" xlink:href="#glyph1-13" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="460.720974" xlink:href="#glyph1-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="469.258843" xlink:href="#glyph1-13" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="475.308648" xlink:href="#glyph1-14" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="488.631131" xlink:href="#glyph1-11" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="502.432129" xlink:href="#glyph1-8" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="509.353787" xlink:href="#glyph1-9" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="517.891656" xlink:href="#glyph1-10" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="526.365777" xlink:href="#glyph1-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
  <use x="539.762858" xlink:href="#glyph1-7" xmlns:xlink="http://www.w3.org/1999/xlink" y="21.26709">
</use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></use></g>
</path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></path></rect></g>
</svg>
<br>
This map tree is the result of parsing a file that has dictionaries with
the keys a, b, c many times, the keys a, b, f less often, and also some
objects with the keys x, y.<br>
When parsing a dictionary we traverse this tree from the root, according
to the keys that we see in the input file. While doing this, we
potentially add new nodes, if we get key combinations that we have never
seen before. The set of keys of a dictionary parsed so far are
represented by the current tree node, while we can store the values into
an array. We can use the tree of nodes to speed up parsing. A lot of the
nodes only have one child, because after reading the first few keys of
an object, the remaining ones are often uniquely determined in a given
file. If we have only one child map node, we can speculatively parse the
next key by doing a <tt class="docutils literal">memcmp</tt> between the key that the map tree says is
likely to come next and the characters that follow the ',' that started
the next entry in the dictionary. If the <tt class="docutils literal">memcmp</tt> returns true this
means that the speculation paid off, and we can transition to the new map
that the edge points to, and parse the corresponding value. If not, we
fall back to general code that parses the string, handles escaping rules
etc. This trick was explained to me by some V8 engineers, the same trick
is supposedly used <a class="reference external" href="https://github.com/v8/v8/blob/master/src/json/json-parser.cc">as part of the V8 JSON parser</a>.<br>
This scheme doesn't immediately work for map tree nodes that have more
than one child. However, since we keep statistics anyway about how often
each map is used as the map of a parsed dictionary, we can speculate
that the most common map transition is taken more often than the others
in the future, and use that as the speculated next node.<br>
So for the example transition tree shown in the figure above the key
speculation would succeed for objects with keys <tt class="docutils literal">a, b, c</tt>. For objects
with keys <tt class="docutils literal">a, b, f</tt> the speculation would succeed for the first two
keys, but not for the third key <tt class="docutils literal">f</tt>. For objects with the keys
<tt class="docutils literal">x, y</tt> the speculation would fail for the first key <tt class="docutils literal">x</tt> but succeed
for the second key <tt class="docutils literal">y</tt>.<br>
For real-world datasets these transition trees can become a lot more
complicated, for example here is a visualization of a part of the
transition tree generated for parsing a New York Times dataset:<br>
<a href="https://2.bp.blogspot.com/-Jv_p8rFIq8Y/XZubp3WVptI/AAAAAAAAwuY/rhTCqXJpoMUdtEf22tzqK64dcEJmBE6fwCPcBGAYYCw/s1600/2019_json_nytimes.png"><img border="0" height="310" src="https://2.bp.blogspot.com/-Jv_p8rFIq8Y/XZubp3WVptI/AAAAAAAAwuY/rhTCqXJpoMUdtEf22tzqK64dcEJmBE6fwCPcBGAYYCw/s400/2019_json_nytimes.png" width="400"></a>

<br>
<h2>
Caching Strings</h2>
A rather obvious observation we can use to improve performance of the
parser is the fact that string values repeat a lot in most JSON files.
For strings that are used as dictionary keys this is pretty obvious.
However it happens also for strings that are used as values in
dictionaries (or are stored in lists). We can use this fact to
intern/memoize strings and save memory. This is an approach that many
JSON parsers use, including
<a class="reference external" href="https://github.com/python/cpython/blob/3.7/Modules/_json.c#L749">CPython's</a>.
To do this, I keep a dictionary of strings that we have seen so far
during parsing and look up new strings that are deserialized. If we have
seen the string before, we can re-use the deserialized previous string.
Right now I only consider utf-8 strings for caching that do not contain
any escapes (whether stuff like <tt class="docutils literal">\", \n</tt> or escaped unicode chars).<br>
This simple approach works extremely well for dictionary keys, but needs
a number of improvements to be a win in general. The first observation
is that computing the hash to look up the string in the dictionary of
strings we've seen so far is basically free. We can compute the hash
while scanning the input for the end of the string we are currently
deserializing. Computing the hash while scanning doesn't increase the
time spent scanning much. This is not a new idea, I am sure many other
parsers do the same thing (but CPython doesn't seem to).<br>
Another improvement follows from the observation that inserting every
single deserialized non-key string into a hashmap is too expensive.
Instead, we insert strings into the cache more conservatively, by
keeping a small ring buffer of hashes of recently deserialized strings.
The hash is looked for in the ring buffer, and only if the hash is
present we insert the string into the memoization hashmap. This has the
effect of only inserting strings into the memoization hashmap that
re-occur a second time not too far into the file. This seems to give a
good trade-off between still re-using a lot of strings but keeping the
time spent updating and the size of the memoization hashmap low.<br>
Another twist is that in a lot of situations caching strings is not
useful at all, because it will almost never succeed. Examples of this
are UUIDs (which are unique), or the content of a tweet in a JSON file
with many tweets (which is usually unique). However, in the same file it
might be useful to cache e.g. the user name of the Twitter user, because
many tweets from the same person could be in such a file. Therefore the
usefulness of the string cache depends on which fields of objects we are
deserializing the value off. Therefore we keep statistics per map field
and disable string memoization per individual field if the cache hit
rate falls below a certain threshold. This gives the best of both
worlds: in the cases where string values repeat a lot in certain fields
we use the cache to save time and memory. But for those fields that
mostly contain unique strings we don't waste time looking up and adding
strings in the memoization table. Strings outside of dictionaries are
quite rare anyway, so we just always try to use the cache for them.<br>
The following pseudocode sketches the code to deserialize a string in
the input at a given position. The function also takes a map, which is
the point in the map tree that we are currently deserializing a field
off (if we are deserializing a string in another context, some kind of
dummy map can be used there).<br>
<pre><code class="python">
def deserialize_string(pos, input, map):
    # input is the input string, pos is the position of the starting " of
    # the string

    # find end of string, check whether it contains escape codes,
    # compute hash, all at the same time
    end, escapes, hash = find_end_of_string(pos + 1, input)
    if end == -1:
        raise ParseError
    if escapes:
        # need to be much more careful with escaping
        return deserialize_string_escapes(pos, input)
    
    # should we cache at all?
    if map.cache_disabled():
        return input[pos + 1:end]

    # if string is in cache, return it
    if hash in cache:
        map.cache_hit += 1
        return cache[hash]

    result = input[pos + 1:end]
    map.cache_miss += 1

    # if hash is in the ring buffer of recently seen hashes,
    # add the string to the cache
    if hash in ring_buffer:
        cache[hash] = result
    else:
        ring_buffer.write(hash)
    return result

</code>
</pre>
<h2>
Evaluation</h2>
To find out how much the various techniques help, I implemented a number
of JSON parsers in PyPy with different combinations of the techniques
enabled. I compared the numbers with the JSON parser of CPython 3.7.3
(simplejson), with ujson, with the JSON parser of Node 12.11.1 (V8) and with
RapidJSON (in DOM mode).<br>
I collected a number of medium-to-large JSON files to try the JSON
parsers on:<br>
<ul class="simple">
<li><a class="reference external" href="https://censys.io/data">Censys</a>: A subset of the Censys port and
protocol scan data for websites in the Alexa top million domains</li>
<li><a class="reference external" href="https://www.gharchive.org/">Gharchive</a>: Github activity from
January 15-23, 2015 from Github Archive</li>
<li><a class="reference external" href="https://files.pushshift.io/reddit/comments/">Reddit</a>: Reddit
comments from May 2009</li>
<li>Rosie: The nested matches produced using the <a class="reference external" href="https://rosie-lang.org/">Rosie pattern
language</a> <tt class="docutils literal">all.things</tt> pattern on a log
file</li>
<li>Nytimes: Metadata of a collection of New York Times articles</li>
<li>Tpch: The TPC-H database benchmark's deals table as a JSON file</li>
<li>Twitter: A JSON export of the @pypyproject Twitter account data</li>
<li>Wikidata: A file storing a subset of the Wikidata fact dump from Nov
11, 2014</li>
<li><a class="reference external" href="https://www.yelp.com/dataset/download">Yelp</a>: A file of yelp
businesses</li>
</ul>
Here are the file sizes of the benchmarks:<br>
<table class="dataframe">
  <thead>
<tr style="text-align: right;">
      <th>Benchmark</th>
      <th>File Size [MiB]</th>
    </tr>
</thead>
  <tbody>
<tr style="text-align: right;">
      <td>Censys</td>
      <td>898.45</td>
    </tr>
<tr style="text-align: right;">
      <td>Gharchive</td>
      <td>276.34</td>
    </tr>
<tr style="text-align: right;">
      <td>NYTimes</td>
      <td>12.98</td>
    </tr>
<tr style="text-align: right;">
      <td>Reddit</td>
      <td>931.65</td>
    </tr>
<tr style="text-align: right;">
      <td>Rosie</td>
      <td>388.88</td>
    </tr>
<tr style="text-align: right;">
      <td>TPCH</td>
      <td>173.86</td>
    </tr>
<tr style="text-align: right;">
      <td>Wikidata</td>
      <td>119.75</td>
    </tr>
<tr style="text-align: right;">
      <td>Yelp</td>
      <td>167.61</td>
    </tr>
</tbody>
</table>
I measured the times of each benchmark with a number of variations
of the improved PyPy algorithms:<br>
<ul class="simple">
<li>PyPyBaseline: The PyPy JSON parser as it was before my work with JSON
parsing started (PyPy version 5.8)</li>
<li>PyPyKeyStringCaching: Memoizing the key strings of dictionaries, but
not the other strings in a json file, and not using maps to represent
dictionaries (this is the JSON parser that PyPy has been shipping since
version 5.9, in the benchmarks I used 7.1).</li>
<li>PyPyMapNoCache: Like PyPyKeyStringCaching, but using maps to
represent dictionaries. This includes speculatively parsing the next
key using memcmp, but does not use string caching of non-key strings.</li>
<li>PyPyFull: Like PyPyMapNoCache but uses a string cache for all
strings, not just keys. This is equivalent to what will be released soon as part of PyPy 7.2</li>
</ul>
In addition to wall clock time of parsing, I also measured the increase
in memory use of each implementation after the input string has been
deserialized, i.e. the size of the in-memory representation of every
JSON file.<br>

<h3>
Contributions of Individual Optimizations</h3>
Let's first look at the contributions of the individual optimizations to the
overall performance and memory usage.<br>
<img src="https://docs.google.com/uc?id=1oqsebLsZH8pj4exAVbDthaRhERXqg8mN" width="800/">
<img src="https://docs.google.com/uc?id=1_3UuTihT0A6wfM-F3sj8j9M9IoQuvcCt" width="800/">

<br>
All the benchmarks were run 30 times in new processes, all the numbers are
normalized to PyPyFull.<br>
The biggest individual improvement to both parsing time and memory used comes
from caching just the keys in parsed dictionaries. This is the optimization in
PyPy's JSON parser that has been implemented for a while already. To understand
why this optimization is so useful, let's look at some numbers about each
benchmark, namely the number of total keys across all dictionaries in each
file, as well as the number of unique keys. As we can see, for all benchmarks
the number of unique keys is significantly smaller than the number of keys in
total.<br>
<table class="dataframe">
  <thead>
<tr style="text-align: right;">
      <th>Benchmark</th>
      <th>Number of keys</th>
      <th>Number of unique keys</th>
    </tr>
</thead>
  <tbody>
<tr style="text-align: right;">
      <td>Censys</td>
      <td>14404234</td>
      <td>163</td>
    </tr>
<tr style="text-align: right;">
      <td>Gharchive</td>
      <td>6637881</td>
      <td>169</td>
    </tr>
<tr style="text-align: right;">
      <td>NYTimes</td>
      <td>417337</td>
      <td>60</td>
    </tr>
<tr style="text-align: right;">
      <td>Reddit</td>
      <td>25226397</td>
      <td>21</td>
    </tr>
<tr style="text-align: right;">
      <td>Rosie</td>
      <td>28500101</td>
      <td>5</td>
    </tr>
<tr style="text-align: right;">
      <td>TPCH</td>
      <td>6700000</td>
      <td>45</td>
    </tr>
<tr style="text-align: right;">
      <td>Wikidata</td>
      <td>6235088</td>
      <td>1602</td>
    </tr>
<tr style="text-align: right;">
      <td>Yelp</td>
      <td>5133914</td>
      <td>61</td>
    </tr>
</tbody>
</table>
The next big jump in deserialization time and memory comes from introducing
maps to represent deserialized dictionaries. With PyPyMapNoCache
deserialization time goes down because it's much cheaper to walk the tree
of maps and store all deserialized objects into an array of values than to
build hashmaps with the same keys again and again. Memory use goes down
for the same reason: it takes a lot less memory to store the shared
structure of each set of keys in the map, as opposed to repeating it again
and again in every hashmap.<br>
We can look at some numbers about every benchmark again. The table shows how
many map-based dictionaries are deserialized for every benchmark, and how many
hashmap-backed dictionaries. We see that the number of hashmap-backed
dictionaries is often zero, or at most a small percentage of all dictionaries
in each benchmark. Yelp has the biggest number of hashmap-backed dictionaries.
The reason for this is that the input file contains hashmaps that store
combinations of various features of Yelp businesses, and a lot of these
combinations are totally unique to a business. Therefore the heuristics
determine that it's better to store these using hashmaps.<br>
<table class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Benchmark</th>
      <th>Map Dicts</th>
      <th>Regular Dicts</th>
      <th>% Regular Dicts</th>
    </tr>
  </thead>
  <tbody>
    <tr style="text-align: right;">
      <td>Censys</td>
      <td>4049235</td>
      <td>1042</td>
      <td>0.03</td>
    </tr>
    <tr style="text-align: right;">
      <td>Gharchive</td>
      <td>955301</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
    <tr style="text-align: right;">
      <td>NYTimes</td>
      <td>80393</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
    <tr style="text-align: right;">
      <td>Reddit</td>
      <td>1201257</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
    <tr style="text-align: right;">
      <td>Rosie</td>
      <td>6248966</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
    <tr style="text-align: right;">
      <td>TPCH</td>
      <td>1000000</td>
      <td>0</td>
      <td>0.00</td>
    </tr>
    <tr style="text-align: right;">
      <td>Wikidata</td>
      <td>1923460</td>
      <td>46905</td>
      <td>2.38</td>
    </tr>
    <tr style="text-align: right;">
      <td>Yelp</td>
      <td>443140</td>
      <td>52051</td>
      <td>10.51</td>
    </tr>
  </tbody>
</table>

We can also look at numbers about how often the memcmp-based speculative
parsing of the next key of a given map succeeds. Looking at statistics
about each benchmark, we can see that the speculation of what key we
expect next pays off in a significant percentage of cases, between 63% for
Wikidata where the dictionary structures are quite irregular, and 99% for
Reddit, where all the dictionaries have the same set of keys.<br>
<table class="dataframe">
  <thead>
<tr style="text-align: right;">
      <th>Benchmark</th>
      <th>Number of Keys</th>
      <th>Map Transitions</th>
      <th>% Successful Speculation</th>
    </tr>
</thead>
  <tbody>
<tr style="text-align: right;">
      <td>Censys</td>
      <td>14404234</td>
      <td>14403243</td>
      <td>65.79</td>
    </tr>
<tr style="text-align: right;">
      <td>Gharchive</td>
      <td>6637881</td>
      <td>6637881</td>
      <td>86.71</td>
    </tr>
<tr style="text-align: right;">
      <td>NYTimes</td>
      <td>417337</td>
      <td>417337</td>
      <td>79.85</td>
    </tr>
<tr style="text-align: right;">
      <td>Reddit</td>
      <td>25226397</td>
      <td>25226397</td>
      <td>100.00</td>
    </tr>
<tr style="text-align: right;">
      <td>Rosie</td>
      <td>28500101</td>
      <td>28500101</td>
      <td>90.37</td>
    </tr>
<tr style="text-align: right;">
      <td>TPCH</td>
      <td>6700000</td>
      <td>6700000</td>
      <td>86.57</td>
    </tr>
<tr style="text-align: right;">
      <td>Wikidata</td>
      <td>6235088</td>
      <td>5267744</td>
      <td>63.68</td>
    </tr>
<tr style="text-align: right;">
      <td>Yelp</td>
      <td>5133914</td>
      <td>4593980</td>
      <td>90.43</td>
    </tr>
<tr style="text-align: right;">
      <td>geomean</td>
      <td></td>
      <td></td>
      <td>82.04</td>
    </tr>
</tbody>
</table>
General string caching is the most unclear optimization. On the one hand its
impact on memory usage is quite substantial, leading to a 20% reduction for
Gharchive and Reddit, up to a 2 improvement for Yelp. On the other hand, the
effect on performance is less clear, since it even leads to a slowdown in
Gharchive and Reddit, and generally only a small improvement. Choosing the
right heuristic for when to disable the cache also has somewhat unclear effects
and is definitely a topic worthy of further investigation.<br>
<h3>
Comparison against other JSON Decoders</h3>
To get a more general feeling of the performance and memory usage of the
improved PyPy parser, we compare it against CPython's built-in json
parser, ujson for CPython, Node's (V8) JSON parser and RapidJSON. For
better context for the memory usage I also show the file size of the input
files.<br>
These benchmarks are not really an apples-to-apple comparison. All of the
implementations use different in-memory representations of strings in
the deserialized data-structure (Node uses two bytes per character in
a string, <a href="https://www.python.org/dev/peps/pep-0393/">in CPython it
depends</a> but 4 bytes on my
machine), PyPyBaseline uses four bytes, PyPy and RapidJSON use utf-8). But
it's still interesting to get some ballpark numbers. The results are as
follows:<br>
<img src="https://docs.google.com/uc?id=1Q-aFNXE-sWJi5kSKTwmQNLz5LI3DDgtm" width="800/">
<img src="https://docs.google.com/uc?id=1sgGyqp93_czrxN4IYkXeZ-jFWCAs37bu" width="800/">

<br>
As we can see, PyPyFull handily beats CPython and ujson, with a geometric
mean of the improvement of about 2.5. The memory improvement can be even
more extreme, with an improvement of over 4 against CPython/ujson in some
cases (CPython gives better memory sizes, because its parser caches the
keys of dictionaries as well). Node is often more than 50% slower, whereas
RapidJSON beats us easily, by a factor of 2 on average.<br>
<h2>
Conclusions</h2>
While the speedup I managed to achieve over the course of this project is
nice and I am certainly happy to beat both CPython and Node, I am
ultimately still annoyed that RapidJSON manages to maintain such a clear
lead over PyPyFull, and would like to get closer to it. One problem that
PyPy suffers compared to RapidJSON is the overhead of garbage collection.
Deserializing large JSON files is pretty much the worst case for the
generational GC that PyPy uses, since none of the deserialized objects die
young (and the GC expects that most objects do). That means that a lot of
the deserialization time of PyPy is wasted allocating the resulting
objects in the nursery, and then copying them into the old generation.
Somehow, this should be done in better ways, but all my attempts to not
have to do the copy did not seem to help much. So maybe more improvements
are possible, if I can come up with more ideas.<br>
On the memory side of things, Node/V8 is beating PyPy clearly which might
indicate more general problems in how we represent Python objects in
memory. On the other hand, I think it's cool that we are competitive with
RapidJSON in terms of memory and often within 2 of the file size.<br>
An effect that I didn't consider at all in this blog post is the fact that
accessing the deserialized objects with constants strings is <i>also</i> faster
than with regular dictionaries, due to them being represented with maps.
More benchmarking work to do in the future!<br>
If you have your own programs that run on PyPy and use the json parser
a lot, please measure them on the new code and let me know whether you see
any difference!</body></html>