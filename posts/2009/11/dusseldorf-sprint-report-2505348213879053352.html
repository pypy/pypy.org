<!DOCTYPE html>
<html \ prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Düsseldorf Sprint Report | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2009/11/dusseldorf-sprint-report-2505348213879053352.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../../assets/css/tipuesearch.css">
<meta name="author" content="Carl Friedrich Bolz-Tereick">
<link rel="prev" href="dusseldorf-sprint-started-7608527610228870250.html" title="Düsseldorf Sprint Started" type="text/html">
<link rel="next" href="some-benchmarking-9211261260383281459.html" title="Some benchmarking" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Düsseldorf Sprint Report">
<meta property="og:url" content="https://www.pypy.org/posts/2009/11/dusseldorf-sprint-report-2505348213879053352.html">
<meta property="og:description" content="While the Düsseldorf is dwindling off, we put our minds to the task of retelling
our accomplishments. The sprint was mostly about improving the JIT and we         
managed to stick to that task (as mu">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2009-11-13T12:46:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog/">Index</a> </li>  
                    <li> <a href="../../../categories/">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://bsky.app/profile/pypyproject.bsky.social">Bluesky</a> </li>  
                    <li> <a href="https://libera.irclog.whitequark.org/pypy">IRC logs</a> </li>  
                    <li> <a href="https://www.youtube.com/playlist?list=PLADqad94yVqDRQXuqxKrPS5QnVqbDLlRt">YouTube</a> </li>  
                    <li> <a href="https://www.twitch.tv/pypyproject">Twitch</a> </li>  
                    <li> <a href="../../../pypy-sponsors.html">Sponsors</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section><div class="searchform" role="search">
                
<form class="navbar-form navbar-left" action="../../../search.html" role="search">
    <div class="form-group">
        <input type="text" class="form-control" id="tipue_search_input" name="q" placeholder="Search…" autocomplete="off">
</div>
    <input type="submit" value="Local Search" style="visibility: hidden;">
</form>

            </div>
    </header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Düsseldorf Sprint Report</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../../authors/carl-friedrich-bolz-tereick.html">Carl Friedrich Bolz-Tereick</a>
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2009-11-13T12:46:00Z" itemprop="datePublished" title="2009-11-13 12:46">2009-11-13 12:46</time></a>
            </p>
                <p class="commentline">4 comments</p>

                <p class="commentline">            <a href="dusseldorf-sprint-report-2505348213879053352.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>While the Düsseldorf is dwindling off, we put our minds to the task of retelling
our accomplishments. The sprint was mostly about improving the JIT and we         
managed to stick to that task (as much as we managed to stick to anything). The   
sprint was mostly filled with doing many small things.</p>                        
<div class="section" id="inlining">                                               
<h2>Inlining<a href="#inlining" class="headerlink" title="Permalink to this heading">¶</a></h2>                                                                 
<p>Carl Friedrich and Samuele started the sprint trying to tame the JIT's inlining.
Until now, the JIT would try to inline everything in a loop (except other loops)  
which is what most tracing JITs actually do. This works great if the resulting    
trace is of reasonable length, but if not it would result in excessive memory     
consumption and code cache problems in the CPU. So far we just had a limit on     
the trace size, and we would abort tracing when the limit was reached. This       
would happen again and again for the same loop, which is not useful at all. The   
new approach introduced is to be more clever when tracing is aborted by marking   
the function with the largest contribution to the trace size as non-inlinable. The
next time this loop is traced, it usually then gives a reasonably sized trace.</p>
<p>This gives a problem because now some functions that don't contain loops are not
inlined, which means they never get assembler code for them generated. To remedy  
this problem we also make it possible to trace functions from their start (as     
opposed to just tracing loops). We do that only for functions that can not be     
inlinined (either because they contain loops or they were marked as               
non-inlinable as described above).</p>                                            
<p>The result of this is that the <a class="reference external" href="https://svn.python.org/view/sandbox/trunk/decimal/telco/">Python version</a> <a class="reference external" href="https://speleotrove.com/decimal/telco.html">telco decimal benchmark</a> runs                                 
to completion without having to arbitrarily increase the trace length limit.                    
It's also about 40% faster than running it on CPython. This is one of the first                 
non-tiny programs that we speed up.</p>                                                         
</div>                                                                                          
<div class="section" id="reducing-gc-pressure">                                                 
<h2>Reducing GC Pressure<a href="#reducing-gc-pressure" class="headerlink" title="Permalink to this heading">¶</a></h2>                                                                   
<p>Armin and Anto used some GC instrumentation to find places in pypy-c-jit                     
that allocate a lot of memory. This is an endlessly surprising exercise, as                     
usually we don't care too much about allocations of short-lived objects when                    
writing RPython, as our GCs usually deal well with those. They found a few                      
places where they could remove allocations, most importantly by making one of                   
the classes that make up traces smaller.</p>                                                    
</div>                                                                                          
<div class="section" id="optimizing-chains-of-guards">                                          
<h2>Optimizing Chains of Guards<a href="#optimizing-chains-of-guards" class="headerlink" title="Permalink to this heading">¶</a></h2>                                                            
<p>Carl Friedrich and Samuele started a simple optimization on the trace level that             
removes superfluous guards. A common pattern in a trace is to have stronger                     
and stronger guards about the same object. As an example, often there is first a                
guard that an object is not None, later followed by a guard that it is exactly                  
of a given class and then even later that it is a precise instance of that                      
class. This is inefficient, as we can just check the most precise thing in the                  
place of the first guard, saving us guards (which take memory, as they need resume data).       
Maciek, Armin and Anto later improved on that by introducing a new guard that                   
checks for non-nullity and a specific class in one guard, which allows us to                    
collapse more chains.</p>                                                                       
</div>                                                                                          
<div class="section" id="improving-jit-and-exceptions">                                         
<h2>Improving JIT and Exceptions<a href="#improving-jit-and-exceptions" class="headerlink" title="Permalink to this heading">¶</a></h2>                                                           
<p>Armin and Maciek went on a multi-day quest to make the JIT and Python-level                  
exceptions like each other more. So far, raising and catching exceptions would                  
make the JIT generate code that has a certain amusement value, but is not really                
fast in any way. To improve the situation, they had to dig into the exception                   
support in the Python interpreter, where they found various inefficiencies. They                
also had to rewrite the <tt class="docutils literal"><span class="pre">exceptions</span></tt> module to be in RPython (as opposed to                                                             
just pure Python + an old hack). Another problems is that tracebacks give you                   
access to interpreter frames. This forces the JIT to deoptimize things, as                      
the JIT keeps some of the frame's content in CPU registers or on the CPU stack,                 
which reflective access to frames prevents.                                                     
Currently we try to improve the simple cases where the traceback is never                       
actually accessed. This work is not completely finished, but some cases are                     
already significantly faster.</p>                                                               
</div>                                                                                          
<div class="section" id="moving-pypy-to-use-py-test-1-1">                                       
<h2>Moving PyPy to use py.test 1.1<a href="#moving-pypy-to-use-py-test-1-1" class="headerlink" title="Permalink to this heading">¶</a></h2>                                                         
<p>Holger worked on porting PyPy to use the <a class="reference external" href="https://codespeak.net/py/dist/announce/release-1.1.0.html">newly released</a> py.test 1.1. PyPy                   
still uses some very old support code in its testing infrastructure, which makes                
this task a bit annoying. He also gave the other PyPy developers a demo of some                 
of the newer py.test features and we discussed which of them we want to start                   
using to improve our tests to make them shorter and clearer. One of the things                  
we want to do eventually is to have less skipped tests than now.</p>                            
</div>                                                                                          
<div class="section" id="using-a-simple-effect-analysis-for-the-jit">                           
<h2>Using a Simple Effect Analysis for the JIT<a href="#using-a-simple-effect-analysis-for-the-jit" class="headerlink" title="Permalink to this heading">¶</a></h2>                                             
<p>One of the optimization the JIT does is caching fields that are read out of                  
structures on the heap. This cache needs to be invalidated at some points, for
example when such a field is written to (as we don't track aliasing much).
Another case is a call in the assembler, as the target function could
arbitrarily change the heap. This of course is imprecise, since most functions
don't actually change the whole heap, and we have an analysis that finds out
which sorts of types of structs and arrays a function can mutate. During the
sprint Carl Friedrich and Samuele integrated this analysis with the JIT, to help
it invalidate caches less aggressively. Later Anto and Carl Friedrich also
ported this support to the CLI version of the JIT.</p>
</div>
<div class="section" id="miscellaneous">
<h2>Miscellaneous<a href="#miscellaneous" class="headerlink" title="Permalink to this heading">¶</a></h2>
<p>Samuele (with some assistance of Carl Friedrich) set up a buildbot slave on a
Mac Mini at the University. This should let us stabilize on the Max OS X. So far
we still have a number of <a class="reference external" href="https://codespeak.net:8099/summary?category=mac">failing tests</a>, but now we are in a situation to
sanely approach fixing them.</p>
<p>Anto improved the CLI backend to support the infrastructure for producing the
<a class="reference external" href="hi-all-this-week-i-worked-on-improving-6515977421244851229.html">profiling graphs Armin introduced</a>.</p>
<p>The guinea-pigs that were put into Carl Friedrich's care have been fed (which
was the most important sprint task anyway).</p>
<p> Samuele &amp; Carl Friedrich</p>
</div>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="dusseldorf-sprint-started-7608527610228870250.html" rel="prev" title="Düsseldorf Sprint Started">Previous post</a>
            </li>
            <li class="next">
                <a href="some-benchmarking-9211261260383281459.html" rel="next" title="Some benchmarking">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-6208008560238059190">
        <div class="comment-header">
          <a name="comment-6208008560238059190"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2009-11-13 17:57</span>:
        </div>
        <div class="comment-content">
          <p>Great news and a nice read. Out of curiosity, did you also improve performance for the richards or pystone benchmarks?</p>
        </div>
      </div>
      <div class="comment comment-6677563640903018100">
        <div class="comment-header">
          <a name="comment-6677563640903018100"></a>
            <span class="author">hubert</span> wrote on <span class="date">2009-11-14 05:05</span>:
        </div>
        <div class="comment-content">
          <p>this is a very fascinating project and i enjoy reading the blog even if i am not really a computer scientist and don't have a very deep understanding of many details. :)<br><br>something i always wonder about... wouldn't it be possible to use genetic algorithms in compiler technology? like a python to machine code compiler that evolves to the fastest solution by itself? or is there still not enough computing power for something like that?</p>
        </div>
      </div>
      <div class="comment comment-5391370036941297902">
        <div class="comment-header">
          <a name="comment-5391370036941297902"></a>
            <span class="author">pollo</span> wrote on <span class="date">2009-11-14 11:18</span>:
        </div>
        <div class="comment-content">
          <p>Very interesting. Thanks for all your work!</p>
        </div>
      </div>
      <div class="comment comment-5931064261186588892">
        <div class="comment-header">
          <a name="comment-5931064261186588892"></a>
            <span class="author">Carl Friedrich Bolz-Tereick</span> wrote on <span class="date">2009-11-14 14:57</span>:
        </div>
        <div class="comment-content">
          <p>@Anonymous: Richards and Pystone become less and less important as benchmarks, we are trying to look into more application-like larger things now.</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2025/07/pypy-v7320-release.html" class="listtitle">PyPy v7.3.20 release</a>
      </li>
      <li>
        <a href="/posts/2025/06/rpython-gc-allocation-speed.html" class="listtitle">How fast can the RPython GC allocate?</a>
      </li>
      <li>
        <a href="/posts/2025/04/prospero-in-rpython.html" class="listtitle">Doing the Prospero-Challenge in RPython</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7319-release.html" class="listtitle">PyPy v7.3.19 release</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-gc-sampling.html" class="listtitle">Low Overhead Allocation Sampling with VMProf in PyPy's GC</a>
      </li>
      <li>
        <a href="/posts/2025/02/pypy-v7318-release.html" class="listtitle">PyPy v7.3.18 release</a>
      </li>
      <li>
        <a href="/posts/2025/01/musings-tracing.html" class="listtitle">Musings on Tracing in PyPy</a>
      </li>
      <li>
        <a href="/posts/2025/01/towards-pypy311-an-update.html" class="listtitle">Towards PyPy3.11 - an update</a>
      </li>
      <li>
        <a href="/posts/2024/11/guest-post-final-encoding-in-rpython.html" class="listtitle">Guest Post: Final Encoding in RPython Interpreters</a>
      </li>
      <li>
        <a href="/posts/2024/10/jit-peephole-dsl.html" class="listtitle">A DSL for Peephole Transformation Rules of Integer Operations in the PyPy JIT</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
            <li><a class="reference" href="/2021/">2021</a> (10)
            </li>
            <li><a class="reference" href="/2022/">2022</a> (13)
            </li>
            <li><a class="reference" href="/2023/">2023</a> (6)
            </li>
            <li><a class="reference" href="/2024/">2024</a> (13)
            </li>
            <li><a class="reference" href="/2025/">2025</a> (8)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (2)</li>
            <li><a class="reference" href="/categories/benchmarking.html">benchmarking</a> (1)</li>
            <li><a class="reference" href="/categories/casestudy.html">casestudy</a> (3)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/conda-forge.html">conda-forge</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (4)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (3)</li>
            <li><a class="reference" href="/categories/gc.html">gc</a> (3)</li>
            <li><a class="reference" href="/categories/guestpost.html">guestpost</a> (3)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (23)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/meta.html">meta</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/performance.html">performance</a> (2)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (7)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (66)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (2)</li>
            <li><a class="reference" href="/categories/rpython.html">rpython</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (6)</li>
            <li><a class="reference" href="/categories/sponsors.html">sponsors</a> (7)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/sprints.html">sprints</a> (1)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/testing.html">testing</a> (1)</li>
            <li><a class="reference" href="/categories/toy-optimizer.html">toy-optimizer</a> (5)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
            <li><a class="reference" href="/categories/vmprof.html">vmprof</a> (3)</li>
            <li><a class="reference" href="/categories/z3.html">z3</a> (5)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div class="logotext">
    © 2025 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
     
    Built with <a href="https://getnikola.com" rel="nofollow">Nikola</a>
     
    Last built 2025-07-07T11:01
  </div>
  <div style="margin-left: auto">
  <a href="../../../rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>