<html><body><p>Armin and me have been working on PyPy's parser and bytecode compiler for the Python language in the last days. Armin implemented several bytecode optimizations that CPython has since a while whereas I tried to refactor our tokenizer and parser (because our existing parser is rather slow and also not very nice code). Armin is mostly done whereas the new parser is not very far yet.</p> <p>What is done, however, is the Python tokenizer. It is implemented in the usual way, by using a set of <a href="https://en.wikipedia.org/wiki/Regular_expression#Formal_language_theory">regular expressions</a> to generate a <a href="https://en.wikipedia.org/wiki/Deterministic_finite_state_machine">deterministic finite automaton</a> (DFA). This automaton is then turned into a big function which does the actual tokenization. Of course the picture is not quite as simple for Python, because it is not possible to tokenize Python using only regular expressions. To generate the proper "indent" and "dedent" tokens it would be necessary to keep state (the previous indentation levels) which a DFA cannot do. This is solved by postprocessing the tokens that the tokenizer produces to turn whitespace tokens into the proper indent and dedent tokens.</p>
<p>For debugging purposes I implemented a visualization tool for DFAs using PyPy's <a href="https://pygame.org/">pygame</a>-based <a href="https://codespeak.net/viewvc/pypy/dist/dotviewer/">graph viewer</a>. The graph viewer is able to visualize interactively any graph given in the graph-description language of <a href="https://graphviz.or/">Graphviz</a>. Looking at the tokenizing DFA for Python is rather instructive, both for understanding how tokenizing works and (maybe) for understanding the Python language. To try it, download the <a href="https://codespeak.net/%7Ecfbolz/tokenizer.dot">dot file of the DFA</a> and run from a pypy checkout:</p>
<p></p><pre>$ python pypy/bin/dotviewer.py tokenizer.dot</pre><p></p>The following is a screenshot of the graphviewer:
<a href="https://2.bp.blogspot.com/_zICyAWqZbLA/R4NutbgbocI/AAAAAAAAADU/QPPOLMVWp50/s1600-h/graphviewer.png"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5153084125398933954" src="https://2.bp.blogspot.com/_zICyAWqZbLA/R4NutbgbocI/AAAAAAAAADU/QPPOLMVWp50/s320/graphviewer.png" style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;"></a>
<p>For people who don't want do checkout PyPy I generated a (rather big) <a href="https://codespeak.net/%7Ecfbolz/tokenizer.png">png</a> for the DFA.</p>
<p>Next thing I would like to do (apart from actually finishing the parser, of course :-) ) is visualize the Python grammar itself using <a href="https://en.wikipedia.org/wiki/Syntax_diagram">syntax diagrams</a> or something similar. So far I couldn't really find a program to do that, though.</p></body></html>